# Vulnerability Validator Skill

## Purpose

Validate security findings with rigorous scientific controls to minimize false positives and ensure reproducibility. Implements strict validation requirements including 3x reproduction, negative controls, and cross-identity verification.

## Capabilities

1. **Reproduction Testing**
   - Execute finding 3+ times for consistency
   - Track success rate and variance
   - Detect intermittent issues

2. **Negative Control Testing**
   - Verify vulnerability doesn't exist without exploit
   - Test with invalid/missing credentials
   - Confirm expected behavior baseline

3. **Cross-Identity Verification**
   - Test with multiple user identities
   - Verify authorization enforcement
   - Detect privilege escalation

4. **Confidence Scoring**
   - Calculate weighted confidence score
   - Provide promotion/rejection recommendation
   - Document decision factors

## Validation Requirements

A finding must pass ALL of the following to be promoted:

### 1. Reproduction (Required)
- **Minimum**: 3 successful reproductions
- **Consistency**: >90% success rate
- **Variance**: Response characteristics must be stable

### 2. Negative Control (Required)
- **Unauthenticated**: Vulnerability must not work without auth
- **Invalid Token**: Must fail with invalid credentials
- **Different User**: Must not affect unauthorized users

### 3. Cross-Identity (Recommended)
- **Owner Access**: Legitimate owner can access
- **Non-Owner Blocked**: Other users cannot access
- **Admin Override**: Admin access follows policy

## Confidence Score Calculation

```
confidence_score = (repro_score * 0.4) +
                   (negative_control_score * 0.35) +
                   (cross_identity_score * 0.25)
```

Score components:
- **repro_score**: success_rate * consistency_factor
- **negative_control_score**: 1.0 if passed, 0.0 if failed
- **cross_identity_score**: violations_handled_correctly / total_identities

Thresholds:
- **Promote**: confidence >= 0.8
- **Investigate**: 0.5 <= confidence < 0.8
- **Dismiss**: confidence < 0.5

## Validation Workflow

### Step 1: Prepare Validation Context
```json
{
  "finding_id": "F-001",
  "hypothesis_id": "H-001",
  "original_request": {
    "method": "GET",
    "url": "https://api.example.com/users/123/profile",
    "headers": { "Authorization": "Bearer user_a_token" }
  },
  "expected_vulnerability": {
    "type": "BOLA/IDOR",
    "indicator": "Access to user 123 data when authenticated as user 456"
  }
}
```

### Step 2: Reproduction Test
```
For i in 1..3:
    response = execute_request(finding.request)
    record_result(response.status, response.body_hash, response.time)

If success_rate < 0.9:
    mark_as_unreliable()

If all_hashes_identical:
    mark_as_consistent()
```

### Step 3: Negative Control
```
Test 1: Remove Authorization header
    expected: 401 Unauthorized

Test 2: Use invalid token
    expected: 401/403

Test 3: Modify request (remove exploit payload)
    expected: Normal behavior (no vulnerability)

If any test shows vulnerability without conditions:
    mark_negative_control_failed()
```

### Step 4: Cross-Identity Test
```
For each identity in [owner, other_user, admin]:
    response = execute_with_identity(identity, finding.request)
    record_access_result(identity, response.status, identity.should_have_access)

violations = count_authorization_violations()
If violations > 0:
    confirm_authorization_issue()
```

### Step 5: Calculate Confidence
```python
repro_score = (successful_repros / total_repros) * consistency_factor
negative_score = 1.0 if all_negative_controls_passed else 0.0
cross_identity_score = correct_authorizations / total_identities

confidence = (repro_score * 0.4) +
             (negative_score * 0.35) +
             (cross_identity_score * 0.25)

if confidence >= 0.8:
    recommendation = "promote"
elif confidence >= 0.5:
    recommendation = "investigate"
else:
    recommendation = "dismiss"
```

## Output Format

```json
{
  "validation_id": "V-{finding_id}-{timestamp}",
  "finding_id": "F-001",
  "hypothesis_id": "H-001",
  "validation_results": {
    "reproduction": {
      "total_attempts": 3,
      "successful_attempts": 3,
      "success_rate": 1.0,
      "consistent": true,
      "response_hashes": ["abc123", "abc123", "abc123"],
      "avg_response_time_ms": 45
    },
    "negative_control": {
      "tests_run": 3,
      "tests_passed": 3,
      "passed": true,
      "details": [
        {"type": "unauthenticated", "result": "blocked", "status": 401},
        {"type": "invalid_token", "result": "blocked", "status": 403},
        {"type": "modified_request", "result": "normal", "status": 200}
      ]
    },
    "cross_identity": {
      "identities_tested": 3,
      "violations_found": 1,
      "authorization_enforced": false,
      "details": [
        {"identity": "owner", "access": true, "expected": true, "correct": true},
        {"identity": "other_user", "access": true, "expected": false, "correct": false},
        {"identity": "admin", "access": true, "expected": true, "correct": true}
      ]
    }
  },
  "confidence_score": {
    "repro_score": 1.0,
    "negative_control_score": 1.0,
    "cross_identity_score": 0.67,
    "overall_score": 0.87,
    "recommendation": "promote"
  },
  "decision": "PROMOTE",
  "decision_factors": [
    "3/3 reproduction attempts successful",
    "All negative controls passed",
    "Authorization violation detected for 'other_user' identity",
    "Confidence score 0.87 exceeds promotion threshold"
  ],
  "validated_at": "2024-01-15T11:00:00Z"
}
```

## Integration Points

- **validator-mcp**: Core validation operations
- **http-client-mcp**: Execute HTTP requests
- **auth-tester-mcp**: Identity management and differential testing
- **evidence-mcp**: Record validation evidence
- **world-model-mcp**: Update hypothesis/finding status

## Usage Example

```
User: Validate finding F-001 (IDOR in user profile endpoint)

AI (using vulnerability-validator skill):

### Validation Process for F-001

**Step 1: Reproduction Testing**
- Attempt 1: Status 200, Body hash: abc123, Time: 42ms ✓
- Attempt 2: Status 200, Body hash: abc123, Time: 45ms ✓
- Attempt 3: Status 200, Body hash: abc123, Time: 43ms ✓
- Result: 3/3 successful, 100% consistent

**Step 2: Negative Control**
- Unauthenticated request: 401 Unauthorized ✓
- Invalid token: 403 Forbidden ✓
- Modified request (correct user ID): 200 OK (normal behavior) ✓
- Result: All controls passed

**Step 3: Cross-Identity Verification**
- User A (owner): Access granted ✓ (expected)
- User B (other): Access granted ✗ (should be denied!)
- Admin: Access granted ✓ (expected)
- Result: Authorization violation detected

**Confidence Score: 0.87**
- Reproduction: 1.0 (40%)
- Negative Control: 1.0 (35%)
- Cross-Identity: 0.67 (25%)

**Decision: PROMOTE to Confirmed Finding**

Evidence bundle created: evidence/F-001/validation-{timestamp}/
```

## Best Practices

1. **Always Run Full Validation**: Don't skip negative controls
2. **Multiple Identities**: Test with at least 3 different identity types
3. **Document Everything**: Record all request/response pairs
4. **Time Considerations**: Account for rate limiting between requests
5. **False Positive Awareness**: Investigate scores between 0.5-0.8
6. **Evidence Preservation**: Create evidence bundle regardless of outcome
