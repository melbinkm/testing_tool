# /killswitch - Emergency stop for all testing
# Immediately halts all pending operations and locks state

[command]
name = "killswitch"
description = "EMERGENCY STOP - Immediately halt all testing operations"
version = "1.0.0"

[command.args]
[command.args.reason]
description = "Reason for triggering killswitch"
required = false
default = "Manual killswitch triggered"

[command.args.force]
description = "Force killswitch without confirmation"
required = false
default = "false"

[command.prompt]
template = """
!!! EMERGENCY STOP REQUESTED !!!

**KILLSWITCH PROTOCOL**

This will immediately:
1. Cancel all pending HTTP requests
2. Stop all active scans (nuclei, fuzzer)
3. Abort any in-progress operations
4. Lock the current run from further testing
5. Log the killswitch event to the audit trail

{{#if force}}
FORCE MODE: Proceeding without confirmation
{{else}}
**CONFIRMATION REQUIRED**
Type "CONFIRM STOP" to proceed with emergency shutdown.
{{/if}}

---

**EXECUTING KILLSWITCH:**

1. **Stop Active Operations**
   - Query all MCP servers for active operations
   - Send cancel signals to:
     - http-client-mcp: Cancel pending requests
     - nuclei-mcp: Abort active scans
     - fuzzer-mcp: Stop fuzzing operations
   - Wait for acknowledgment (max 5 seconds)

2. **Log Killswitch Event**
   - Record in action ledger:
     ```json
     {
       "action_id": "killswitch-{timestamp}",
       "tool_name": "killswitch",
       "status": "executed",
       "reason": "{{reason}}",
       "timestamp": "{now}"
     }
     ```

3. **Lock Run State**
   - Update run manifest with ended_at timestamp
   - Set status to "TERMINATED"
   - Prevent further operations on this run

4. **Generate Summary**
   ```
   === KILLSWITCH EXECUTED ===

   Run ID: {run_id}
   Terminated: {timestamp}
   Reason: {{reason}}

   OPERATIONS STOPPED:
   - Pending requests: {count} cancelled
   - Active scans: {count} aborted
   - Queued operations: {count} cleared

   FINAL STATE:
   - Actions recorded: {count}
   - Findings: {count}
   - Evidence bundles: {count}

   Run has been locked. Start a new engagement with /engage.
   ```

5. **Post-Killswitch**
   - Display any errors encountered during shutdown
   - Recommend reviewing evidence before proceeding
   - Suggest contacting operator if automated trigger

**NOTE:** This action is irreversible for the current run.
"""

[command.metadata]
category = "pentest"
risk_level = "low"
requires_scope = false
emergency = true
priority = "immediate"
