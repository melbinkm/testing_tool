# World Model MCP Server

An MCP (Model Context Protocol) server that provides a structured state store for tracking penetration testing engagements. It maintains assets, endpoints, identities, hypotheses, observations, and findings throughout security assessments.

## Overview

The World Model MCP server acts as a persistent knowledge base for autonomous penetration testing agents. It enables:

- **Asset Tracking**: Register discovered domains, IPs, and services
- **Endpoint Mapping**: Track API endpoints and their relationships to assets
- **Identity Management**: Manage test identities for authorization testing
- **Hypothesis Lifecycle**: Create and validate security hypotheses
- **Observation Recording**: Log observations from testing activities
- **Finding Management**: Document and validate security findings

## Prerequisites

- Node.js >= 20.0.0
- SQLite (bundled with better-sqlite3)

## Setup

```bash
# Install dependencies
npm install

# Build the project
npm run build

# Run the server
npm start
```

## Environment Variables

| Variable | Description | Default |
|----------|-------------|---------|
| `DB_PATH` | Path to SQLite database file | `./data/world-model.db` |

The server automatically creates the data directory and database file if they don't exist.

## Available Tools

### wm_add_asset

Register a discovered asset (domain, IP, or service).

**Parameters:**
- `kind` (required): Asset type - `'domain'`, `'ip'`, or `'service'`
- `name` (required): Asset name or identifier
- `tags` (optional): Array of tags for categorization

**Example:**
```json
{
  "kind": "domain",
  "name": "api.example.com",
  "tags": ["production", "external"]
}
```

### wm_add_endpoint

Register a discovered API endpoint.

**Parameters:**
- `method` (required): HTTP method (GET, POST, PUT, DELETE, etc.)
- `path` (required): Endpoint path (e.g., `/api/users`)
- `asset_id` (optional): Asset ID to associate with
- `openapi_ref` (optional): OpenAPI operation reference

**Example:**
```json
{
  "method": "GET",
  "path": "/api/users/{id}",
  "asset_id": "uuid-asset-123",
  "openapi_ref": "#/paths/~1api~1users~1{id}/get"
}
```

### wm_add_identity

Register a test identity for authorization testing.

**Parameters:**
- `label` (required): Identity label (e.g., "admin_user", "guest")
- `roles` (optional): Array of roles assigned to this identity
- `tenant_id` (optional): Tenant ID for multi-tenant testing

**Example:**
```json
{
  "label": "regular_user",
  "roles": ["user", "viewer"],
  "tenant_id": "tenant-abc"
}
```

### wm_add_hypothesis

Create a security hypothesis to test.

**Parameters:**
- `description` (required): Description of the security hypothesis
- `status` (optional): Initial status - `'new'` (default), `'testing'`, `'validated'`, `'rejected'`
- `confidence` (optional): Initial confidence level 0-1 (default: 0.5)

**Example:**
```json
{
  "description": "The /api/users/{id} endpoint may be vulnerable to IDOR",
  "status": "new",
  "confidence": 0.7
}
```

### wm_update_hypothesis

Update the status or confidence of a hypothesis.

**Parameters:**
- `hypothesis_id` (required): The hypothesis ID to update
- `status` (optional): New status
- `confidence` (optional): New confidence level 0-1

**Example:**
```json
{
  "hypothesis_id": "H-1704067200000",
  "status": "validated",
  "confidence": 0.95
}
```

### wm_add_finding

Record a security finding.

**Parameters:**
- `title` (required): Finding title
- `severity` (required): Severity level - `'low'`, `'medium'`, `'high'`, `'critical'`
- `status` (optional): Finding status - `'draft'` (default), `'validated'`, `'rejected'`
- `hypothesis_id` (optional): Related hypothesis ID
- `evidence_refs` (optional): Array of evidence references (e.g., Burp history IDs)
- `confidence` (optional): Confidence level 0-1 (default: 0.5)
- `remediation` (optional): Recommended remediation

**Example:**
```json
{
  "title": "IDOR vulnerability in user profile API",
  "severity": "high",
  "status": "draft",
  "hypothesis_id": "H-1704067200000",
  "evidence_refs": ["burp-history-123", "burp-history-124"],
  "confidence": 0.9,
  "remediation": "Implement proper authorization checks on the /api/users/{id} endpoint"
}
```

### wm_update_finding

Update a security finding.

**Parameters:**
- `finding_id` (required): The finding ID to update
- `status` (optional): New status
- `confidence` (optional): New confidence level 0-1
- `evidence_refs` (optional): Updated evidence references

**Example:**
```json
{
  "finding_id": "F-1704067200000",
  "status": "validated",
  "confidence": 0.98,
  "evidence_refs": ["burp-history-123", "burp-history-124", "burp-history-125"]
}
```

### wm_add_observation

Record an observation from testing.

**Parameters:**
- `action_id` (required): ID of the action that generated this observation
- `type` (required): Type of observation (e.g., "response_anomaly", "auth_bypass")
- `confidence` (optional): Confidence level 0-1 (default: 0.5)
- `data` (optional): Arbitrary observation data object
- `evidence_refs` (optional): Array of evidence references

**Example:**
```json
{
  "action_id": "action-456",
  "type": "auth_bypass",
  "confidence": 0.85,
  "data": {
    "expected_status": 403,
    "actual_status": 200,
    "user_id_accessed": "other-user-123"
  },
  "evidence_refs": ["burp-history-789"]
}
```

### wm_query

Query the world model for entities or statistics.

**Parameters:**
- `entity_type` (required): Type of entity - `'assets'`, `'endpoints'`, `'identities'`, `'hypotheses'`, `'findings'`, `'observations'`, `'stats'`
- `filter` (optional): Filter criteria object

**Examples:**
```json
// Get all assets
{ "entity_type": "assets" }

// Get assets filtered by kind
{ "entity_type": "assets", "filter": { "kind": "domain" } }

// Get endpoints filtered by method
{ "entity_type": "endpoints", "filter": { "method": "POST" } }

// Get hypotheses filtered by status
{ "entity_type": "hypotheses", "filter": { "status": "validated" } }

// Get findings filtered by severity and status
{ "entity_type": "findings", "filter": { "severity": "critical", "status": "draft" } }

// Get aggregate statistics
{ "entity_type": "stats" }
```

## MCP Server Configuration

Add to your MCP client configuration:

```json
{
  "mcpServers": {
    "world-model": {
      "command": "node",
      "args": ["/path/to/world-model-mcp/dist/server.js"],
      "env": {
        "DB_PATH": "/path/to/data/world-model.db"
      }
    }
  }
}
```

## Database Schema

### Tables

| Table | Description |
|-------|-------------|
| `assets` | Discovered assets (domains, IPs, services) |
| `endpoints` | API endpoints with optional asset association |
| `identities` | Test identities for authorization testing |
| `hypotheses` | Security hypotheses with status tracking |
| `observations` | Recorded observations from testing |
| `findings` | Security findings with severity and evidence |

### Indexes

- `idx_endpoints_asset_id` - Fast endpoint lookup by asset
- `idx_findings_status` - Fast finding filtering by status
- `idx_hypotheses_status` - Fast hypothesis filtering by status

### ID Formats

- **Assets, Endpoints, Identities, Observations**: UUID v4
- **Hypotheses**: `H-{timestamp}-{random}` (e.g., `H-1704067200000-abc123`)
- **Findings**: `F-{timestamp}-{random}` (e.g., `F-1704067200000-xyz789`)

## Testing

```bash
# Run all tests
npm test

# Run tests with coverage
npm test -- --coverage

# Type check
npm run typecheck
```

## License

MIT
