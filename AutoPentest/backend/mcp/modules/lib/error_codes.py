"""Structured error code taxonomy for AutoPentest.

Provides typed error codes, error types, and a PentestError exception class
with factory methods for common error scenarios.
"""
from __future__ import annotations

from enum import Enum


class ErrorType(Enum):
    config = "config"
    network = "network"
    tool = "tool"
    prompt = "prompt"
    filesystem = "filesystem"
    validation = "validation"
    billing = "billing"
    scope = "scope"
    unknown = "unknown"


class ErrorCode(Enum):
    CONFIG_NOT_FOUND = "CONFIG_NOT_FOUND"
    CONFIG_VALIDATION_FAILED = "CONFIG_VALIDATION_FAILED"
    AGENT_EXECUTION_FAILED = "AGENT_EXECUTION_FAILED"
    OUTPUT_VALIDATION_FAILED = "OUTPUT_VALIDATION_FAILED"
    API_RATE_LIMITED = "API_RATE_LIMITED"
    SPENDING_CAP_REACHED = "SPENDING_CAP_REACHED"
    GIT_CHECKPOINT_FAILED = "GIT_CHECKPOINT_FAILED"
    GIT_ROLLBACK_FAILED = "GIT_ROLLBACK_FAILED"
    SCOPE_VIOLATION = "SCOPE_VIOLATION"
    BUDGET_EXCEEDED = "BUDGET_EXCEEDED"
    TOOL_EXECUTION_FAILED = "TOOL_EXECUTION_FAILED"
    DELIVERABLE_NOT_FOUND = "DELIVERABLE_NOT_FOUND"


class PentestError(Exception):
    """Structured exception with error code, type, and retry metadata."""

    def __init__(
        self,
        code: ErrorCode,
        message: str,
        retryable: bool = False,
        error_type: ErrorType = ErrorType.unknown,
    ):
        super().__init__(message)
        self.code = code
        self.message = message
        self.retryable = retryable
        self.error_type = error_type

    @classmethod
    def scope_violation(cls, msg: str) -> PentestError:
        return cls(ErrorCode.SCOPE_VIOLATION, msg, False, ErrorType.scope)

    @classmethod
    def budget_exceeded(cls, msg: str) -> PentestError:
        return cls(ErrorCode.BUDGET_EXCEEDED, msg, False, ErrorType.billing)

    @classmethod
    def tool_execution_failed(cls, msg: str, retryable: bool = True) -> PentestError:
        return cls(ErrorCode.TOOL_EXECUTION_FAILED, msg, retryable, ErrorType.tool)

    @classmethod
    def config_not_found(cls, msg: str) -> PentestError:
        return cls(ErrorCode.CONFIG_NOT_FOUND, msg, False, ErrorType.config)
