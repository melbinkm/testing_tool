"""
HTTP Client Factory - Creates fully-featured HttpClient instances with audit logging

Provides a single factory function `create_audit_http_client()` that wires up:
- Scope provider from MCP service
- Exchange logger that delegates to ActivityLogger
- Config from environment variables
- Returns fully-featured HttpClient instance for audited requests
"""

import os
from typing import Optional, Any

from lib.http_client import HttpClient


def create_audit_http_client(mcp_service: Optional[Any] = None) -> HttpClient:
    """
    Create an HttpClient with full audit logging and scope validation.

    Args:
        mcp_service: Optional MCP service instance with:
            - scope_provider: AssessmentScopeProvider for scope validation
            - activity_logger: ActivityLogger for HTTP exchange logging
            - current_assessment_id: Assessment ID for per-assessment scope

    Returns:
        Fully-configured HttpClient instance
    """
    # Read config from environment variables
    config = {
        "engagement_id": os.environ.get("ENGAGEMENT_ID", "default-engagement"),
        "proxy_url": os.environ.get("HTTP_PROXY_URL"),
        "max_rps": float(os.environ.get("MAX_RPS", "10")),
        "max_concurrent": int(os.environ.get("MAX_CONCURRENT", "5")),
        "default_timeout": float(os.environ.get("DEFAULT_TIMEOUT_MS", "30000")),
        "max_total_requests": int(os.environ.get("MAX_TOTAL_REQUESTS", "10000")),
    }

    # Wire up scope provider if available
    scope_provider = None
    assessment_id = None
    if mcp_service:
        scope_provider = getattr(mcp_service, "scope_provider", None)
        assessment_id = getattr(mcp_service, "current_assessment_id", None)

    # Wire up exchange logger if available
    exchange_logger = None
    if mcp_service and getattr(mcp_service, "activity_logger", None) is not None:
        activity_logger = mcp_service.activity_logger

        async def _log_exchange(request, response, correlation_ids, timing):
            """Delegate to ActivityLogger.log_http_exchange()"""
            try:
                await activity_logger.log_http_exchange(
                    url=request.get("url", ""),
                    method=request.get("method", ""),
                    status_code=response.get("status", 0),
                    request_headers=request.get("headers", {}),
                    response_headers=response.get("headers", {}),
                    response_body_preview=(response.get("body") or "")[:2048],
                    correlation_id=correlation_ids.get("request_id", ""),
                    timing_ms=timing.get("duration_ms", 0),
                )
            except Exception:
                pass  # Never let logging break requests

        exchange_logger = _log_exchange

    return HttpClient(
        config=config,
        scope_provider=scope_provider,
        assessment_id=assessment_id,
        exchange_logger=exchange_logger,
    )
