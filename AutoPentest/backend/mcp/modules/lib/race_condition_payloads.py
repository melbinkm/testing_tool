"""Race Condition / Timing Attack Testing.

Provides templates and utilities for testing TOCTOU, double-spend,
and other concurrency vulnerabilities.
"""

from dataclasses import dataclass, field
from typing import List, Dict, Any, Optional


@dataclass
class RaceConditionTemplate:
    """Template for a race condition test scenario."""
    description: str
    concurrent_count: int = 10
    delay_ms: int = 0
    pattern_type: str = "toctou"  # toctou / double_spend / time_of_check


RACE_TEMPLATES: List[RaceConditionTemplate] = [
    RaceConditionTemplate(
        description="Double-spend: simultaneous fund transfers",
        concurrent_count=10,
        delay_ms=0,
        pattern_type="double_spend",
    ),
    RaceConditionTemplate(
        description="TOCTOU: check balance then withdraw concurrently",
        concurrent_count=5,
        delay_ms=0,
        pattern_type="toctou",
    ),
    RaceConditionTemplate(
        description="Coupon reuse: apply same discount code concurrently",
        concurrent_count=10,
        delay_ms=0,
        pattern_type="double_spend",
    ),
    RaceConditionTemplate(
        description="Account creation: duplicate signup with same email",
        concurrent_count=5,
        delay_ms=0,
        pattern_type="toctou",
    ),
    RaceConditionTemplate(
        description="Vote manipulation: submit same vote concurrently",
        concurrent_count=20,
        delay_ms=0,
        pattern_type="double_spend",
    ),
    RaceConditionTemplate(
        description="Reservation race: book same slot concurrently",
        concurrent_count=10,
        delay_ms=0,
        pattern_type="toctou",
    ),
    RaceConditionTemplate(
        description="Password change race: concurrent password updates",
        concurrent_count=5,
        delay_ms=0,
        pattern_type="time_of_check",
    ),
    RaceConditionTemplate(
        description="File upload race: concurrent uploads to same path",
        concurrent_count=5,
        delay_ms=0,
        pattern_type="toctou",
    ),
]


def build_concurrent_requests(
    url: str,
    method: str = "POST",
    headers: Optional[Dict[str, str]] = None,
    body: Optional[str] = None,
    count: int = 10,
) -> List[Dict[str, Any]]:
    """Build a list of identical request dicts for concurrent execution.

    Parameters
    ----------
    url : str
        Target URL.
    method : str
        HTTP method.
    headers : dict, optional
        Request headers.
    body : str, optional
        Request body.
    count : int
        Number of concurrent requests.

    Returns
    -------
    list[dict]
        List of request dictionaries ready for concurrent dispatch.
    """
    request_template = {
        "method": method,
        "url": url,
        "headers": headers or {},
    }
    if body is not None:
        request_template["body"] = body

    import copy
    return [copy.deepcopy(request_template) for _ in range(count)]
