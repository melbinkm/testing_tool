"""Declarative Login Flow YAML Config.

Parses login flow configuration from scope/engagement YAML and provides
dataclasses for structured browser-based authentication sequences.
"""

from dataclasses import dataclass, field
from typing import List, Optional


@dataclass
class LoginStep:
    """A single step in a login flow."""
    action: str  # navigate / fill / click / wait
    selector: Optional[str] = None
    value: Optional[str] = None
    wait_ms: int = 1000


@dataclass
class LoginFlow:
    """Declarative login flow configuration."""
    login_type: str  # form / sso / api / basic
    login_url: str
    steps: List[LoginStep] = field(default_factory=list)
    username_field: Optional[str] = None
    password_field: Optional[str] = None
    success_condition: Optional[str] = None  # url_contains:X / element_present:X / cookie_set:X


def parse_login_flow(config_dict: dict) -> Optional[LoginFlow]:
    """Parse a login flow from a scope/engagement config dictionary.

    Looks for an ``authentication`` or ``login_flow`` key in the config.

    Parameters
    ----------
    config_dict : dict
        The scope configuration dictionary (or a sub-dict).

    Returns
    -------
    LoginFlow or None
        Parsed login flow, or None if no login flow is configured.
    """
    auth = config_dict.get("authentication") or config_dict.get("login_flow")
    if not auth:
        return None

    steps = [LoginStep(**s) for s in auth.get("steps", [])]

    return LoginFlow(
        login_type=auth.get("login_type", "form"),
        login_url=auth.get("login_url", ""),
        steps=steps,
        username_field=auth.get("username_field", "#username"),
        password_field=auth.get("password_field", "#password"),
        success_condition=auth.get("success_condition"),
    )


def substitute_credentials(value: str, username: str, password: str) -> str:
    """Replace ``$username`` and ``$password`` placeholders in *value*."""
    return value.replace("$username", username).replace("$password", password)
