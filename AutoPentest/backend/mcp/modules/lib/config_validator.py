"""Config JSON Schema Validation.

Validates scope configuration dictionaries against a JSON Schema
to catch structural errors before they cause runtime failures.
"""

import jsonschema
from typing import Tuple, List

SCOPE_SCHEMA = {
    "type": "object",
    "properties": {
        "domains": {"type": "array", "items": {"type": "string"}},
        "ip_ranges": {"type": "array", "items": {"type": "string"}},
        "ports": {"type": "array", "items": {"type": "integer"}},
        "credentials": {
            "type": "array",
            "items": {
                "type": "object",
                "properties": {
                    "username": {"type": "string"},
                    "password": {"type": "string"},
                },
            },
        },
        "rules": {
            "type": "array",
            "items": {
                "type": "object",
                "properties": {
                    "type": {"type": "string"},
                    "pattern": {"type": "string"},
                },
            },
        },
    },
    "additionalProperties": True,
}


def validate_scope_config(config_dict: dict) -> Tuple[bool, List[str]]:
    """Validate a scope config dict against the JSON Schema.

    Parameters
    ----------
    config_dict : dict
        The scope configuration dictionary to validate.

    Returns
    -------
    tuple[bool, list[str]]
        (is_valid, errors) where errors is a list of human-readable
        error messages. Empty when is_valid is True.
    """
    errors = []
    try:
        validator = jsonschema.Draft7Validator(SCOPE_SCHEMA)
        for error in validator.iter_errors(config_dict):
            path = ".".join(str(p) for p in error.path) if error.path else "(root)"
            errors.append(f"{path}: {error.message}")
        return len(errors) == 0, errors
    except Exception as e:
        return False, [str(e)]
