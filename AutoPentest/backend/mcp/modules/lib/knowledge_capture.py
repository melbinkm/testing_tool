"""
Knowledge Capture - Safe fire-and-forget helper for auto-capturing tool output.

Follows the same pattern as safe_add_card() / safe_add_recon(): never raises,
returns None if no assessment loaded or content too short, logs warnings.
"""

from __future__ import annotations

import logging
from typing import Any, Dict, List, Optional

logger = logging.getLogger("autopentest-mcp")


async def capture_knowledge(
    mcp_service: Any,
    source_tool: str,
    category: str,
    title: str,
    content: str,
    target: str = "",
    metadata: Optional[Dict[str, Any]] = None,
    tags: Optional[List[str]] = None,
    min_content_length: int = 50,
) -> Optional[str]:
    """Store knowledge safely. Never raises. Returns knowledge_id or None.

    Parameters
    ----------
    mcp_service :
        The MCP service instance. Must have ``current_assessment_id``.
    source_tool : str
        Name of the tool that produced this content.
    category : str
        Knowledge category (e.g. "scan_output", "command_output").
    title : str
        Short title for the knowledge entry.
    content : str
        The content to store.
    target : str
        Target identifier (URL, IP, domain, etc.).
    metadata : dict, optional
        Additional metadata.
    tags : list[str], optional
        Tags for filtering.
    min_content_length : int
        Skip storing if content is shorter than this.

    Returns
    -------
    str or None
        The knowledge entry ID, or None if skipped/failed.
    """
    try:
        # Skip if no assessment loaded
        if mcp_service is None or getattr(mcp_service, 'current_assessment_id', None) is None:
            return None

        # Skip if content too short
        if not content or len(content) < min_content_length:
            return None

        # Get the world model database (handle both import contexts)
        try:
            from lib.world_model_db import get_world_model_db
        except ImportError:
            from world_model_db import get_world_model_db
        db = await get_world_model_db(mcp_service.current_assessment_id)

        # Generate embedding (best-effort)
        embedding = None
        try:
            try:
                from lib.embedder import get_embedder
            except ImportError:
                from embedder import get_embedder
            embedder = get_embedder()
            # For large content, embed just the title + first 512 chars
            embed_text = f"{title}\n{content[:512]}" if len(content) > 512 else f"{title}\n{content}"
            embedding = embedder.embed(embed_text)
        except Exception as exc:
            logger.debug("embedding skipped: %s", exc)

        result = await db.store_knowledge(
            source_tool=source_tool,
            category=category,
            title=title,
            content=content,
            target=target,
            metadata=metadata,
            tags=tags,
            embedding=embedding,
        )

        return result.get("id")

    except Exception as exc:
        logger.warning("capture_knowledge failed (%s/%s): %s", source_tool, category, exc)
        return None
