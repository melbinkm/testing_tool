"""
CORS (Cross-Origin Resource Sharing) Misconfiguration Payloads

Collection of test payloads for detecting CORS policy misconfigurations.
"""

from dataclasses import dataclass
from typing import List


@dataclass
class CORSPayload:
    """CORS test payload."""
    origin_header: str
    technique: str
    description: str
    risk_indicator: str
    severity: str
    with_credentials: bool  # Whether to test with credentials


def get_cors_payloads() -> List[CORSPayload]:
    """Get all CORS misconfiguration test payloads."""

    payloads = []

    # ==== NULL ORIGIN ====

    # null origin (file:// or sandboxed iframe)
    payloads.append(CORSPayload(
        origin_header="null",
        technique="null_origin",
        description="Test null origin reflection",
        risk_indicator="Access-Control-Allow-Origin:.*null",
        severity="high",
        with_credentials=True
    ))

    # ==== WILDCARD MISCONFIGURATIONS ====

    # Wildcard with credentials
    payloads.append(CORSPayload(
        origin_header="http://evil.com",
        technique="wildcard_with_creds",
        description="Test for wildcard (*) with credentials",
        risk_indicator="Access-Control-Allow-Origin:.*\\*.*Access-Control-Allow-Credentials:.*true",
        severity="critical",
        with_credentials=True
    ))

    # ==== ORIGIN REFLECTION ====

    # Arbitrary origin reflection
    payloads.append(CORSPayload(
        origin_header="http://evil.com",
        technique="arbitrary_origin",
        description="Test arbitrary origin reflection",
        risk_indicator="Access-Control-Allow-Origin:.*evil\\.com",
        severity="high",
        with_credentials=True
    ))

    payloads.append(CORSPayload(
        origin_header="https://attacker.com",
        technique="arbitrary_origin",
        description="Test HTTPS arbitrary origin",
        risk_indicator="Access-Control-Allow-Origin:.*attacker\\.com",
        severity="high",
        with_credentials=True
    ))

    # ==== SUBDOMAIN BYPASSES ====

    # Subdomain prefix bypass
    payloads.append(CORSPayload(
        origin_header="http://evil.com.target.com",
        technique="prefix_bypass",
        description="Subdomain prefix bypass",
        risk_indicator="Access-Control-Allow-Origin:.*evil\\.com\\.target\\.com",
        severity="medium",
        with_credentials=True
    ))

    # Subdomain suffix bypass
    payloads.append(CORSPayload(
        origin_header="http://target.com.evil.com",
        technique="suffix_bypass",
        description="Subdomain suffix bypass",
        risk_indicator="Access-Control-Allow-Origin:.*target\\.com\\.evil\\.com",
        severity="medium",
        with_credentials=True
    ))

    # ==== PROTOCOL BYPASSES ====

    # HTTP vs HTTPS mismatch
    payloads.append(CORSPayload(
        origin_header="http://target.com",
        technique="protocol_downgrade",
        description="HTTP origin for HTTPS endpoint",
        risk_indicator="Access-Control-Allow-Origin:.*http://target\\.com",
        severity="medium",
        with_credentials=True
    ))

    # ==== REGEX BYPASSES ====

    # Dot bypass (.target.com matches evil-target.com)
    payloads.append(CORSPayload(
        origin_header="http://evil-target.com",
        technique="regex_bypass",
        description="Regex dot bypass",
        risk_indicator="Access-Control-Allow-Origin:.*evil-target\\.com",
        severity="medium",
        with_credentials=True
    ))

    # ==== LOCALHOST/INTERNAL ORIGINS ====

    # localhost origin
    payloads.append(CORSPayload(
        origin_header="http://localhost",
        technique="localhost_origin",
        description="Localhost origin allowed",
        risk_indicator="Access-Control-Allow-Origin:.*localhost",
        severity="low",
        with_credentials=False
    ))

    # 127.0.0.1 origin
    payloads.append(CORSPayload(
        origin_header="http://127.0.0.1",
        technique="loopback_origin",
        description="Loopback origin allowed",
        risk_indicator="Access-Control-Allow-Origin:.*127\\.0\\.0\\.1",
        severity="low",
        with_credentials=False
    ))

    return payloads


def get_high_severity_payloads() -> List[CORSPayload]:
    """Get high and critical severity payloads."""
    all_payloads = get_cors_payloads()
    return [p for p in all_payloads if p.severity in ('high', 'critical')]


def get_credentialed_payloads() -> List[CORSPayload]:
    """Get payloads that test with credentials."""
    all_payloads = get_cors_payloads()
    return [p for p in all_payloads if p.with_credentials]


def get_bypass_payloads() -> List[CORSPayload]:
    """Get regex/subdomain bypass payloads."""
    all_payloads = get_cors_payloads()
    return [p for p in all_payloads if 'bypass' in p.technique]
