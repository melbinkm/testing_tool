"""
Tool Metadata Registry - Machine-readable tool categorization and metadata.

Provides structured data about tool relationships, categories, risk levels,
and phase mappings for programmatic tool routing and decision support.
"""

from typing import Dict, List, Literal
from lib.phase_orchestrator import NUM_PHASES

PhaseType = Literal["recon", "mapping", "sast", "assessment", "exploitation", "reporting"]
RiskLevel = Literal["safe", "caution", "high_risk"]
BudgetImpact = Literal["low", "medium", "high"]

TOOL_METADATA: Dict[str, Dict] = {
    # Assessment & Documentation (4 tools)
    "load_assessment": {
        "category": "assessment",
        "phase": "recon",
        "risk_level": "safe",
        "budget_impact": "low",
        "dependencies": [],
        "enables": ["All tools require assessment loaded"],
    },
    "update_phase": {
        "category": "assessment",
        "phase": "recon",
        "risk_level": "safe",
        "budget_impact": "low",
        "dependencies": ["load_assessment"],
        "enables": [],
    },
    "orchestration_status": {
        "category": "assessment",
        "phase": "recon",
        "risk_level": "safe",
        "budget_impact": "low",
        "dependencies": ["load_assessment"],
        "enables": [],
        "note": "Check current phase and gate conditions"
    },
    "orchestration_advance": {
        "category": "assessment",
        "phase": "recon",
        "risk_level": "safe",
        "budget_impact": "low",
        "dependencies": ["load_assessment"],
        "enables": [],
        "note": "Transition to next assessment phase"
    },
    "orchestration_auto_run": {
        "category": "assessment",
        "phase": "recon",
        "risk_level": "caution",
        "budget_impact": "low",
        "dependencies": ["load_assessment"],
        "enables": [],
        "note": "Step-based autonomous runbook navigator. Call repeatedly for automated assessment."
    },

    # Cards (4 tools)
    "add_card": {
        "category": "documentation",
        "phase": "assessment",
        "risk_level": "safe",
        "budget_impact": "low",
        "dependencies": ["load_assessment"],
        "enables": ["validate_repro", "evidence_bundle"],
    },
    "list_cards": {
        "category": "documentation",
        "phase": "reporting",
        "risk_level": "safe",
        "budget_impact": "low",
        "dependencies": ["load_assessment"],
        "enables": [],
    },
    "update_card": {
        "category": "documentation",
        "phase": "assessment",
        "risk_level": "safe",
        "budget_impact": "low",
        "dependencies": ["add_card"],
        "enables": [],
    },
    "delete_card": {
        "category": "documentation",
        "phase": "reporting",
        "risk_level": "safe",
        "budget_impact": "low",
        "dependencies": ["add_card"],
        "enables": [],
    },

    # Reconnaissance (5 tools)
    "scan": {
        "category": "reconnaissance",
        "phase": "recon",
        "risk_level": "caution",
        "budget_impact": "medium",
        "dependencies": ["scope_validate_target"],
        "enables": ["tech_detection", "ssl_analysis"],
        "note": "nmap_quick=100 requests, nmap_full=1000+, directory=500-5000"
    },
    "subdomain_enum": {
        "category": "reconnaissance",
        "phase": "recon",
        "risk_level": "safe",
        "budget_impact": "low",
        "dependencies": ["scope_validate_target"],
        "enables": ["scan", "crawler_start"],
        "note": "Passive recon, no target requests"
    },
    "ssl_analysis": {
        "category": "reconnaissance",
        "phase": "recon",
        "risk_level": "safe",
        "budget_impact": "low",
        "dependencies": ["scope_validate_target"],
        "enables": [],
        "note": "Single TLS handshake per target"
    },
    "tech_detection": {
        "category": "reconnaissance",
        "phase": "recon",
        "risk_level": "safe",
        "budget_impact": "low",
        "dependencies": ["scope_validate_target"],
        "enables": ["nuclei_scan_template"],
        "note": "Use results to filter nuclei templates by technology"
    },
    "tool_help": {
        "category": "utility",
        "phase": "recon",
        "risk_level": "safe",
        "budget_impact": "low",
        "dependencies": [],
        "enables": ["execute"],
        "note": "Local container introspection"
    },

    # Execution (1 tool)
    "execute": {
        "category": "execution",
        "phase": "assessment",
        "risk_level": "high_risk",
        "budget_impact": "high",
        "dependencies": ["scope_validate_target"],
        "enables": [],
        "note": "Budget impact varies by command, prefer dedicated tools"
    },

    # Crawler (3 tools)
    "crawler_start": {
        "category": "mapping",
        "phase": "mapping",
        "risk_level": "caution",
        "budget_impact": "medium",
        "dependencies": ["scope_validate_target"],
        "enables": ["coverage_discover", "coverage_init"],
        "note": "50-200 requests depending on site size, auto-populates world model"
    },
    "crawler_status": {
        "category": "mapping",
        "phase": "mapping",
        "risk_level": "safe",
        "budget_impact": "low",
        "dependencies": ["crawler_start"],
        "enables": [],
    },
    "crawler_results": {
        "category": "mapping",
        "phase": "mapping",
        "risk_level": "safe",
        "budget_impact": "low",
        "dependencies": ["crawler_start"],
        "enables": [],
    },

    # Coverage Engine (6 tools)
    "coverage_init": {
        "category": "coverage",
        "phase": "mapping",
        "risk_level": "safe",
        "budget_impact": "low",
        "dependencies": ["wm_add_endpoint"],
        "enables": ["coverage_next", "coverage_mark"],
        "note": "Deterministic matrix: endpoint × vuln_class, local only"
    },
    "coverage_next": {
        "category": "coverage",
        "phase": "assessment",
        "risk_level": "safe",
        "budget_impact": "low",
        "dependencies": ["coverage_init"],
        "enables": ["endpoint_execute_plan", "fuzz_parameter", "coverage_mark"],
        "note": "Returns prioritized untested cells with exact tool invocations"
    },
    "coverage_mark": {
        "category": "coverage",
        "phase": "assessment",
        "risk_level": "safe",
        "budget_impact": "low",
        "dependencies": ["coverage_next"],
        "enables": [],
        "note": "MUST call after executing test from coverage_next"
    },
    "coverage_report": {
        "category": "coverage",
        "phase": "reporting",
        "risk_level": "safe",
        "budget_impact": "low",
        "dependencies": ["coverage_init"],
        "enables": [],
    },
    "coverage_discover": {
        "category": "coverage",
        "phase": "mapping",
        "risk_level": "safe",
        "budget_impact": "low",
        "dependencies": ["crawler_start"],
        "enables": ["coverage_next"],
        "note": "Discovery feedback loop, auto-extends matrix with new endpoints"
    },
    "coverage_refresh": {
        "category": "coverage",
        "phase": "mapping",
        "risk_level": "safe",
        "budget_impact": "low",
        "dependencies": ["coverage_init"],
        "enables": [],
        "note": "Idempotent rebuild, preserves existing test results"
    },

    # Endpoint Analysis (3 tools)
    "endpoint_probe": {
        "category": "testing",
        "phase": "assessment",
        "risk_level": "caution",
        "budget_impact": "low",
        "dependencies": ["scope_validate_target"],
        "enables": ["endpoint_execute_plan"],
        "note": "Gathers context: reflected params, tech indicators, error patterns"
    },
    "endpoint_execute_plan": {
        "category": "testing",
        "phase": "assessment",
        "risk_level": "high_risk",
        "budget_impact": "high",
        "dependencies": ["endpoint_probe"],
        "enables": ["coverage_mark", "validate_repro"],
        "note": "Executes test plan with library or LLM-generated payloads"
    },
    "endpoint_analyze_exchange": {
        "category": "testing",
        "phase": "assessment",
        "risk_level": "safe",
        "budget_impact": "low",
        "dependencies": [],
        "enables": ["endpoint_execute_plan"],
        "note": "Offline analysis of captured request/response"
    },

    # Fuzzing (3 tools)
    "fuzz_parameter": {
        "category": "testing",
        "phase": "assessment",
        "risk_level": "high_risk",
        "budget_impact": "high",
        "dependencies": ["scope_validate_target", "scope_check_budget"],
        "enables": ["validate_repro"],
        "note": "200-500 requests per parameter depending on payload selection"
    },
    "fuzz_endpoint": {
        "category": "testing",
        "phase": "assessment",
        "risk_level": "high_risk",
        "budget_impact": "high",
        "dependencies": ["scope_validate_target", "scope_check_budget"],
        "enables": ["validate_repro"],
        "note": "500+ requests per endpoint, tests all parameters"
    },
    "fuzz_list_payloads": {
        "category": "utility",
        "phase": "assessment",
        "risk_level": "safe",
        "budget_impact": "low",
        "dependencies": [],
        "enables": ["fuzz_parameter"],
        "note": "Lists available payload categories"
    },

    # Nuclei (3 tools)
    "nuclei_scan_single": {
        "category": "scanning",
        "phase": "assessment",
        "risk_level": "high_risk",
        "budget_impact": "medium",
        "dependencies": ["scope_validate_target"],
        "enables": ["validate_repro"],
        "note": "Single template execution"
    },
    "nuclei_scan_template": {
        "category": "scanning",
        "phase": "assessment",
        "risk_level": "high_risk",
        "budget_impact": "high",
        "dependencies": ["scope_validate_target", "scope_check_budget"],
        "enables": ["validate_repro"],
        "note": "100-1000 requests per template set, expensive"
    },
    "nuclei_list_templates": {
        "category": "utility",
        "phase": "assessment",
        "risk_level": "safe",
        "budget_impact": "low",
        "dependencies": [],
        "enables": ["nuclei_scan_template"],
        "note": "Lists available templates for filtering"
    },

    # HTTP (3 tools)
    "http_send": {
        "category": "testing",
        "phase": "assessment",
        "risk_level": "caution",
        "budget_impact": "low",
        "dependencies": ["scope_validate_target", "scope_record_request"],
        "enables": ["validate_repro", "evidence_add_artifact"],
        "note": "Single request with full control"
    },
    "http_send_batch": {
        "category": "testing",
        "phase": "assessment",
        "risk_level": "caution",
        "budget_impact": "medium",
        "dependencies": ["scope_validate_target", "scope_check_budget"],
        "enables": ["validate_repro"],
        "note": "Budget-efficient for parallel requests"
    },
    "http_get_stats": {
        "category": "utility",
        "phase": "reporting",
        "risk_level": "safe",
        "budget_impact": "low",
        "dependencies": [],
        "enables": [],
    },

    # Auth Testing (3 tools)
    "auth_get_identities": {
        "category": "utility",
        "phase": "assessment",
        "risk_level": "safe",
        "budget_impact": "low",
        "dependencies": [],
        "enables": ["auth_diff_test", "crawler_start"],
    },
    "auth_diff_test": {
        "category": "testing",
        "phase": "assessment",
        "risk_level": "high_risk",
        "budget_impact": "medium",
        "dependencies": ["scope_validate_target", "auth_get_identities"],
        "enables": ["sequence_data_ownership", "validate_cross_identity"],
        "note": "Tests IDOR, privilege escalation, authorization bypass"
    },
    "auth_replay_with_identity": {
        "category": "testing",
        "phase": "assessment",
        "risk_level": "caution",
        "budget_impact": "low",
        "dependencies": ["auth_get_identities"],
        "enables": [],
    },

    # Sequences (4 tools)
    "sequence_execute": {
        "category": "testing",
        "phase": "assessment",
        "risk_level": "high_risk",
        "budget_impact": "medium",
        "dependencies": ["http_send"],
        "enables": ["sequence_workflow_bypass"],
        "note": "Multi-step business logic testing"
    },
    "sequence_workflow_bypass": {
        "category": "testing",
        "phase": "assessment",
        "risk_level": "high_risk",
        "budget_impact": "medium",
        "dependencies": ["sequence_execute"],
        "enables": ["validate_repro"],
        "note": "Tests skip_step, replay, reorder, direct_access bypasses"
    },
    "sequence_data_ownership": {
        "category": "testing",
        "phase": "assessment",
        "risk_level": "high_risk",
        "budget_impact": "medium",
        "dependencies": ["auth_diff_test"],
        "enables": ["validate_repro"],
        "note": "Tests ownership across resource IDs"
    },
    "sequence_get_execution_log": {
        "category": "utility",
        "phase": "reporting",
        "risk_level": "safe",
        "budget_impact": "low",
        "dependencies": ["sequence_execute"],
        "enables": [],
    },
    "sequence_credential_reuse": {
        "category": "testing",
        "phase": "assessment",
        "risk_level": "high_risk",
        "budget_impact": "medium",
        "dependencies": ["credentials_add"],
        "enables": ["validate_repro"],
        "note": "Tests credential reuse across endpoints"
    },

    # Validation (4 tools)
    "validate_repro": {
        "category": "validation",
        "phase": "exploitation",
        "risk_level": "caution",
        "budget_impact": "low",
        "dependencies": ["add_card"],
        "enables": ["validate_negative_control", "validate_promote"],
        "note": "Runs finding reproduction 3x minimum"
    },
    "validate_negative_control": {
        "category": "validation",
        "phase": "exploitation",
        "risk_level": "caution",
        "budget_impact": "low",
        "dependencies": ["validate_repro"],
        "enables": ["validate_promote"],
        "note": "Tests benign input to rule out false positive"
    },
    "validate_cross_identity": {
        "category": "validation",
        "phase": "exploitation",
        "risk_level": "caution",
        "budget_impact": "medium",
        "dependencies": ["validate_repro", "auth_get_identities"],
        "enables": ["validate_promote"],
        "note": "Tests finding across multiple user contexts"
    },
    "validate_promote": {
        "category": "validation",
        "phase": "exploitation",
        "risk_level": "safe",
        "budget_impact": "low",
        "dependencies": ["validate_repro"],
        "enables": ["evidence_bundle", "poc_generate"],
        "note": "Promotes validated finding to confirmed status"
    },

    # Evidence (4 tools)
    "evidence_bundle": {
        "category": "evidence",
        "phase": "exploitation",
        "risk_level": "safe",
        "budget_impact": "low",
        "dependencies": ["validate_promote"],
        "enables": ["evidence_add_artifact", "evidence_export"],
    },
    "evidence_add_artifact": {
        "category": "evidence",
        "phase": "exploitation",
        "risk_level": "safe",
        "budget_impact": "low",
        "dependencies": ["evidence_bundle"],
        "enables": ["evidence_export"],
    },
    "evidence_export": {
        "category": "evidence",
        "phase": "reporting",
        "risk_level": "safe",
        "budget_impact": "low",
        "dependencies": ["evidence_bundle"],
        "enables": [],
    },
    "evidence_generate_report": {
        "category": "evidence",
        "phase": "reporting",
        "risk_level": "safe",
        "budget_impact": "low",
        "dependencies": ["evidence_bundle"],
        "enables": [],
        "note": "Only generate when user explicitly requests"
    },

    # World Model (16 tools)
    "wm_add_asset": {
        "category": "world_model",
        "phase": "recon",
        "risk_level": "safe",
        "budget_impact": "low",
        "dependencies": [],
        "enables": ["wm_add_endpoint"],
    },
    "wm_add_endpoint": {
        "category": "world_model",
        "phase": "mapping",
        "risk_level": "safe",
        "budget_impact": "low",
        "dependencies": ["wm_add_asset"],
        "enables": ["coverage_init"],
    },
    "wm_add_hypothesis": {
        "category": "world_model",
        "phase": "mapping",
        "risk_level": "safe",
        "budget_impact": "low",
        "dependencies": [],
        "enables": ["wm_update_hypothesis", "wm_add_observation"],
    },
    "wm_update_hypothesis": {
        "category": "world_model",
        "phase": "assessment",
        "risk_level": "safe",
        "budget_impact": "low",
        "dependencies": ["wm_add_hypothesis"],
        "enables": ["wm_add_finding"],
    },
    "wm_add_finding": {
        "category": "world_model",
        "phase": "assessment",
        "risk_level": "safe",
        "budget_impact": "low",
        "dependencies": ["wm_add_hypothesis"],
        "enables": ["evidence_bundle"],
    },
    "wm_query": {
        "category": "world_model",
        "phase": "reporting",
        "risk_level": "safe",
        "budget_impact": "low",
        "dependencies": [],
        "enables": [],
        "note": "Query any world model table with filters"
    },
    "wm_store": {
        "category": "world_model",
        "phase": "recon",
        "risk_level": "safe",
        "budget_impact": "low",
        "dependencies": [],
        "enables": ["wm_recall"],
        "note": "Auto-chunks large content, full-text indexed"
    },
    "wm_recall": {
        "category": "world_model",
        "phase": "recon",
        "risk_level": "safe",
        "budget_impact": "low",
        "dependencies": [],
        "enables": [],
        "note": "FTS + semantic search across stored knowledge"
    },
    "wm_add_identity": {
        "category": "world_model",
        "phase": "mapping",
        "risk_level": "safe",
        "budget_impact": "low",
        "dependencies": [],
        "enables": ["auth_diff_test", "auth_replay_with_identity"],
    },
    "wm_add_observation": {
        "category": "world_model",
        "phase": "assessment",
        "risk_level": "safe",
        "budget_impact": "low",
        "dependencies": ["wm_add_hypothesis"],
        "enables": [],
        "note": "Record test artifacts as evidence"
    },
    "wm_update_finding": {
        "category": "world_model",
        "phase": "exploitation",
        "risk_level": "safe",
        "budget_impact": "low",
        "dependencies": ["wm_add_finding"],
        "enables": [],
    },
    "wm_add_plan": {
        "category": "world_model",
        "phase": "assessment",
        "risk_level": "safe",
        "budget_impact": "low",
        "dependencies": [],
        "enables": ["wm_update_plan"],
        "note": "Structured testing plans for multi-step attacks"
    },
    "wm_update_plan": {
        "category": "world_model",
        "phase": "assessment",
        "risk_level": "safe",
        "budget_impact": "low",
        "dependencies": ["wm_add_plan"],
        "enables": [],
        "note": "Track step progress and reflection"
    },
    "wm_add_relationship": {
        "category": "world_model",
        "phase": "mapping",
        "risk_level": "safe",
        "budget_impact": "low",
        "dependencies": [],
        "enables": ["wm_get_neighbors", "wm_find_path"],
        "note": "Create typed graph edges between entities"
    },
    "wm_get_neighbors": {
        "category": "world_model",
        "phase": "reporting",
        "risk_level": "safe",
        "budget_impact": "low",
        "dependencies": ["wm_add_relationship"],
        "enables": [],
        "note": "BFS graph traversal to discover connected entities"
    },
    "wm_find_path": {
        "category": "world_model",
        "phase": "reporting",
        "risk_level": "safe",
        "budget_impact": "low",
        "dependencies": ["wm_add_relationship"],
        "enables": [],
        "note": "Shortest path between entities for attack chain analysis"
    },

    # Browser (15 tools)
    "browser_session_create": {
        "category": "browser",
        "phase": "mapping",
        "risk_level": "safe",
        "budget_impact": "low",
        "dependencies": [],
        "enables": ["browser_navigate"],
    },
    "browser_navigate": {
        "category": "browser",
        "phase": "mapping",
        "risk_level": "caution",
        "budget_impact": "low",
        "dependencies": ["scope_validate_target"],
        "enables": ["browser_discover_forms", "browser_test_xss", "browser_screenshot"],
    },
    "browser_discover_forms": {
        "category": "browser",
        "phase": "mapping",
        "risk_level": "safe",
        "budget_impact": "low",
        "dependencies": ["browser_navigate"],
        "enables": ["browser_test_xss"],
        "note": "Identifies all input vectors"
    },
    "browser_test_xss": {
        "category": "browser",
        "phase": "assessment",
        "risk_level": "high_risk",
        "budget_impact": "medium",
        "dependencies": ["browser_navigate"],
        "enables": ["validate_repro"],
        "note": "Automated XSS detection with JS execution verification"
    },
    "browser_screenshot": {
        "category": "browser",
        "phase": "exploitation",
        "risk_level": "safe",
        "budget_impact": "low",
        "dependencies": ["browser_navigate"],
        "enables": ["evidence_add_artifact"],
    },
    "browser_session_close": {
        "category": "browser",
        "phase": "mapping",
        "risk_level": "safe",
        "budget_impact": "low",
        "dependencies": ["browser_session_create"],
        "enables": [],
    },
    "browser_click": {
        "category": "browser",
        "phase": "mapping",
        "risk_level": "caution",
        "budget_impact": "low",
        "dependencies": ["browser_navigate"],
        "enables": [],
    },
    "browser_fill": {
        "category": "browser",
        "phase": "mapping",
        "risk_level": "caution",
        "budget_impact": "low",
        "dependencies": ["browser_navigate"],
        "enables": [],
    },
    "browser_type": {
        "category": "browser",
        "phase": "mapping",
        "risk_level": "caution",
        "budget_impact": "low",
        "dependencies": ["browser_navigate"],
        "enables": [],
    },
    "browser_press_key": {
        "category": "browser",
        "phase": "mapping",
        "risk_level": "caution",
        "budget_impact": "low",
        "dependencies": ["browser_navigate"],
        "enables": [],
    },
    "browser_eval": {
        "category": "browser",
        "phase": "assessment",
        "risk_level": "caution",
        "budget_impact": "low",
        "dependencies": ["browser_navigate"],
        "enables": [],
        "note": "Execute JavaScript in page context"
    },
    "browser_get_state": {
        "category": "browser",
        "phase": "mapping",
        "risk_level": "safe",
        "budget_impact": "low",
        "dependencies": ["browser_navigate"],
        "enables": [],
    },
    "browser_get_elements": {
        "category": "browser",
        "phase": "mapping",
        "risk_level": "safe",
        "budget_impact": "low",
        "dependencies": ["browser_navigate"],
        "enables": [],
    },
    "browser_wait": {
        "category": "browser",
        "phase": "mapping",
        "risk_level": "safe",
        "budget_impact": "low",
        "dependencies": ["browser_navigate"],
        "enables": [],
    },
    "browser_dismiss_popups": {
        "category": "browser",
        "phase": "mapping",
        "risk_level": "safe",
        "budget_impact": "low",
        "dependencies": ["browser_navigate"],
        "enables": [],
        "note": "Auto-dismiss alerts, confirms, and popups"
    },

    # Risk (3 tools)
    "risk_score": {
        "category": "risk",
        "phase": "exploitation",
        "risk_level": "safe",
        "budget_impact": "low",
        "dependencies": ["validate_promote"],
        "enables": [],
        "note": "CVSS v3.1 + business impact + EPSS"
    },
    "risk_assess": {
        "category": "risk",
        "phase": "reporting",
        "risk_level": "safe",
        "budget_impact": "low",
        "dependencies": ["wm_query"],
        "enables": [],
        "note": "Batch risk assessment on all confirmed findings"
    },
    "poc_generate": {
        "category": "risk",
        "phase": "exploitation",
        "risk_level": "safe",
        "budget_impact": "low",
        "dependencies": ["validate_promote"],
        "enables": ["evidence_add_artifact"],
        "note": "Generates curl + Python PoC scripts"
    },

    # Recon Pipeline (3 tools)
    "recon_pipeline_run": {
        "category": "reconnaissance",
        "phase": "recon",
        "risk_level": "caution",
        "budget_impact": "high",
        "dependencies": ["scope_validate_target", "scope_check_budget"],
        "enables": ["coverage_init"],
        "note": "500-2000 requests for 6-stage automated pipeline"
    },
    "recon_pipeline_status": {
        "category": "reconnaissance",
        "phase": "recon",
        "risk_level": "safe",
        "budget_impact": "low",
        "dependencies": ["recon_pipeline_run"],
        "enables": [],
        "note": "Check pipeline progress and stage completion"
    },
    "recon_pipeline_results": {
        "category": "reconnaissance",
        "phase": "recon",
        "risk_level": "safe",
        "budget_impact": "low",
        "dependencies": ["recon_pipeline_run"],
        "enables": [],
        "note": "Get discovery results from completed pipeline"
    },

    # OpenAPI (6 tools)
    "openapi_parse": {
        "category": "mapping",
        "phase": "mapping",
        "risk_level": "safe",
        "budget_impact": "low",
        "dependencies": [],
        "enables": ["openapi_list_endpoints", "coverage_init"],
        "note": "Local parsing, auto-adds endpoints to world model"
    },
    "openapi_list_endpoints": {
        "category": "mapping",
        "phase": "mapping",
        "risk_level": "safe",
        "budget_impact": "low",
        "dependencies": ["openapi_parse"],
        "enables": ["coverage_init"],
    },
    "openapi_list_specs": {
        "category": "mapping",
        "phase": "mapping",
        "risk_level": "safe",
        "budget_impact": "low",
        "dependencies": [],
        "enables": [],
        "note": "List all loaded OpenAPI specifications"
    },
    "openapi_get_endpoint": {
        "category": "mapping",
        "phase": "mapping",
        "risk_level": "safe",
        "budget_impact": "low",
        "dependencies": ["openapi_parse"],
        "enables": [],
        "note": "Get detailed endpoint info (params, schemas, auth)"
    },
    "openapi_get_schemas": {
        "category": "mapping",
        "phase": "mapping",
        "risk_level": "safe",
        "budget_impact": "low",
        "dependencies": ["openapi_parse"],
        "enables": [],
        "note": "Get component schemas from specification"
    },
    "openapi_remove": {
        "category": "mapping",
        "phase": "mapping",
        "risk_level": "safe",
        "budget_impact": "low",
        "dependencies": ["openapi_parse"],
        "enables": [],
        "note": "Remove loaded OpenAPI specification"
    },

    # Scope (6 tools)
    "scope_validate_target": {
        "category": "scope",
        "phase": "recon",
        "risk_level": "safe",
        "budget_impact": "low",
        "dependencies": [],
        "enables": ["ALL_TOOLS_TO_TARGET"],
        "note": "MANDATORY before ANY request to target"
    },
    "scope_get_allowlist": {
        "category": "scope",
        "phase": "recon",
        "risk_level": "safe",
        "budget_impact": "low",
        "dependencies": [],
        "enables": [],
    },
    "scope_get_constraints": {
        "category": "scope",
        "phase": "recon",
        "risk_level": "safe",
        "budget_impact": "low",
        "dependencies": [],
        "enables": [],
    },
    "scope_check_budget": {
        "category": "scope",
        "phase": "recon",
        "risk_level": "safe",
        "budget_impact": "low",
        "dependencies": [],
        "enables": [],
        "note": "Call every 20-30 tools, before expensive operations"
    },
    "scope_record_request": {
        "category": "scope",
        "phase": "assessment",
        "risk_level": "safe",
        "budget_impact": "low",
        "dependencies": [],
        "enables": [],
        "note": "Record request for rate-limit tracking"
    },
    "scope_get_identities": {
        "category": "scope",
        "phase": "assessment",
        "risk_level": "safe",
        "budget_impact": "low",
        "dependencies": [],
        "enables": ["auth_diff_test"],
        "note": "Get configured test identities"
    },

    # Credentials (2 tools)
    "credentials_add": {
        "category": "credentials",
        "phase": "assessment",
        "risk_level": "safe",
        "budget_impact": "low",
        "dependencies": [],
        "enables": ["crawler_start", "http_send"],
        "note": "Auto-generates placeholder for credential substitution"
    },
    "credentials_list": {
        "category": "credentials",
        "phase": "assessment",
        "risk_level": "safe",
        "budget_impact": "low",
        "dependencies": [],
        "enables": [],
        "note": "List stored credentials with placeholders"
    },

    # Recon (2 tools)
    "add_recon_data": {
        "category": "documentation",
        "phase": "recon",
        "risk_level": "safe",
        "budget_impact": "low",
        "dependencies": [],
        "enables": [],
    },
    "list_recon": {
        "category": "documentation",
        "phase": "recon",
        "risk_level": "safe",
        "budget_impact": "low",
        "dependencies": [],
        "enables": [],
        "note": "List all reconnaissance data with filters"
    },

    # Pentest (8 tools) - LLM-in-the-loop manual security testing
    "recon_endpoint": {
        "category": "pentest",
        "phase": "assessment",
        "risk_level": "caution",
        "budget_impact": "low",
        "dependencies": ["scope_validate_target"],
        "enables": ["inject_payload", "inject_batch", "analyze_headers"],
    },
    "get_test_payloads": {
        "category": "pentest",
        "phase": "assessment",
        "risk_level": "safe",
        "budget_impact": "low",
        "dependencies": [],
        "enables": ["inject_batch"],
    },
    "inject_payload": {
        "category": "pentest",
        "phase": "assessment",
        "risk_level": "caution",
        "budget_impact": "low",
        "dependencies": ["recon_endpoint"],
        "enables": ["record_finding"],
    },
    "inject_batch": {
        "category": "pentest",
        "phase": "assessment",
        "risk_level": "caution",
        "budget_impact": "medium",
        "dependencies": ["get_test_payloads"],
        "enables": ["inject_payload", "record_finding"],
    },
    "analyze_headers": {
        "category": "pentest",
        "phase": "assessment",
        "risk_level": "safe",
        "budget_impact": "low",
        "dependencies": ["scope_validate_target"],
        "enables": ["record_finding"],
    },
    "discover_attack_surface": {
        "category": "pentest",
        "phase": "mapping",
        "risk_level": "safe",
        "budget_impact": "low",
        "dependencies": ["load_assessment"],
        "enables": ["recon_endpoint"],
    },
    "record_finding": {
        "category": "pentest",
        "phase": "assessment",
        "risk_level": "safe",
        "budget_impact": "low",
        "dependencies": ["inject_payload"],
        "enables": ["get_test_progress"],
    },
    "get_test_progress": {
        "category": "pentest",
        "phase": "reporting",
        "risk_level": "safe",
        "budget_impact": "low",
        "dependencies": ["load_assessment"],
        "enables": [],
    },

    # SAST (13 tools) - Static Application Security Testing
    "sast_clone_repo": {
        "category": "sast",
        "phase": "mapping",
        "risk_level": "safe",
        "budget_impact": "low",
        "dependencies": ["load_assessment"],
        "enables": ["sast_index_repo", "sast_scan_semgrep", "sast_scan_bandit", "sast_scan_gitleaks", "sast_list_files"],
        "note": "Clone git repo for SAST analysis",
    },
    "sast_index_repo": {
        "category": "sast",
        "phase": "mapping",
        "risk_level": "safe",
        "budget_impact": "low",
        "dependencies": ["sast_clone_repo"],
        "enables": ["wm_recall"],
        "note": "Index source code into RAG for semantic search",
    },
    "sast_scan_semgrep": {
        "category": "sast",
        "phase": "assessment",
        "risk_level": "safe",
        "budget_impact": "low",
        "dependencies": ["sast_clone_repo"],
        "enables": ["sast_record_finding"],
        "note": "Run Semgrep static analyzer",
    },
    "sast_scan_bandit": {
        "category": "sast",
        "phase": "assessment",
        "risk_level": "safe",
        "budget_impact": "low",
        "dependencies": ["sast_clone_repo"],
        "enables": ["sast_record_finding"],
        "note": "Run Bandit (Python-only) security scanner",
    },
    "sast_scan_gitleaks": {
        "category": "sast",
        "phase": "assessment",
        "risk_level": "safe",
        "budget_impact": "low",
        "dependencies": ["sast_clone_repo"],
        "enables": ["sast_record_finding"],
        "note": "Run Gitleaks secret scanner",
    },
    "sast_list_files": {
        "category": "sast",
        "phase": "assessment",
        "risk_level": "safe",
        "budget_impact": "low",
        "dependencies": ["sast_clone_repo"],
        "enables": ["sast_read_file"],
        "note": "List files with priority scoring",
    },
    "sast_read_file": {
        "category": "sast",
        "phase": "assessment",
        "risk_level": "safe",
        "budget_impact": "low",
        "dependencies": ["sast_list_files"],
        "enables": ["sast_record_finding"],
        "note": "Read source file for manual code review",
    },
    "sast_search_code": {
        "category": "sast",
        "phase": "assessment",
        "risk_level": "safe",
        "budget_impact": "low",
        "dependencies": ["sast_clone_repo"],
        "enables": ["sast_read_file"],
        "note": "Regex search across codebase",
    },
    "sast_record_finding": {
        "category": "sast",
        "phase": "assessment",
        "risk_level": "safe",
        "budget_impact": "low",
        "dependencies": ["sast_scan_semgrep", "sast_read_file"],
        "enables": ["sast_correlate"],
        "note": "Record code-level security finding",
    },
    "sast_correlate": {
        "category": "sast",
        "phase": "exploitation",
        "risk_level": "safe",
        "budget_impact": "low",
        "dependencies": ["sast_record_finding"],
        "enables": [],
        "note": "Cross-reference SAST↔DAST findings",
    },
    "sast_get_progress": {
        "category": "sast",
        "phase": "reporting",
        "risk_level": "safe",
        "budget_impact": "low",
        "dependencies": ["load_assessment"],
        "enables": [],
        "note": "Show SAST review progress",
    },
    "sast_get_next_unverified": {
        "category": "sast",
        "phase": "assessment",
        "risk_level": "safe",
        "budget_impact": "low",
        "dependencies": ["sast_scan_semgrep"],
        "enables": ["sast_mark_verified"],
        "note": "Get next unverified SAST finding with function-level code and local file path for dynamic testing",
    },
    "sast_mark_verified": {
        "category": "sast",
        "phase": "assessment",
        "risk_level": "safe",
        "budget_impact": "low",
        "dependencies": ["sast_get_next_unverified"],
        "enables": ["sast_record_finding"],
        "note": "Mark SAST finding as verified after dynamic testing, creates finding if exploitable",
    },
    # Code audit tools
    "code_audit_enumerate": {
        "category": "sast",
        "phase": "assessment",
        "risk_level": "safe",
        "budget_impact": "low",
        "dependencies": ["sast_index_repo"],
        "enables": ["code_audit_get_next"],
        "note": "Parse all functions from indexed source code, create audit queue prioritized by risk",
    },
    "code_audit_get_next": {
        "category": "sast",
        "phase": "assessment",
        "risk_level": "safe",
        "budget_impact": "low",
        "dependencies": ["code_audit_enumerate"],
        "enables": ["code_audit_mark_reviewed"],
        "note": "Get next unreviewed function for LLM security review, returns highest-risk first",
    },
    "code_audit_mark_reviewed": {
        "category": "sast",
        "phase": "assessment",
        "risk_level": "safe",
        "budget_impact": "low",
        "dependencies": ["code_audit_get_next"],
        "enables": ["code_audit_progress"],
        "note": "Record LLM verdict (safe/suspicious/vulnerable), creates finding if vulnerable",
    },
    "code_audit_progress": {
        "category": "sast",
        "phase": "assessment",
        "risk_level": "safe",
        "budget_impact": "low",
        "dependencies": ["code_audit_enumerate"],
        "enables": [],
        "note": "Show audit completion stats (total, reviewed, by_verdict, by_risk_tier)",
    },
}

# Tool categories for quick filtering
TOOL_CATEGORIES = {
    "reconnaissance": ["scan", "subdomain_enum", "ssl_analysis", "tech_detection", "recon_pipeline_run"],
    "mapping": ["crawler_start", "crawler_status", "crawler_results", "openapi_parse", "openapi_list_endpoints", "browser_discover_forms", "browser_navigate"],
    "coverage": ["coverage_init", "coverage_next", "coverage_mark", "coverage_discover", "coverage_refresh", "coverage_report"],
    "testing": ["endpoint_probe", "endpoint_execute_plan", "fuzz_parameter", "fuzz_endpoint", "http_send", "http_send_batch", "auth_diff_test", "sequence_execute", "browser_test_xss"],
    "validation": ["validate_repro", "validate_negative_control", "validate_cross_identity", "validate_promote"],
    "evidence": ["evidence_bundle", "evidence_add_artifact", "evidence_export", "evidence_generate_report"],
    "world_model": ["wm_add_asset", "wm_add_endpoint", "wm_add_hypothesis", "wm_update_hypothesis", "wm_add_finding", "wm_query", "wm_store", "wm_recall"],
    "browser": ["browser_session_create", "browser_navigate", "browser_discover_forms", "browser_test_xss", "browser_screenshot", "browser_eval", "browser_click", "browser_fill"],
    "scope": ["scope_validate_target", "scope_get_allowlist", "scope_get_constraints", "scope_check_budget", "scope_record_request", "scope_get_identities"],
    "utility": ["tool_help", "fuzz_list_payloads", "nuclei_list_templates", "auth_get_identities", "http_get_stats"],
    "sast": ["sast_clone_repo", "sast_index_repo", "sast_scan_semgrep", "sast_scan_bandit", "sast_scan_gitleaks", "sast_list_files", "sast_read_file", "sast_search_code", "sast_record_finding", "sast_correlate", "sast_get_progress", "sast_get_next_unverified", "sast_mark_verified", "code_audit_enumerate", "code_audit_get_next", "code_audit_mark_reviewed", "code_audit_progress"],
}

# Phase-to-tools mapping
PHASE_TOOLS = {
    "recon": ["load_assessment", "scope_get_allowlist", "scope_validate_target", "scan", "subdomain_enum", "ssl_analysis", "tech_detection", "recon_pipeline_run", "add_recon_data", "execute"],
    "mapping": ["openapi_parse", "openapi_list_endpoints", "crawler_start", "browser_navigate", "browser_discover_forms", "coverage_init", "wm_add_endpoint", "wm_add_hypothesis", "coverage_discover", "sast_clone_repo", "sast_index_repo"],
    "assessment": ["coverage_next", "endpoint_probe", "endpoint_execute_plan", "fuzz_parameter", "nuclei_scan_template", "http_send", "auth_diff_test", "sequence_execute", "browser_test_xss", "wm_update_hypothesis", "sast_scan_semgrep", "sast_scan_bandit", "sast_scan_gitleaks", "sast_list_files", "sast_read_file", "sast_search_code", "sast_record_finding", "sast_get_next_unverified", "sast_mark_verified", "code_audit_enumerate", "code_audit_get_next", "code_audit_mark_reviewed", "code_audit_progress"],
    "exploitation": ["validate_repro", "validate_negative_control", "validate_promote", "evidence_bundle", "poc_generate", "sequence_workflow_bypass", "browser_screenshot", "risk_score", "sast_correlate"],
    "reporting": ["evidence_export", "evidence_generate_report", "risk_assess", "coverage_report", "wm_query", "list_cards", "sast_get_progress"],
}

def get_tool_metadata(tool_name: str) -> Dict:
    """Get metadata for a specific tool."""
    return TOOL_METADATA.get(tool_name, {})

def get_tools_by_category(category: str) -> List[str]:
    """Get all tools in a specific category."""
    return TOOL_CATEGORIES.get(category, [])

def get_tools_by_phase(phase: PhaseType) -> List[str]:
    """Get recommended tools for a specific phase."""
    return PHASE_TOOLS.get(phase, [])

def get_tool_dependencies(tool_name: str) -> List[str]:
    """Get prerequisite tools that should be called before this one."""
    metadata = TOOL_METADATA.get(tool_name, {})
    return metadata.get("dependencies", [])

def get_high_risk_tools() -> List[str]:
    """Get all tools marked as high_risk."""
    return [name for name, meta in TOOL_METADATA.items()
            if meta.get("risk_level") == "high_risk"]

def get_high_budget_tools() -> List[str]:
    """Get all tools with high budget impact."""
    return [name for name, meta in TOOL_METADATA.items()
            if meta.get("budget_impact") == "high"]

def get_tools_enabled_by(tool_name: str) -> List[str]:
    """Get tools that become available after calling this tool."""
    metadata = TOOL_METADATA.get(tool_name, {})
    return metadata.get("enables", [])


# ====== Phase-Filtered Tool Visibility ======

CORE_TOOLS: set = {
    # Assessment lifecycle
    "load_assessment", "update_phase", "orchestration_status", "orchestration_advance", "orchestration_auto_run",
    # Scope (needed before any request)
    "scope_validate_target", "scope_get_allowlist", "scope_get_constraints", "scope_check_budget",
    # World model read (introspection anytime)
    "wm_query", "wm_store", "wm_recall",
    # Cards (documentation anytime)
    "add_card", "list_cards",
    # Budget monitoring
    "http_get_stats",
    # Credentials (needed once discovered)
    "credentials_add", "credentials_list",
}

PHASE_TOOL_SETS: Dict[int, set] = {
    1: {  # Reconnaissance (core + 15 = ~32 tools)
        "scan", "subdomain_enum", "ssl_analysis", "tech_detection", "tool_help", "execute",
        "recon_pipeline_run", "recon_pipeline_status", "recon_pipeline_results",
        "add_recon_data", "list_recon",
        "wm_add_asset",
        "scope_record_request", "scope_get_identities",
        "recon_endpoint",
    },
    2: {  # Mapping & Enumeration (core + 33 = ~49 tools)
        "crawler_start", "crawler_status", "crawler_results",
        "openapi_parse", "openapi_list_specs", "openapi_list_endpoints",
        "openapi_get_endpoint", "openapi_get_schemas", "openapi_remove",
        "browser_session_create", "browser_session_close", "browser_navigate",
        "browser_discover_forms", "browser_get_state", "browser_click", "browser_fill",
        "browser_type", "browser_press_key", "browser_get_elements", "browser_wait",
        "browser_dismiss_popups",
        "wm_add_endpoint", "wm_add_identity", "wm_add_hypothesis", "wm_add_relationship",
        "coverage_init", "coverage_discover", "coverage_refresh",
        "scope_record_request", "scope_get_identities",
        "discover_attack_surface", "recon_endpoint", "analyze_headers",
    },
    3: {  # SAST Code Review (core + 17 = ~33 tools)
        "sast_clone_repo", "sast_index_repo",
        "sast_scan_semgrep", "sast_scan_bandit", "sast_scan_gitleaks",
        "sast_list_files", "sast_read_file", "sast_search_code",
        "sast_get_next_unverified", "sast_mark_verified",
        "sast_record_finding", "sast_get_progress",
        "code_audit_enumerate", "code_audit_get_next",
        "code_audit_mark_reviewed", "code_audit_progress",
        "wm_store", "wm_recall",
    },
    4: {  # Vulnerability Assessment (core + 42 = ~58 tools)
        # PRIMARY: LLM-in-the-loop pentest workflow
        "recon_endpoint", "get_test_payloads", "inject_payload", "inject_batch",
        "analyze_headers", "discover_attack_surface", "record_finding", "get_test_progress",
        # SECONDARY: Automated testing engine
        "testing_build_matrix", "testing_next", "testing_should_continue",
        "testing_record_auth_change", "testing_status",
        "checklist_get", "checklist_analyze_exchange",
        # Coverage tracking
        "coverage_next", "coverage_mark", "coverage_report",
        # Endpoint analysis (automated)
        "endpoint_probe", "endpoint_execute_plan", "endpoint_analyze_exchange",
        # Raw HTTP (manual crafting)
        "http_send", "http_send_batch",
        # Auth testing
        "auth_get_identities", "auth_diff_test", "auth_replay_with_identity",
        # Business logic sequences
        "sequence_execute", "sequence_workflow_bypass", "sequence_data_ownership", "sequence_credential_reuse",
        # Nuclei scanning
        "nuclei_scan_single", "nuclei_scan_template", "nuclei_list_templates",
        # Browser testing
        "browser_test_xss", "browser_eval", "browser_navigate", "browser_screenshot",
        # World model writes
        "wm_update_hypothesis", "wm_add_finding", "wm_add_observation", "wm_add_plan", "wm_update_plan",
        # Scope
        "scope_record_request", "scope_get_identities",
    },
    5: {  # Exploitation (core + 20 = ~36 tools)
        "validate_repro", "validate_negative_control", "validate_cross_identity", "validate_promote",
        "evidence_bundle", "evidence_add_artifact",
        "risk_score", "poc_generate",
        "wm_update_finding", "wm_add_observation",
        "update_card", "delete_card",
        "browser_navigate", "browser_screenshot",
        "http_send",
        "inject_payload", "record_finding", "get_test_progress",
        # SAST: Cross-reference findings
        "sast_correlate",
    },
    6: {  # Reporting (core + 14 = ~31 tools)
        "evidence_export", "evidence_generate_report", "evidence_bundle", "evidence_add_artifact",
        "risk_assess", "risk_score", "poc_generate",
        "coverage_report",
        "wm_get_neighbors", "wm_find_path",
        "update_card", "delete_card",
        "get_test_progress",
        "sequence_get_execution_log",
        # SAST: Review progress
        "sast_get_progress",
    },
}

def get_visible_tools_for_phase(phase: int) -> set:
    """Return tool names that should be visible for a given phase.

    CORE_TOOLS + phase-specific tools. Phase 0 or invalid = all tools.

    Parameters
    ----------
    phase : int
        Phase number (1-6). 0 or invalid returns all tools.

    Returns
    -------
    set
        Set of tool names visible in this phase.
    """
    if phase < 1 or phase > NUM_PHASES:
        return set(TOOL_METADATA.keys())
    return CORE_TOOLS | PHASE_TOOL_SETS.get(phase, set())
