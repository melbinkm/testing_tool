"""
Vulnerability Test Checklist Registry

Defines 42+ vulnerability test specifications as a static registry.
Each specification includes metadata, applicability predicates, detection patterns,
and tool mappings for comprehensive security testing.
"""

from dataclasses import dataclass, field
from typing import List, Dict, Callable, Tuple, Any, Optional
import re


@dataclass
class VulnTestSpec:
    """Specification for a single vulnerability test category."""

    id: str                          # e.g., "csrf", "cors_misconfig"
    name: str                        # Human-readable name
    category: str                    # injection|auth|config|client_side|api|business_logic|info_leak
    description: str                 # What this test checks
    applicable_when: Callable[[Dict], bool]  # Predicate: endpoint metadata -> bool
    detection_patterns: List[str]    # Regex patterns for response classification
    tool_name: str                   # MCP tool to invoke
    base_args: Dict[str, Any]        # Default tool arguments
    severity_range: Tuple[str, str]  # (min_severity, max_severity)
    parameter_bound: bool            # Whether test runs per-parameter
    requires_auth: bool              # Needs authenticated session
    owasp_category: str              # e.g., "A03:2021-Injection"
    detection_method: str = "pattern"  # pattern|behavioral (must come after non-defaults)
    references: List[str] = field(default_factory=list)  # Documentation links

    def to_dict(self) -> Dict[str, Any]:
        """Convert to dictionary for JSON serialization."""
        return {
            'id': self.id,
            'name': self.name,
            'category': self.category,
            'description': self.description,
            'detection_method': self.detection_method,
            'tool_name': self.tool_name,
            'base_args': self.base_args,
            'severity_range': self.severity_range,
            'parameter_bound': self.parameter_bound,
            'requires_auth': self.requires_auth,
            'owasp_category': self.owasp_category,
            'references': self.references
        }


class VulnChecklist:
    """
    Central registry of all vulnerability test specifications.
    Provides filtering, querying, and backward-compatible tool mapping.
    """

    @staticmethod
    def _normalize_endpoint_for_predicates(row: Dict) -> Dict:
        """Transform DB endpoint row to format expected by VulnChecklist predicates."""
        params = row.get('parameters') or row.get('ep_parameters') or []
        # If params is a dict (JSONB), convert to list of parameter dicts
        if isinstance(params, dict):
            params = [{'name': k, 'type': 'string', 'in': 'query'} for k in params.keys()]
        return {
            'method': row.get('method', 'GET'),
            'parameters': params,
            'content_type': row.get('content_type', ''),
            'response_type': row.get('response_type', ''),
            'requires_auth': row.get('requires_auth', row.get('auth_required', False)),
        }

    # Applicability predicates
    @staticmethod
    def _has_parameters(endpoint: Dict) -> bool:
        """Check if endpoint has any parameters."""
        params = endpoint.get('parameters', [])
        return len(params) > 0

    @staticmethod
    def _is_state_changing(endpoint: Dict) -> bool:
        """Check if endpoint uses state-changing HTTP methods."""
        method = endpoint.get('method', 'GET').upper()
        return method in ('POST', 'PUT', 'PATCH', 'DELETE')

    @staticmethod
    def _has_auth(endpoint: Dict) -> bool:
        """Check if endpoint requires authentication."""
        return endpoint.get('requires_auth', False)

    @staticmethod
    def _is_html_response(endpoint: Dict) -> bool:
        """Check if endpoint returns HTML."""
        content_type = endpoint.get('content_type', '').lower()
        return 'html' in content_type or endpoint.get('response_type') == 'html'

    @staticmethod
    def _is_json_response(endpoint: Dict) -> bool:
        """Check if endpoint returns JSON."""
        content_type = endpoint.get('content_type', '').lower()
        return 'json' in content_type or endpoint.get('response_type') == 'json'

    @staticmethod
    def _is_xml_response(endpoint: Dict) -> bool:
        """Check if endpoint accepts/returns XML."""
        content_type = endpoint.get('content_type', '').lower()
        return 'xml' in content_type

    @staticmethod
    def _always_applicable(endpoint: Dict) -> bool:
        """Always applicable regardless of endpoint characteristics."""
        return True

    @staticmethod
    def _has_file_upload(endpoint: Dict) -> bool:
        """Check if endpoint handles file uploads."""
        params = endpoint.get('parameters', [])
        return any(p.get('type') == 'file' for p in params)

    @staticmethod
    def _has_id_params(endpoint: Dict) -> bool:
        """Check if endpoint has ID-like parameters."""
        params = endpoint.get('parameters', [])
        id_names = {'id', 'user_id', 'account_id', 'order_id', 'resource_id'}
        return any(p.get('name', '').lower() in id_names or
                  p.get('name', '').lower().endswith('_id')
                  for p in params)

    @staticmethod
    def _build_specs() -> List[VulnTestSpec]:
        """Build the complete list of vulnerability test specifications."""

        specs = []

        # ===== INJECTION CATEGORY =====

        # SQL Injection - Error-based
        specs.append(VulnTestSpec(
            id='sqli_error',
            name='SQL Injection (Error-Based)',
            category='injection',
            description='Tests for SQL injection via database error messages',
            applicable_when=VulnChecklist._has_parameters,
            detection_patterns=[
                r'SQL syntax.*MySQL',
                r'Warning.*mysql_',
                r'valid MySQL result',
                r'MySqlClient\.',
                r'PostgreSQL.*ERROR',
                r'Warning.*\Wpg_',
                r'valid PostgreSQL result',
                r'Npgsql\.',
                r'Driver.*SQL.*Server',
                r'OLE DB.*SQL Server',
                r'(\W|\A)SQL Server.*Driver',
                r'Warning.*mssql_',
                r'(\W|\A)SQL Server.*[0-9a-fA-F]{8}',
                r'SQLite/JDBCDriver',
                r'SQLite.Exception',
                r'System.Data.SQLite.SQLiteException',
                r'Warning.*sqlite_',
                r'Oracle error',
                r'Oracle.*Driver',
                r'Warning.*\Woci_',
                r'Warning.*\Wora_',
            ],
            tool_name='fuzz_parameter',
            base_args={'vuln_class': 'sqli', 'technique': 'error'},
            severity_range=('high', 'critical'),
            parameter_bound=True,
            requires_auth=False,
            owasp_category='A03:2021-Injection',
            references=[
                'https://owasp.org/www-community/attacks/SQL_Injection',
                'https://portswigger.net/web-security/sql-injection'
            ]
        ))

        # SQL Injection - Boolean-based blind
        specs.append(VulnTestSpec(
            id='sqli_blind_boolean',
            name='SQL Injection (Boolean Blind)',
            category='injection',
            description='Tests for blind SQL injection via boolean conditions',
            applicable_when=VulnChecklist._has_parameters,
            detection_patterns=[
                r'TRUE.*FALSE.*differential',
                r'boolean.*condition.*exploitable',
            ],
            tool_name='fuzz_parameter',
            base_args={'vuln_class': 'sqli', 'technique': 'boolean'},
            severity_range=('high', 'critical'),
            parameter_bound=True,
            requires_auth=False,
            owasp_category='A03:2021-Injection',
            references=['https://owasp.org/www-community/attacks/Blind_SQL_Injection']
        ))

        # SQL Injection - Time-based blind
        specs.append(VulnTestSpec(
            id='sqli_blind_time',
            name='SQL Injection (Time-Based Blind)',
            category='injection',
            description='Tests for blind SQL injection via time delays',
            applicable_when=VulnChecklist._has_parameters,
            detection_patterns=[
                r'time.*delay.*detected',
                r'sleep.*executed',
            ],
            tool_name='fuzz_parameter',
            base_args={'vuln_class': 'sqli', 'technique': 'time'},
            severity_range=('high', 'critical'),
            parameter_bound=True,
            requires_auth=False,
            owasp_category='A03:2021-Injection',
            references=['https://owasp.org/www-community/attacks/Blind_SQL_Injection']
        ))

        # SQL Injection - Union-based
        specs.append(VulnTestSpec(
            id='sqli_union',
            name='SQL Injection (Union-Based)',
            category='injection',
            description='Tests for SQL injection via UNION queries',
            applicable_when=VulnChecklist._has_parameters,
            detection_patterns=[
                r'UNION.*SELECT.*successful',
                r'column.*count.*match',
            ],
            tool_name='fuzz_parameter',
            base_args={'vuln_class': 'sqli', 'technique': 'union'},
            severity_range=('high', 'critical'),
            parameter_bound=True,
            requires_auth=False,
            owasp_category='A03:2021-Injection',
            references=['https://portswigger.net/web-security/sql-injection/union-attacks']
        ))

        # XSS - Reflected
        specs.append(VulnTestSpec(
            id='xss_reflected',
            name='Cross-Site Scripting (Reflected)',
            category='injection',
            description='Tests for reflected XSS vulnerabilities',
            applicable_when=lambda e: VulnChecklist._has_parameters(e) and VulnChecklist._is_html_response(e),
            detection_patterns=[
                r'<script[^>]*>.*alert\(',
                r'onerror\s*=',
                r'javascript:',
                r'<img[^>]*src[^>]*onerror',
            ],
            tool_name='fuzz_parameter',
            base_args={'vuln_class': 'xss', 'technique': 'reflected'},
            severity_range=('medium', 'high'),
            parameter_bound=True,
            requires_auth=False,
            owasp_category='A03:2021-Injection',
            references=['https://owasp.org/www-community/attacks/xss/']
        ))

        # XSS - Stored
        specs.append(VulnTestSpec(
            id='xss_stored',
            name='Cross-Site Scripting (Stored)',
            category='injection',
            description='Tests for stored/persistent XSS vulnerabilities',
            applicable_when=lambda e: VulnChecklist._is_state_changing(e) and VulnChecklist._is_html_response(e),
            detection_patterns=[
                r'stored.*xss.*detected',
                r'persistent.*script.*found',
            ],
            tool_name='fuzz_parameter',
            base_args={'vuln_class': 'xss', 'technique': 'stored'},
            severity_range=('high', 'critical'),
            parameter_bound=True,
            requires_auth=False,
            owasp_category='A03:2021-Injection',
            references=['https://owasp.org/www-community/attacks/xss/#stored-xss-attacks']
        ))

        # XSS - DOM-based
        specs.append(VulnTestSpec(
            id='xss_dom',
            name='Cross-Site Scripting (DOM-Based)',
            category='injection',
            description='Tests for DOM-based XSS vulnerabilities',
            applicable_when=VulnChecklist._is_html_response,
            detection_patterns=[
                r'document\.location',
                r'innerHTML\s*=',
                r'eval\(',
                r'location\.hash',
            ],
            tool_name='browser_test_xss',
            base_args={'xss_type': 'dom'},
            severity_range=('medium', 'high'),
            parameter_bound=True,
            requires_auth=False,
            owasp_category='A03:2021-Injection',
            references=['https://owasp.org/www-community/attacks/DOM_Based_XSS']
        ))

        # Server-Side Template Injection
        specs.append(VulnTestSpec(
            id='ssti',
            name='Server-Side Template Injection',
            category='injection',
            description='Tests for template injection vulnerabilities',
            applicable_when=VulnChecklist._has_parameters,
            detection_patterns=[
                r'49|7\*7',  # {{7*7}} = 49
                r'template.*error',
                r'Jinja2.*Exception',
                r'TemplateSyntaxError',
            ],
            tool_name='fuzz_parameter',
            base_args={'vuln_class': 'ssti'},
            severity_range=('high', 'critical'),
            parameter_bound=True,
            requires_auth=False,
            owasp_category='A03:2021-Injection',
            references=['https://portswigger.net/web-security/server-side-template-injection']
        ))

        # Server-Side Request Forgery
        specs.append(VulnTestSpec(
            id='ssrf',
            name='Server-Side Request Forgery',
            category='injection',
            description='Tests for SSRF vulnerabilities',
            applicable_when=VulnChecklist._has_parameters,
            detection_patterns=[
                r'169\.254\.169\.254',  # AWS metadata
                r'metadata\.google\.internal',
                r'localhost.*response',
                r'internal.*service.*accessed',
            ],
            tool_name='fuzz_parameter',
            base_args={'vuln_class': 'ssrf'},
            severity_range=('high', 'critical'),
            parameter_bound=True,
            requires_auth=False,
            owasp_category='A10:2021-Server-Side Request Forgery',
            references=['https://owasp.org/www-community/attacks/Server_Side_Request_Forgery']
        ))

        # Path Traversal
        specs.append(VulnTestSpec(
            id='path_traversal',
            name='Path Traversal',
            category='injection',
            description='Tests for directory traversal vulnerabilities',
            applicable_when=VulnChecklist._has_parameters,
            detection_patterns=[
                r'root:.*:0:0:',  # /etc/passwd
                r'\[boot loader\]',  # boot.ini
                r'<DIR>',  # Directory listing
            ],
            tool_name='fuzz_parameter',
            base_args={'vuln_class': 'path_traversal'},
            severity_range=('medium', 'high'),
            parameter_bound=True,
            requires_auth=False,
            owasp_category='A01:2021-Broken Access Control',
            references=['https://owasp.org/www-community/attacks/Path_Traversal']
        ))

        # Command Injection
        specs.append(VulnTestSpec(
            id='command_injection',
            name='OS Command Injection',
            category='injection',
            description='Tests for OS command injection vulnerabilities',
            applicable_when=VulnChecklist._has_parameters,
            detection_patterns=[
                r'uid=\d+.*gid=\d+',  # Unix id command
                r'root:.*:0:0:',  # Command result showing /etc/passwd
                r'PING.*TTL',
                r'Directory of',  # Windows dir
                r'Volume Serial Number',
            ],
            tool_name='fuzz_parameter',
            base_args={'vuln_class': 'command_injection'},
            severity_range=('critical', 'critical'),
            parameter_bound=True,
            requires_auth=False,
            owasp_category='A03:2021-Injection',
            references=['https://owasp.org/www-community/attacks/Command_Injection']
        ))

        # LDAP Injection
        specs.append(VulnTestSpec(
            id='ldap_injection',
            name='LDAP Injection',
            category='injection',
            description='Tests for LDAP injection vulnerabilities',
            applicable_when=VulnChecklist._has_parameters,
            detection_patterns=[
                r'javax\.naming\.directory',
                r'LDAP.*error',
                r'Invalid DN syntax',
            ],
            tool_name='fuzz_parameter',
            base_args={'vuln_class': 'ldap_injection'},
            severity_range=('medium', 'high'),
            parameter_bound=True,
            requires_auth=False,
            owasp_category='A03:2021-Injection',
            references=['https://owasp.org/www-community/attacks/LDAP_Injection']
        ))

        # XML/XXE Injection
        specs.append(VulnTestSpec(
            id='xml_injection',
            name='XML External Entity (XXE) Injection',
            category='injection',
            description='Tests for XXE and XML injection vulnerabilities',
            applicable_when=VulnChecklist._is_xml_response,
            detection_patterns=[
                r'<!ENTITY',
                r'<!DOCTYPE',
                r'SYSTEM.*file://',
                r'root:.*:0:0:',  # File read via XXE
            ],
            tool_name='fuzz_parameter',
            base_args={'vuln_class': 'xml_injection'},
            severity_range=('high', 'critical'),
            parameter_bound=True,
            requires_auth=False,
            owasp_category='A03:2021-Injection',
            references=['https://owasp.org/www-community/vulnerabilities/XML_External_Entity_(XXE)_Processing']
        ))

        # Header Injection (CRLF)
        specs.append(VulnTestSpec(
            id='header_injection',
            name='HTTP Header Injection',
            category='injection',
            description='Tests for CRLF injection in HTTP headers',
            applicable_when=VulnChecklist._has_parameters,
            detection_patterns=[
                r'Set-Cookie:.*injected',
                r'\r\n.*X-Injected-Header',
            ],
            tool_name='fuzz_parameter',
            base_args={'vuln_class': 'header_injection'},
            severity_range=('medium', 'high'),
            parameter_bound=True,
            requires_auth=False,
            owasp_category='A03:2021-Injection',
            references=['https://owasp.org/www-community/vulnerabilities/CRLF_Injection']
        ))

        # NoSQL Injection
        specs.append(VulnTestSpec(
            id='nosql_injection',
            name='NoSQL Injection',
            category='injection',
            description='Tests for NoSQL injection (MongoDB, etc.)',
            applicable_when=lambda e: VulnChecklist._has_parameters(e) and VulnChecklist._is_json_response(e),
            detection_patterns=[
                r'MongoError',
                r'\$where.*function',
                r'MongoDB.*error',
            ],
            tool_name='fuzz_parameter',
            base_args={'vuln_class': 'nosql_injection'},
            severity_range=('high', 'critical'),
            parameter_bound=True,
            requires_auth=False,
            owasp_category='A03:2021-Injection',
            references=['https://owasp.org/www-project-web-security-testing-guide/latest/4-Web_Application_Security_Testing/07-Input_Validation_Testing/05.6-Testing_for_NoSQL_Injection']
        ))

        # ===== AUTHENTICATION & AUTHORIZATION CATEGORY =====

        # Insecure Direct Object Reference
        specs.append(VulnTestSpec(
            id='idor',
            name='Insecure Direct Object Reference',
            category='auth',
            description='Tests for IDOR vulnerabilities',
            applicable_when=VulnChecklist._has_id_params,
            detection_patterns=[
                r'unauthorized.*access',
                r'different.*user.*data',
            ],
            detection_method='behavioral',
            tool_name='validate_cross_identity',
            base_args={},
            severity_range=('medium', 'high'),
            parameter_bound=False,
            requires_auth=True,
            owasp_category='A01:2021-Broken Access Control',
            references=['https://owasp.org/www-project-web-security-testing-guide/latest/4-Web_Application_Security_Testing/05-Authorization_Testing/04-Testing_for_Insecure_Direct_Object_References']
        ))

        # Authentication Bypass
        specs.append(VulnTestSpec(
            id='auth_bypass',
            name='Authentication Bypass',
            category='auth',
            description='Tests for authentication bypass vulnerabilities',
            applicable_when=VulnChecklist._has_auth,
            detection_patterns=[
                r'auth.*bypass',
                r'unauthenticated.*access',
            ],
            detection_method='behavioral',
            tool_name='auth_diff_test',
            base_args={},
            severity_range=('critical', 'critical'),
            parameter_bound=False,
            requires_auth=False,
            owasp_category='A07:2021-Identification and Authentication Failures',
            references=['https://owasp.org/www-project-web-security-testing-guide/latest/4-Web_Application_Security_Testing/04-Authentication_Testing/']
        ))

        # Broken Authentication (Default/Weak Credentials)
        specs.append(VulnTestSpec(
            id='broken_auth',
            name='Broken Authentication',
            category='auth',
            description='Tests for default credentials and weak authentication',
            applicable_when=VulnChecklist._always_applicable,
            detection_patterns=[
                r'default.*credential',
                r'weak.*password',
            ],
            detection_method='behavioral',
            tool_name='sequence_credential_reuse',
            base_args={},
            severity_range=('high', 'critical'),
            parameter_bound=False,
            requires_auth=False,
            owasp_category='A07:2021-Identification and Authentication Failures',
            references=['https://owasp.org/www-project-top-ten/2017/A2_2017-Broken_Authentication']
        ))

        # Session Fixation
        specs.append(VulnTestSpec(
            id='session_fixation',
            name='Session Fixation',
            category='auth',
            description='Tests for session fixation vulnerabilities',
            applicable_when=VulnChecklist._always_applicable,
            detection_patterns=[
                r'session.*not.*regenerated',
                r'fixation.*detected',
            ],
            detection_method='behavioral',
            tool_name='auth_diff_test',
            base_args={'test_type': 'session_fixation'},
            severity_range=('medium', 'high'),
            parameter_bound=False,
            requires_auth=False,
            owasp_category='A07:2021-Identification and Authentication Failures',
            references=['https://owasp.org/www-community/attacks/Session_fixation']
        ))

        # Session Expiry
        specs.append(VulnTestSpec(
            id='session_expiry',
            name='Insufficient Session Expiration',
            category='auth',
            description='Tests for weak session timeout policies',
            applicable_when=VulnChecklist._has_auth,
            detection_patterns=[
                r'session.*expired.*too.*long',
                r'timeout.*insufficient',
            ],
            detection_method='behavioral',
            tool_name='auth_diff_test',
            base_args={'test_type': 'session_expiry'},
            severity_range=('low', 'medium'),
            parameter_bound=False,
            requires_auth=True,
            owasp_category='A07:2021-Identification and Authentication Failures',
            references=['https://owasp.org/www-project-web-security-testing-guide/latest/4-Web_Application_Security_Testing/06-Session_Management_Testing/']
        ))

        # JWT Manipulation
        specs.append(VulnTestSpec(
            id='jwt_manipulation',
            name='JWT Token Manipulation',
            category='auth',
            description='Tests for JWT vulnerabilities (alg:none, weak signing, etc.)',
            applicable_when=VulnChecklist._always_applicable,
            detection_patterns=[
                r'alg.*none.*accepted',
                r'signature.*not.*verified',
                r'jwt.*manipulated',
            ],
            tool_name='fuzz_parameter',
            base_args={'vuln_class': 'jwt_manipulation', 'target': 'authorization_header'},
            severity_range=('high', 'critical'),
            parameter_bound=False,
            requires_auth=True,
            owasp_category='A07:2021-Identification and Authentication Failures',
            references=['https://owasp.org/www-chapter-vancouver/assets/presentations/2020-01_Attacking_and_Securing_JWT.pdf']
        ))

        # Privilege Escalation
        specs.append(VulnTestSpec(
            id='privilege_escalation',
            name='Privilege Escalation',
            category='auth',
            description='Tests for vertical privilege escalation',
            applicable_when=VulnChecklist._has_auth,
            detection_patterns=[
                r'privilege.*escalation',
                r'admin.*access.*low.*privilege',
            ],
            detection_method='behavioral',
            tool_name='validate_cross_identity',
            base_args={'test_type': 'privilege_escalation'},
            severity_range=('high', 'critical'),
            parameter_bound=False,
            requires_auth=True,
            owasp_category='A01:2021-Broken Access Control',
            references=['https://owasp.org/www-project-web-security-testing-guide/latest/4-Web_Application_Security_Testing/05-Authorization_Testing/']
        ))

        # Username Enumeration
        specs.append(VulnTestSpec(
            id='username_enumeration',
            name='Username Enumeration',
            category='auth',
            description='Tests for username enumeration via timing/error differences',
            applicable_when=VulnChecklist._always_applicable,
            detection_patterns=[
                r'user.*exists',
                r'invalid.*username',
                r'timing.*difference.*detected',
            ],
            tool_name='fuzz_parameter',
            base_args={'vuln_class': 'username_enumeration'},
            severity_range=('low', 'medium'),
            parameter_bound=True,
            requires_auth=False,
            owasp_category='A07:2021-Identification and Authentication Failures',
            references=['https://owasp.org/www-project-web-security-testing-guide/latest/4-Web_Application_Security_Testing/03-Identity_Management_Testing/04-Testing_for_Account_Enumeration_and_Guessable_User_Account']
        ))

        # ===== CONFIGURATION CATEGORY =====

        # CORS Misconfiguration
        specs.append(VulnTestSpec(
            id='cors_misconfig',
            name='CORS Misconfiguration',
            category='config',
            description='Tests for permissive CORS policies',
            applicable_when=VulnChecklist._always_applicable,
            detection_patterns=[
                r'Access-Control-Allow-Origin:\s*\*',
                r'Access-Control-Allow-Origin:.*null',
                r'Access-Control-Allow-Credentials:\s*true',
            ],
            tool_name='http_send',
            base_args={'check_cors': True},
            severity_range=('medium', 'high'),
            parameter_bound=False,
            requires_auth=False,
            owasp_category='A05:2021-Security Misconfiguration',
            references=['https://owasp.org/www-community/attacks/CORS_OriginHeaderScrutiny']
        ))

        # Cross-Site Request Forgery
        specs.append(VulnTestSpec(
            id='csrf',
            name='Cross-Site Request Forgery',
            category='config',
            description='Tests for missing CSRF protection',
            applicable_when=VulnChecklist._is_state_changing,
            detection_patterns=[
                r'csrf.*token.*missing',
                r'no.*anti.*forgery',
            ],
            tool_name='http_send',
            base_args={'check_csrf': True},
            severity_range=('medium', 'high'),
            parameter_bound=False,
            requires_auth=False,
            owasp_category='A01:2021-Broken Access Control',
            references=['https://owasp.org/www-community/attacks/csrf']
        ))

        # Clickjacking
        specs.append(VulnTestSpec(
            id='clickjacking',
            name='Clickjacking',
            category='config',
            description='Tests for missing X-Frame-Options/CSP frame-ancestors',
            applicable_when=VulnChecklist._is_html_response,
            detection_patterns=[
                r'X-Frame-Options.*missing',
                r'frame-ancestors.*missing',
            ],
            tool_name='http_send',
            base_args={'check_clickjacking': True},
            severity_range=('low', 'medium'),
            parameter_bound=False,
            requires_auth=False,
            owasp_category='A05:2021-Security Misconfiguration',
            references=['https://owasp.org/www-community/attacks/Clickjacking']
        ))

        # Security Headers
        specs.append(VulnTestSpec(
            id='security_headers',
            name='Missing Security Headers',
            category='config',
            description='Tests for missing security headers (CSP, HSTS, etc.)',
            applicable_when=VulnChecklist._always_applicable,
            detection_patterns=[
                r'Content-Security-Policy.*missing',
                r'Strict-Transport-Security.*missing',
                r'X-Content-Type-Options.*missing',
            ],
            tool_name='http_send',
            base_args={'check_security_headers': True},
            severity_range=('low', 'medium'),
            parameter_bound=False,
            requires_auth=False,
            owasp_category='A05:2021-Security Misconfiguration',
            references=['https://owasp.org/www-project-secure-headers/']
        ))

        # Cookie Security
        specs.append(VulnTestSpec(
            id='cookie_security',
            name='Insecure Cookie Attributes',
            category='config',
            description='Tests for cookies without Secure, HttpOnly, SameSite flags',
            applicable_when=VulnChecklist._always_applicable,
            detection_patterns=[
                r'Set-Cookie.*(?!.*Secure)',
                r'Set-Cookie.*(?!.*HttpOnly)',
                r'Set-Cookie.*(?!.*SameSite)',
            ],
            tool_name='http_send',
            base_args={'check_cookies': True},
            severity_range=('low', 'medium'),
            parameter_bound=False,
            requires_auth=False,
            owasp_category='A05:2021-Security Misconfiguration',
            references=['https://owasp.org/www-community/controls/SecureCookieAttribute']
        ))

        # HTTP Method Tampering
        specs.append(VulnTestSpec(
            id='http_method_tampering',
            name='HTTP Method Tampering',
            category='config',
            description='Tests for access control bypass via method override',
            applicable_when=VulnChecklist._always_applicable,
            detection_patterns=[
                r'method.*override.*successful',
                r'X-HTTP-Method-Override.*bypass',
            ],
            tool_name='http_send',
            base_args={'test_method_override': True},
            severity_range=('medium', 'high'),
            parameter_bound=False,
            requires_auth=False,
            owasp_category='A01:2021-Broken Access Control',
            references=['https://owasp.org/www-project-web-security-testing-guide/latest/4-Web_Application_Security_Testing/07-Input_Validation_Testing/03-Testing_for_HTTP_Verb_Tampering']
        ))

        # TLS Configuration
        specs.append(VulnTestSpec(
            id='tls_config',
            name='TLS/SSL Misconfiguration',
            category='config',
            description='Tests for weak TLS versions, ciphers, and configuration',
            applicable_when=VulnChecklist._always_applicable,
            detection_patterns=[
                r'TLS.*1\.0',
                r'SSL.*v[23]',
                r'weak.*cipher',
            ],
            tool_name='ssl_analysis',
            base_args={},
            severity_range=('medium', 'high'),
            parameter_bound=False,
            requires_auth=False,
            owasp_category='A02:2021-Cryptographic Failures',
            references=['https://owasp.org/www-project-web-security-testing-guide/latest/4-Web_Application_Security_Testing/09-Testing_for_Weak_Cryptography/']
        ))

        # ===== CLIENT-SIDE CATEGORY =====

        # Open Redirect
        specs.append(VulnTestSpec(
            id='open_redirect',
            name='Open Redirect',
            category='client_side',
            description='Tests for unvalidated redirects',
            applicable_when=VulnChecklist._has_parameters,
            detection_patterns=[
                r'Location:.*evil\.com',
                r'redirect.*unvalidated',
            ],
            tool_name='fuzz_parameter',
            base_args={'vuln_class': 'open_redirect'},
            severity_range=('low', 'medium'),
            parameter_bound=True,
            requires_auth=False,
            owasp_category='A01:2021-Broken Access Control',
            references=['https://owasp.org/www-project-web-security-testing-guide/latest/4-Web_Application_Security_Testing/11-Client-side_Testing/04-Testing_for_Client-side_URL_Redirect']
        ))

        # ===== INFORMATION LEAKAGE CATEGORY =====

        # Information Leak - Error Messages
        specs.append(VulnTestSpec(
            id='info_leak_errors',
            name='Information Leakage via Error Messages',
            category='info_leak',
            description='Tests for verbose error messages exposing system details',
            applicable_when=VulnChecklist._always_applicable,
            detection_patterns=[
                r'stack.*trace',
                r'SQLException',
                r'System\.Exception',
                r'at.*line.*\d+',
            ],
            tool_name='http_send',
            base_args={'check_error_disclosure': True},
            severity_range=('low', 'medium'),
            parameter_bound=False,
            requires_auth=False,
            owasp_category='A05:2021-Security Misconfiguration',
            references=['https://owasp.org/www-project-web-security-testing-guide/latest/4-Web_Application_Security_Testing/08-Testing_for_Error_Handling/']
        ))

        # Information Leak - HTML Comments
        specs.append(VulnTestSpec(
            id='info_leak_comments',
            name='Information Leakage via HTML Comments',
            category='info_leak',
            description='Tests for sensitive info in HTML/JS comments',
            applicable_when=VulnChecklist._is_html_response,
            detection_patterns=[
                r'<!--.*(?:password|secret|api.*key|token).*-->',
                r'//.*(?:TODO|FIXME|XXX).*password',
            ],
            tool_name='http_send',
            base_args={'check_comments': True},
            severity_range=('low', 'low'),
            parameter_bound=False,
            requires_auth=False,
            owasp_category='A05:2021-Security Misconfiguration',
            references=['https://owasp.org/www-project-web-security-testing-guide/latest/4-Web_Application_Security_Testing/01-Information_Gathering/05-Review_Webpage_Content_for_Information_Leakage']
        ))

        # Information Leak - Source Maps
        specs.append(VulnTestSpec(
            id='info_leak_source_maps',
            name='Exposed Source Maps',
            category='info_leak',
            description='Tests for publicly accessible source map files',
            applicable_when=VulnChecklist._always_applicable,
            detection_patterns=[
                r'\.map$',
                r'sourceMappingURL',
            ],
            tool_name='http_send',
            base_args={'check_source_maps': True},
            severity_range=('low', 'low'),
            parameter_bound=False,
            requires_auth=False,
            owasp_category='A05:2021-Security Misconfiguration',
            references=['https://owasp.org/www-project-web-security-testing-guide/latest/4-Web_Application_Security_Testing/01-Information_Gathering/']
        ))

        # Information Leak - Headers
        specs.append(VulnTestSpec(
            id='info_leak_headers',
            name='Information Leakage via Headers',
            category='info_leak',
            description='Tests for verbose Server/X-Powered-By headers',
            applicable_when=VulnChecklist._always_applicable,
            detection_patterns=[
                r'Server:.*\d+\.\d+',  # Version numbers
                r'X-Powered-By:',
                r'X-AspNet-Version:',
            ],
            tool_name='http_send',
            base_args={'check_info_headers': True},
            severity_range=('info', 'low'),
            parameter_bound=False,
            requires_auth=False,
            owasp_category='A05:2021-Security Misconfiguration',
            references=['https://owasp.org/www-project-web-security-testing-guide/latest/4-Web_Application_Security_Testing/01-Information_Gathering/02-Fingerprint_Web_Server']
        ))

        # Directory Listing
        specs.append(VulnTestSpec(
            id='directory_listing',
            name='Directory Listing Enabled',
            category='info_leak',
            description='Tests for exposed directory listings',
            applicable_when=VulnChecklist._always_applicable,
            detection_patterns=[
                r'Index of /',
                r'<DIR>',
                r'Parent Directory',
            ],
            tool_name='http_send',
            base_args={'check_directory_listing': True},
            severity_range=('low', 'medium'),
            parameter_bound=False,
            requires_auth=False,
            owasp_category='A05:2021-Security Misconfiguration',
            references=['https://owasp.org/www-project-web-security-testing-guide/latest/4-Web_Application_Security_Testing/02-Configuration_and_Deployment_Management_Testing/04-Review_Old_Backup_and_Unreferenced_Files_for_Sensitive_Information']
        ))

        # ===== API CATEGORY =====

        # Mass Assignment
        specs.append(VulnTestSpec(
            id='mass_assignment',
            name='Mass Assignment',
            category='api',
            description='Tests for mass assignment vulnerabilities',
            applicable_when=lambda e: VulnChecklist._is_state_changing(e) and VulnChecklist._is_json_response(e),
            detection_patterns=[
                r'role.*admin',
                r'isAdmin.*true',
                r'mass.*assignment',
            ],
            detection_method='behavioral',
            tool_name='fuzz_parameter',
            base_args={'vuln_class': 'mass_assignment'},
            severity_range=('medium', 'high'),
            parameter_bound=True,
            requires_auth=False,
            owasp_category='A01:2021-Broken Access Control',
            references=['https://owasp.org/www-project-api-security/']
        ))

        # Parameter Pollution
        specs.append(VulnTestSpec(
            id='param_pollution',
            name='HTTP Parameter Pollution',
            category='api',
            description='Tests for HPP vulnerabilities',
            applicable_when=VulnChecklist._has_parameters,
            detection_patterns=[
                r'parameter.*pollution',
                r'duplicate.*parameter',
            ],
            detection_method='behavioral',
            tool_name='fuzz_parameter',
            base_args={'vuln_class': 'param_pollution'},
            severity_range=('low', 'medium'),
            parameter_bound=True,
            requires_auth=False,
            owasp_category='A03:2021-Injection',
            references=['https://owasp.org/www-project-web-security-testing-guide/latest/4-Web_Application_Security_Testing/07-Input_Validation_Testing/04-Testing_for_HTTP_Parameter_Pollution']
        ))

        # GraphQL Introspection
        specs.append(VulnTestSpec(
            id='graphql_introspection',
            name='GraphQL Introspection Enabled',
            category='api',
            description='Tests for exposed GraphQL introspection',
            applicable_when=VulnChecklist._always_applicable,
            detection_patterns=[
                r'__schema',
                r'__type',
                r'introspection.*enabled',
            ],
            tool_name='http_send',
            base_args={'check_graphql': True},
            severity_range=('low', 'medium'),
            parameter_bound=False,
            requires_auth=False,
            owasp_category='A05:2021-Security Misconfiguration',
            references=['https://owasp.org/www-project-api-security/']
        ))

        # Rate Limit Bypass
        specs.append(VulnTestSpec(
            id='rate_limit_bypass',
            name='Rate Limiting Bypass',
            category='api',
            description='Tests for missing or bypassable rate limits',
            applicable_when=VulnChecklist._always_applicable,
            detection_patterns=[
                r'rate.*limit.*bypass',
                r'X-RateLimit-Remaining:\s*\d{3,}',
            ],
            tool_name='http_send_batch',
            base_args={'check_rate_limit': True},
            severity_range=('medium', 'medium'),
            parameter_bound=False,
            requires_auth=False,
            owasp_category='A04:2021-Insecure Design',
            references=['https://owasp.org/www-project-api-security/']
        ))

        # ===== BUSINESS LOGIC CATEGORY =====

        # Race Condition
        specs.append(VulnTestSpec(
            id='race_condition',
            name='Race Condition',
            category='business_logic',
            description='Tests for TOCTOU and race condition vulnerabilities',
            applicable_when=VulnChecklist._is_state_changing,
            detection_patterns=[
                r'race.*condition',
                r'concurrent.*access',
            ],
            detection_method='behavioral',
            tool_name='http_send_batch',
            base_args={'test_race_condition': True},
            severity_range=('medium', 'high'),
            parameter_bound=False,
            requires_auth=False,
            owasp_category='A04:2021-Insecure Design',
            references=['https://owasp.org/www-community/vulnerabilities/Race_Conditions']
        ))

        # Price Manipulation
        specs.append(VulnTestSpec(
            id='price_manipulation',
            name='Price/Amount Manipulation',
            category='business_logic',
            description='Tests for price tampering in transactions',
            applicable_when=VulnChecklist._has_parameters,
            detection_patterns=[
                r'price.*tampered',
                r'negative.*amount',
            ],
            detection_method='behavioral',
            tool_name='fuzz_parameter',
            base_args={'vuln_class': 'price_manipulation'},
            severity_range=('high', 'critical'),
            parameter_bound=True,
            requires_auth=False,
            owasp_category='A04:2021-Insecure Design',
            references=['https://owasp.org/www-project-web-security-testing-guide/latest/4-Web_Application_Security_Testing/10-Business_Logic_Testing/']
        ))

        # Round 11 Fix 4A: Weak Password Policy
        specs.append(VulnTestSpec(
            id='weak_password_policy',
            name='Weak Password Policy',
            category='auth',
            description='Application accepts weak passwords without server-side validation',
            applicable_when=VulnChecklist._is_state_changing,
            detection_patterns=[
                r'password.*accepted',
                r'weak.*password.*allowed',
                r'success.*registration',
                r'account.*created',
            ],
            detection_method='behavioral',
            tool_name='fuzz_parameter',
            base_args={'vuln_class': 'weak_password_policy'},
            severity_range=('medium', 'high'),
            parameter_bound=True,
            requires_auth=False,
            owasp_category='A07:2021-Identification and Authentication Failures',
            references=['https://owasp.org/www-community/vulnerabilities/Weak_password_requirements']
        ))

        # Round 11 Fix 4B: Input Validation
        specs.append(VulnTestSpec(
            id='input_validation',
            name='Insufficient Input Validation',
            category='config',
            description='Application accepts invalid/malformed input without validation',
            applicable_when=VulnChecklist._has_parameters,
            detection_patterns=[
                r'invalid.*input.*processed',
                r'malformed.*data.*accepted',
                r'validation.*failed',
                r'error.*parsing',
            ],
            detection_method='behavioral',
            tool_name='fuzz_parameter',
            base_args={'vuln_class': 'input_validation'},
            severity_range=('low', 'medium'),
            parameter_bound=True,
            requires_auth=False,
            owasp_category='A03:2021-Injection',
            references=['https://owasp.org/www-community/vulnerabilities/Improper_Input_Validation']
        ))

        return specs

    def __init__(self):
        """Initialize the vulnerability checklist."""
        self._specs = self._build_specs()
        self._specs_by_id = {spec.id: spec for spec in self._specs}
        self._specs_by_category = {}
        for spec in self._specs:
            if spec.category not in self._specs_by_category:
                self._specs_by_category[spec.category] = []
            self._specs_by_category[spec.category].append(spec)

    def get_all_specs(self) -> List[VulnTestSpec]:
        """Get all vulnerability test specifications."""
        return self._specs.copy()

    def get_spec_by_id(self, spec_id: str) -> Optional[VulnTestSpec]:
        """Get a specific vulnerability test specification by ID."""
        return self._specs_by_id.get(spec_id)

    def get_applicable_specs(self, endpoint: Dict) -> List[VulnTestSpec]:
        """
        Get all applicable vulnerability specs for an endpoint.

        Args:
            endpoint: Endpoint metadata dict with keys like:
                     - method: HTTP method
                     - parameters: List of parameter dicts
                     - content_type: Response content type
                     - requires_auth: Whether auth is needed

        Returns:
            List of applicable VulnTestSpec objects
        """
        applicable = []
        for spec in self._specs:
            try:
                if spec.applicable_when(endpoint):
                    applicable.append(spec)
            except Exception as e:
                # Predicate failed, skip this spec
                pass
        return applicable

    def get_specs_by_category(self, category: str) -> List[VulnTestSpec]:
        """Get all specs in a specific category."""
        return self._specs_by_category.get(category, []).copy()

    def get_categories(self) -> List[str]:
        """Get list of all vulnerability categories."""
        return list(self._specs_by_category.keys())

    def build_tool_map(self) -> Dict[str, Dict]:
        """
        Build backward-compatible tool map for coverage_tracker.py.

        Returns:
            Dict mapping vuln spec IDs to tool configuration dicts
        """
        tool_map = {}
        for spec in self._specs:
            tool_map[spec.id] = {
                'tool_name': spec.tool_name,
                'base_args': spec.base_args.copy(),
                'parameter_bound': spec.parameter_bound
            }
        return tool_map

    def get_spec_count(self) -> int:
        """Get total number of vulnerability test specifications."""
        return len(self._specs)

    def get_summary(self) -> Dict[str, Any]:
        """Get summary statistics about the checklist."""
        return {
            'total_specs': len(self._specs),
            'categories': {
                cat: len(specs)
                for cat, specs in self._specs_by_category.items()
            },
            'parameter_bound_count': sum(1 for s in self._specs if s.parameter_bound),
            'requires_auth_count': sum(1 for s in self._specs if s.requires_auth),
            'severity_distribution': {
                'critical': sum(1 for s in self._specs if 'critical' in s.severity_range),
                'high': sum(1 for s in self._specs if 'high' in s.severity_range),
                'medium': sum(1 for s in self._specs if 'medium' in s.severity_range),
                'low': sum(1 for s in self._specs if 'low' in s.severity_range),
            }
        }


# Global singleton instance
_checklist_instance = None

def get_vuln_checklist() -> VulnChecklist:
    """Get the global vulnerability checklist instance."""
    global _checklist_instance
    if _checklist_instance is None:
        _checklist_instance = VulnChecklist()
    return _checklist_instance
