"""
Credentials Management Tools - credentials_add, credentials_list
"""
import re
from typing import List
from mcp.types import Tool, TextContent


def get_credentials_tools() -> List[Tool]:
    """Get credentials management tool definitions"""
    return [
        Tool(
            name="credentials_add",
            description="Add authentication credentials (bearer tokens, cookies, SSH creds, etc.) - Placeholder auto-generated from name",
            inputSchema={
                "type": "object",
                "properties": {
                    "credential_type": {
                        "type": "string",
                        "enum": ["bearer_token", "cookie", "basic_auth", "api_key", "ssh", "custom"],
                        "description": "Type of credential"
                    },
                    "name": {
                        "type": "string",
                        "description": "Descriptive name (e.g., 'Fleet Manager Auth') - placeholder will be auto-generated"
                    },
                    "placeholder": {
                        "type": "string",
                        "description": "Optional: Custom placeholder (auto-generated from name if not provided)"
                    },
                    "token": {
                        "type": "string",
                        "description": "Token value (for bearer_token, api_key)"
                    },
                    "username": {
                        "type": "string",
                        "description": "Username (for basic_auth, ssh)"
                    },
                    "password": {
                        "type": "string",
                        "description": "Password (for basic_auth, ssh)"
                    },
                    "cookie_value": {
                        "type": "string",
                        "description": "Cookie string (for cookie type)"
                    },
                    "custom_data": {
                        "type": "object",
                        "description": "Custom data (JSON object for custom type)"
                    },
                    "service": {
                        "type": "string",
                        "description": "Service name (SSH, API, Web, etc.)"
                    },
                    "target": {
                        "type": "string",
                        "description": "Target URL or IP"
                    },
                    "notes": {
                        "type": "string",
                        "description": "Additional notes (e.g., 'Found in config file', 'Expires in 15 min')"
                    }
                },
                "required": ["credential_type", "name"]
            }
        ),
        Tool(
            name="credentials_list",
            description="List all available credentials with their placeholders and types",
            inputSchema={
                "type": "object",
                "properties": {
                    "credential_type": {
                        "type": "string",
                        "enum": ["bearer_token", "cookie", "basic_auth", "api_key", "ssh", "custom"],
                        "description": "Filter by type (optional)"
                    }
                },
                "required": []
            }
        ),
    ]


async def handle_credentials_tool(name: str, arguments: dict, mcp_service) -> List[TextContent]:
    """Route credentials tool calls to the appropriate handler"""
    if name == "credentials_add":
        return await _handle_credentials_add(arguments, mcp_service)
    elif name == "credentials_list":
        return await _handle_credentials_list(arguments, mcp_service)
    return [TextContent(type="text", text=f"Unknown credentials tool: {name}")]


async def _handle_credentials_add(arguments: dict, mcp_service) -> List[TextContent]:
    """Handle credentials_add - Add authentication credentials"""
    if not mcp_service.current_assessment_id:
        return [TextContent(type="text", text="No assessment loaded. Use 'load_assessment' first.")]

    credential_type = arguments["credential_type"]
    name = arguments["name"]

    # Auto-generate placeholder if not provided
    if "placeholder" in arguments and arguments["placeholder"]:
        placeholder = arguments["placeholder"]
    else:
        # Generate placeholder from name and type
        clean_name = re.sub(r'[^A-Z0-9\s]', '', name.upper()).replace(' ', '_')
        type_prefix = credential_type.upper().replace('_', '_')
        placeholder = f"{{{{{type_prefix}_{clean_name}}}}}"

    # Prepare credential data
    credential_data = {
        "credential_type": credential_type,
        "name": name,
        "placeholder": placeholder,
        "discovered_by": "claude"  # Marked as added by Claude
    }

    # Add optional fields if present
    optional_fields = ["token", "username", "password", "cookie_value", "custom_data", "service", "target", "notes"]
    for field in optional_fields:
        if field in arguments:
            credential_data[field] = arguments[field]

    # API call to create credential
    try:
        response = await mcp_service.http_client.post(
            f"{mcp_service.backend_url}/assessments/{mcp_service.current_assessment_id}/credentials",
            json=credential_data
        )
        response.raise_for_status()
        result = response.json()

        # Format response
        response_text = f"Credential added: **{name}**\n\n"
        response_text += f"**Type:** {credential_type}\n"
        response_text += f"**Placeholder:** `{placeholder}`\n"

        if credential_data.get("target"):
            response_text += f"**Target:** {credential_data['target']}\n"

        if credential_data.get("service"):
            response_text += f"**Service:** {credential_data['service']}\n"

        response_text += f"\n**Usage:** Use `{placeholder}` in your execute commands.\n"
        response_text += f"**Example:** `execute('curl -H \"Authorization: Bearer {placeholder}\" https://api.example.com')`"

        return [TextContent(type="text", text=response_text)]

    except Exception as e:
        error_msg = str(e)
        if "409" in error_msg or "already exists" in error_msg.lower():
            return [TextContent(
                type="text",
                text=f"Error: Placeholder '{placeholder}' already exists for this assessment. Choose a different placeholder."
            )]
        else:
            return [TextContent(
                type="text",
                text=f"Error adding credential: {error_msg}"
            )]


async def _handle_credentials_list(arguments: dict, mcp_service) -> List[TextContent]:
    """Handle credentials_list - List all credentials"""
    if not mcp_service.current_assessment_id:
        return [TextContent(type="text", text="No assessment loaded. Use 'load_assessment' first.")]

    # Filter by type if specified
    credential_type = arguments.get("credential_type")

    # API call to list credentials
    try:
        url = f"{mcp_service.backend_url}/assessments/{mcp_service.current_assessment_id}/credentials"
        if credential_type:
            url += f"?credential_type={credential_type}"

        response = await mcp_service.http_client.get(url)
        response.raise_for_status()
        result = response.json()

        credentials = result.get("credentials", [])
        total = result.get("total", 0)
        by_type = result.get("by_type", {})

        if total == 0:
            return [TextContent(
                type="text",
                text="No credentials found for this assessment.\n\nUse `credentials_add` to add authentication tokens, cookies, or other credentials."
            )]

        # Format response
        response_text = f"**Available Credentials ({total}):**\n\n"

        # Summary by type
        if by_type:
            response_text += "**By Type:**\n"
            for cred_type, count in by_type.items():
                response_text += f"- {cred_type}: {count}\n"
            response_text += "\n"

        # Detailed list
        response_text += "**Credentials:**\n\n"
        for i, cred in enumerate(credentials, 1):
            response_text += f"{i}. **{cred['name']}** ({cred['credential_type']})\n"
            response_text += f"   - Placeholder: `{cred['placeholder']}`\n"

            if cred.get("target"):
                response_text += f"   - Target: {cred['target']}\n"

            if cred.get("service"):
                response_text += f"   - Service: {cred['service']}\n"

            if cred.get("notes"):
                notes_preview = cred['notes'][:80] + "..." if len(cred['notes']) > 80 else cred['notes']
                response_text += f"   - Notes: {notes_preview}\n"

            response_text += f"   - Added: {cred.get('created_at', 'N/A')}\n"
            response_text += "\n"

        response_text += "**Tip:** Use placeholders in execute commands for automatic substitution."

        return [TextContent(type="text", text=response_text)]

    except Exception as e:
        return [TextContent(
            type="text",
            text=f"Error listing credentials: {str(e)}"
        )]
