"""
Evidence Tools - evidence_bundle, evidence_add_artifact, evidence_export,
evidence_generate_report.

Ported from the evidence-mcp TypeScript server to Python, following the
same pattern as tools_scope.py and tools_fuzzer.py.
"""

from __future__ import annotations

import json
import logging
import os
from typing import Any, Dict, List

from mcp.types import Tool, TextContent

from lib.evidence_bundler import get_bundler
from lib.evidence_redactor import get_redactor
from lib.evidence_exporter import get_exporter

logger = logging.getLogger("autopentest-mcp")

# ---------------------------------------------------------------------------
# Environment configuration
# ---------------------------------------------------------------------------

EVIDENCE_DIR = os.environ.get("EVIDENCE_DIR", "./evidence")
REDACT_SECRETS = os.environ.get("REDACT_SECRETS", "true").lower() != "false"


# ---------------------------------------------------------------------------
# Helpers
# ---------------------------------------------------------------------------

def _json_content(data: Any) -> List[TextContent]:
    """Return a single-element TextContent list with *data* as JSON."""
    return [TextContent(type="text", text=json.dumps(data, indent=2, default=str))]


def _error_content(message: str) -> List[TextContent]:
    """Return a JSON error object wrapped in TextContent."""
    return [TextContent(type="text", text=json.dumps({"success": False, "error": message}, indent=2))]


# ---------------------------------------------------------------------------
# Tool definitions
# ---------------------------------------------------------------------------

def get_evidence_tools() -> List[Tool]:
    """Return the four evidence tools."""
    return [
        Tool(
            name="evidence_bundle",
            description=(
                "Create a new evidence bundle for a security finding. "
                "Returns a bundle_id for adding artifacts."
            ),
            inputSchema={
                "type": "object",
                "properties": {
                    "finding_id": {
                        "type": "string",
                        "description": "The ID of the finding this evidence relates to",
                    },
                    "metadata": {
                        "type": "object",
                        "description": (
                            "Optional metadata (title, severity, description, "
                            "cvss_score, cwe_id, etc.)"
                        ),
                        "additionalProperties": True,
                    },
                },
                "required": ["finding_id"],
            },
        ),
        Tool(
            name="evidence_add_artifact",
            description=(
                "Add an artifact (request, response, screenshot, log, config) "
                "to an evidence bundle"
            ),
            inputSchema={
                "type": "object",
                "properties": {
                    "bundle_id": {
                        "type": "string",
                        "description": "The evidence bundle ID to add the artifact to",
                    },
                    "artifact": {
                        "type": "object",
                        "description": "The artifact to add",
                        "properties": {
                            "type": {
                                "type": "string",
                                "enum": [
                                    "request", "response", "screenshot",
                                    "log", "config", "other",
                                ],
                                "description": "Type of artifact",
                            },
                            "name": {
                                "type": "string",
                                "description": "Name/label for the artifact",
                            },
                            "content": {
                                "type": "string",
                                "description": "Content of the artifact",
                            },
                            "content_type": {
                                "type": "string",
                                "description": "MIME type of the content (default: text/plain)",
                            },
                        },
                        "required": ["type", "name", "content"],
                    },
                },
                "required": ["bundle_id", "artifact"],
            },
        ),
        Tool(
            name="evidence_export",
            description=(
                "Export an evidence bundle as ZIP or JSON. "
                "Sensitive data is redacted by default."
            ),
            inputSchema={
                "type": "object",
                "properties": {
                    "bundle_id": {
                        "type": "string",
                        "description": "The evidence bundle ID to export",
                    },
                    "format": {
                        "type": "string",
                        "enum": ["zip", "json", "sarif"],
                        "description": "Export format (sarif for CI/CD integration)",
                    },
                    "include_redacted": {
                        "type": "boolean",
                        "description": (
                            "If true, skip redaction and include raw data "
                            "(default: false)"
                        ),
                    },
                    "output_path": {
                        "type": "string",
                        "description": "Optional file path to save the export",
                    },
                },
                "required": ["bundle_id", "format"],
            },
        ),
        Tool(
            name="evidence_generate_report",
            description="Generate a security finding report from an evidence bundle",
            inputSchema={
                "type": "object",
                "properties": {
                    "bundle_id": {
                        "type": "string",
                        "description": "The evidence bundle ID",
                    },
                    "template": {
                        "type": "string",
                        "enum": ["markdown", "html"],
                        "description": "Report template format",
                    },
                    "title": {
                        "type": "string",
                        "description": "Optional report title",
                    },
                    "include_artifacts": {
                        "type": "boolean",
                        "description": "Include artifact contents in report (default: true)",
                    },
                    "custom_template": {
                        "type": "string",
                        "description": "Path to a custom Jinja2 template file",
                    },
                },
                "required": ["bundle_id", "template"],
            },
        ),
    ]


# ---------------------------------------------------------------------------
# Tool handler dispatch
# ---------------------------------------------------------------------------

async def handle_evidence_tool(
    name: str,
    arguments: dict,
    mcp_service,
) -> List[TextContent]:
    """Dispatch an evidence tool call to the appropriate handler.

    Parameters
    ----------
    name : str
        Tool name (one of the four evidence_* tools).
    arguments : dict
        Arguments supplied by the caller.
    mcp_service :
        The MCP service instance (unused by evidence tools but kept for
        interface parity with other tool modules).
    """
    if name == "evidence_bundle":
        return await _handle_evidence_bundle(arguments, mcp_service)
    elif name == "evidence_add_artifact":
        return _handle_add_artifact(arguments)
    elif name == "evidence_export":
        return _handle_export(arguments)
    elif name == "evidence_generate_report":
        return _handle_generate_report(arguments)

    return _error_content(f"Unknown evidence tool: {name}")


# ---------------------------------------------------------------------------
# Individual handlers
# ---------------------------------------------------------------------------

async def _handle_evidence_bundle(arguments: dict, mcp_service=None) -> List[TextContent]:
    """Create a new evidence bundle."""
    finding_id = arguments.get("finding_id")
    if not finding_id or not isinstance(finding_id, str):
        return _error_content("finding_id is required and must be a string")

    try:
        metadata = arguments.get("metadata") or {}
        if not isinstance(metadata, dict):
            metadata = {}

        bundler = get_bundler()
        bundle = bundler.create_bundle(finding_id, metadata)

        # Link evidence bundle to backend as an info card
        if mcp_service:
            bundle_id = bundle["bundle_id"]
            title = metadata.get("title", finding_id)
            await mcp_service.safe_add_card(
                card_type="info",
                title=f"Evidence: {title}",
                context=f"Bundle: {bundle_id}, Finding: {finding_id}",
                notes=json.dumps(metadata, default=str)[:2000],
            )

        return _json_content({
            "success": True,
            "bundle_id": bundle["bundle_id"],
            "finding_id": bundle["finding_id"],
            "created_at": bundle["created_at"],
            "message": (
                f'Evidence bundle created. Use bundle_id '
                f'"{bundle["bundle_id"]}" to add artifacts.'
            ),
        })

    except Exception as exc:
        return _error_content(f"Error creating bundle: {exc}")


def _handle_add_artifact(arguments: dict) -> List[TextContent]:
    """Add an artifact to an evidence bundle."""
    bundle_id = arguments.get("bundle_id")
    if not bundle_id or not isinstance(bundle_id, str):
        return _error_content("bundle_id is required and must be a string")

    artifact_input = arguments.get("artifact")
    if not artifact_input or not isinstance(artifact_input, dict):
        return _error_content("artifact is required and must be an object")

    try:
        bundler = get_bundler()
        artifact = bundler.add_artifact(bundle_id, artifact_input)

        # Check for sensitive data if redaction is enabled
        sensitive_data_warning = None
        if REDACT_SECRETS:
            redactor = get_redactor()
            if redactor.contains_sensitive_data(artifact["content"]):
                sensitive_data_warning = (
                    "Artifact contains sensitive data that will be "
                    "redacted on export"
                )

        return _json_content({
            "success": True,
            "artifact_id": artifact["artifact_id"],
            "bundle_id": bundle_id,
            "type": artifact["type"],
            "name": artifact["name"],
            "timestamp": artifact["timestamp"],
            "sensitive_data_warning": sensitive_data_warning,
        })

    except Exception as exc:
        return _error_content(f"Error adding artifact: {exc}")


def _handle_export(arguments: dict) -> List[TextContent]:
    """Export an evidence bundle."""
    bundle_id = arguments.get("bundle_id")
    if not bundle_id or not isinstance(bundle_id, str):
        return _error_content("bundle_id is required and must be a string")

    fmt = arguments.get("format")
    if fmt not in ("zip", "json", "sarif"):
        return _error_content('format must be "zip", "json", or "sarif"')

    bundler = get_bundler()
    bundle = bundler.get_bundle(bundle_id)
    if bundle is None:
        return _error_content(f"Bundle not found: {bundle_id}")

    include_redacted = arguments.get("include_redacted") is True
    output_path = arguments.get("output_path")
    if output_path is not None and not isinstance(output_path, str):
        output_path = None

    try:
        if fmt == "sarif":
            # SARIF 2.1.0 export
            redactor = get_redactor()
            exporter = get_exporter(redactor)
            result = exporter.export_to_sarif(
                bundle,
                output_path=output_path,
            )
            return _json_content({
                "success": True,
                "format": "sarif",
                "bundle_id": bundle_id,
                "output_path": result.get("output_path"),
                "data": result.get("data"),
                "finding_count": result.get("finding_count", 0),
            })

        redactor = get_redactor()
        exporter = get_exporter(redactor)

        if fmt == "zip":
            result = exporter.export_to_zip(
                bundle,
                include_redacted=include_redacted,
                output_path=output_path,
            )
        else:
            result = exporter.export_to_json(
                bundle,
                include_redacted=include_redacted,
                output_path=output_path,
            )

        return _json_content({
            "success": result["success"],
            "format": result["format"],
            "bundle_id": bundle_id,
            "artifact_count": result["artifact_count"],
            "redacted_count": result["redacted_count"],
            "size_bytes": result["size_bytes"],
            "output_path": result.get("output_path"),
            "data": result.get("data"),
        })

    except Exception as exc:
        return _error_content(f"Error exporting bundle: {exc}")


def _handle_generate_report(arguments: dict) -> List[TextContent]:
    """Generate a report from an evidence bundle."""
    bundle_id = arguments.get("bundle_id")
    if not bundle_id or not isinstance(bundle_id, str):
        return _error_content("bundle_id is required and must be a string")

    template = arguments.get("template")
    if template not in ("markdown", "html"):
        return _error_content('template must be "markdown" or "html"')

    bundler = get_bundler()
    bundle = bundler.get_bundle(bundle_id)
    if bundle is None:
        return _error_content(f"Bundle not found: {bundle_id}")

    title = arguments.get("title")
    if title is not None and not isinstance(title, str):
        title = None

    include_artifacts = arguments.get("include_artifacts") is not False

    custom_template = arguments.get("custom_template")
    if custom_template is not None and not isinstance(custom_template, str):
        custom_template = None

    try:
        redactor = get_redactor()
        exporter = get_exporter(redactor)

        result = exporter.generate_report(
            bundle,
            template=template,
            title=title,
            include_artifacts=include_artifacts,
            custom_template=custom_template,
        )

        return _json_content({
            "success": result["success"],
            "template": result["template"],
            "bundle_id": result["bundle_id"],
            "finding_id": result["finding_id"],
            "artifact_count": result["artifact_count"],
            "content": result["content"],
        })

    except Exception as exc:
        return _error_content(f"Error generating report: {exc}")
