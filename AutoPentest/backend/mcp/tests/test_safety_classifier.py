"""
Tests for the Safety Classifier.

Covers:
- SafetyClassifier.classify_command: empty, blocked, dangerous, caution, safe
- SafetyClassifier.classify_payload: empty, blocked, dangerous, caution (SQL + XSS)
- SafetyClassifier.classify_url: empty, cloud metadata, scope_validator blocks
- get_safety_classifier singleton behaviour
"""

from __future__ import annotations

import os
import sys
import unittest

# Add modules to path
sys.path.insert(0, os.path.join(os.path.dirname(__file__), "..", "modules"))

# Mock mcp.types before importing anything that depends on it
import types as pytypes
mock_mcp = pytypes.ModuleType("mcp")
mock_mcp_types = pytypes.ModuleType("mcp.types")

class MockTool:
    def __init__(self, name="", description="", inputSchema=None):
        self.name = name
        self.description = description
        self.inputSchema = inputSchema or {}

class MockTextContent:
    def __init__(self, type="text", text=""):
        self.type = type
        self.text = text

mock_mcp_types.Tool = MockTool
mock_mcp_types.TextContent = MockTextContent
sys.modules["mcp"] = mock_mcp
sys.modules["mcp.types"] = mock_mcp_types


from lib.safety_classifier import SafetyClassifier, SafetyLevel, get_safety_classifier


# ---------------------------------------------------------------------------
# classify_command tests
# ---------------------------------------------------------------------------

class TestClassifyCommand(unittest.TestCase):
    """Test SafetyClassifier.classify_command across all four safety levels."""

    def setUp(self):
        self.classifier = SafetyClassifier()

    def test_empty_command(self):
        result = self.classifier.classify_command("")
        self.assertEqual(result["level"], "safe")
        self.assertEqual(result["matched_pattern"], "")

    def test_blocked_rm_rf_root(self):
        result = self.classifier.classify_command("rm -rf /")
        self.assertEqual(result["level"], "blocked")
        self.assertIn("deletion", result["reason"].lower())

    def test_blocked_shutdown(self):
        result = self.classifier.classify_command("shutdown now")
        self.assertEqual(result["level"], "blocked")
        self.assertIn("shutdown", result["reason"].lower())

    def test_dangerous_drop_table(self):
        result = self.classifier.classify_command("DROP TABLE users")
        self.assertEqual(result["level"], "dangerous")
        self.assertIn("drop", result["reason"].lower())

    def test_caution_gobuster(self):
        result = self.classifier.classify_command("gobuster dir -u http://example.com")
        self.assertEqual(result["level"], "caution")
        self.assertNotEqual(result["matched_pattern"], "")

    def test_safe_nmap(self):
        result = self.classifier.classify_command("nmap -sV 10.0.0.1")
        self.assertEqual(result["level"], "safe")
        self.assertEqual(result["matched_pattern"], "")


# ---------------------------------------------------------------------------
# classify_payload tests
# ---------------------------------------------------------------------------

class TestClassifyPayload(unittest.TestCase):
    """Test SafetyClassifier.classify_payload across safety levels."""

    def setUp(self):
        self.classifier = SafetyClassifier()

    def test_empty_payload(self):
        result = self.classifier.classify_payload("")
        self.assertEqual(result["level"], "safe")
        self.assertEqual(result["matched_pattern"], "")

    def test_blocked_drop_database(self):
        result = self.classifier.classify_payload("DROP DATABASE test")
        self.assertEqual(result["level"], "blocked")
        self.assertIn("database", result["reason"].lower())

    def test_dangerous_delete_from(self):
        result = self.classifier.classify_payload("DELETE FROM users")
        self.assertEqual(result["level"], "dangerous")
        self.assertIn("delet", result["reason"].lower())

    def test_caution_union_select(self):
        result = self.classifier.classify_payload("UNION SELECT 1,2,3")
        self.assertEqual(result["level"], "caution")
        self.assertIn("union", result["reason"].lower())

    def test_caution_script_tag(self):
        result = self.classifier.classify_payload("<script>alert(1)</script>")
        self.assertEqual(result["level"], "caution")
        self.assertIn("xss", result["reason"].lower())


# ---------------------------------------------------------------------------
# classify_url tests
# ---------------------------------------------------------------------------

class TestClassifyUrl(unittest.TestCase):
    """Test SafetyClassifier.classify_url for metadata endpoints and scope."""

    def setUp(self):
        self.classifier = SafetyClassifier()

    def test_empty_url(self):
        result = self.classifier.classify_url("")
        self.assertEqual(result["level"], "safe")
        self.assertEqual(result["matched_pattern"], "")

    def test_cloud_metadata_url(self):
        result = self.classifier.classify_url("http://169.254.169.254/latest/meta-data")
        self.assertEqual(result["level"], "caution")
        self.assertIn("metadata", result["reason"].lower())

    def test_scope_validator_blocks(self):
        def deny_all(url):
            return False

        result = self.classifier.classify_url("http://evil.com/path", scope_validator=deny_all)
        self.assertEqual(result["level"], "blocked")
        self.assertIn("scope", result["reason"].lower())


# ---------------------------------------------------------------------------
# Singleton tests
# ---------------------------------------------------------------------------

class TestSingleton(unittest.TestCase):
    """Test get_safety_classifier returns the same instance."""

    def test_get_safety_classifier_returns_same_instance(self):
        instance_a = get_safety_classifier()
        instance_b = get_safety_classifier()
        self.assertIs(instance_a, instance_b)


if __name__ == "__main__":
    unittest.main()
