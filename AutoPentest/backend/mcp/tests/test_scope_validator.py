"""
Tests for the Scope Validator (TargetValidator).

Covers:
- Domain validation (exact match, wildcard, disallowed, URL extraction)
- IP validation (in-range, disallowed, port restrictions)
- Denylist enforcement (domain deny overrides allow, IP deny, keyword deny)
- Edge cases (invalid format, assert_in_scope exception, is_valid_ip helper)
"""

import os
import sys
import unittest

# Add modules to path
sys.path.insert(0, os.path.join(os.path.dirname(__file__), "..", "modules"))

# Mock mcp.types before importing anything that depends on it
import types as pytypes
mock_mcp = pytypes.ModuleType("mcp")
mock_mcp_types = pytypes.ModuleType("mcp.types")

class MockTool:
    def __init__(self, name="", description="", inputSchema=None):
        self.name = name
        self.description = description
        self.inputSchema = inputSchema or {}

class MockTextContent:
    def __init__(self, type="text", text=""):
        self.type = type
        self.text = text

mock_mcp_types.Tool = MockTool
mock_mcp_types.TextContent = MockTextContent
sys.modules["mcp"] = mock_mcp
sys.modules["mcp.types"] = mock_mcp_types

from lib.scope_types import (
    ApprovalPolicy,
    Budget,
    EngagementInfo,
    EngagementScope,
    Escalation,
    OutOfScopeError,
    RateLimits,
    ScopeAllowlist,
    ScopeConstraints,
    ScopeDenylist,
    Timeouts,
    ValidationResult,
)
from lib.scope_validator import TargetValidator


# ---------------------------------------------------------------------------
# Helper
# ---------------------------------------------------------------------------

def _make_scope(
    domains=None, ip_ranges=None, ports=None,
    deny_domains=None, deny_ip_ranges=None, deny_ports=None, deny_keywords=None,
):
    """Build a minimal valid EngagementScope for testing."""
    return EngagementScope(
        schema_version="1.0",
        engagement=EngagementInfo(
            id="test-001", name="Test", client="Test Client",
            start_date="2024-01-01", end_date="2024-12-31", timezone="UTC",
        ),
        allowlist=ScopeAllowlist(
            domains=domains or ["example.com", "*.example.com"],
            ip_ranges=ip_ranges or ["10.0.0.0/8"],
            ports=ports,
        ),
        denylist=ScopeDenylist(
            domains=deny_domains,
            ip_ranges=deny_ip_ranges,
            ports=deny_ports,
            keywords=deny_keywords,
        ) if any([deny_domains, deny_ip_ranges, deny_ports, deny_keywords]) else None,
        constraints=ScopeConstraints(
            rate_limits=RateLimits(requests_per_second=10, max_concurrent=5, burst_limit=20),
            budget=Budget(max_total_requests=10000, max_requests_per_target=1000, max_scan_duration_hours=8.0),
            timeouts=Timeouts(connect_timeout_ms=5000, read_timeout_ms=30000, total_timeout_ms=60000),
        ),
        approval_policy=ApprovalPolicy(
            mode="AUTO_APPROVE", timeout_seconds=30, default_action="DENY",
            escalation=Escalation(on_timeout="DENY", on_error="DENY", notify=False),
        ),
    )


# ===========================================================================
# TestTargetValidatorDomain
# ===========================================================================

class TestTargetValidatorDomain(unittest.TestCase):
    """Domain-based validation tests."""

    def setUp(self):
        scope = _make_scope()
        self.validator = TargetValidator(scope)

    def test_exact_domain_match(self):
        """Exact domain 'example.com' should be valid."""
        result = self.validator.validate_target("example.com")
        self.assertTrue(result.valid, f"Expected valid=True, got reason: {result.reason}")
        self.assertEqual(result.target, "example.com")

    def test_wildcard_domain_match(self):
        """Subdomain 'sub.example.com' should match *.example.com."""
        result = self.validator.validate_target("sub.example.com")
        self.assertTrue(result.valid, f"Expected valid=True, got reason: {result.reason}")

    def test_disallowed_domain(self):
        """Domain 'evil.com' should NOT be valid (not in allowlist)."""
        result = self.validator.validate_target("evil.com")
        self.assertFalse(result.valid)
        self.assertIn("not in allowlist", result.reason.lower())

    def test_url_with_allowed_domain(self):
        """Full URL 'https://example.com/path' should be valid."""
        result = self.validator.validate_target("https://example.com/path")
        self.assertTrue(result.valid, f"Expected valid=True, got reason: {result.reason}")
        self.assertEqual(result.target, "https://example.com/path")


# ===========================================================================
# TestTargetValidatorIP
# ===========================================================================

class TestTargetValidatorIP(unittest.TestCase):
    """IP-based validation tests."""

    def test_ip_in_range(self):
        """IP '10.1.2.3' should be valid (inside 10.0.0.0/8)."""
        scope = _make_scope()
        validator = TargetValidator(scope)
        result = validator.validate_target("10.1.2.3")
        self.assertTrue(result.valid, f"Expected valid=True, got reason: {result.reason}")

    def test_disallowed_ip(self):
        """IP '192.168.1.1' should NOT be valid (not in 10.0.0.0/8)."""
        scope = _make_scope()
        validator = TargetValidator(scope)
        result = validator.validate_target("192.168.1.1")
        self.assertFalse(result.valid)
        self.assertIn("not in any allowed range", result.reason.lower())

    def test_ip_with_port_restriction(self):
        """IP '10.0.0.1:8080' should NOT be valid when only ports 80,443 are allowed."""
        scope = _make_scope(ports=[80, 443])
        validator = TargetValidator(scope)
        result = validator.validate_target("10.0.0.1:8080")
        self.assertFalse(result.valid)
        self.assertIn("not in allowlist", result.reason.lower())


# ===========================================================================
# TestTargetValidatorDenylist
# ===========================================================================

class TestTargetValidatorDenylist(unittest.TestCase):
    """Denylist enforcement tests."""

    def test_deny_overrides_allow_domain(self):
        """Denied domain 'admin.example.com' should be rejected even though
        '*.example.com' is in the allowlist."""
        scope = _make_scope(deny_domains=["admin.example.com"])
        validator = TargetValidator(scope)
        result = validator.validate_target("admin.example.com")
        self.assertFalse(result.valid)
        self.assertIn("denylist", result.reason.lower())

    def test_deny_ip_range(self):
        """IP '10.0.0.5' should be rejected when 10.0.0.0/24 is in the
        deny list, even though 10.0.0.0/8 is allowed."""
        scope = _make_scope(deny_ip_ranges=["10.0.0.0/24"])
        validator = TargetValidator(scope)
        result = validator.validate_target("10.0.0.5")
        self.assertFalse(result.valid)
        self.assertIn("denylist", result.reason.lower())

    def test_deny_keyword_in_path(self):
        """URL containing denied keyword 'admin' in the path should be rejected."""
        scope = _make_scope(deny_keywords=["admin"])
        validator = TargetValidator(scope)
        result = validator.validate_target("https://example.com/admin/panel")
        self.assertFalse(result.valid)
        self.assertIn("denied keyword", result.reason.lower())


# ===========================================================================
# TestTargetValidatorEdgeCases
# ===========================================================================

class TestTargetValidatorEdgeCases(unittest.TestCase):
    """Edge case and helper method tests."""

    def setUp(self):
        scope = _make_scope()
        self.validator = TargetValidator(scope)

    def test_invalid_format(self):
        """A gibberish string should return valid=False."""
        result = self.validator.validate_target("not a valid target!!!")
        self.assertFalse(result.valid)
        self.assertIn("invalid target format", result.reason.lower())

    def test_assert_in_scope_raises(self):
        """assert_in_scope should raise OutOfScopeError for out-of-scope targets."""
        with self.assertRaises(OutOfScopeError) as ctx:
            self.validator.assert_in_scope("evil.com")
        self.assertEqual(ctx.exception.target, "evil.com")
        self.assertIsNotNone(ctx.exception.reason)

    def test_helper_is_valid_ip(self):
        """Static helper is_valid_ip should correctly identify IPs."""
        self.assertTrue(TargetValidator.is_valid_ip("10.0.0.1"))
        self.assertFalse(TargetValidator.is_valid_ip("not-an-ip"))


if __name__ == "__main__":
    unittest.main()
