#!/usr/bin/env python3
"""
AutoPentest MCP Server - Main Entry Point
Unified MCP Server for AI-Powered Penetration Testing

Merges 10 TypeScript MCP servers + AIDA Python MCP into a single server
with ~70 tools sharing state (assessments, scope, evidence).
"""
import asyncio
import sys
import signal
import logging
from pathlib import Path

try:
    from mcp.server.models import InitializationOptions
    from mcp.server import NotificationOptions, Server
    from mcp.server.stdio import stdio_server
    from mcp.types import Tool, TextContent, Resource

    # Add parent directory to path for utils import
    sys.path.insert(0, str(Path(__file__).parent.parent))

    # Import structured logging
    from utils.logger import setup_logging, get_logger
    from config import settings

    # Setup logging for MCP server
    setup_logging(
        log_level=settings.LOG_LEVEL,
        log_format="json",
        log_dir=settings.LOG_DIR,
        enable_file_logging=False,
        enable_console_logging=False,
        max_bytes=settings.LOG_FILE_MAX_BYTES,
        backup_count=settings.LOG_FILE_BACKUP_COUNT
    )

    # Silence MCP SDK loggers to prevent stdout pollution
    for logger_name in ["mcp", "mcp.server", "mcp.server.stdio", "anyio", "httpx", "httpcore"]:
        sdk_logger = logging.getLogger(logger_name)
        sdk_logger.setLevel(logging.CRITICAL)
        sdk_logger.handlers = []
        sdk_logger.addHandler(logging.NullHandler())
        sdk_logger.propagate = False

    logger = get_logger(__name__)

    # Add modules directory to path
    sys.path.insert(0, str(Path(__file__).parent / "modules"))

    # Import core service and resources
    from modules.service import AutoPentestService
    from modules.resources import get_resources, handle_resource_read

    # Import tool modules - AIDA core tools (Phase 2)
    from modules.tools_assessment import get_assessment_tools, handle_assessment_tool
    from modules.tools_cards import get_cards_tools, handle_cards_tool
    from modules.tools_recon import get_recon_tools, handle_recon_tool
    from modules.tools_execution import get_execution_tools, handle_execution_tool
    from modules.tools_scanning import get_scanning_tools, handle_scanning_tool
    from modules.tools_credentials import get_credentials_tools, handle_credentials_tool

    # Import tool modules - Ported from TypeScript (Phase 3-5)
    from modules.tools_scope import get_scope_tools, handle_scope_tool
    from modules.tools_http import get_http_tools, handle_http_tool
    from modules.tools_fuzzer import get_fuzzer_tools, handle_fuzzer_tool
    from modules.tools_nuclei import get_nuclei_tools, handle_nuclei_tool
    from modules.tools_openapi import get_openapi_tools, handle_openapi_tool
    from modules.tools_validator import get_validator_tools, handle_validator_tool
    from modules.tools_evidence import get_evidence_tools, handle_evidence_tool
    from modules.tools_auth_tester import get_auth_tester_tools, handle_auth_tester_tool
    from modules.tools_world_model import get_world_model_tools, handle_world_model_tool
    from modules.tools_browser import get_browser_tools, handle_browser_tool
    from modules.tools_risk import get_risk_tools, handle_risk_tool

    # Import tool modules - Coverage engine + Recon pipeline (Phase 6+)
    from modules.tools_coverage import get_coverage_tools, handle_coverage_tool
    from modules.tools_recon_pipeline import get_recon_pipeline_tools, handle_recon_pipeline_tool

    # Import tool modules - Endpoint analysis engine
    from modules.tools_endpoint_analysis import get_endpoint_analysis_tools, handle_endpoint_analysis_tool

    # Import tool modules - Crawler + Business logic sequences
    from modules.tools_crawler import get_crawler_tools, handle_crawler_tool
    from modules.tools_sequences import get_sequence_tools, handle_sequence_tool

except Exception as e:
    import traceback
    print(f"FATAL MCP INIT ERROR: {e}", file=sys.stderr)
    traceback.print_exc(file=sys.stderr)
    sys.exit(1)

# ========== Registry-based tool dispatch ==========

# All tool module pairs: (get_tools_func, handler_func)
TOOL_MODULES = [
    # AIDA core tools (18 tools, includes 2 orchestration tools)
    (get_assessment_tools, handle_assessment_tool),
    (get_cards_tools, handle_cards_tool),
    (get_recon_tools, handle_recon_tool),
    (get_execution_tools, handle_execution_tool),
    (get_scanning_tools, handle_scanning_tool),
    (get_credentials_tools, handle_credentials_tool),
    # Ported from TypeScript MCP servers
    (get_scope_tools, handle_scope_tool),           # 6 tools
    (get_http_tools, handle_http_tool),             # 3 tools
    (get_fuzzer_tools, handle_fuzzer_tool),          # 3 tools
    (get_nuclei_tools, handle_nuclei_tool),          # 3 tools
    (get_openapi_tools, handle_openapi_tool),        # 6 tools
    (get_validator_tools, handle_validator_tool),     # 4 tools
    (get_evidence_tools, handle_evidence_tool),      # 4 tools
    (get_auth_tester_tools, handle_auth_tester_tool),# 3 tools
    (get_world_model_tools, handle_world_model_tool),# 16 tools
    (get_browser_tools, handle_browser_tool),        # 15 tools
    (get_risk_tools, handle_risk_tool),              # 3 tools
    # Coverage engine + Recon pipeline
    (get_coverage_tools, handle_coverage_tool),        # 4 tools
    (get_recon_pipeline_tools, handle_recon_pipeline_tool),  # 3 tools
    # Endpoint analysis engine
    (get_endpoint_analysis_tools, handle_endpoint_analysis_tool),  # 3 tools
    # Web crawler + Business logic sequences
    (get_crawler_tools, handle_crawler_tool),          # 3 tools
    (get_sequence_tools, handle_sequence_tool),         # 4 tools
]

# Build dispatch map: tool_name -> handler_func
TOOL_REGISTRY = {}
ALL_TOOLS = []

for get_tools_func, handler_func in TOOL_MODULES:
    tools = get_tools_func()
    ALL_TOOLS.extend(tools)
    for tool in tools:
        TOOL_REGISTRY[tool.name] = handler_func

# ========== MCP Server Setup ==========

server = Server("autopentest-mcp")
mcp_service = AutoPentestService()


@server.list_resources()
async def handle_list_resources() -> list[Resource]:
    """List available resources"""
    return get_resources()


@server.read_resource()
async def handle_read_resource(uri: str) -> str:
    """Read resource content"""
    return await handle_resource_read(uri, mcp_service)


@server.list_tools()
async def handle_list_tools() -> list[Tool]:
    """List all available MCP tools"""
    return ALL_TOOLS


@server.call_tool()
async def handle_call_tool_wrapper(name: str, arguments: dict) -> list[TextContent]:
    """Handle tool calls - registry-based dispatch"""
    try:
        await mcp_service.initialize()

        handler = TOOL_REGISTRY.get(name)
        if handler:
            return await handler(name, arguments, mcp_service)

        return [TextContent(type="text", text=f"Unknown tool: `{name}`")]

    except Exception as e:
        logger.error(f"Tool execution error: {e}", exc_info=True)
        return [TextContent(type="text", text=f"Error: {str(e)}")]


async def main():
    """Main server function"""

    def signal_handler(signum, frame):
        logger.info("Shutting down MCP server", signal=signum)
        sys.exit(0)

    signal.signal(signal.SIGINT, signal_handler)
    signal.signal(signal.SIGTERM, signal_handler)

    logger.info(
        "MCP server starting",
        server="autopentest-mcp",
        project="AutoPentest - Unified MCP Penetration Testing Server",
        version="1.0.0-alpha",
        tool_count=len(ALL_TOOLS),
        log_level=settings.LOG_LEVEL
    )

    # Initialize MCP service
    await mcp_service.initialize()

    try:
        async with stdio_server() as (read_stream, write_stream):
            await server.run(
                read_stream,
                write_stream,
                InitializationOptions(
                    server_name="autopentest-mcp",
                    server_version="1.0.0-alpha",
                    capabilities=server.get_capabilities(
                        notification_options=NotificationOptions(),
                        experimental_capabilities={}
                    )
                )
            )
    except Exception as e:
        logger.error("MCP server error", error=str(e), exc_info=True)
        raise
    finally:
        await mcp_service.cleanup()
        logger.info("MCP server shutdown complete")


if __name__ == "__main__":
    asyncio.run(main())
