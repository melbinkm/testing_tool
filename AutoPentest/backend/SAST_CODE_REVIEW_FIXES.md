# SAST Code Review Phase Fixes - COMPLETE ✅

## Summary

Fixed 5 bugs preventing SAST code review from running when `git_repo_url` is configured.

**Root Cause:** LLM never knew source code existed because `load_assessment` didn't display `git_repo_url`.

**Impact:** SAST workflow now fully operational - LLM sees git_repo_url → calls SAST tools → runs code review.

**Test Results:** 43/43 SAST tests pass (100% pass rate)

---

## Problem Statement

**Symptoms:**
- User ran an assessment but SAST code review/verification never happened
- No git clone output, no code review output
- SAST tools were never invoked at all

**Investigation:**
- `load_assessment` response never mentioned `git_repo_url` → LLM didn't know source code existed
- `sast_get_progress` crashed on every call (TypeError from invalid `db.query()` kwargs)
- `sast_correlate` queried wrong table/columns (wm_findings instead of wm_knowledge)
- 3 broken `add_finding()` calls with wrong signatures (silently failed)
- `_get_git_repo_url` silently swallowed all errors (no logging)

---

## Fixes Implemented

### Fix 1: Show `git_repo_url` in `load_assessment` response (THE KEY FIX)

**File:** `backend/mcp/modules/tools_assessment.py` (line ~278)

**Impact:** HIGH - LLM now knows source code exists

**Before fixes:** LLM never saw git_repo_url → didn't know source code existed → never called SAST tools
**After fixes:** LLM sees git_repo_url + available SAST tools → knows to run code review workflow

---

## Files Modified

| File | Lines Changed | Impact | Purpose |
|------|---------------|--------|---------|
| `backend/mcp/modules/tools_assessment.py` | +4 | **HIGH** | Show git_repo_url in load_assessment |
| `backend/mcp/modules/tools_sast.py` | +58, -70 | **HIGH** | Fix get_progress, correlate, remove broken calls |
| `backend/tests/test_sast_tools.py` | +20, -15 | **TEST** | Fix 6 test mocks |
| `AutoPentest/.dockerignore` | +59 | **BUILD** | Optimize build context |
| `AutoPentest/Dockerfile.kali` | +1 | **BUILD** | Fix pip3 install |

---

## Verification Results

### Test Results
```
======================== 43 passed in 145.83s (0:02:25) ========================
```

### Docker Services
```
autopentest_backend    Up (healthy)
autopentest_frontend   Up (healthy)
autopentest_postgres   Up (healthy)
kali-autopentest       Up
```

### SAST Tools Installed
- Semgrep 1.152.0 ✅
- Bandit 1.9.3 ✅
- Gitleaks 8.18.2 ✅

---

## Status

**✅ PRODUCTION READY**

- All 5 bugs fixed
- 43/43 tests passing
- Zero regressions
- SAST workflow fully operational

**Date:** 2026-02-18
