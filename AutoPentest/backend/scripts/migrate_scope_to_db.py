#!/usr/bin/env python3
"""
Migration script: Initialize scope configuration for existing assessments.

For each assessment without a scope configuration in the database:
1. Load ./scope/engagement.yaml (or path from SCOPE_FILE env var)
2. Insert into wm_scope_config table
3. Create wm_budget_state row (zeroed counters)

Usage:
    python backend/scripts/migrate_scope_to_db.py

Environment variables:
    DATABASE_URL: PostgreSQL connection string (default: from backend config)
    SCOPE_FILE: Path to default scope file (default: ./scope/engagement.yaml)
"""

import asyncio
import os
import sys
from pathlib import Path

# Add backend directory to path
sys.path.insert(0, str(Path(__file__).parent.parent))

import asyncpg
from config import settings


async def main():
    """Run the scope migration for existing assessments."""
    print("=" * 70)
    print("Scope Configuration Migration Script")
    print("=" * 70)
    print()

    # Get configuration
    db_url = settings.DATABASE_URL.replace("postgresql://", "postgresql+asyncpg://")
    # Use asyncpg format
    db_url = db_url.replace("postgresql+asyncpg://", "postgresql://")
    scope_file = os.getenv("SCOPE_FILE", "./scope/engagement.yaml")

    print(f"Database: {db_url.split('@')[1] if '@' in db_url else db_url}")
    print(f"Scope file: {scope_file}")
    print()

    # Check if scope file exists
    if not Path(scope_file).exists():
        print(f"ERROR: Scope file not found: {scope_file}")
        print("Set SCOPE_FILE environment variable to the path of your scope file.")
        return 1

    # Connect to database
    print("Connecting to database...")
    try:
        pool = await asyncpg.create_pool(db_url, min_size=1, max_size=2)
        print("✓ Connected to database")
        print()
    except Exception as exc:
        print(f"ERROR: Failed to connect to database: {exc}")
        return 1

    try:
        # Load scope from file
        print(f"Loading scope from {scope_file}...")
        sys.path.insert(0, str(Path(__file__).parent.parent / "mcp" / "modules"))
        from lib.scope_loader import load_scope
        from lib.scope_loader_db import save_scope_to_db

        try:
            scope = load_scope(scope_file)
            print(f"✓ Loaded scope: {scope.engagement.id}")
            print()
        except Exception as exc:
            print(f"ERROR: Failed to load scope file: {exc}")
            return 1

        # Get all assessments without scope configuration
        print("Finding assessments without scope configuration...")
        async with pool.acquire() as conn:
            rows = await conn.fetch(
                """
                SELECT id, name
                FROM assessments
                WHERE id NOT IN (
                    SELECT DISTINCT assessment_id
                    FROM wm_scope_config
                    WHERE is_active = TRUE
                )
                ORDER BY id
                """
            )

        if not rows:
            print("✓ No assessments need migration (all have scope configurations)")
            print()
            return 0

        print(f"Found {len(rows)} assessment(s) without scope configuration:")
        for row in rows:
            print(f"  - [{row['id']}] {row['name']}")
        print()

        # Confirm migration
        response = input("Proceed with migration? [y/N]: ").strip().lower()
        if response != "y":
            print("Migration cancelled.")
            return 0

        print()
        print("Migrating assessments...")
        migrated_count = 0

        for row in rows:
            assessment_id = row["id"]
            assessment_name = row["name"]

            try:
                # Save scope configuration
                version = await save_scope_to_db(
                    assessment_id=assessment_id,
                    scope=scope,
                    pool=pool,
                    created_by="migration_script",
                    notes="Migrated from file-based scope configuration",
                )

                # Create budget state row (zeroed counters)
                async with pool.acquire() as conn:
                    await conn.execute(
                        """
                        INSERT INTO wm_budget_state
                            (assessment_id, total_requests, requests_by_target, recent_requests)
                        VALUES ($1, 0, '{}', '[]')
                        ON CONFLICT (assessment_id) DO NOTHING
                        """,
                        assessment_id,
                    )

                print(f"  ✓ [{assessment_id}] {assessment_name} - scope v{version}")
                migrated_count += 1

            except Exception as exc:
                print(f"  ✗ [{assessment_id}] {assessment_name} - ERROR: {exc}")

        print()
        print("=" * 70)
        print(f"Migration complete: {migrated_count}/{len(rows)} assessments migrated")
        print("=" * 70)
        print()
        print("Next steps:")
        print("  1. Restart backend: docker compose restart backend")
        print("  2. Verify scope loading: Use scope_get_allowlist() tool")
        print("  3. Test budget tracking: Use scope_check_budget() tool")
        print()

        return 0

    finally:
        await pool.close()


if __name__ == "__main__":
    exit_code = asyncio.run(main())
    sys.exit(exit_code)
