-- Create activity_log table for comprehensive assessment activity tracking
-- Run with: docker exec -i autopentest_postgres psql -U autopentest -d autopentest_db < backend/scripts/create_activity_log_table.sql

-- Create activity_log table (without DROP for production safety)
CREATE TABLE IF NOT EXISTS activity_log (
    id SERIAL PRIMARY KEY,
    assessment_id INTEGER NOT NULL REFERENCES assessments(id) ON DELETE CASCADE,
    activity_type VARCHAR(50) NOT NULL,  -- tool_execution, phase_transition, finding_created, scan_started, scan_completed, recon_data, world_model_update, error
    timestamp TIMESTAMP NOT NULL,
    data JSONB NOT NULL,  -- Full log entry with all details
    created_at TIMESTAMP DEFAULT NOW()
);

-- Create indexes
CREATE INDEX IF NOT EXISTS idx_activity_assessment ON activity_log(assessment_id);
CREATE INDEX IF NOT EXISTS idx_activity_type ON activity_log(activity_type);
CREATE INDEX IF NOT EXISTS idx_activity_timestamp ON activity_log(timestamp DESC);
CREATE INDEX IF NOT EXISTS idx_activity_type_assessment ON activity_log(activity_type, assessment_id);

-- GIN index for JSONB queries
CREATE INDEX IF NOT EXISTS idx_activity_data_gin ON activity_log USING GIN(data);

-- Comments
COMMENT ON TABLE activity_log IS 'Comprehensive activity logging for assessments - tracks all tool executions, phase transitions, findings, scans, and errors';
COMMENT ON COLUMN activity_log.activity_type IS 'Type of activity: tool_execution, phase_transition, finding_created, scan_started, scan_completed, recon_data, world_model_update, error';
COMMENT ON COLUMN activity_log.data IS 'Full JSON log entry with all contextual details specific to the activity type';

-- Grant permissions (adjust based on your user setup)
-- GRANT SELECT, INSERT ON activity_log TO autopentest;
-- GRANT USAGE, SELECT ON SEQUENCE activity_log_id_seq TO autopentest;

-- Sample query patterns for reference:
-- 1. Get all activities for an assessment: SELECT * FROM activity_log WHERE assessment_id = 6 ORDER BY timestamp DESC;
-- 2. Get tool executions only: SELECT * FROM activity_log WHERE activity_type = 'tool_execution' AND assessment_id = 6;
-- 3. Get phase transitions: SELECT data FROM activity_log WHERE activity_type = 'phase_transition' ORDER BY timestamp;
-- 4. Find errors: SELECT data FROM activity_log WHERE activity_type = 'error';
-- 5. JSON query example: SELECT data->'tool_name' as tool, data->'status' as status FROM activity_log WHERE activity_type = 'tool_execution';
