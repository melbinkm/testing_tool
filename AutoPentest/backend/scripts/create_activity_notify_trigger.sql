-- PostgreSQL NOTIFY trigger for real-time activity feed
-- Creates a trigger that notifies the activity_bridge when new activity_log entries are inserted

-- Drop existing trigger and function if they exist
DROP TRIGGER IF EXISTS activity_log_notify ON activity_log;
DROP FUNCTION IF EXISTS notify_activity_event();

-- Create notification function
CREATE OR REPLACE FUNCTION notify_activity_event() RETURNS trigger AS $$
DECLARE
    payload_json TEXT;
BEGIN
    -- Build JSON payload with activity data
    payload_json := json_build_object(
        'id', NEW.id,
        'assessment_id', NEW.assessment_id,
        'activity_type', NEW.activity_type,
        'timestamp', NEW.timestamp,
        'data', NEW.data
    )::TEXT;

    -- Truncate payload to PostgreSQL NOTIFY limit (7900 bytes for safety)
    -- This prevents "payload string too long" errors
    IF LENGTH(payload_json) > 7900 THEN
        payload_json := LEFT(payload_json, 7900);
    END IF;

    -- Send notification on 'activity_events' channel
    PERFORM pg_notify('activity_events', payload_json);

    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

-- Create trigger that fires after each INSERT
CREATE TRIGGER activity_log_notify
    AFTER INSERT ON activity_log
    FOR EACH ROW
    EXECUTE FUNCTION notify_activity_event();

-- Grant necessary permissions (adjust role name as needed)
-- GRANT EXECUTE ON FUNCTION notify_activity_event() TO autopentest_user;

-- Verification query (for psql only, commented out for asyncpg):
-- SELECT tgname, tgenabled FROM pg_trigger WHERE tgname = 'activity_log_notify';
