"""
Logging context management for propagating contextual information across logs
Uses contextvars for async-safe context propagation
"""
import uuid
from contextlib import contextmanager
from contextvars import ContextVar
from typing import Any, Dict, Generator, Optional

import structlog

# Context variables for request tracking
request_id_var: ContextVar[Optional[str]] = ContextVar("request_id", default=None)
assessment_id_var: ContextVar[Optional[int]] = ContextVar("assessment_id", default=None)
user_id_var: ContextVar[Optional[str]] = ContextVar("user_id", default=None)


def generate_request_id() -> str:
    """Generate a unique request ID"""
    return str(uuid.uuid4())[:8]


def set_request_id(request_id: str) -> None:
    """Set request ID in context"""
    request_id_var.set(request_id)
    structlog.contextvars.bind_contextvars(request_id=request_id)


def set_assessment_id(assessment_id: int) -> None:
    """Set assessment ID in context"""
    assessment_id_var.set(assessment_id)
    structlog.contextvars.bind_contextvars(assessment_id=assessment_id)


def set_container_name(container_name: str) -> None:
    """Set container name in context"""
    structlog.contextvars.bind_contextvars(container_name=container_name)


@contextmanager
def request_context(
    request_id: Optional[str] = None,
    assessment_id: Optional[int] = None,
    user_id: Optional[str] = None
) -> Generator[str, None, None]:
    """
    Context manager for HTTP request tracking

    Args:
        request_id: Request ID (auto-generated if not provided)
        assessment_id: Assessment ID if applicable
        user_id: User ID if authenticated

    Yields:
        request_id: The request ID for this context

    Example:
        with request_context(assessment_id=123) as req_id:
            logger.info("Processing request")
    """
    # Generate request ID if not provided
    if request_id is None:
        request_id = generate_request_id()

    # Build context
    context: Dict[str, Any] = {"request_id": request_id}
    if assessment_id is not None:
        context["assessment_id"] = assessment_id
        assessment_id_var.set(assessment_id)
    if user_id is not None:
        context["user_id"] = user_id
        user_id_var.set(user_id)

    # Set request ID
    request_id_var.set(request_id)

    # Bind all context
    structlog.contextvars.bind_contextvars(**context)

    try:
        yield request_id
    finally:
        # Clear context after request
        structlog.contextvars.unbind_contextvars(*context.keys())
        request_id_var.set(None)
        if assessment_id is not None:
            assessment_id_var.set(None)
        if user_id is not None:
            user_id_var.set(None)
