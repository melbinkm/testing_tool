# load_assessment skip_data Fix - COMPLETE ✅

## Problem

When `load_assessment(name="...", skip_data=true)` was called, it returned only:
```
"Assessment 'InvoiceFlow2' loaded successfully."
```

This **hid critical information** including:
- `git_repo_url` → LLM didn't know SAST tools were available
- `target_domains` / `ip_scopes` → LLM couldn't see scope configuration
- `ports` → LLM couldn't construct base URLs

**Impact:** LLM skipped SAST workflow even when source code was available.

## What is skip_data?

The `skip_data` parameter is meant to skip **verbose output** to save tokens:
- Workspace tree structure (can be 50+ lines)
- Context documents list (20+ lines)
- Client info, environment notes, detailed scope descriptions

**It should NOT hide critical configuration needed for tool selection.**

## Solution

Modified `skip_data=True` response to show critical configuration while still skipping verbose parts.

### Code Change

**File:** `backend/mcp/modules/tools_assessment.py` (lines 265-283)

**Before:**
```python
if skip_data:
    return [TextContent(
        type="text",
        text=f"Assessment '{assessment_name}' loaded successfully."
    )]
```

**After:**
```python
if skip_data:
    # Show critical config even with skip_data (Fix: SAST visibility)
    response = f"Assessment '{assessment_name}' loaded successfully.\n\n"

    # Show target scope
    if assessment.get("target_domains"):
        response += f"**Target Domains:** {', '.join(assessment['target_domains'])}\n"
    if assessment.get("ip_scopes"):
        response += f"**IP Scopes:** {', '.join(assessment['ip_scopes'])}\n"
    if assessment.get("ports"):
        response += f"**Ports:** {', '.join(str(p) for p in assessment['ports'])}\n"

    # Show git_repo_url if present (CRITICAL for SAST workflow)
    if assessment.get('git_repo_url'):
        response += f"\n**Git Repository:** {assessment['git_repo_url']}\n"
        response += "  → SAST tools available: `sast_clone_repo`, `sast_scan_semgrep`, `sast_scan_bandit`, `sast_scan_gitleaks`\n"
        response += "  → Run SAST scans in Phase 2 before advancing to Phase 3\n"

    return [TextContent(type="text", text=response)]
```

## Output Examples

### Example 1: Assessment with git_repo_url

**Input:**
```python
load_assessment(name="InvoiceFlow2", skip_data=true)
```

**Output (BEFORE fix):**
```
Assessment 'InvoiceFlow2' loaded successfully.
```

**Output (AFTER fix):**
```
Assessment 'InvoiceFlow2' loaded successfully.

**IP Scopes:** 172.26.240.78
**Ports:** 5000

**Git Repository:** https://github.com/melbinkm/InvoiceFlow.git
  → SAST tools available: `sast_clone_repo`, `sast_scan_semgrep`, `sast_scan_bandit`, `sast_scan_gitleaks`
  → Run SAST scans in Phase 2 before advancing to Phase 3
```

### Example 2: Assessment without git_repo_url

**Input:**
```python
load_assessment(name="Example", skip_data=true)
```

**Output:**
```
Assessment 'Example' loaded successfully.

**Target Domains:** https://example.com
**Ports:** 443
```

### Example 3: Assessment with no scope configured

**Input:**
```python
load_assessment(name="Empty", skip_data=true)
```

**Output:**
```
Assessment 'Empty' loaded successfully.
```

## What skip_data Still Skips

When `skip_data=true`, the following verbose sections are **still skipped** (saving ~100+ lines):

✅ Skipped:
- Workspace tree structure
- Context documents list
- Client name, environment notes, detailed scope descriptions
- Phase status details
- Verbose formatting

❌ NOT skipped (critical for LLM decision-making):
- git_repo_url + available SAST tools
- Target domains / IP scopes
- Ports

## Impact

**Before fix:**
- Autonomous runbook used `skip_data=true` → hid git_repo_url
- LLM advanced to Phase 3 without running SAST scans
- Source code vulnerabilities missed

**After fix:**
- Autonomous runbook uses `skip_data=true` → shows git_repo_url
- LLM sees "SAST tools available" → runs SAST scans in Phase 2
- Source code vulnerabilities detected

## Testing

**Test 1: Load with skip_data=true (has git_repo_url)**
```python
load_assessment(name="InvoiceFlow2", skip_data=true)
```
Expected: Shows git_repo_url + SAST tools prompt

**Test 2: Load with skip_data=false (has git_repo_url)**
```python
load_assessment(name="InvoiceFlow2")
```
Expected: Shows git_repo_url + SAST tools + full workspace tree + context docs

**Test 3: Load with skip_data=true (no git_repo_url)**
```python
load_assessment(name="Example", skip_data=true)
```
Expected: Shows scope info, no SAST tools

## Files Modified

- `backend/mcp/modules/tools_assessment.py` (+17 lines)

## Status

**✅ DEPLOYED** - Backend restarted with fix

**Date:** 2026-02-18

---

## User Impact

Users running assessments with source code will now see SAST tools recommended even when using `skip_data=true`, ensuring the SAST workflow is not accidentally skipped.
