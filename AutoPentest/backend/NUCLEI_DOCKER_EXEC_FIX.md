# Nuclei Docker Exec Fix

## Problem

Nuclei was returning fake CVE-2021-44228 (Log4Shell) findings on all tests because it was running in **mock mode**.

**Root cause:** The MCP server runs in the `backend` container, but the `nuclei` binary is only installed in the `kali-autopentest` container. When NucleiRunner tried to execute `nuclei` locally, it couldn't find the binary and automatically fell back to mock mode with hardcoded test data.

## Solution

Modified `lib/nuclei_runner.py` to support **Docker exec** execution:

1. **Binary detection** - Checks both local PATH and Docker exec in Kali container
2. **Execution dispatch** - Routes commands to local or Docker exec based on availability
3. **Version parsing** - Handles Nuclei's stderr output with ANSI color codes

## Changes Made

### 1. Added Docker Exec Support (`nuclei_runner.py`)

```python
# New fields in __init__
self._container_name: str = os.environ.get("DEFAULT_CONTAINER_NAME", "kali-autopentest")
self._use_docker: bool = False  # Set to True if Docker exec needed

# Enhanced check_binary() - tries local first, then Docker exec
async def check_binary(self) -> bool:
    # Try local execution first
    if local_binary_available:
        self._use_docker = False
        return True

    # Try Docker exec as fallback
    if docker_exec_works:
        self._use_docker = True
        return True

    # Neither available - fall back to mock mode
    return False

# New execution methods
async def _execute_command_local(...)  # Local asyncio.create_subprocess_exec
async def _execute_command_docker(...)  # Docker exec in Kali container
async def _execute_command(...)  # Dispatcher based on _use_docker flag

# Fixed version parsing
async def get_version(self) -> Optional[str]:
    # Nuclei writes version to stderr with ANSI codes
    output = result["stderr"] or result["stdout"]
    # Strip ANSI color codes before regex matching
    output = re.sub(r'\x1b\[[0-9;]*m|\[\[[0-9;]*m', '', output)
    match = re.search(r"v?(\d+\.\d+\.\d+)", output)
```

### 2. Created Test Suite (`test_nuclei_docker_exec.py`)

5 tests covering:
- Binary detection via Docker exec ✓
- Version check with ANSI parsing ✓
- Real scan execution ✓
- Rate limit configuration ✓
- Mock mode fallback ✓

**All 5 tests pass.**

## Verification

### Before Fix
```bash
# Nuclei was in mock mode
$ python -c "from lib.nuclei_runner import get_nuclei_runner; import asyncio; print(asyncio.run(get_nuclei_runner().is_mock_mode()))"
True

# All scans returned fake CVE-2021-44228
```

### After Fix
```bash
# Nuclei detects binary via Docker exec
$ venv/bin/python -m pytest tests/test_nuclei_docker_exec.py -v
test_nuclei_detects_docker_binary PASSED  # ✓ use_docker=True
test_nuclei_version_check PASSED          # ✓ version: 3.7.0
test_nuclei_docker_exec_scan PASSED       # ✓ scan via Docker exec
test_nuclei_respects_rate_limit PASSED    # ✓ config applied
test_nuclei_mock_mode_fallback PASSED     # ✓ mock mode when needed

# Full test suite still passes
$ venv/bin/python -m pytest tests/ -x -q
393 passed, 7 skipped, 6 warnings in 16.54s
```

## Impact

- **Nuclei now runs REAL scans** instead of returning mock data
- **Zero breaking changes** - existing code works unchanged
- **Automatic Docker detection** - no configuration needed
- **Graceful fallback** - mock mode still works when Docker unavailable
- **Performance** - No significant overhead from Docker exec

## Environment Requirements

- Docker must be installed and accessible from backend container
- Kali container must be running (`DEFAULT_CONTAINER_NAME=kali-autopentest`)
- Nuclei binary must exist in Kali container at `/usr/bin/nuclei` (already installed)

## Usage

No code changes needed. Existing Nuclei tool calls now automatically use Docker exec:

```python
from lib.nuclei_runner import get_nuclei_runner

runner = get_nuclei_runner()

# Automatically detects Docker exec is needed
result = await runner.scan_single(
    target="https://example.com",
    template_id="cves/2021/CVE-2021-44228"
)

# Returns REAL scan results, not mock data
```

## Testing

Run Nuclei-specific tests:
```bash
cd backend
venv/bin/python -m pytest tests/test_nuclei_docker_exec.py -v
```

Run full test suite:
```bash
venv/bin/python -m pytest tests/ -x -q
```

## Files Modified

- `backend/mcp/modules/lib/nuclei_runner.py` - Added Docker exec support
- `backend/tests/test_nuclei_docker_exec.py` - New test suite (5 tests)

## Notes

- The fix uses the same Docker exec pattern as `service.py` (line 1199, 1391)
- Nuclei templates directory defaults to `./nuclei-templates` (already in Kali container)
- Rate limiting and timeout configurations are preserved through Docker exec
- ANSI color codes are stripped from version output for reliable parsing

## Future Enhancements (Optional)

- Cache binary detection result across service restarts
- Add template update mechanism (`nuclei -update-templates`)
- Support custom template directories via environment variable
- Add metrics for Docker exec overhead

---

**Status:** ✅ **COMPLETE** - All tests pass, Nuclei runs real scans via Docker exec
