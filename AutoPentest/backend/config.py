"""
Configuration for AutoPentest - Unified MCP Penetration Testing Server
"""
import os
from typing import Optional
from pydantic import field_validator
from pydantic_settings import BaseSettings


class Settings(BaseSettings):
    """Application settings"""

    # Application Metadata
    PROJECT_NAME: str = "AutoPentest"
    PROJECT_TAGLINE: str = "Unified MCP Penetration Testing Server"
    PROJECT_DESCRIPTION: str = "Unified autonomous penetration testing powered by AI"
    VERSION: str = "1.0.0-alpha"
    API_V1_PREFIX: str = "/api"

    # Database Credentials
    POSTGRES_USER: str = "autopentest"
    POSTGRES_PASSWORD: str = "autopentest"
    POSTGRES_DB: str = "autopentest_db"
    POSTGRES_HOST: str = "localhost"
    POSTGRES_PORT: str = "5432"

    # Database URL (will be constructed in validator if not provided)
    DATABASE_URL: Optional[str] = None

    # CORS - Will be parsed from comma-separated string
    BACKEND_CORS_ORIGINS: str = "http://localhost:5173,http://localhost:3000"

    # Container Configuration (Kali pentesting container)
    CONTAINER_WORKSPACE_BASE: str = "/workspace"
    DEFAULT_CONTAINER_NAME: str = "kali-autopentest"
    COMMAND_TIMEOUT: int = 300  # seconds (5 minutes default)

    # Logging
    LOG_LEVEL: str = "INFO"
    LOG_FORMAT: str = "json"  # json or console
    LOG_DIR: str = "logs"
    LOG_FILE_ENABLED: bool = True
    LOG_CONSOLE_ENABLED: bool = True
    LOG_FILE_MAX_BYTES: int = 10485760  # 10MB
    LOG_FILE_BACKUP_COUNT: int = 5

    # Backend API URL (for MCP server)
    BACKEND_API_URL: str = "http://localhost:8000/api"

    # MCP Data Paths (used by MCP tool modules via os.environ)
    EVIDENCE_DIR: str = "./evidence"

    # Environment
    ENVIRONMENT: str = "development"
    DEBUG: bool = False

    @field_validator('DATABASE_URL', mode='before')
    @classmethod
    def construct_database_url(cls, v: Optional[str], values) -> str:
        """Construct DATABASE_URL from components if not provided"""
        if v:
            return v

        # Get values from environment or defaults
        user = os.getenv("POSTGRES_USER", "autopentest")
        password = os.getenv("POSTGRES_PASSWORD", "autopentest")
        host = os.getenv("POSTGRES_HOST", "localhost")
        port = os.getenv("POSTGRES_PORT", "5432")
        db = os.getenv("POSTGRES_DB", "autopentest_db")

        return f"postgresql://{user}:{password}@{host}:{port}/{db}"

    @field_validator('BACKEND_CORS_ORIGINS', mode='after')
    @classmethod
    def parse_cors_origins(cls, v: str) -> list[str]:
        """Parse CORS origins from comma-separated string to list"""
        if isinstance(v, list):
            return v
        return [origin.strip() for origin in v.split(",") if origin.strip()]

    @field_validator('LOG_FILE_ENABLED', 'LOG_CONSOLE_ENABLED', 'DEBUG', mode='before')
    @classmethod
    def parse_bool(cls, v):
        """Parse boolean from string"""
        if isinstance(v, bool):
            return v
        if isinstance(v, str):
            return v.lower() in ('true', '1', 'yes', 'on')
        return bool(v)

    class Config:
        env_file = ".env"
        case_sensitive = True


settings = Settings()
