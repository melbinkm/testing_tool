"""
Main FastAPI application
"""
from fastapi import FastAPI
from fastapi.middleware.cors import CORSMiddleware

from config import settings
from database import init_db, create_wm_tables
from api import assessments, cards, recon, sections, containers, folders, global_commands, search, system, credentials, websocket, workspace, pending_commands, context_documents, activity_log
from api import commands
from api.commands import global_router as commands_global_router
from utils.logger import setup_logging, get_logger
from middleware.logging_middleware import LoggingMiddleware
from websocket.manager import manager as ws_manager
from websocket.activity_bridge import start_activity_bridge, stop_activity_bridge

# Setup structured logging
setup_logging(
    log_level=settings.LOG_LEVEL,
    log_format=settings.LOG_FORMAT,
    log_dir=settings.LOG_DIR,
    enable_file_logging=settings.LOG_FILE_ENABLED,
    enable_console_logging=settings.LOG_CONSOLE_ENABLED,
    max_bytes=settings.LOG_FILE_MAX_BYTES,
    backup_count=settings.LOG_FILE_BACKUP_COUNT
)

logger = get_logger(__name__)

# Create FastAPI app
app = FastAPI(
    title=settings.PROJECT_NAME,
    version=settings.VERSION,
    description=settings.PROJECT_TAGLINE
)

# Configure logging middleware (before CORS)
app.add_middleware(LoggingMiddleware)

# Configure CORS
app.add_middleware(
    CORSMiddleware,
    allow_origins=settings.BACKEND_CORS_ORIGINS,
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)

# Include routers
app.include_router(assessments.router, prefix=settings.API_V1_PREFIX)
app.include_router(cards.router, prefix=settings.API_V1_PREFIX)
app.include_router(recon.router, prefix=settings.API_V1_PREFIX)
app.include_router(commands.router, prefix=settings.API_V1_PREFIX)
app.include_router(commands_global_router, prefix=settings.API_V1_PREFIX)  # Global commands view
app.include_router(credentials.router, prefix=settings.API_V1_PREFIX)
app.include_router(global_commands.router, prefix=settings.API_V1_PREFIX)
app.include_router(search.router, prefix=settings.API_V1_PREFIX)
app.include_router(system.router, prefix=settings.API_V1_PREFIX)
app.include_router(sections.router, prefix=settings.API_V1_PREFIX)
app.include_router(containers.router, prefix=settings.API_V1_PREFIX)
app.include_router(folders.router, prefix=settings.API_V1_PREFIX)
app.include_router(workspace.router, prefix=settings.API_V1_PREFIX)
app.include_router(websocket.router, prefix=settings.API_V1_PREFIX)
app.include_router(pending_commands.router, prefix=settings.API_V1_PREFIX)  # Pending commands
app.include_router(pending_commands.settings_router, prefix=settings.API_V1_PREFIX)  # Command settings
app.include_router(context_documents.router, prefix=settings.API_V1_PREFIX)  # Context documents
app.include_router(activity_log.router, prefix=settings.API_V1_PREFIX)  # Activity logging


async def _ensure_activity_log_table():
    """Ensure activity_log table and NOTIFY trigger exist."""
    import asyncpg
    import os
    from pathlib import Path

    try:
        conn = await asyncpg.connect(settings.DATABASE_URL)
        try:
            # Read and execute table creation script
            scripts_dir = Path(__file__).parent / "scripts"
            table_sql = (scripts_dir / "create_activity_log_table.sql").read_text()
            trigger_sql = (scripts_dir / "create_activity_notify_trigger.sql").read_text()

            # Execute table creation (idempotent - uses IF NOT EXISTS)
            await conn.execute(table_sql)
            # Execute trigger creation (has DROP IF EXISTS for idempotency)
            await conn.execute(trigger_sql)

            logger.info("Activity log table and trigger initialized successfully")
        finally:
            await conn.close()
    except Exception as e:
        logger.error(f"Failed to ensure activity_log table: {e}", exc_info=True)
        # Non-fatal - continue startup


@app.on_event("startup")
async def startup_event():
    """Initialize database and services on startup"""
    init_db()
    await create_wm_tables()

    # Round 11 Fix 2A: Ensure activity_log table and trigger exist
    await _ensure_activity_log_table()

    # Start activity bridge for real-time WebSocket notifications
    try:
        await start_activity_bridge(settings.DATABASE_URL, ws_manager)
        logger.info("Activity bridge started successfully")
    except Exception as e:
        logger.error(f"Failed to start activity bridge: {e}", exc_info=True)
        # Continue startup even if bridge fails - not critical

    logger.info(
        "Application started",
        project=settings.PROJECT_NAME,
        version=settings.VERSION,
        database=settings.DATABASE_URL.split("@")[-1],  # Hide credentials
        workspace=settings.CONTAINER_WORKSPACE_BASE,
        log_level=settings.LOG_LEVEL,
        log_format=settings.LOG_FORMAT
    )


@app.on_event("shutdown")
async def shutdown_event():
    """Clean up resources on shutdown"""
    try:
        await stop_activity_bridge()
        logger.info("Activity bridge stopped")
    except Exception as e:
        logger.error(f"Error stopping activity bridge: {e}", exc_info=True)

    logger.info("Application shutdown complete")


@app.get("/")
async def root():
    """Root endpoint"""
    return {
        "message": f"{settings.PROJECT_NAME} API",
        "tagline": settings.PROJECT_TAGLINE,
        "version": settings.VERSION,
        "docs": "/docs"
    }


@app.get("/health")
async def health():
    """Health check endpoint"""
    return {"status": "healthy"}
