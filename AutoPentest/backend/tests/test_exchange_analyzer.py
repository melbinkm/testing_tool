"""
Tests for ExchangeAnalyzer - Per-request/response analysis for test recommendations.
"""

import os
import sys
import unittest

sys.path.insert(0, os.path.join(os.path.dirname(__file__), "..", "mcp", "modules"))

from lib.exchange_analyzer import get_exchange_analyzer, ExchangeAnalysis


class TestExchangeAnalyzer(unittest.TestCase):
    """Test exchange analyzer functionality."""

    def setUp(self):
        """Set up test fixtures."""
        self.analyzer = get_exchange_analyzer()

    def test_cors_wildcard_detection(self):
        """Test detection of wildcard CORS policy."""
        request = {
            'method': 'GET',
            'url': 'https://example.com/api/users',
            'headers': {},
            'parameters': []
        }

        response = {
            'status': 200,
            'headers': {
                'Access-Control-Allow-Origin': '*',
                'Content-Type': 'application/json'
            },
            'body': '{"users": []}'
        }

        analysis = self.analyzer.analyze(request, response)

        self.assertIn('cors_misconfig', analysis.recommended_tests)
        self.assertGreater(analysis.priority_adjustments.get('cors_misconfig', 0), 0)

        # Check risk signals
        cors_signals = [s for s in analysis.risk_signals if s['type'] == 'cors_wildcard']
        self.assertGreater(len(cors_signals), 0)

    def test_cors_with_credentials(self):
        """Test CORS with credentials (critical misconfiguration)."""
        request = {'method': 'GET', 'url': 'https://example.com/api', 'headers': {}, 'parameters': []}
        response = {
            'status': 200,
            'headers': {
                'Access-Control-Allow-Origin': 'https://evil.com',
                'Access-Control-Allow-Credentials': 'true'
            },
            'body': '{}'
        }

        analysis = self.analyzer.analyze(request, response)

        self.assertIn('cors_misconfig', analysis.recommended_tests)
        cors_priority = analysis.priority_adjustments.get('cors_misconfig', 0)
        self.assertGreater(cors_priority, 5)  # Should get priority boost

    def test_cookie_security_missing_flags(self):
        """Test detection of insecure cookie attributes."""
        request = {'method': 'POST', 'url': 'https://example.com/login', 'headers': {}, 'parameters': []}
        response = {
            'status': 200,
            'headers': {
                'Set-Cookie': 'session=abc123; Path=/',  # Missing Secure, HttpOnly, SameSite
            },
            'body': '{}'
        }

        analysis = self.analyzer.analyze(request, response)

        self.assertIn('cookie_security', analysis.recommended_tests)

        # Should have multiple risk signals for missing flags
        cookie_signals = [s for s in analysis.risk_signals if 'cookie' in s['type'].lower()]
        self.assertGreaterEqual(len(cookie_signals), 1)

    def test_csrf_missing_token(self):
        """Test detection of forms without CSRF tokens."""
        request = {'method': 'GET', 'url': 'https://example.com/form', 'headers': {}, 'parameters': []}
        response = {
            'status': 200,
            'headers': {'Content-Type': 'text/html'},
            'body': '''
                <html>
                <form method="POST" action="/submit">
                    <input name="email" />
                    <button type="submit">Submit</button>
                </form>
                </html>
            '''
        }

        analysis = self.analyzer.analyze(request, response)

        self.assertIn('csrf', analysis.recommended_tests)

        csrf_signals = [s for s in analysis.risk_signals if s['type'] == 'missing_csrf_token']
        self.assertGreater(len(csrf_signals), 0)

    def test_server_version_disclosure(self):
        """Test detection of server version in headers."""
        request = {'method': 'GET', 'url': 'https://example.com/', 'headers': {}, 'parameters': []}
        response = {
            'status': 200,
            'headers': {
                'Server': 'Apache/2.4.41 (Ubuntu)',
                'X-Powered-By': 'PHP/7.4.3'
            },
            'body': 'Hello'
        }

        analysis = self.analyzer.analyze(request, response)

        self.assertIn('info_leak_headers', analysis.recommended_tests)
        self.assertIn('Apache/2.4.41 (Ubuntu)', analysis.detected_technologies)
        self.assertIn('X-Powered-By: PHP/7.4.3', analysis.detected_technologies)

    def test_missing_security_headers(self):
        """Test detection of missing security headers."""
        request = {'method': 'GET', 'url': 'https://example.com/', 'headers': {}, 'parameters': []}
        response = {
            'status': 200,
            'headers': {
                'Content-Type': 'text/html'
                # Missing: CSP, X-Frame-Options, HSTS, etc.
            },
            'body': '<html><body>Hello</body></html>'
        }

        analysis = self.analyzer.analyze(request, response)

        # Should recommend clickjacking and XSS DOM tests due to missing CSP
        self.assertIn('clickjacking', analysis.recommended_tests)
        self.assertIn('xss_dom', analysis.recommended_tests)

    def test_parameter_reflection_xss(self):
        """Test detection of parameter reflection (XSS indicator)."""
        request = {
            'method': 'GET',
            'url': 'https://example.com/search?q=test',
            'headers': {},
            'parameters': [
                {'name': 'q', 'value': 'test'}
            ]
        }

        response = {
            'status': 200,
            'headers': {'Content-Type': 'text/html'},
            'body': '<html><body>Search results for: test</body></html>'
        }

        analysis = self.analyzer.analyze(request, response)

        # Parameter 'q' is reflected
        self.assertIn('q', analysis.parameter_recommendations)
        self.assertIn('xss_reflected', analysis.parameter_recommendations['q'])

        # Should boost XSS priority
        self.assertGreater(analysis.priority_adjustments.get('xss_reflected', 0), 0)

    def test_jwt_detection(self):
        """Test detection of JWT in Authorization header."""
        request = {
            'method': 'GET',
            'url': 'https://example.com/api/profile',
            'headers': {
                'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxMjM0NTY3ODkwIn0.dozjgNryP4J3jVmNHl0w5N_XgL0n3I9PlFUP0THsR8U'
            },
            'parameters': []
        }

        response = {
            'status': 200,
            'headers': {},
            'body': '{}'
        }

        analysis = self.analyzer.analyze(request, response)

        self.assertIn('jwt_manipulation', analysis.recommended_tests)

        jwt_signals = [s for s in analysis.risk_signals if s['type'] == 'jwt_detected']
        self.assertGreater(len(jwt_signals), 0)

    def test_xml_content_type(self):
        """Test detection of XML content type."""
        request = {
            'method': 'POST',
            'url': 'https://example.com/api/xml',
            'headers': {'Content-Type': 'application/xml'},
            'parameters': []
        }

        response = {
            'status': 200,
            'headers': {},
            'body': '<response>OK</response>'
        }

        analysis = self.analyzer.analyze(request, response)

        self.assertIn('xml_injection', analysis.recommended_tests)
        self.assertGreater(analysis.priority_adjustments.get('xml_injection', 0), 0)

    def test_id_parameters_idor(self):
        """Test detection of ID parameters (IDOR indicator)."""
        request = {
            'method': 'GET',
            'url': 'https://example.com/api/users/123',
            'headers': {},
            'parameters': [
                {'name': 'user_id', 'value': '123'}
            ]
        }

        response = {
            'status': 200,
            'headers': {},
            'body': '{}'
        }

        analysis = self.analyzer.analyze(request, response)

        self.assertIn('user_id', analysis.parameter_recommendations)
        self.assertIn('idor', analysis.parameter_recommendations['user_id'])

    def test_url_parameters_ssrf(self):
        """Test detection of URL parameters (SSRF indicator)."""
        request = {
            'method': 'GET',
            'url': 'https://example.com/fetch',
            'headers': {},
            'parameters': [
                {'name': 'url', 'value': 'https://example.com/image.jpg'}
            ]
        }

        response = {
            'status': 200,
            'headers': {},
            'body': 'Image data...'
        }

        analysis = self.analyzer.analyze(request, response)

        self.assertIn('url', analysis.parameter_recommendations)
        self.assertIn('ssrf', analysis.parameter_recommendations['url'])
        self.assertIn('open_redirect', analysis.parameter_recommendations['url'])

    def test_error_stack_trace(self):
        """Test detection of error messages with stack traces."""
        request = {'method': 'GET', 'url': 'https://example.com/error', 'headers': {}, 'parameters': []}
        response = {
            'status': 500,
            'headers': {},
            'body': '''
                Traceback (most recent call last):
                  File "app.py", line 42, in handler
                    process_request()
                Exception: Database connection failed
            '''
        }

        analysis = self.analyzer.analyze(request, response)

        self.assertIn('info_leak_errors', analysis.recommended_tests)
        self.assertGreater(analysis.priority_adjustments.get('info_leak_errors', 0), 0)

    def test_sensitive_comments(self):
        """Test detection of sensitive information in HTML comments."""
        request = {'method': 'GET', 'url': 'https://example.com/', 'headers': {}, 'parameters': []}
        response = {
            'status': 200,
            'headers': {'Content-Type': 'text/html'},
            'body': '''
                <html>
                <!-- TODO: Remove hardcoded password before production -->
                <!-- API key: abc123xyz -->
                <body>Hello</body>
                </html>
            '''
        }

        analysis = self.analyzer.analyze(request, response)

        self.assertIn('info_leak_comments', analysis.recommended_tests)

        comment_signals = [s for s in analysis.risk_signals if s['type'] == 'sensitive_comment']
        self.assertGreaterEqual(len(comment_signals), 1)

    def test_json_with_enumerable_ids(self):
        """Test detection of enumerable IDs in JSON (IDOR risk)."""
        request = {'method': 'GET', 'url': 'https://example.com/api/user', 'headers': {}, 'parameters': []}
        response = {
            'status': 200,
            'headers': {'Content-Type': 'application/json'},
            'body': '{"id": 123, "name": "John", "email": "john@example.com"}'
        }

        analysis = self.analyzer.analyze(request, response)

        self.assertIn('idor', analysis.recommended_tests)

        id_signals = [s for s in analysis.risk_signals if s['type'] == 'enumerable_id']
        self.assertGreater(len(id_signals), 0)

    def test_redirect_detection(self):
        """Test detection of redirects (open redirect risk)."""
        request = {'method': 'GET', 'url': 'https://example.com/redirect?next=/dashboard', 'headers': {}, 'parameters': []}
        response = {
            'status': 302,
            'headers': {
                'Location': 'https://example.com/dashboard'
            },
            'body': ''
        }

        analysis = self.analyzer.analyze(request, response)

        self.assertIn('open_redirect', analysis.recommended_tests)

    def test_top_recommendations(self):
        """Test priority-sorted recommendations."""
        request = {'method': 'GET', 'url': 'https://example.com/', 'headers': {}, 'parameters': []}
        response = {
            'status': 200,
            'headers': {
                'Access-Control-Allow-Origin': '*',  # High priority
                'Set-Cookie': 'session=abc',  # Medium priority
            },
            'body': '<html></html>'
        }

        analysis = self.analyzer.analyze(request, response)

        top_recs = self.analyzer.get_top_recommendations(analysis, limit=5)

        # CORS should be prioritized over cookie_security
        self.assertIn('cors_misconfig', top_recs)
        if 'cors_misconfig' in top_recs and 'cookie_security' in top_recs:
            cors_idx = top_recs.index('cors_misconfig')
            cookie_idx = top_recs.index('cookie_security')
            self.assertLess(cors_idx, cookie_idx, "CORS should be prioritized over cookie_security")

    def test_empty_response(self):
        """Test analyzer handles empty response gracefully."""
        request = {'method': 'GET', 'url': 'https://example.com/', 'headers': {}, 'parameters': []}
        response = {
            'status': 204,
            'headers': {},
            'body': ''
        }

        analysis = self.analyzer.analyze(request, response)

        # Should not crash, should return some recommendations
        self.assertIsInstance(analysis, ExchangeAnalysis)
        self.assertIsInstance(analysis.recommended_tests, list)


if __name__ == '__main__':
    unittest.main()
