"""
Test Nuclei Docker exec support.

Verifies that NucleiRunner can detect and execute nuclei binary in Kali container
when MCP server runs in backend container where nuclei is not installed.
"""
import pytest
import os
import sys
from pathlib import Path

# Add MCP modules to path (avoid pip mcp package shadowing)
mcp_modules_path = Path(__file__).parent.parent / 'mcp' / 'modules'
sys.path.insert(0, str(mcp_modules_path))

from lib.nuclei_runner import NucleiRunner, NucleiConfig


@pytest.mark.asyncio
async def test_nuclei_detects_docker_binary():
    """Test that Nuclei can detect binary via Docker exec."""
    # Create runner (should auto-detect Docker if local binary unavailable)
    runner = NucleiRunner()

    # Check binary availability
    is_available = await runner.check_binary()

    # If running in Docker environment, binary should be available via Docker exec
    # If running locally without Docker, mock mode is expected
    if is_available:
        assert runner._use_docker is True or runner._use_docker is False  # Either is valid
        print(f"✓ Nuclei binary detected (use_docker={runner._use_docker})")
    else:
        # Mock mode fallback is expected in environments without Docker
        is_mock = await runner.is_mock_mode()
        assert is_mock is True
        print("✓ Nuclei not available - mock mode enabled (expected in test environment)")


@pytest.mark.asyncio
async def test_nuclei_version_check():
    """Test that Nuclei version can be retrieved via Docker exec."""
    runner = NucleiRunner()

    version = await runner.get_version()

    if version == "mock-mode":
        print("✓ Nuclei in mock mode (expected if binary unavailable)")
    else:
        # Real version should be a semantic version string
        assert version is not None
        assert "." in version  # e.g., "3.1.4"
        print(f"✓ Nuclei version: {version}")


@pytest.mark.asyncio
async def test_nuclei_docker_exec_scan():
    """Test that Nuclei can run a real scan via Docker exec.

    This is a minimal test that only runs if Nuclei binary is actually available.
    It uses a safe test target and a minimal template.
    """
    runner = NucleiRunner()

    # Check if binary available
    is_available = await runner.check_binary()
    if not is_available:
        pytest.skip("Nuclei binary not available - skipping Docker exec test")

    # Run a minimal scan with http-missing-security-headers template
    # Using example.com as test target (public, safe to scan)
    result = await runner.scan_single(
        target="http://example.com",
        template_id="misconfiguration/http-missing-security-headers"
    )

    # Verify result structure
    assert "success" in result
    assert "target" in result
    assert result["target"] == "http://example.com"
    assert "findings" in result
    assert isinstance(result["findings"], list)
    assert "mock_mode" in result

    if result["mock_mode"]:
        print("✓ Nuclei scan completed in mock mode")
    else:
        print(f"✓ Nuclei scan completed via Docker exec - found {len(result['findings'])} findings")

    # Should not error out
    assert "error" not in result or result["error"] is None


@pytest.mark.asyncio
async def test_nuclei_respects_rate_limit():
    """Test that Nuclei respects rate limit configuration via Docker exec."""
    # Create runner with custom rate limit
    config = NucleiConfig(rate_limit=5, timeout=10000)
    runner = NucleiRunner(config)

    # Verify config is applied
    assert runner._config.rate_limit == 5
    assert runner._config.timeout == 10000
    print("✓ Nuclei config applied correctly")


@pytest.mark.asyncio
async def test_nuclei_mock_mode_fallback():
    """Test that Nuclei falls back to mock mode gracefully when binary unavailable."""
    # Force mock mode
    config = NucleiConfig(mock_mode=True)
    runner = NucleiRunner(config)

    # Should be in mock mode
    is_mock = await runner.is_mock_mode()
    assert is_mock is True

    # Mock scan should work
    result = await runner.scan_single(
        target="http://test.example.com",
        template_id="cves/2021/CVE-2021-44228"
    )

    assert result["success"] is True
    assert result["mock_mode"] is True
    assert len(result["findings"]) > 0  # Mock findings
    assert result["findings"][0]["template_id"] == "CVE-2021-44228"
    print("✓ Mock mode fallback works correctly")


if __name__ == "__main__":
    import asyncio

    async def run_tests():
        print("\n=== Nuclei Docker Exec Tests ===\n")

        await test_nuclei_detects_docker_binary()
        await test_nuclei_version_check()
        await test_nuclei_docker_exec_scan()
        await test_nuclei_respects_rate_limit()
        await test_nuclei_mock_mode_fallback()

        print("\n=== All Tests Passed ===\n")

    asyncio.run(run_tests())
