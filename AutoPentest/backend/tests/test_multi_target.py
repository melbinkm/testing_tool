"""
Tests for assessment_add_target tool (Multi-Target Assessment Support).

4 tests validating target URL addition with validation and metadata storage.
"""

import sys
import os
import json
import unittest
from unittest.mock import AsyncMock, MagicMock, patch

# Add modules to path (avoid pip mcp package shadowing)
sys.path.insert(0, os.path.join(os.path.dirname(__file__), '../mcp/modules'))

from tools_assessment import (
    get_assessment_tools,
    handle_assessment_tool,
    _handle_assessment_add_target,
)


class TestMultiTarget(unittest.IsolatedAsyncioTestCase):
    """Test suite for multi-target assessment support."""

    def setUp(self):
        self.mcp_service = MagicMock()
        self.mcp_service.current_assessment_id = 1
        self.mcp_service.scope_provider = MagicMock()
        self.mcp_service.activity_logger = None

    def test_tool_definition_exists(self):
        """Test that assessment_add_target tool is defined."""
        tools = get_assessment_tools()
        tool_names = [t.name for t in tools]
        self.assertIn("assessment_add_target", tool_names)

        # Check required fields
        tool = [t for t in tools if t.name == "assessment_add_target"][0]
        required = tool.inputSchema.get("required", [])
        self.assertIn("target_url", required)

    @patch("tools_assessment._get_db")
    async def test_valid_url_stored_as_asset(self, mock_get_db):
        """Test that a valid URL is stored as wm_asset successfully."""
        mock_db = AsyncMock()
        mock_db.assessment_id = 1
        mock_db.add_asset = AsyncMock(return_value={"id": "test-asset-id"})
        mock_get_db.return_value = mock_db

        result = await _handle_assessment_add_target(
            {
                "target_url": "https://api.example.com",
                "target_type": "api",
                "label": "Example API",
            },
            self.mcp_service,
        )

        data = json.loads(result[0].text)
        self.assertTrue(data["success"])
        self.assertEqual(data["target_url"], "https://api.example.com")
        self.assertEqual(data["target_type"], "api")
        self.assertEqual(data["label"], "Example API")
        self.assertIn("asset_id", data)

        # Verify add_asset was called with correct params
        mock_db.add_asset.assert_called_once()
        call_kwargs = mock_db.add_asset.call_args[1]
        self.assertEqual(call_kwargs["kind"], "application")
        self.assertEqual(call_kwargs["name"], "Example API")

    async def test_invalid_url_returns_error(self):
        """Test that an invalid URL returns error."""
        result = await _handle_assessment_add_target(
            {"target_url": "not-a-url"},
            self.mcp_service,
        )

        data = json.loads(result[0].text)
        self.assertFalse(data.get("success", True))
        self.assertIn("Invalid URL", data.get("error", ""))

    async def test_empty_url_returns_error(self):
        """Test that empty URL returns error."""
        result = await _handle_assessment_add_target(
            {"target_url": ""},
            self.mcp_service,
        )

        data = json.loads(result[0].text)
        self.assertFalse(data.get("success", True))
        self.assertIn("required", data.get("error", ""))

    @patch("tools_assessment._get_db")
    async def test_asset_stored_with_correct_metadata(self, mock_get_db):
        """Test that asset metadata includes target_type, label, and added_via."""
        mock_db = AsyncMock()
        mock_db.assessment_id = 1
        mock_db.add_asset = AsyncMock(return_value={"id": "test-asset-id"})
        mock_get_db.return_value = mock_db

        result = await _handle_assessment_add_target(
            {
                "target_url": "https://ws.example.com",
                "target_type": "websocket",
            },
            self.mcp_service,
        )

        data = json.loads(result[0].text)
        self.assertTrue(data["success"])
        self.assertEqual(data["target_type"], "websocket")
        # Label should default to netloc
        self.assertEqual(data["label"], "ws.example.com")

        # Verify the metadata passed to add_asset
        call_kwargs = mock_db.add_asset.call_args[1]
        metadata = call_kwargs["metadata"]
        self.assertEqual(metadata["target_type"], "websocket")
        self.assertEqual(metadata["added_via"], "assessment_add_target")


if __name__ == "__main__":
    unittest.main()
