"""
Tests for scope sync service - auto-sync assessment scope to MCP wm_scope_config.
"""

import sys
import unittest
import asyncio
from datetime import date
from unittest.mock import MagicMock, AsyncMock, patch

# Add mcp/modules to path to avoid pip mcp package shadowing
sys.path.insert(0, '../mcp/modules')

from services.scope_sync import (
    sync_assessment_scope_to_mcp,
    slugify,
    extract_urls_from_scope_text,
)
from lib.scope_types import EngagementScope, EngagementInfo, ScopeAllowlist


class MockAssessment:
    """Mock assessment object for testing."""
    def __init__(self, **kwargs):
        self.id = kwargs.get('id', 1)
        self.name = kwargs.get('name', 'Test Assessment')
        self.client_name = kwargs.get('client_name', 'Test Client')
        self.target_domains = kwargs.get('target_domains', [])
        self.ip_scopes = kwargs.get('ip_scopes', [])
        self.ports = kwargs.get('ports', [])
        self.scope = kwargs.get('scope', '')
        self.start_date = kwargs.get('start_date', None)
        self.end_date = kwargs.get('end_date', None)


class TestScopeSync(unittest.IsolatedAsyncioTestCase):
    """Tests for scope sync functionality."""

    async def test_slugify(self):
        """Test slugification of assessment names."""
        self.assertEqual(slugify('Wien 17'), 'wien-17')
        self.assertEqual(slugify('Test Assessment'), 'test-assessment')
        self.assertEqual(slugify('API Test 2024'), 'api-test-2024')
        self.assertEqual(slugify('Special!@#$%Chars'), 'special-chars')
        self.assertEqual(slugify('---multiple---dashes---'), 'multiple-dashes')

    async def test_extract_urls_from_scope_text(self):
        """Test URL extraction from scope text."""
        scope_text = """
        Test the following:
        - https://www.example.com
        - http://api.example.com/v1
        - https://staging.example.com:8080/test
        """
        urls = extract_urls_from_scope_text(scope_text)
        self.assertEqual(len(urls), 3)
        self.assertIn('https://www.example.com', urls)
        self.assertIn('http://api.example.com/v1', urls)
        self.assertIn('https://staging.example.com:8080/test', urls)

    async def test_extract_urls_handles_none(self):
        """Test URL extraction handles None scope text."""
        urls = extract_urls_from_scope_text(None)
        self.assertEqual(urls, [])

    async def test_extract_urls_handles_empty(self):
        """Test URL extraction handles empty scope text."""
        urls = extract_urls_from_scope_text('')
        self.assertEqual(urls, [])

    @patch('services.scope_sync.save_scope_to_db')
    async def test_sync_creates_scope_from_assessment(self, mock_save):
        """Test that sync creates a valid EngagementScope from assessment fields."""
        mock_save.return_value = 1  # Version number
        pool = AsyncMock()

        assessment = MockAssessment(
            id=17,
            name='Wien 17',
            client_name='City of Vienna',
            target_domains=['www.wien.gv.at', '*.wien.gv.at'],
            ip_scopes=['192.168.1.0/24'],
            ports=[80, 443, 5000],
            start_date=date(2024, 1, 1),
            end_date=date(2024, 12, 31),
        )

        version = await sync_assessment_scope_to_mcp(assessment, pool)

        # Verify save was called
        self.assertEqual(version, 1)
        mock_save.assert_called_once()

        # Verify the EngagementScope passed to save
        call_args = mock_save.call_args
        scope = call_args[1]['scope']  # Keyword arg

        self.assertIsInstance(scope, EngagementScope)
        self.assertEqual(scope.engagement.id, 'wien-17')
        self.assertEqual(scope.engagement.name, 'Wien 17')
        self.assertEqual(scope.engagement.client, 'City of Vienna')
        self.assertEqual(scope.engagement.start_date, '2024-01-01')
        self.assertEqual(scope.engagement.end_date, '2024-12-31')

        self.assertEqual(scope.allowlist.domains, ['www.wien.gv.at', '*.wien.gv.at'])
        self.assertEqual(scope.allowlist.ip_ranges, ['192.168.1.0/24'])
        self.assertEqual(scope.allowlist.ports, [80, 443, 5000])

    @patch('services.scope_sync.save_scope_to_db')
    async def test_sync_handles_empty_fields(self, mock_save):
        """Test sync handles assessment with no domains/IPs/ports."""
        mock_save.return_value = 1
        pool = AsyncMock()

        assessment = MockAssessment(
            id=1,
            name='Empty Assessment',
            client_name='',
            target_domains=[],
            ip_scopes=[],
            ports=[],
        )

        version = await sync_assessment_scope_to_mcp(assessment, pool)

        self.assertEqual(version, 1)
        call_args = mock_save.call_args
        scope = call_args[1]['scope']

        # Empty arrays should become None
        self.assertIsNone(scope.allowlist.domains)
        self.assertIsNone(scope.allowlist.ip_ranges)
        self.assertIsNone(scope.allowlist.ports)

    @patch('services.scope_sync.save_scope_to_db')
    async def test_sync_includes_ports(self, mock_save):
        """Test that ports flow through to allowlist.ports."""
        mock_save.return_value = 1
        pool = AsyncMock()

        assessment = MockAssessment(
            id=1,
            name='Ports Test',
            ports=[22, 80, 443, 3000, 8080],
        )

        await sync_assessment_scope_to_mcp(assessment, pool)

        call_args = mock_save.call_args
        scope = call_args[1]['scope']

        self.assertEqual(scope.allowlist.ports, [22, 80, 443, 3000, 8080])

    @patch('services.scope_sync.save_scope_to_db')
    async def test_sync_extracts_urls_from_scope_text(self, mock_save):
        """Test that URLs in scope text are added to allowlist.urls."""
        mock_save.return_value = 1
        pool = AsyncMock()

        assessment = MockAssessment(
            id=1,
            name='URL Test',
            scope='Test https://app.example.com and http://api.example.com/v1',
        )

        await sync_assessment_scope_to_mcp(assessment, pool)

        call_args = mock_save.call_args
        scope = call_args[1]['scope']

        self.assertIsNotNone(scope.allowlist.urls)
        self.assertIn('https://app.example.com', scope.allowlist.urls)
        self.assertIn('http://api.example.com/v1', scope.allowlist.urls)

    async def test_scope_types_defaults(self):
        """Test that EngagementScope can be constructed with minimal fields."""
        # This should not raise validation errors
        scope = EngagementScope(
            engagement=EngagementInfo(
                id='test-1',
                name='Test',
            ),
            allowlist=ScopeAllowlist(
                domains=['example.com'],
            ),
        )

        # Verify defaults are applied
        self.assertEqual(scope.schema_version, '1.0')
        self.assertEqual(scope.engagement.client, '')
        self.assertEqual(scope.engagement.timezone, 'UTC')
        self.assertEqual(scope.constraints.rate_limits.requests_per_second, 10)
        self.assertEqual(scope.constraints.budget.max_total_requests, 999999999)
        self.assertEqual(scope.approval_policy.mode, 'AUTO_APPROVE')

    async def test_scope_types_defaults_empty_allowlist(self):
        """Test that EngagementScope can be constructed with empty allowlist."""
        scope = EngagementScope(
            engagement=EngagementInfo(
                id='test-2',
                name='Test 2',
            ),
        )

        # Empty allowlist should work with defaults
        self.assertIsNone(scope.allowlist.domains)
        self.assertIsNone(scope.allowlist.ip_ranges)
        self.assertIsNone(scope.allowlist.ports)

    @patch('services.scope_sync.save_scope_to_db')
    async def test_cache_invalidation_args(self, mock_save):
        """Test that scope sync passes correct args to save_scope_to_db."""
        mock_save.return_value = 1
        pool = AsyncMock()

        assessment = MockAssessment(id=5, name='Test')

        await sync_assessment_scope_to_mcp(assessment, pool)

        # Verify save was called with correct assessment_id and metadata
        call_args = mock_save.call_args
        self.assertEqual(call_args[1]['assessment_id'], 5)
        self.assertEqual(call_args[1]['created_by'], 'frontend_sync')
        self.assertEqual(call_args[1]['notes'], 'Auto-synced from assessment scope fields')


if __name__ == '__main__':
    unittest.main()
