"""Tests for Wave 2 dev-beta features: Payload classes, Deserialization, Race condition.

Feature #17: Fill 12 Empty Payload Classes
Feature #15: Insecure Deserialization Testing
Feature #21: Race Condition / Timing Attack Testing
"""

import sys
import os
import unittest
from unittest.mock import AsyncMock, MagicMock, patch

sys.path.insert(0, os.path.join(os.path.dirname(__file__), '..', 'mcp', 'modules'))


# ============================================================================
# Feature #17: Filled Payload Classes
# ============================================================================

class TestFilledPayloadClasses(unittest.TestCase):
    """Test that all 12 previously-empty payload classes now have payloads."""

    def setUp(self):
        from lib.payload_registry import PayloadRegistry
        self.registry = PayloadRegistry()

    def test_idor_payloads(self):
        payloads = self.registry.get_payloads('idor')
        self.assertGreaterEqual(len(payloads), 15)
        strings = self.registry.to_string_payloads(payloads)
        self.assertTrue(any('../' in s for s in strings))

    def test_auth_bypass_payloads(self):
        payloads = self.registry.get_payloads('auth_bypass')
        self.assertGreaterEqual(len(payloads), 12)
        strings = self.registry.to_string_payloads(payloads)
        self.assertTrue(any('admin' in s for s in strings))

    def test_broken_auth_payloads(self):
        payloads = self.registry.get_payloads('broken_auth')
        self.assertGreaterEqual(len(payloads), 10)

    def test_session_fixation_payloads(self):
        payloads = self.registry.get_payloads('session_fixation')
        self.assertGreaterEqual(len(payloads), 8)
        strings = self.registry.to_string_payloads(payloads)
        self.assertTrue(any('session' in s.lower() for s in strings))

    def test_session_expiry_payloads(self):
        payloads = self.registry.get_payloads('session_expiry')
        self.assertGreaterEqual(len(payloads), 6)

    def test_privilege_escalation_payloads(self):
        payloads = self.registry.get_payloads('privilege_escalation')
        self.assertGreaterEqual(len(payloads), 15)
        strings = self.registry.to_string_payloads(payloads)
        self.assertTrue(any('admin' in s for s in strings))

    def test_csrf_payloads(self):
        payloads = self.registry.get_payloads('csrf')
        self.assertGreaterEqual(len(payloads), 10)

    def test_clickjacking_payloads(self):
        payloads = self.registry.get_payloads('clickjacking')
        self.assertGreaterEqual(len(payloads), 8)
        strings = self.registry.to_string_payloads(payloads)
        self.assertTrue(any('iframe' in s.lower() or 'frame' in s.lower() for s in strings))

    def test_security_headers_payloads(self):
        payloads = self.registry.get_payloads('security_headers')
        self.assertGreaterEqual(len(payloads), 10)
        strings = self.registry.to_string_payloads(payloads)
        self.assertTrue(any('Content-Security-Policy' in s for s in strings))

    def test_cookie_security_payloads(self):
        payloads = self.registry.get_payloads('cookie_security')
        self.assertGreaterEqual(len(payloads), 8)
        strings = self.registry.to_string_payloads(payloads)
        self.assertTrue(any('Secure' in s or 'HttpOnly' in s for s in strings))

    def test_tls_config_payloads(self):
        payloads = self.registry.get_payloads('tls_config')
        self.assertGreaterEqual(len(payloads), 6)

    def test_race_condition_payloads(self):
        payloads = self.registry.get_payloads('race_condition')
        self.assertGreaterEqual(len(payloads), 10)


# ============================================================================
# Feature #15: Deserialization Testing
# ============================================================================

class TestDeserializationPayloads(unittest.TestCase):
    """Test deserialization_payloads.py."""

    def test_java_payloads(self):
        from lib.deserialization_payloads import get_deserialization_payloads
        payloads = get_deserialization_payloads('java')
        self.assertGreaterEqual(len(payloads), 8)
        # Java payloads are base64-encoded
        self.assertTrue(all(isinstance(p, str) for p in payloads))

    def test_python_payloads(self):
        from lib.deserialization_payloads import get_deserialization_payloads
        payloads = get_deserialization_payloads('python')
        self.assertGreaterEqual(len(payloads), 5)

    def test_php_payloads(self):
        from lib.deserialization_payloads import get_deserialization_payloads
        payloads = get_deserialization_payloads('php')
        self.assertGreaterEqual(len(payloads), 5)
        self.assertTrue(any('O:' in p for p in payloads))

    def test_dotnet_payloads(self):
        from lib.deserialization_payloads import get_deserialization_payloads
        payloads = get_deserialization_payloads('dotnet')
        self.assertGreaterEqual(len(payloads), 5)

    def test_all_platform_payloads(self):
        from lib.deserialization_payloads import get_deserialization_payloads
        payloads = get_deserialization_payloads('all')
        self.assertGreaterEqual(len(payloads), 23)  # 8+5+5+5

    def test_unknown_platform_defaults_java(self):
        from lib.deserialization_payloads import get_deserialization_payloads
        payloads = get_deserialization_payloads('unknown')
        java = get_deserialization_payloads('java')
        self.assertEqual(payloads, java)

    def test_detection_patterns_exist(self):
        from lib.deserialization_payloads import DESERIALIZATION_ERROR_PATTERNS
        self.assertGreaterEqual(len(DESERIALIZATION_ERROR_PATTERNS), 10)
        self.assertTrue(any('ClassNotFoundException' in p for p in DESERIALIZATION_ERROR_PATTERNS))

    def test_insecure_deserialization_in_registry(self):
        from lib.payload_registry import PayloadRegistry
        reg = PayloadRegistry()
        payloads = reg.get_payloads('insecure_deserialization')
        self.assertGreaterEqual(len(payloads), 8)  # Default java

    def test_insecure_deserialization_with_context(self):
        from lib.payload_registry import PayloadRegistry
        reg = PayloadRegistry()
        payloads = reg.get_payloads('insecure_deserialization', {'platform': 'python'})
        self.assertGreaterEqual(len(payloads), 5)

    def test_vuln_checklist_has_deserialization(self):
        from lib.vuln_checklist import VulnChecklist
        cl = VulnChecklist()
        spec = cl.get_spec_by_id('insecure_deserialization')
        self.assertIsNotNone(spec)
        self.assertEqual(spec.category, 'injection')
        self.assertIn('ClassNotFoundException', spec.detection_patterns)


# ============================================================================
# Feature #21: Race Condition Testing
# ============================================================================

class TestRaceConditionPayloads(unittest.TestCase):
    """Test race_condition_payloads.py."""

    def test_race_templates(self):
        from lib.race_condition_payloads import RACE_TEMPLATES
        self.assertGreaterEqual(len(RACE_TEMPLATES), 8)
        for t in RACE_TEMPLATES:
            self.assertIn(t.pattern_type, ("toctou", "double_spend", "time_of_check"))
            self.assertGreater(t.concurrent_count, 0)

    def test_build_concurrent_requests(self):
        from lib.race_condition_payloads import build_concurrent_requests
        reqs = build_concurrent_requests(
            url="https://example.com/transfer",
            method="POST",
            headers={"Content-Type": "application/json"},
            body='{"amount": 100}',
            count=5,
        )
        self.assertEqual(len(reqs), 5)
        for r in reqs:
            self.assertEqual(r["url"], "https://example.com/transfer")
            self.assertEqual(r["method"], "POST")
            self.assertEqual(r["body"], '{"amount": 100}')

    def test_build_concurrent_requests_are_independent(self):
        from lib.race_condition_payloads import build_concurrent_requests
        reqs = build_concurrent_requests(url="https://example.com/test", count=3)
        # Modify one should not affect others
        reqs[0]["headers"]["X-Test"] = "modified"
        self.assertNotIn("X-Test", reqs[1].get("headers", {}))


class TestRaceConditionTool(unittest.IsolatedAsyncioTestCase):
    """Test the race_condition_test tool handler."""

    async def test_race_condition_test_handler(self):
        from tools_pentest import _handle_race_condition_test

        mock_client = MagicMock()
        mock_client.send = AsyncMock(return_value={
            "status": 200,
            "body": '{"success": true}',
            "headers": {},
        })

        mock_service = MagicMock()
        mock_service.current_assessment_id = 1
        mock_service._http_client_cache = mock_client
        mock_service._http_client_cache_key = 1

        args = {
            "url": "https://example.com/transfer",
            "method": "POST",
            "body": '{"amount": 100}',
            "concurrent_count": 3,
        }

        result = await _handle_race_condition_test(args, mock_service)
        import json
        data = json.loads(result[0].text)

        self.assertEqual(data["request_count"], 3)
        self.assertEqual(data["successful_requests"], 3)
        self.assertIn("timing", data)
        self.assertIn("status_codes", data)
        self.assertFalse(data["any_different_responses"])

    async def test_race_condition_detects_variance(self):
        from tools_pentest import _handle_race_condition_test

        call_count = 0

        async def mock_send(request):
            nonlocal call_count
            call_count += 1
            # Alternate status codes to simulate race condition
            return {
                "status": 200 if call_count % 2 == 0 else 409,
                "body": '{"ok": true}' if call_count % 2 == 0 else '{"error": "conflict"}',
                "headers": {},
            }

        mock_client = MagicMock()
        mock_client.send = mock_send

        mock_service = MagicMock()
        mock_service.current_assessment_id = 1
        mock_service._http_client_cache = mock_client
        mock_service._http_client_cache_key = 1

        args = {
            "url": "https://example.com/transfer",
            "concurrent_count": 4,
        }

        result = await _handle_race_condition_test(args, mock_service)
        import json
        data = json.loads(result[0].text)

        self.assertTrue(data["any_different_responses"])
        self.assertTrue(data["possible_race_condition"])
        self.assertIn("200", data["status_codes"])
        self.assertIn("409", data["status_codes"])

    async def test_race_condition_requires_url(self):
        from tools_pentest import _handle_race_condition_test
        mock_service = MagicMock()
        result = await _handle_race_condition_test({}, mock_service)
        import json
        data = json.loads(result[0].text)
        self.assertFalse(data["success"])


if __name__ == "__main__":
    unittest.main()
