"""
Tests for PoC code generation enhancement + generate_poc tool.

5 tests validating poc_code field on record_finding and the generate_poc tool.
"""

import sys
import os
import json
import unittest
from unittest.mock import AsyncMock, MagicMock, patch

# Add modules to path (avoid pip mcp package shadowing)
sys.path.insert(0, os.path.join(os.path.dirname(__file__), '../mcp/modules'))

from tools_pentest import (
    get_pentest_tools,
    handle_pentest_tool,
    _handle_record_finding,
    _handle_generate_poc,
)


class TestPoCGeneration(unittest.IsolatedAsyncioTestCase):
    """Test suite for PoC generation."""

    def setUp(self):
        self.mcp_service = MagicMock()
        self.mcp_service.current_assessment_id = 1
        self.mcp_service.scope_provider = MagicMock()
        self.mcp_service.activity_logger = None

    def test_generate_poc_tool_defined(self):
        """Test that generate_poc tool exists in tool definitions."""
        tools = get_pentest_tools()
        tool_names = [t.name for t in tools]
        self.assertIn("generate_poc", tool_names)

        # Check required fields
        poc_tool = [t for t in tools if t.name == "generate_poc"][0]
        required = poc_tool.inputSchema.get("required", [])
        self.assertIn("finding_id", required)

    def test_poc_code_field_in_record_finding_schema(self):
        """Test that poc_code field exists in record_finding inputSchema."""
        tools = get_pentest_tools()
        rf_tool = [t for t in tools if t.name == "record_finding"][0]
        properties = rf_tool.inputSchema.get("properties", {})
        self.assertIn("poc_code", properties)
        self.assertEqual(properties["poc_code"]["type"], "string")

    @patch("lib.world_model_db.get_world_model_db")
    @patch("tools_pentest._get_db")
    async def test_record_finding_stores_poc_code(self, mock_get_db, mock_get_wm_db):
        """Test that record_finding stores poc_code in evidence metadata."""
        mock_db = AsyncMock()
        mock_db.assessment_id = 1
        mock_db.query = AsyncMock(return_value=[])  # No existing SAST match
        mock_db.coverage_mark = AsyncMock()
        mock_get_db.return_value = mock_db
        mock_get_wm_db.return_value = mock_db

        # Mock safe_add_card
        mock_result = MagicMock()
        mock_result.ok = True
        mock_result.data = {"id": "card-123"}
        self.mcp_service.safe_add_card = AsyncMock(return_value=mock_result)
        self.mcp_service.update_card_metadata = AsyncMock()

        poc_code = "curl -X GET 'http://target/api?id=1 OR 1=1'"

        result = await _handle_record_finding(
            {
                "title": "SQL Injection in /api/users",
                "severity": "high",
                "url": "http://target/api/users",
                "vuln_class": "sqli_error",
                "parameter": "id",
                "description": "SQL injection via id parameter",
                "evidence": {"payload": "' OR 1=1--", "description": "Error-based SQLi"},
                "remediation": "Use parameterized queries",
                "cvss_vector": "CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:H/A:N",
                "attack_scenario": "Attacker extracts database",
                "poc_code": poc_code,
            },
            self.mcp_service,
        )

        data = json.loads(result[0].text)
        self.assertTrue(data.get("success") or data.get("card_id"))

        # Verify safe_add_card was called with evidence containing poc_code
        call_kwargs = self.mcp_service.safe_add_card.call_args
        evidence_str = call_kwargs.kwargs.get("evidence") or call_kwargs[1].get("evidence", "")
        if evidence_str:
            evidence_data = json.loads(evidence_str)
            self.assertEqual(evidence_data.get("poc_code"), poc_code)

    @patch("tools_pentest._get_db")
    async def test_record_finding_works_without_poc_code(self, mock_get_db):
        """Test that record_finding still works without poc_code (optional)."""
        mock_db = AsyncMock()
        mock_db.assessment_id = 1
        mock_db.query = AsyncMock(return_value=[])
        mock_db.coverage_mark = AsyncMock()
        mock_get_db.return_value = mock_db

        mock_result = MagicMock()
        mock_result.ok = True
        mock_result.data = {"id": "card-456"}
        self.mcp_service.safe_add_card = AsyncMock(return_value=mock_result)

        result = await _handle_record_finding(
            {
                "title": "Missing HSTS Header",
                "severity": "low",
                "url": "http://target/",
                "description": "HSTS header not set",
                "evidence": {"description": "Header missing"},
                "remediation": "Add Strict-Transport-Security header",
                "cvss_vector": "CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:L/I:N/A:N",
                "attack_scenario": "MITM downgrade attack",
            },
            self.mcp_service,
        )

        data = json.loads(result[0].text)
        self.assertTrue(data.get("success") or data.get("card_id"))

    @patch("tools_pentest._get_db")
    async def test_generate_poc_returns_script_and_curl(self, mock_get_db):
        """Test that generate_poc returns PoC script and curl command."""
        mock_db = AsyncMock()
        mock_db.assessment_id = 1
        mock_db.query = AsyncMock(return_value=[
            {
                "id": "finding-1",
                "title": "SQL Injection in /api/search",
                "vuln_class": "sqli",
                "url": "http://target/api/search",
                "severity": "high",
                "evidence": "",
                "metadata": json.dumps({
                    "parameter": "q",
                    "payload": "' OR 1=1--",
                    "method": "GET",
                }),
            }
        ])
        mock_get_db.return_value = mock_db

        result = await _handle_generate_poc(
            {"finding_id": "finding-1"},
            self.mcp_service,
        )

        data = json.loads(result[0].text)
        self.assertEqual(data["finding_id"], "finding-1")
        self.assertIn("vuln_type", data)
        self.assertIn("poc", data)
        self.assertIn("script", data)
        self.assertIn("curl", data)
        # Script should contain python code
        self.assertIn("import requests", data["script"])

    @patch("tools_pentest._get_db")
    async def test_generate_poc_not_found(self, mock_get_db):
        """Test that generate_poc returns error for unknown finding_id."""
        mock_db = AsyncMock()
        mock_db.assessment_id = 1
        mock_db.query = AsyncMock(return_value=[])
        mock_get_db.return_value = mock_db

        result = await _handle_generate_poc(
            {"finding_id": "nonexistent"},
            self.mcp_service,
        )

        data = json.loads(result[0].text)
        self.assertFalse(data.get("success", True))
        self.assertIn("not found", data.get("error", ""))


if __name__ == "__main__":
    unittest.main()
