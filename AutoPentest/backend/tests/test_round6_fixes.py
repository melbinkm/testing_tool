"""
Test Deep Audit Round 6 Fixes

Verifies all fixes from the Round 6 implementation:
- A1: safe_add_card uses add_finding() not add()
- A2: Frontend URL corrected
- A3: _try_mark_coverage uses 'id' not 'cell_id'
- B1: testing_build_matrix includes id, created_at, updated_at
- B2: http_send_batch wraps requests correctly
- B3: current_base_url attribute exists
- B4: recon_pipeline uses correct arg name
- B5: get_status returns 100% when complete
- C1: HTTP client cached per assessment
- C2: add_card routes through safe_add_card
- C3: Exchange analyzer signature fixed
- C4: Credential password redacted
- C6: NucleiRunner constructor fixed
- C7: scan_with_templates return type handled
"""

import unittest
import sys
from pathlib import Path

# Add parent directories to path
backend_path = Path(__file__).parent.parent
sys.path.insert(0, str(backend_path))
sys.path.insert(0, str(backend_path / "mcp" / "modules"))


class TestRound6FixesA(unittest.TestCase):
    """Test Part A fixes (broken fixes)."""

    def test_a1_safe_add_card_uses_add_finding(self):
        """Verify safe_add_card calls db.add_finding() not db.add()."""
        from service import AutoPentestService
        import inspect

        source = inspect.getsource(AutoPentestService.safe_add_card)

        # Should use add_finding()
        self.assertIn("add_finding(", source, "safe_add_card should call add_finding()")

        # Should NOT use add("findings"
        self.assertNotIn('add("findings"', source, "safe_add_card should not use add() method")

        # Should pass required params
        self.assertIn("hypothesis_id=", source, "add_finding requires hypothesis_id")
        self.assertIn("confidence=", source, "add_finding requires confidence")

    def test_a3_try_mark_coverage_uses_id_column(self):
        """Verify _try_mark_coverage queries 'id' column not 'cell_id'."""
        from service import AutoPentestService
        import inspect

        source = inspect.getsource(AutoPentestService._try_mark_coverage)

        # SELECT should use 'id'
        self.assertIn('SELECT id', source, "Query should SELECT id column")

        # UPDATE should use 'id'
        self.assertIn('WHERE id =', source, "UPDATE should use WHERE id =")

        # Should NOT reference cell_id column
        self.assertNotIn('SELECT cell_id', source, "Should not SELECT cell_id (doesn't exist)")
        self.assertNotIn('"cell_id"]', source, "Should not access row['cell_id']")


class TestRound6FixesB(unittest.TestCase):
    """Test Part B fixes (critical bugs)."""

    def test_b1_testing_build_matrix_includes_uuid(self):
        """Verify testing_build_matrix INSERT includes id, created_at, updated_at."""
        from tools_testing_engine import _handle_build_matrix
        import inspect

        source = inspect.getsource(_handle_build_matrix)

        # Should generate UUID
        self.assertIn("uuid.uuid4()", source, "Should generate UUID for id column")

        # INSERT should include id column
        self.assertIn("INSERT INTO wm_coverage_matrix (id,", source,
                     "INSERT should include id column")

        # Should include timestamps
        self.assertIn("created_at", source, "INSERT should include created_at")
        self.assertIn("updated_at", source, "INSERT should include updated_at")

    def test_b2_http_send_batch_wraps_requests(self):
        """Verify http_send_batch wraps requests in correct format."""
        from tools_http import _handle_http_send_batch
        import inspect

        source = inspect.getsource(_handle_http_send_batch)

        # Should wrap requests with "request" key
        self.assertIn('batch_items =', source, "Should create batch_items variable")
        self.assertIn('"request":', source, "Should wrap with 'request' key")
        self.assertIn('"identity_id":', source, "Should include 'identity_id' key")

    def test_b3_current_base_url_attribute_exists(self):
        """Verify service has current_base_url attribute."""
        from service import AutoPentestService
        import inspect

        # Check __init__ method
        source = inspect.getsource(AutoPentestService.__init__)
        self.assertIn("current_base_url", source,
                     "__init__ should initialize current_base_url")

    def test_b5_get_status_handles_phase6_completion(self):
        """Verify get_status returns 100% when phase 6 complete."""
        from lib.phase_orchestrator import PhaseOrchestrator, NUM_PHASES
        import inspect

        source = inspect.getsource(PhaseOrchestrator.get_status)

        # Should check if final phase (NUM_PHASES) is done
        self.assertTrue(
            'current_phase == NUM_PHASES' in source or 'current_phase == 6' in source,
            "Should check for final phase (NUM_PHASES or 6)"
        )
        self.assertTrue(
            'steps[NUM_PHASES - 1]' in source or 'steps[5]' in source,
            "Should check final phase status (index NUM_PHASES-1 or 5)"
        )
        self.assertIn('"done"', source,
                     "Should check if status is 'done'")


class TestRound6FixesC(unittest.TestCase):
    """Test Part C fixes (high priority bugs)."""

    def test_c1_http_client_cached(self):
        """Verify _get_http_client caches client per assessment."""
        from tools_http import _get_http_client
        import inspect

        source = inspect.getsource(_get_http_client)

        # Should check cache
        self.assertIn("_http_client_cache", source,
                     "Should check for cached client")

        # Should cache the client
        self.assertIn("_http_client_cache =", source,
                     "Should store client in cache")

    def test_c2_add_card_routes_through_safe_add_card(self):
        """Verify add_card MCP tool routes through safe_add_card()."""
        from tools_cards import _handle_add_card
        import inspect

        source = inspect.getsource(_handle_add_card)

        # Should call safe_add_card
        self.assertIn("safe_add_card(", source,
                     "Should call safe_add_card()")

        # Should NOT call add_card directly
        self.assertNotIn("mcp_service.add_card(", source,
                        "Should not call add_card() directly")

    def test_c3_exchange_analyzer_signature_fixed(self):
        """Verify http_send_batch calls ea.analyze() with correct signature."""
        from tools_http import _handle_http_send_batch
        import inspect

        source = inspect.getsource(_handle_http_send_batch)

        # Should pass request and response dicts
        self.assertIn('ea.analyze(', source, "Should call analyze()")
        self.assertIn('request={', source, "Should pass request dict")
        self.assertIn('response={', source, "Should pass response dict")

        # Should NOT use old parameter names
        self.assertNotIn('url=', source.split('ea.analyze(')[1].split(')')[0],
                        "Should not use url= parameter in analyze()")

    def test_c4_credential_password_redacted(self):
        """Verify credential logging redacts password."""
        from tools_credentials import _handle_credentials_add
        import inspect

        source = inspect.getsource(_handle_credentials_add)

        # Should redact password in technical_analysis
        self.assertIn(':***', source, "Should use *** for password in output")

        # Should redact in logger
        count_redacted = source.count(':***')
        self.assertGreaterEqual(count_redacted, 2,
                               "Should redact password in multiple places")

    def test_c6_nuclei_runner_constructor_fixed(self):
        """Verify recon_pipeline uses correct NucleiRunner constructor."""
        from lib.recon_pipeline import ReconPipeline
        import inspect

        source = inspect.getsource(ReconPipeline._stage_nuclei_scan)

        # Should import NucleiConfig
        self.assertIn('NucleiConfig', source, "Should import NucleiConfig")

        # Should create config
        self.assertIn('config =', source, "Should create NucleiConfig")

        # Should pass config to NucleiRunner
        self.assertIn('NucleiRunner(config', source,
                     "Should pass config to NucleiRunner()")


class TestRound6Frontend(unittest.TestCase):
    """Test frontend fixes."""

    def test_a2_frontend_url_corrected(self):
        """Verify frontend uses /sections/phases not /phases/progress."""
        frontend_file = Path(__file__).parent.parent.parent / "frontend" / "src" / "pages" / "AssessmentDetail.jsx"

        if not frontend_file.exists():
            self.skipTest("Frontend file not found")

        content = frontend_file.read_text()

        # Should use correct URL
        self.assertIn('/sections/phases', content,
                     "Should use /sections/phases endpoint")

        # Should NOT use old URL
        self.assertNotIn('/phases/progress', content,
                        "Should not use /phases/progress (wrong endpoint)")


if __name__ == "__main__":
    unittest.main()
