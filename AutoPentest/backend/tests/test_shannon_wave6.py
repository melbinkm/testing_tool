"""Tests for Shannon Wave 6 features: Browser sessions, DOM instrumentation, WebSocket, Multi-tab."""
import sys
import types
import unittest
import json
from unittest.mock import AsyncMock, MagicMock, patch, PropertyMock

sys.path.insert(0, 'mcp/modules')

# Mock mcp.types to avoid import errors on system Python.
# We need Tool.__init__ to store kwargs (especially 'name') as attributes.
def _tool_init(self, **kwargs):
    for k, v in kwargs.items():
        setattr(self, k, v)

_ToolCls = type('Tool', (), {'__init__': _tool_init})
_TextContentCls = type('TextContent', (), {'__init__': lambda s, **k: None})

if 'mcp' not in sys.modules:
    sys.modules['mcp'] = types.ModuleType('mcp')
if 'mcp.types' not in sys.modules:
    mcp_types = types.ModuleType('mcp.types')
    mcp_types.Tool = _ToolCls
    mcp_types.TextContent = _TextContentCls
    sys.modules['mcp.types'] = mcp_types

# Temporarily swap in our Tool class to ensure tools_browser picks it up,
# then restore the original to avoid affecting other test files.
_orig_tool = sys.modules['mcp.types'].Tool
sys.modules['mcp.types'].Tool = _ToolCls
# Force re-import of tools_browser with our Tool class
if 'tools_browser' in sys.modules:
    del sys.modules['tools_browser']
import tools_browser as _tb_module  # noqa: E402
# Restore original Tool so other test files are not affected
sys.modules['mcp.types'].Tool = _orig_tool


class TestBrowserToolCount(unittest.TestCase):
    """Verify tools_browser.py tool definitions."""

    def test_tool_count_at_least_24(self):
        from tools_browser import get_browser_tools
        tools = get_browser_tools()
        self.assertGreaterEqual(len(tools), 24)

    def test_ws_connect_tool_exists(self):
        from tools_browser import get_browser_tools
        tools = get_browser_tools()
        names = [t.name for t in tools]
        self.assertIn("browser_ws_connect", names)

    def test_ws_send_tool_exists(self):
        from tools_browser import get_browser_tools
        tools = get_browser_tools()
        names = [t.name for t in tools]
        self.assertIn("browser_ws_send", names)

    def test_ws_listen_tool_exists(self):
        from tools_browser import get_browser_tools
        tools = get_browser_tools()
        names = [t.name for t in tools]
        self.assertIn("browser_ws_listen", names)

    def test_instrument_dom_tool_exists(self):
        from tools_browser import get_browser_tools
        tools = get_browser_tools()
        names = [t.name for t in tools]
        self.assertIn("browser_instrument_dom", names)

    def test_get_dom_mutations_tool_exists(self):
        from tools_browser import get_browser_tools
        tools = get_browser_tools()
        names = [t.name for t in tools]
        self.assertIn("browser_get_dom_mutations", names)

    def test_new_tab_tool_exists(self):
        from tools_browser import get_browser_tools
        tools = get_browser_tools()
        names = [t.name for t in tools]
        self.assertIn("browser_new_tab", names)

    def test_switch_tab_tool_exists(self):
        from tools_browser import get_browser_tools
        tools = get_browser_tools()
        names = [t.name for t in tools]
        self.assertIn("browser_switch_tab", names)

    def test_postmessage_test_tool_exists(self):
        from tools_browser import get_browser_tools
        tools = get_browser_tools()
        names = [t.name for t in tools]
        self.assertIn("browser_postmessage_test", names)


class TestBrowserSessionCreate(unittest.IsolatedAsyncioTestCase):
    """Test browser_session_create and browser_session_close tools."""

    @patch('tools_browser._get_session_manager')
    async def test_session_create_returns_session_id(self, mock_get_mgr):
        from tools_browser import handle_browser_tool
        mock_mgr = AsyncMock()
        mock_session = AsyncMock()
        mock_session._session_id = "test-session-1"
        mock_mgr.create_session.return_value = mock_session
        mock_get_mgr.return_value = mock_mgr

        mock_service = MagicMock()
        mock_service.current_assessment_id = 1
        mock_service.current_base_url = "http://target.com"

        result = await handle_browser_tool(
            "browser_session_create",
            {"session_name": "test-session"},
            mock_service
        )
        self.assertTrue(len(result) > 0)

    @patch('tools_browser._get_session_manager')
    async def test_session_close(self, mock_get_mgr):
        from tools_browser import handle_browser_tool
        mock_mgr = AsyncMock()
        mock_get_mgr.return_value = mock_mgr

        mock_service = MagicMock()
        mock_service.current_assessment_id = 1
        mock_service.current_base_url = "http://target.com"

        result = await handle_browser_tool(
            "browser_session_close",
            {"session_name": "test-session"},
            mock_service
        )
        self.assertTrue(len(result) > 0)


class TestWsConnectHandler(unittest.IsolatedAsyncioTestCase):
    """Test browser_ws_connect handler."""

    @patch('tools_browser._get_session_manager')
    async def test_ws_connect_missing_url(self, mock_get_mgr):
        from tools_browser import handle_browser_tool
        mock_service = MagicMock()
        mock_service.current_assessment_id = 1
        mock_service.current_base_url = "http://target.com"

        result = await handle_browser_tool("browser_ws_connect", {}, mock_service)
        self.assertTrue(len(result) > 0)

    @patch('tools_browser._get_session_manager')
    async def test_ws_connect_success(self, mock_get_mgr):
        from tools_browser import handle_browser_tool
        mock_mgr = AsyncMock()
        mock_session = AsyncMock()
        mock_page = AsyncMock()
        mock_page.evaluate.return_value = {"status": "connecting", "connection_id": "ws-1"}
        mock_session._page = mock_page
        mock_mgr.get_session.return_value = mock_session
        mock_get_mgr.return_value = mock_mgr

        mock_service = MagicMock()
        mock_service.current_assessment_id = 1
        mock_service.current_base_url = "http://target.com"

        result = await handle_browser_tool(
            "browser_ws_connect",
            {"url": "ws://target.com/ws", "session_name": "default"},
            mock_service
        )
        self.assertTrue(len(result) > 0)


class TestInstrumentDomHandler(unittest.IsolatedAsyncioTestCase):
    """Test browser_instrument_dom handler."""

    @patch('tools_browser._get_session_manager')
    async def test_instrument_dom(self, mock_get_mgr):
        from tools_browser import handle_browser_tool
        mock_mgr = AsyncMock()
        mock_session = AsyncMock()
        mock_page = AsyncMock()
        mock_page.evaluate.return_value = "instrumentation_installed"
        mock_session._page = mock_page
        mock_mgr.get_session.return_value = mock_session
        mock_get_mgr.return_value = mock_mgr

        mock_service = MagicMock()
        mock_service.current_assessment_id = 1
        mock_service.current_base_url = "http://target.com"

        result = await handle_browser_tool(
            "browser_instrument_dom",
            {"session_name": "default"},
            mock_service
        )
        self.assertTrue(len(result) > 0)


class TestGetDomMutationsHandler(unittest.IsolatedAsyncioTestCase):
    """Test browser_get_dom_mutations handler."""

    @patch('tools_browser._get_session_manager')
    async def test_get_mutations_empty(self, mock_get_mgr):
        from tools_browser import handle_browser_tool
        mock_mgr = AsyncMock()
        mock_session = AsyncMock()
        mock_page = AsyncMock()
        mock_page.evaluate.return_value = []
        mock_session._page = mock_page
        mock_mgr.get_session.return_value = mock_session
        mock_get_mgr.return_value = mock_mgr

        mock_service = MagicMock()
        mock_service.current_assessment_id = 1
        mock_service.current_base_url = "http://target.com"

        result = await handle_browser_tool(
            "browser_get_dom_mutations",
            {"session_name": "default"},
            mock_service
        )
        self.assertTrue(len(result) > 0)

    @patch('tools_browser._get_session_manager')
    async def test_get_mutations_with_data(self, mock_get_mgr):
        from tools_browser import handle_browser_tool
        mock_mgr = AsyncMock()
        mock_session = AsyncMock()
        mock_page = AsyncMock()
        mock_page.evaluate.return_value = [
            {"type": "childList", "target": "div", "addedNodes": 1}
        ]
        mock_session._page = mock_page
        mock_mgr.get_session.return_value = mock_session
        mock_get_mgr.return_value = mock_mgr

        mock_service = MagicMock()
        mock_service.current_assessment_id = 1
        mock_service.current_base_url = "http://target.com"

        result = await handle_browser_tool(
            "browser_get_dom_mutations",
            {"session_name": "default"},
            mock_service
        )
        self.assertTrue(len(result) > 0)


class TestNewTabHandler(unittest.IsolatedAsyncioTestCase):
    """Test browser_new_tab handler."""

    @patch('tools_browser._get_session_manager')
    async def test_new_tab(self, mock_get_mgr):
        from tools_browser import handle_browser_tool
        mock_mgr = AsyncMock()
        mock_session = AsyncMock()
        mock_page = AsyncMock()
        mock_context = MagicMock()
        mock_new_page = AsyncMock()
        mock_context.new_page = AsyncMock(return_value=mock_new_page)
        mock_context.pages = [mock_page, mock_new_page]
        mock_session._page = mock_page
        mock_session._context = mock_context
        mock_mgr.get_session.return_value = mock_session
        mock_get_mgr.return_value = mock_mgr

        mock_service = MagicMock()
        mock_service.current_assessment_id = 1
        mock_service.current_base_url = "http://target.com"

        result = await handle_browser_tool(
            "browser_new_tab",
            {"session_name": "default"},
            mock_service
        )
        self.assertTrue(len(result) > 0)


class TestSwitchTabHandler(unittest.IsolatedAsyncioTestCase):
    """Test browser_switch_tab handler."""

    @patch('tools_browser._get_session_manager')
    async def test_switch_tab_missing_id(self, mock_get_mgr):
        from tools_browser import handle_browser_tool
        mock_service = MagicMock()
        mock_service.current_assessment_id = 1
        mock_service.current_base_url = "http://target.com"

        result = await handle_browser_tool(
            "browser_switch_tab",
            {"session_name": "default"},
            mock_service
        )
        self.assertTrue(len(result) > 0)


class TestPostMessageHandler(unittest.IsolatedAsyncioTestCase):
    """Test browser_postmessage_test handler."""

    @patch('tools_browser._get_session_manager')
    async def test_postmessage_test(self, mock_get_mgr):
        from tools_browser import handle_browser_tool
        mock_mgr = AsyncMock()
        mock_session = AsyncMock()
        mock_page = AsyncMock()
        mock_page.evaluate.return_value = {
            "messages_received": 1,
            "wildcard_origin_used": False,
            "null_origin_response": False,
            "sensitive_data_in_response": False,
        }
        mock_session._page = mock_page
        mock_mgr.get_session.return_value = mock_session
        mock_get_mgr.return_value = mock_mgr

        mock_service = MagicMock()
        mock_service.current_assessment_id = 1
        mock_service.current_base_url = "http://target.com"

        result = await handle_browser_tool(
            "browser_postmessage_test",
            {"origin": "http://evil.com", "message": "test", "session_name": "default"},
            mock_service
        )
        self.assertTrue(len(result) > 0)


class TestHandlerDispatch(unittest.IsolatedAsyncioTestCase):
    """Test that handler dispatch routes to correct functions."""

    @patch('tools_browser._get_session_manager')
    async def test_unknown_tool_returns_error(self, mock_get_mgr):
        from tools_browser import handle_browser_tool
        mock_service = MagicMock()
        mock_service.current_assessment_id = 1
        mock_service.current_base_url = "http://target.com"

        result = await handle_browser_tool("browser_nonexistent", {}, mock_service)
        self.assertTrue(len(result) > 0)


if __name__ == '__main__':
    unittest.main()
