"""Tests for Strix skill resources, framework/protocol resources, and get_relevant_skills tool."""
import sys
import os
import unittest
import asyncio
import json

# Fix import path: local mcp/ must come before pip mcp package
sys.path.insert(0, os.path.join(os.path.dirname(os.path.dirname(os.path.abspath(__file__))), 'mcp', 'modules'))
sys.path.insert(0, os.path.dirname(os.path.dirname(os.path.abspath(__file__))))


class TestSkillResources(unittest.TestCase):
    """Test vulnerability methodology skill file loading."""

    def test_get_skill_content_xss(self):
        from resources import _get_skill_content
        content = _get_skill_content("xss")
        self.assertIsInstance(content, str)
        self.assertGreater(len(content), 100)
        self.assertIn("# XSS", content)

    def test_get_skill_content_sql_injection(self):
        from resources import _get_skill_content
        content = _get_skill_content("sql_injection")
        self.assertIsInstance(content, str)
        self.assertGreater(len(content), 100)

    def test_get_skill_content_unknown(self):
        from resources import _get_skill_content
        content = _get_skill_content("unknown_skill")
        self.assertIn("Error:", content)
        self.assertIn("Unknown skill", content)

    def test_skill_has_autopentest_tools_section(self):
        from resources import _get_skill_content
        content = _get_skill_content("xss")
        self.assertIn("## AutoPentest Tools", content)
        self.assertIn("`http_send`", content)
        self.assertIn("`record_finding`", content)
        self.assertIn("`coverage_mark`", content)

    def test_skill_no_yaml_frontmatter(self):
        from resources import _get_skill_content
        content = _get_skill_content("authentication_jwt")
        # Content should not start with --- (YAML frontmatter)
        self.assertFalse(content.strip().startswith("---"))

    def test_all_17_skills_exist(self):
        from resources import _VALID_SKILL_NAMES, _get_skill_content
        self.assertEqual(len(_VALID_SKILL_NAMES), 17)
        for name in _VALID_SKILL_NAMES:
            content = _get_skill_content(name)
            self.assertNotIn("Error:", content, f"Skill {name} failed to load")
            self.assertIn("## AutoPentest Tools", content, f"Skill {name} missing AutoPentest Tools section")


class TestFrameworkResources(unittest.TestCase):
    """Test framework/technology skill file loading."""

    def test_get_framework_content_fastapi(self):
        from resources import _get_framework_content
        content = _get_framework_content("fastapi")
        self.assertIsInstance(content, str)
        self.assertGreater(len(content), 100)
        self.assertIn("FastAPI", content)

    def test_get_framework_content_unknown(self):
        from resources import _get_framework_content
        content = _get_framework_content("django")
        self.assertIn("Error:", content)

    def test_all_4_frameworks_exist(self):
        from resources import _VALID_FRAMEWORK_NAMES, _get_framework_content
        self.assertEqual(len(_VALID_FRAMEWORK_NAMES), 4)
        for name in _VALID_FRAMEWORK_NAMES:
            content = _get_framework_content(name)
            self.assertNotIn("Error:", content, f"Framework {name} failed to load")
            self.assertIn("## AutoPentest Tools", content, f"Framework {name} missing AutoPentest Tools section")


class TestProtocolResources(unittest.TestCase):
    """Test protocol skill file loading."""

    def test_get_protocol_content_graphql(self):
        from resources import _get_protocol_content
        content = _get_protocol_content("graphql")
        self.assertIsInstance(content, str)
        self.assertGreater(len(content), 100)

    def test_get_protocol_content_unknown(self):
        from resources import _get_protocol_content
        content = _get_protocol_content("grpc")
        self.assertIn("Error:", content)


class TestGetRelevantSkills(unittest.IsolatedAsyncioTestCase):
    """Test the get_relevant_skills tool handler."""

    async def test_vuln_class_xss(self):
        from tools_pentest import _handle_get_relevant_skills
        result = await _handle_get_relevant_skills({"vuln_class": "xss"})
        data = json.loads(result[0].text)
        self.assertGreater(len(data["skills"]), 0)
        self.assertEqual(data["skills"][0]["skill"], "xss")
        self.assertEqual(data["skills"][0]["uri"], "autopentest://skill/xss")

    async def test_vuln_class_sql(self):
        from tools_pentest import _handle_get_relevant_skills
        result = await _handle_get_relevant_skills({"vuln_class": "sql"})
        data = json.loads(result[0].text)
        self.assertGreater(len(data["skills"]), 0)
        self.assertEqual(data["skills"][0]["skill"], "sql_injection")

    async def test_tech_stack_fastapi(self):
        from tools_pentest import _handle_get_relevant_skills
        result = await _handle_get_relevant_skills({"tech_stack": ["fastapi"]})
        data = json.loads(result[0].text)
        self.assertGreater(len(data["skills"]), 0)
        self.assertEqual(data["skills"][0]["skill"], "fastapi")
        self.assertEqual(data["skills"][0]["type"], "framework")
        self.assertEqual(data["skills"][0]["uri"], "autopentest://framework/fastapi")

    async def test_tech_stack_graphql(self):
        from tools_pentest import _handle_get_relevant_skills
        result = await _handle_get_relevant_skills({"tech_stack": ["graphql"]})
        data = json.loads(result[0].text)
        self.assertGreater(len(data["skills"]), 0)
        self.assertEqual(data["skills"][0]["skill"], "graphql")
        self.assertEqual(data["skills"][0]["type"], "protocol")
        self.assertEqual(data["skills"][0]["uri"], "autopentest://protocol/graphql")

    async def test_no_match(self):
        from tools_pentest import _handle_get_relevant_skills
        result = await _handle_get_relevant_skills({"vuln_class": "zzzzz_nonexistent"})
        data = json.loads(result[0].text)
        self.assertEqual(len(data["skills"]), 0)
        self.assertIn("No matching skills", data["message"])

    async def test_combined_vuln_and_tech(self):
        from tools_pentest import _handle_get_relevant_skills
        result = await _handle_get_relevant_skills({
            "vuln_class": "idor",
            "tech_stack": ["nextjs", "supabase"]
        })
        data = json.loads(result[0].text)
        skill_names = [s["skill"] for s in data["skills"]]
        self.assertIn("idor", skill_names)
        self.assertIn("nextjs", skill_names)
        self.assertIn("supabase", skill_names)

    async def test_deduplication(self):
        from tools_pentest import _handle_get_relevant_skills
        result = await _handle_get_relevant_skills({
            "vuln_class": "graphql",
            "tech_stack": ["graphql"]
        })
        data = json.loads(result[0].text)
        graphql_entries = [s for s in data["skills"] if s["skill"] == "graphql"]
        self.assertEqual(len(graphql_entries), 1)


class TestResourceEntries(unittest.TestCase):
    """Test that resources are properly registered."""

    def test_skill_resources_in_list(self):
        from resources import get_resources
        resources = get_resources()
        uris = [str(r.uri) for r in resources]
        self.assertIn("autopentest://skill/xss", uris)
        self.assertIn("autopentest://skill/sql_injection", uris)

    def test_framework_resources_in_list(self):
        from resources import get_resources
        resources = get_resources()
        uris = [str(r.uri) for r in resources]
        self.assertIn("autopentest://framework/fastapi", uris)
        self.assertIn("autopentest://framework/supabase", uris)

    def test_protocol_resources_in_list(self):
        from resources import get_resources
        resources = get_resources()
        uris = [str(r.uri) for r in resources]
        self.assertIn("autopentest://protocol/graphql", uris)

    def test_instructions_resource_in_list(self):
        from resources import get_resources
        resources = get_resources()
        uris = [str(r.uri) for r in resources]
        self.assertIn("autopentest://instructions", uris)


if __name__ == "__main__":
    unittest.main()
