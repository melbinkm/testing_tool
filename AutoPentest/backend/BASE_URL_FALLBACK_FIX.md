# Base URL Fallback Fix - COMPLETE ✅

## Problem

When running `orchestration_auto_run`, the autonomous runbook failed with:
```
"error": "target_domain requires base_url to be set. Call load_assessment() first."
```

**Root Cause:** The InvoiceFlow2 assessment had `ip_scopes` configured but no `target_domains`, so `current_base_url` was set to `None`, causing the runbook to fail when it tried to derive `target_domain`.

## Impact

Assessments configured with IP scopes but no target domains couldn't use the autonomous runbook.

## Solution

Added fallback logic to construct `base_url` from `ip_scopes` when `target_domains` is empty.

### Code Change

**File:** `backend/mcp/modules/tools_assessment.py` (lines 245-258)

**Before:**
```python
# Extract base URL from target domains if available (Fix B3)
if assessment.get("target_domains") and len(assessment["target_domains"]) > 0:
    mcp_service.current_base_url = assessment["target_domains"][0]
else:
    mcp_service.current_base_url = None
```

**After:**
```python
# Extract base URL from target domains if available (Fix B3)
if assessment.get("target_domains") and len(assessment["target_domains"]) > 0:
    mcp_service.current_base_url = assessment["target_domains"][0]
elif assessment.get("ip_scopes") and len(assessment["ip_scopes"]) > 0:
    # Fallback: construct base_url from first IP scope (Fix: autonomous runbook support)
    ip_scope = assessment["ip_scopes"][0]
    # Extract IP from CIDR notation (e.g., "172.26.240.78/32" -> "172.26.240.78")
    ip = ip_scope.split('/')[0] if '/' in ip_scope else ip_scope
    # Use port from scope if available, otherwise default to 80
    port = assessment.get("ports", [80])[0] if assessment.get("ports") else 80
    mcp_service.current_base_url = f"http://{ip}:{port}" if port != 80 else f"http://{ip}"
else:
    mcp_service.current_base_url = None
```

## Behavior

### Scenario 1: target_domains present
- **Input:** `target_domains: ["http://example.com"]`
- **Output:** `current_base_url = "http://example.com"`

### Scenario 2: No target_domains, has ip_scopes + ports
- **Input:** `ip_scopes: ["172.26.240.78/32"], ports: [5000]`
- **Output:** `current_base_url = "http://172.26.240.78:5000"`

### Scenario 3: No target_domains, has ip_scopes, default port
- **Input:** `ip_scopes: ["172.26.240.78"], ports: [80]`
- **Output:** `current_base_url = "http://172.26.240.78"`

### Scenario 4: No target_domains, has ip_scopes with CIDR
- **Input:** `ip_scopes: ["192.168.1.0/24"], ports: [443]`
- **Output:** `current_base_url = "http://192.168.1.0:443"`

### Scenario 5: No target_domains, no ip_scopes
- **Input:** `target_domains: [], ip_scopes: []`
- **Output:** `current_base_url = None` (runbook will fail, user must configure assessment)

## Testing

**User should:**
1. Call `load_assessment(name="InvoiceFlow2")` (without skip_data)
2. Verify `current_base_url` is now set to `http://172.26.240.78:5000`
3. Call `orchestration_auto_run(action="next")`
4. Should now succeed instead of failing with "target_domain requires base_url"

## Files Modified

- `backend/mcp/modules/tools_assessment.py` (+7 lines)

## Status

**✅ DEPLOYED** - Backend restarted with fix

**Date:** 2026-02-18
