"""
Scope Sync Service - Auto-sync assessment scope to MCP wm_scope_config.

When users add target domains/IPs/ports in the frontend, this service
automatically syncs that data to the wm_scope_config table that the MCP
server uses for scope validation.
"""

import re
import logging
from typing import Optional
from urllib.parse import urlparse

import asyncpg

# Import scope types from MCP modules
import sys
import os

# Add MCP modules to path (works both in Docker and local dev)
if os.path.exists('/app/mcp/modules'):
    sys.path.insert(0, '/app/mcp/modules')
else:
    # Local development path
    mcp_modules_path = os.path.join(os.path.dirname(__file__), '..', 'mcp', 'modules')
    sys.path.insert(0, mcp_modules_path)

from lib.scope_types import EngagementScope, EngagementInfo, ScopeAllowlist
from lib.scope_loader_db import save_scope_to_db

logger = logging.getLogger(__name__)


def slugify(text: str) -> str:
    """Convert text to slug format (lowercase, hyphens, alphanumeric)."""
    text = text.lower()
    text = re.sub(r'[^a-z0-9]+', '-', text)
    text = text.strip('-')
    return text


def extract_urls_from_scope_text(scope_text: Optional[str]) -> list[str]:
    """Extract URLs from scope description text.

    Parameters
    ----------
    scope_text : str or None
        The scope description field from assessment.

    Returns
    -------
    list[str]
        List of URLs found in the text.
    """
    if not scope_text:
        return []

    # Simple URL regex (http/https URLs)
    url_pattern = r'https?://[^\s<>"{}|\\^`\[\]]+'
    urls = re.findall(url_pattern, scope_text)

    # Clean up any trailing punctuation
    cleaned_urls = []
    for url in urls:
        url = url.rstrip('.,;:!?)')
        cleaned_urls.append(url)

    return cleaned_urls


async def sync_assessment_scope_to_mcp(
    assessment,
    pool: asyncpg.Pool,
) -> int:
    """Sync assessment scope fields to wm_scope_config for MCP server.

    Converts simple frontend fields (target_domains, ip_scopes, ports) into
    a full EngagementScope Pydantic model and saves it to the database.

    The MCP server reads from wm_scope_config, so this bridges the gap between
    the two scope storage systems.

    Parameters
    ----------
    assessment : Assessment
        SQLAlchemy assessment model instance with scope fields populated.
    pool : asyncpg.Pool
        Asyncpg connection pool to PostgreSQL.

    Returns
    -------
    int
        Version number of the created scope configuration.

    Raises
    ------
    Exception
        If scope construction or database save fails.
    """
    # Extract fields from assessment
    assessment_id = assessment.id
    assessment_name = assessment.name
    client_name = assessment.client_name or ""
    target_domains = assessment.target_domains or []
    ip_scopes = assessment.ip_scopes or []
    ports = assessment.ports or []
    scope_text = assessment.scope or ""
    start_date = assessment.start_date.isoformat() if assessment.start_date else ""
    end_date = assessment.end_date.isoformat() if assessment.end_date else ""

    # Extract URLs from scope text
    urls = extract_urls_from_scope_text(scope_text)

    # Build EngagementInfo
    engagement_id = slugify(assessment_name)
    if not engagement_id:  # Fallback if name is all special chars
        engagement_id = f"assessment-{assessment_id}"

    engagement_info = EngagementInfo(
        id=engagement_id,
        name=assessment_name,
        client=client_name,
        start_date=start_date,
        end_date=end_date,
        timezone="UTC",
    )

    # Build ScopeAllowlist
    allowlist = ScopeAllowlist(
        domains=target_domains if target_domains else None,
        ip_ranges=ip_scopes if ip_scopes else None,
        ports=ports if ports else None,
        urls=urls if urls else None,
    )

    # Build EngagementScope with defaults for all other fields
    scope = EngagementScope(
        engagement=engagement_info,
        allowlist=allowlist,
    )

    # Save to database (creates new version, deactivates old versions)
    version = await save_scope_to_db(
        assessment_id=assessment_id,
        scope=scope,
        pool=pool,
        created_by="frontend_sync",
        notes="Auto-synced from assessment scope fields",
    )

    logger.info(
        f"Synced scope to MCP for assessment {assessment_id} "
        f"(v{version}, engagement_id={engagement_id})"
    )

    return version
