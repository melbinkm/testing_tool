# Verification Checklist - Assessment 4 vs 6 Gap Fixes

## Quick Verification Commands

### 1. Verify Command History Logging (Fix 1)

**Test:** Load any assessment via MCP and run a container command
```bash
# Expected: Commands should appear in command_history table
docker exec -i autopentest_postgres psql -U autopentest -d autopentest_db -c \
  "SELECT COUNT(*) FROM command_history WHERE assessment_id = 6;"
```
**Expected Result:** Count > 0 after any MCP tool execution

---

### 2. Verify UI Phase Completion Display (Fix 2)

**Test Assessment 4:**
```bash
curl -s http://localhost:8000/api/assessments/4/sections/phases | \
  python3 -c "import sys,json; d=json.load(sys.stdin); print('Complete:', d['is_complete'], '| Message:', d['message'])"
```
**Expected Result:** `Complete: True | Message: Assessment Complete`

**Test Assessment 6:**
```bash
curl -s http://localhost:8000/api/assessments/6/sections/phases | \
  python3 -c "import sys,json; d=json.load(sys.stdin); print('Complete:', d['is_complete'], '| Message:', d['message'])"
```
**Expected Result:** `Complete: True | Message: Assessment Complete`

**UI Test:**
1. Open http://localhost:3000/assessments/4
2. Scroll to "Phase Timeline" section
3. **Expected:** Green completion card with "Assessment Complete" and checkmark

---

### 3. Verify ActivityLogger Integration (Fix 3)

**Test:** Load assessment and advance phase
```bash
# Check activity_log table for phase transitions
docker exec -i autopentest_postgres psql -U autopentest -d autopentest_db -c \
  "SELECT activity_type, COUNT(*) FROM activity_log WHERE assessment_id = 6 GROUP BY activity_type;"
```
**Expected Result (after running tools):**
```
activity_type       | count
--------------------+-------
tool_execution      | (varies)
phase_transition    | (varies)
```

**Get Phase Transition Details:**
```bash
docker exec -i autopentest_postgres psql -U autopentest -d autopentest_db -c \
  "SELECT data->>'from_phase', data->>'to_phase', data->>'reason', created_at \
   FROM activity_log WHERE activity_type = 'phase_transition' AND assessment_id = 6 \
   ORDER BY created_at DESC LIMIT 5;"
```

---

### 4. Verify Centralized Tool Logging (Fix 4)

**Test:** Execute any MCP tool
```bash
# Check tool execution logs
docker exec -i autopentest_postgres psql -U autopentest -d autopentest_db -c \
  "SELECT data->>'tool_name', data->>'status', data->>'execution_time_ms' \
   FROM activity_log WHERE activity_type = 'tool_execution' AND assessment_id = 6 \
   ORDER BY created_at DESC LIMIT 10;"
```
**Expected Result:** Shows tool names, status (started/completed/failed), execution times

**Activity Log Summary API:**
```bash
curl -s http://localhost:8000/api/assessments/6/activity_log/summary | python3 -m json.tool
```
**Expected Result:**
```json
{
  "total_entries": (number),
  "activity_types": {
    "tool_execution": (number),
    "phase_transition": (number),
    ...
  },
  ...
}
```

---

### 5. End-to-End Integration Test

**Scenario:** Load assessment, run a tool, advance phase

```python
# Via MCP (using Claude Code or direct MCP client):
# 1. load_assessment(name="InvoiceFlow3")
# 2. execute(command="ls /workspace")
# 3. orchestration_status()
# 4. orchestration_advance(target_phase=2, force=true)
```

**Verify All Logs Created:**
```sql
-- Check all activity for the assessment
SELECT
  activity_type,
  data->>'tool_name' as tool,
  data->>'status' as status,
  created_at
FROM activity_log
WHERE assessment_id = 6
ORDER BY created_at DESC
LIMIT 20;
```

**Expected:**
- `load_assessment` tool_execution entries (started + completed)
- `execute` tool_execution entries
- `orchestration_status` tool_execution entries
- `orchestration_advance` tool_execution entries
- Phase transition entry (from 1 to 2)

---

### 6. Verify No Regressions

**Run Test Suite:**
```bash
cd /mnt/d/testing_tool/AutoPentest/backend
/mnt/d/testing_tool/AutoPentest/backend/venv/bin/python -m pytest tests/ -v
```
**Expected:** 88 tests pass, 36 fail (pre-existing failures from SQLite migration)

**Check Service Initialization:**
```bash
docker logs autopentest_backend 2>&1 | grep -i "activitylogger\|command_history"
```
**Expected:** Log entries showing ActivityLogger initialization

---

## Troubleshooting

### Command History Not Logging
**Symptom:** `command_history` table empty after MCP tool execution
**Check:**
1. Is `pg_pool` initialized? Check backend logs for "asyncpg connection pool created"
2. Is `current_assessment_id` set? Check logs for "Logged command to database"
3. Check for errors: `docker logs autopentest_backend | grep -i "failed to log command"`

### ActivityLogger Not Logging
**Symptom:** `activity_log` table empty
**Check:**
1. Was `load_assessment` called first? ActivityLogger only initialized after loading assessment
2. Check logs: `docker logs autopentest_backend | grep -i "activitylogger initialized"`
3. Check for errors: `docker logs autopentest_backend | grep -i "failed to log"`

### Phase Transitions Not Logged
**Symptom:** No `phase_transition` entries in `activity_log`
**Check:**
1. Is ActivityLogger passed to PhaseOrchestrator? Check `tools_assessment.py` lines 458, 490
2. Check for errors: `docker logs autopentest_backend | grep -i "failed to log phase"`

---

## Database Schema Reference

### command_history Table
```sql
\d command_history
```
Columns: id, assessment_id, container_name, command, stdout, stderr, returncode, execution_time, success, phase, status, created_at

### activity_log Table
```sql
\d activity_log
```
Columns: id, assessment_id, activity_type, timestamp, data (JSONB), created_at

**Activity Types:**
- `tool_execution` - All MCP tool calls
- `phase_transition` - Phase advancement
- `finding_created` - When findings are created
- `scan_started`, `scan_completed` - Scan operations
- `recon_data` - Reconnaissance data collection
- `world_model_update` - World model operations
- `error` - Errors and exceptions

---

## Success Criteria

✅ All commands executed via MCP appear in `command_history`
✅ All tool executions appear in `activity_log` with start/complete/failed status
✅ Phase transitions appear in `activity_log` with metrics
✅ Assessment 4 and 6 show "Assessment Complete" in UI
✅ No new test failures (88 tests still pass)
✅ Backend logs show ActivityLogger initialization on assessment load
