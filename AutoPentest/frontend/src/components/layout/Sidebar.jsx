import React, { useState, useEffect, useCallback } from 'react';
import { useLocation, useNavigate } from 'react-router-dom';
import { Layout, Menu, Badge as AntBadge } from 'antd';
import {
  LayoutDashboard,
  FileText,
  Terminal,
  Settings,
} from '../icons';
import commandSettingsService from '../../services/commandSettingsService';
import { useWebSocketContext } from '../../contexts/WebSocketContext';
import { useTheme } from '../../contexts/ThemeContext';

const { Sider } = Layout;

const Sidebar = ({ onToggle }) => {
  const { isDark } = useTheme();
  const location = useLocation();
  const navigate = useNavigate();
  const [collapsed, setCollapsed] = useState(true);
  const [isHovered, setIsHovered] = useState(false);
  const [pendingCount, setPendingCount] = useState(0);

  const shouldShowExpanded = !collapsed || isHovered;

  // WebSocket for real-time updates
  const { subscribe } = useWebSocketContext();

  // Load pending count
  const loadPendingCount = useCallback(async () => {
    try {
      const data = await commandSettingsService.getPendingCount();
      setPendingCount(data.pending_count || 0);
    } catch (error) {
      // Silently fail
    }
  }, []);

  useEffect(() => {
    loadPendingCount();
    const unsubscribes = [
      subscribe('command_pending_approval', loadPendingCount),
      subscribe('command_approved', loadPendingCount),
      subscribe('command_rejected', loadPendingCount),
      subscribe('command_timeout', loadPendingCount),
    ];
    return () => unsubscribes.forEach(unsub => unsub && unsub());
  }, [subscribe, loadPendingCount]);

  // Notify parent of expansion state
  React.useEffect(() => {
    if (onToggle) {
      onToggle(shouldShowExpanded);
    }
  }, [shouldShowExpanded, onToggle]);

  // Determine selected key from current path
  const getSelectedKey = () => {
    const path = location.pathname;
    if (path === '/') return '/';
    if (path.startsWith('/assessments')) return '/assessments';
    if (path.startsWith('/commands')) return '/commands';
    if (path.startsWith('/settings')) return '/settings';
    return '/';
  };

  const menuItems = [
    {
      key: '/',
      icon: <LayoutDashboard className="w-[18px] h-[18px]" />,
      label: 'Dashboard',
    },
    {
      key: '/assessments',
      icon: <FileText className="w-[18px] h-[18px]" />,
      label: 'Assessments',
    },
    {
      key: '/commands',
      icon: (
        <AntBadge count={pendingCount} size="small" offset={[6, -2]}>
          <Terminal className="w-[18px] h-[18px]" />
        </AntBadge>
      ),
      label: (
        <span className="flex items-center justify-between w-full">
          Commands
          {pendingCount > 0 && (
            <AntBadge
              count={pendingCount}
              size="small"
              style={{ backgroundColor: '#f59e0b' }}
            />
          )}
        </span>
      ),
    },
    {
      key: '/settings',
      icon: <Settings className="w-[18px] h-[18px]" />,
      label: 'Settings',
    },
  ];

  const handleMenuClick = ({ key }) => {
    navigate(key);
  };

  return (
    <Sider
      collapsible
      collapsed={!shouldShowExpanded}
      trigger={null}
      width={256}
      collapsedWidth={64}
      onMouseEnter={() => setIsHovered(true)}
      onMouseLeave={() => setIsHovered(false)}
      style={{
        height: '100vh',
        borderRight: `1px solid ${isDark ? '#404040' : '#e5e5e5'}`,
        overflow: 'hidden',
      }}
    >
      {/* Logo */}
      <div
        style={{
          height: 56,
          display: 'flex',
          alignItems: 'center',
          gap: 8,
          padding: '0 16px',
          borderBottom: `1px solid ${isDark ? '#404040' : '#e5e5e5'}`,
        }}
      >
        <div style={{ width: 32, height: 32, flexShrink: 0, display: 'flex', alignItems: 'center', justifyContent: 'center' }}>
          <img
            src="/assets/autopentest-logo.svg"
            alt="AutoPentest Logo"
            style={{
              width: 28,
              height: 28,
              filter: isDark ? 'invert(1)' : 'none',
            }}
          />
        </div>
        {shouldShowExpanded && (
          <div style={{ minWidth: 0 }}>
            <div style={{ fontSize: 14, fontWeight: 700, color: isDark ? '#f5f5f5' : '#171717', lineHeight: 1.2 }}>
              AutoPentest
            </div>
            <div style={{ fontSize: 11, color: isDark ? '#a3a3a3' : '#737373', lineHeight: 1.2 }}>
              AI Security Assessment
            </div>
          </div>
        )}
      </div>

      {/* Navigation */}
      <Menu
        mode="inline"
        selectedKeys={[getSelectedKey()]}
        items={menuItems}
        onClick={handleMenuClick}
        style={{
          border: 'none',
          flex: 1,
          paddingTop: 8,
        }}
      />

      {/* Footer */}
      {shouldShowExpanded && (
        <div
          style={{
            padding: '12px 16px',
            borderTop: `1px solid ${isDark ? '#404040' : '#e5e5e5'}`,
          }}
        >
          <div style={{ display: 'flex', alignItems: 'center', gap: 8, padding: '4px 8px' }}>
            <img
              src="/assets/autopentest-logo.svg"
              alt="AutoPentest"
              style={{ width: 20, height: 20, filter: isDark ? 'invert(1)' : 'none' }}
            />
            <div style={{ flex: 1, minWidth: 0 }}>
              <div style={{ fontSize: 11, fontWeight: 500, color: isDark ? '#f5f5f5' : '#171717' }}>
                AutoPentest
              </div>
              <div style={{ fontSize: 11, color: isDark ? '#a3a3a3' : '#737373' }}>
                v1.0.0 Beta
              </div>
            </div>
          </div>
        </div>
      )}
    </Sider>
  );
};

export default Sidebar;
