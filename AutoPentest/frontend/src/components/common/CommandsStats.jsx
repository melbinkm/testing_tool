import { useMemo } from 'react';
import { Card, Statistic, Progress, Typography } from 'antd';
import { Terminal, Clock, CheckCircle, XCircle, TrendingUp, TrendingDown } from '../icons';

const { Text, Title } = Typography;

const CommandsStats = ({ commands = [], className = "" }) => {
  const stats = useMemo(() => {
    const total = commands.length;
    const successful = commands.filter(c => c.success).length;
    const failed = total - successful;
    const successRate = total > 0 ? Math.round((successful / total) * 100) : 0;

    const categories = commands.reduce((acc, cmd) => {
      const category = cmd.category || 'other';
      if (!acc[category]) {
        acc[category] = { total: 0, successful: 0, failed: 0 };
      }
      acc[category].total++;
      if (cmd.success) {
        acc[category].successful++;
      } else {
        acc[category].failed++;
      }
      return acc;
    }, {});

    const now = new Date();
    const last7days = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
    const last14days = new Date(now.getTime() - 14 * 24 * 60 * 60 * 1000);

    const recentCommands = commands.filter(c => new Date(c.created_at) > last7days).length;
    const previousCommands = commands.filter(c => {
      const date = new Date(c.created_at);
      return date > last14days && date <= last7days;
    }).length;

    const trend = previousCommands > 0
      ? Math.round(((recentCommands - previousCommands) / previousCommands) * 100)
      : recentCommands > 0 ? 100 : 0;

    return {
      total,
      successful,
      failed,
      successRate,
      categories,
      trend,
      recentCommands
    };
  }, [commands]);

  const categoryColors = {
    recon: '#3b82f6',
    exploitation: '#ef4444',
    reporting: '#22c55e',
    other: '#737373'
  };

  return (
    <Card className={className}>
      <div className="flex items-center justify-between" style={{ marginBottom: 24 }}>
        <Title level={5} style={{ margin: 0 }}>Command Statistics</Title>
        <div className="flex items-center gap-2">
          <Terminal className="w-5 h-5 text-neutral-400" />
          <Text type="secondary">{stats.total} total</Text>
        </div>
      </div>

      {/* Main Stats */}
      <div className="grid grid-cols-3 gap-4" style={{ marginBottom: 24 }}>
        <Card size="small" style={{ textAlign: 'center' }}>
          <Statistic
            value={stats.successful}
            valueStyle={{ color: '#22c55e', fontSize: 24 }}
            prefix={<CheckCircle className="w-5 h-5" style={{ color: '#22c55e' }} />}
            suffix={<Text type="secondary" style={{ fontSize: 12 }}>Successful</Text>}
          />
        </Card>

        <Card size="small" style={{ textAlign: 'center' }}>
          <Statistic
            value={stats.failed}
            valueStyle={{ color: '#ef4444', fontSize: 24 }}
            prefix={<XCircle className="w-5 h-5" style={{ color: '#ef4444' }} />}
            suffix={<Text type="secondary" style={{ fontSize: 12 }}>Failed</Text>}
          />
        </Card>

        <Card size="small" style={{ textAlign: 'center' }}>
          <Statistic
            value={stats.successRate}
            valueStyle={{ color: '#3b82f6', fontSize: 24 }}
            prefix={<Clock className="w-5 h-5" style={{ color: '#3b82f6' }} />}
            suffix={<Text type="secondary" style={{ fontSize: 12 }}>% Rate</Text>}
          />
        </Card>
      </div>

      {/* Trend */}
      <Card size="small" style={{ marginBottom: 24 }}>
        <div className="flex items-center justify-between">
          <div className="flex items-center gap-2">
            <Text strong>Last 7 days</Text>
            <Text type="secondary">({stats.recentCommands} commands)</Text>
          </div>
          <div className="flex items-center gap-1">
            {stats.trend >= 0 ? (
              <>
                <TrendingUp className="w-4 h-4" style={{ color: '#22c55e' }} />
                <Text style={{ color: '#22c55e', fontWeight: 500 }}>+{stats.trend}%</Text>
              </>
            ) : (
              <>
                <TrendingDown className="w-4 h-4" style={{ color: '#ef4444' }} />
                <Text style={{ color: '#ef4444', fontWeight: 500 }}>{stats.trend}%</Text>
              </>
            )}
          </div>
        </div>
      </Card>

      {/* Categories */}
      <div>
        <Text strong style={{ display: 'block', marginBottom: 12 }}>By Category</Text>
        <div className="space-y-2">
          {Object.entries(stats.categories).map(([category, data]) => {
            const color = categoryColors[category] || categoryColors.other;
            const successRate = data.total > 0 ? Math.round((data.successful / data.total) * 100) : 0;

            return (
              <Card size="small" key={category}>
                <div className="flex items-center justify-between">
                  <div className="flex items-center gap-3">
                    <div style={{ width: 12, height: 12, borderRadius: '50%', backgroundColor: color }} />
                    <Text strong style={{ textTransform: 'capitalize' }}>{category}</Text>
                  </div>
                  <div className="flex items-center gap-4">
                    <Text type="secondary">{data.successful}/{data.total}</Text>
                    <div style={{ width: 80 }}>
                      <Progress percent={successRate} size="small" strokeColor={color} showInfo={false} />
                    </div>
                    <Text strong>{successRate}%</Text>
                  </div>
                </div>
              </Card>
            );
          })}
        </div>
      </div>
    </Card>
  );
};

export default CommandsStats;
