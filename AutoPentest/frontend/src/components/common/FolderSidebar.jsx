import { useState } from 'react';
import { Menu, Dropdown, Button as AntButton } from 'antd';
import {
  FolderOpen,
  Clock,
  CheckCircle,
  Archive,
  FolderPlus,
  MoreVertical,
  Edit3
} from '../icons';
import { useTheme } from '../../contexts/ThemeContext';

const FolderSidebar = ({
  folders = [],
  allAssessments = [],
  activeView,
  onViewChange,
  onCreateFolder,
  onEditFolder,
  className = ""
}) => {
  const { isDark } = useTheme();

  // Calculate counts for status views
  const getStatusCount = (status) => {
    return allAssessments.filter(a => a.status === status).length;
  };

  // Status views configuration
  const statusViews = [
    { id: 'active', name: 'Active', icon: Clock, count: getStatusCount('active'), color: '#3b82f6' },
    { id: 'completed', name: 'Completed', icon: CheckCircle, count: getStatusCount('completed'), color: '#22c55e' },
    { id: 'archived', name: 'Archived', icon: Archive, count: getStatusCount('archived'), color: '#737373' },
  ];

  // Custom folders
  const customFolders = folders.map(folder => ({
    id: folder.id.toString(),
    name: folder.name,
    count: folder.assessment_count || 0,
    color: folder.color || '#06b6d4',
    folder: folder
  }));

  const statusMenuItems = statusViews.map(view => {
    const Icon = view.icon;
    return {
      key: view.id,
      icon: <Icon className="w-4 h-4" style={{ color: view.color }} />,
      label: (
        <span className="flex items-center justify-between w-full">
          <span>{view.name}</span>
          <span className="text-xs opacity-60 ml-2">{view.count}</span>
        </span>
      ),
    };
  });

  const folderMenuItems = customFolders.map(folder => ({
    key: folder.id,
    icon: <FolderOpen className="w-4 h-4" style={{ color: folder.color }} />,
    label: (
      <span className="flex items-center justify-between w-full">
        <span className="truncate">{folder.name}</span>
        <span className="flex items-center gap-1">
          <span className="text-xs opacity-60">{folder.count}</span>
          <Dropdown
            menu={{
              items: [{
                key: 'edit',
                icon: <Edit3 className="w-3.5 h-3.5" />,
                label: 'Edit Folder',
                onClick: (e) => {
                  e.domEvent.stopPropagation();
                  onEditFolder(folder.folder);
                },
              }],
            }}
            trigger={['click']}
          >
            <span
              onClick={(e) => e.stopPropagation()}
              className="p-1 opacity-0 group-hover:opacity-100 hover:bg-neutral-200 dark:hover:bg-neutral-600 rounded transition-all cursor-pointer"
            >
              <MoreVertical className="w-3 h-3" />
            </span>
          </Dropdown>
        </span>
      </span>
    ),
  }));

  const allItems = [
    ...statusMenuItems,
    ...(customFolders.length > 0 ? [
      { type: 'group', label: 'My Folders', children: folderMenuItems },
    ] : []),
  ];

  return (
    <div className={`flex flex-col h-full ${className}`}>
      {/* Header */}
      <div style={{ padding: '16px 16px 8px', borderBottom: `1px solid ${isDark ? '#404040' : '#e5e5e5'}` }}>
        <span className="text-xs font-semibold text-neutral-500 dark:text-neutral-400 uppercase tracking-wider">
          Views
        </span>
      </div>

      {/* Menu */}
      <div className="flex-1 overflow-y-auto">
        <Menu
          mode="inline"
          selectedKeys={[activeView]}
          onClick={({ key }) => onViewChange(key)}
          items={allItems}
          style={{ border: 'none' }}
        />
      </div>

      {/* Footer */}
      <div style={{ padding: 16, borderTop: `1px solid ${isDark ? '#404040' : '#e5e5e5'}` }}>
        <AntButton
          type="text"
          icon={<FolderPlus className="w-4 h-4" />}
          onClick={onCreateFolder}
          block
          style={{ textAlign: 'left', display: 'flex', alignItems: 'center', gap: 8 }}
        >
          New Folder
        </AntButton>
      </div>
    </div>
  );
};

export default FolderSidebar;
