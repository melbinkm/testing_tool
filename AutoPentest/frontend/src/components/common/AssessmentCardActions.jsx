import { useRef } from 'react';
import { Dropdown, Button } from 'antd';
import { MoreVertical, Folder, Copy, Trash2, Share, FileText } from 'lucide-react';
import folderService from '../../services/folderService';

const AssessmentCardActions = ({
  assessment,
  folders = [],
  onAssessmentUpdate,
  onAssessmentDelete
}) => {
  const customFolders = folders.filter(folder => !folder.is_system);

  const handleMoveToFolder = async (folderId) => {
    try {
      await folderService.moveAssessment(assessment.id, folderId);
      onAssessmentUpdate();
    } catch (error) {
      console.error('Failed to move assessment:', error);
    }
  };

  const handleDuplicate = async () => {
    try {
      await folderService.duplicateAssessment(assessment.id);
      onAssessmentUpdate();
    } catch (error) {
      console.error('Failed to duplicate assessment:', error);
    }
  };

  const handleDelete = async () => {
    if (window.confirm(`Are you sure you want to delete "${assessment.name}"? This action cannot be undone.`)) {
      try {
        onAssessmentDelete(assessment.id);
      } catch (error) {
        console.error('Failed to delete assessment:', error);
      }
    }
  };

  const folderItems = customFolders.length > 0 ? [
    {
      key: 'move-group',
      type: 'group',
      label: 'Move to Folder',
      children: [
        {
          key: 'no-folder',
          icon: <Folder className="w-4 h-4" />,
          label: 'No Folder',
          onClick: () => handleMoveToFolder(null),
        },
        ...customFolders.map(folder => ({
          key: `folder-${folder.id}`,
          icon: <Folder className="w-4 h-4" style={{ color: folder.color }} />,
          label: folder.name,
          onClick: () => handleMoveToFolder(folder.id),
        })),
      ],
    },
    { type: 'divider' },
  ] : [];

  const menuItems = [
    ...folderItems,
    {
      key: 'duplicate',
      icon: <Copy className="w-4 h-4" />,
      label: 'Duplicate Assessment',
      onClick: handleDuplicate,
    },
    {
      key: 'delete',
      icon: <Trash2 className="w-4 h-4" />,
      label: 'Delete Assessment',
      danger: true,
      onClick: handleDelete,
    },
    { type: 'divider' },
    {
      key: 'export',
      icon: <FileText className="w-4 h-4" />,
      label: 'Export Report',
    },
    {
      key: 'share',
      icon: <Share className="w-4 h-4" />,
      label: 'Share Assessment',
    },
  ];

  return (
    <Dropdown menu={{ items: menuItems }} trigger={['click']} placement="bottomRight">
      <Button
        type="text"
        size="small"
        icon={<MoreVertical className="w-4 h-4" />}
        onClick={(e) => e.stopPropagation()}
      />
    </Dropdown>
  );
};

export default AssessmentCardActions;
