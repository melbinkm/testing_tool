import { useNavigate } from 'react-router-dom';
import { Button, Progress, Typography } from 'antd';
import { Terminal, X } from '../icons';
import { usePendingCommands } from '../../contexts/PendingCommandsContext';
import { useEffect, useState, useRef, useCallback } from 'react';
import commandSettingsService from '../../services/commandSettingsService';

const { Text } = Typography;

const CommandApprovalToast = () => {
    const navigate = useNavigate();
    const { showBanner, dismissBanner, latestCommand, pendingCount, loadPendingCommands } = usePendingCommands();
    const [progressPercent, setProgressPercent] = useState(100);
    const [timeoutSec, setTimeoutSec] = useState(30);
    const [visible, setVisible] = useState(false);
    const [isClosing, setIsClosing] = useState(false);
    const intervalRef = useRef(null);
    const hasPlayedSound = useRef(false);

    // Fetch timeout setting
    useEffect(() => {
        commandSettingsService.getSettings()
            .then(s => setTimeoutSec(s.timeout_seconds || 30))
            .catch(() => setTimeoutSec(30));
    }, []);

    // Play notification sound
    const playSound = useCallback(() => {
        if (hasPlayedSound.current) return;
        hasPlayedSound.current = true;
        try {
            const ctx = new (window.AudioContext || window.webkitAudioContext)();
            const osc = ctx.createOscillator();
            const gain = ctx.createGain();
            osc.connect(gain);
            gain.connect(ctx.destination);
            osc.frequency.value = 800;
            osc.type = 'sine';
            gain.gain.setValueAtTime(0.2, ctx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.2);
            osc.start(ctx.currentTime);
            osc.stop(ctx.currentTime + 0.2);
        } catch (e) { }
    }, []);

    // Handle visibility
    useEffect(() => {
        if (showBanner && pendingCount > 0) {
            setIsClosing(false);
            setVisible(true);
            playSound();
        } else if (visible && !isClosing) {
            setIsClosing(true);
            hasPlayedSound.current = false;
            const timer = setTimeout(() => {
                setVisible(false);
                setIsClosing(false);
            }, 300);
            return () => clearTimeout(timer);
        }
    }, [showBanner, pendingCount, visible, isClosing, playSound]);

    // Progress timer
    useEffect(() => {
        if (!visible || !latestCommand?.created_at) {
            return;
        }

        const startTime = new Date(latestCommand.created_at).getTime();
        const commandTimeout = latestCommand.timeout_seconds || timeoutSec;
        const totalMs = commandTimeout * 1000;

        const update = () => {
            const elapsed = Date.now() - startTime;
            const remaining = Math.max(0, totalMs - elapsed);
            const pct = (remaining / totalMs) * 100;
            setProgressPercent(pct);

            if (pct <= 0 && intervalRef.current) {
                clearInterval(intervalRef.current);
                intervalRef.current = null;
                loadPendingCommands();
            }
        };

        update();
        intervalRef.current = setInterval(update, 100);

        return () => {
            if (intervalRef.current) {
                clearInterval(intervalRef.current);
                intervalRef.current = null;
            }
        };
    }, [visible, latestCommand?.created_at, latestCommand?.id, timeoutSec, loadPendingCommands]);

    const handleReview = () => {
        dismissBanner();
        navigate('/commands');
    };

    if (!visible) return null;

    const timeLeft = Math.max(0, Math.ceil((progressPercent / 100) * timeoutSec));

    return (
        <div
            className={`fixed bottom-4 right-4 z-50 transition-all duration-300 ${isClosing ? 'opacity-0 translate-y-4' : 'opacity-100 translate-y-0'}`}
            style={{ width: 288 }}
        >
            <div
                style={{
                    borderRadius: 8,
                    overflow: 'hidden',
                    boxShadow: '0 4px 24px rgba(0,0,0,0.12)',
                }}
                className="bg-white dark:bg-neutral-800 border border-neutral-200 dark:border-neutral-700"
            >
                {/* Progress bar */}
                <Progress
                    percent={progressPercent}
                    showInfo={false}
                    strokeColor="#06b6d4"
                    trailColor="transparent"
                    size="small"
                    style={{ margin: 0, lineHeight: 0 }}
                    strokeLinecap="square"
                />

                <div style={{ padding: 16 }}>
                    {/* Header */}
                    <div className="flex items-center justify-between" style={{ marginBottom: 12 }}>
                        <div className="flex items-center gap-2">
                            <Terminal className="w-4 h-4 text-cyan-500" />
                            <Text strong style={{ fontSize: 13 }}>Approval Required</Text>
                        </div>
                        <div className="flex items-center gap-2">
                            <Text type="secondary" style={{ fontSize: 12, fontFamily: 'monospace' }}>
                                {timeLeft}s
                            </Text>
                            <button
                                onClick={dismissBanner}
                                className="p-1 text-neutral-400 hover:text-neutral-600 dark:hover:text-white rounded transition-colors"
                            >
                                <X className="w-4 h-4" />
                            </button>
                        </div>
                    </div>

                    {/* Command */}
                    {latestCommand?.command && (
                        <div
                            style={{
                                padding: '8px 12px',
                                borderRadius: 6,
                                marginBottom: 12,
                            }}
                            className="bg-neutral-50 dark:bg-neutral-900 border border-neutral-100 dark:border-neutral-700"
                        >
                            <code className="text-xs text-neutral-600 dark:text-neutral-400 font-mono block truncate">
                                {latestCommand.command}
                            </code>
                        </div>
                    )}

                    {/* Footer */}
                    <div className="flex items-center justify-between">
                        <Button type="primary" size="small" onClick={handleReview}>
                            Review
                        </Button>
                        {pendingCount > 1 && (
                            <Text type="secondary" style={{ fontSize: 12 }}>
                                +{pendingCount - 1} more
                            </Text>
                        )}
                    </div>
                </div>
            </div>
        </div>
    );
};

export default CommandApprovalToast;
