import { useState } from 'react';
import { Link } from 'react-router-dom';
import { Table, Tag, Button, Space, Spin, Empty, Dropdown, Tooltip } from 'antd';
import { Calendar, User, Edit3, FolderOpen } from '../icons';
import { MoreVertical } from 'lucide-react';
import StatusDropdown from './StatusDropdown';
import ContextMenu from './ContextMenu';
import folderService from '../../services/folderService';
import apiClient from '../../services/api';

const CATEGORY_COLORS = {
  API: 'blue',
  Website: 'green',
  'External Infra': 'purple',
  Mobile: 'orange',
  Cloud: 'cyan',
  General: 'default',
};

const AssessmentsTable = ({
  assessments = [],
  folders = [],
  onAssessmentUpdate,
  onAssessmentDelete,
  onAssessmentEdit,
  loading = false
}) => {
  const [contextMenu, setContextMenu] = useState({ open: false, position: { x: 0, y: 0 }, assessment: null });

  const getCategoryFromName = (name) => {
    if (name.toLowerCase().includes('api')) return 'API';
    if (name.toLowerCase().includes('web')) return 'Website';
    if (name.toLowerCase().includes('infra') || name.toLowerCase().includes('network')) return 'External Infra';
    if (name.toLowerCase().includes('mobile')) return 'Mobile';
    if (name.toLowerCase().includes('cloud')) return 'Cloud';
    return 'General';
  };

  const formatDeadline = (endDate) => {
    if (!endDate) return 'No deadline';

    const end = new Date(endDate);
    const now = new Date();
    const diffTime = end - now;
    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

    if (diffDays < 0) return `${Math.abs(diffDays)} days ago`;
    if (diffDays === 0) return 'Today';
    if (diffDays === 1) return 'Tomorrow';
    if (diffDays <= 7) return `${diffDays} days from now`;
    return `${Math.ceil(diffDays / 7)} weeks from now`;
  };

  const handleStatusChange = async (assessmentId, newStatus) => {
    try {
      await apiClient.put(`/assessments/${assessmentId}`, { status: newStatus });
      if (onAssessmentUpdate) {
        onAssessmentUpdate();
      }
    } catch (error) {
      console.error('Failed to update assessment status:', error);
    }
  };

  const handleMoveToFolder = async (folderId) => {
    if (!contextMenu.assessment) return;
    try {
      await folderService.moveAssessment(contextMenu.assessment.id, folderId);
      onAssessmentUpdate();
    } catch (error) {
      console.error('Failed to move assessment:', error);
    }
  };

  const handleDuplicate = async () => {
    if (!contextMenu.assessment) return;
    try {
      await folderService.duplicateAssessment(contextMenu.assessment.id);
      onAssessmentUpdate();
    } catch (error) {
      console.error('Failed to duplicate assessment:', error);
    }
  };

  const handleDelete = async () => {
    if (!contextMenu.assessment) return;
    if (window.confirm(`Are you sure you want to delete "${contextMenu.assessment.name}"? This action cannot be undone.`)) {
      onAssessmentDelete(contextMenu.assessment.id);
    }
  };

  const columns = [
    {
      title: 'Name',
      dataIndex: 'name',
      key: 'name',
      sorter: (a, b) => a.name.localeCompare(b.name),
      width: '25%',
      render: (name, record) => (
        <Link
          to={`/assessments/${record.id}`}
          className="text-sm font-medium hover:text-blue-500 transition-colors"
        >
          {name}
        </Link>
      ),
    },
    {
      title: 'Category',
      key: 'category',
      width: '12%',
      render: (_, record) => {
        const category = record.category || getCategoryFromName(record.name);
        return <Tag color={CATEGORY_COLORS[category] || 'default'}>{category}</Tag>;
      },
    },
    {
      title: 'Client',
      dataIndex: 'client_name',
      key: 'client_name',
      sorter: (a, b) => (a.client_name || '').localeCompare(b.client_name || ''),
      width: '15%',
      render: (client) => (
        <span className="flex items-center gap-1.5">
          <User className="w-3 h-3 text-neutral-400" />
          <span className="text-xs truncate">{client || 'No client'}</span>
        </span>
      ),
    },
    {
      title: 'Status',
      dataIndex: 'status',
      key: 'status',
      sorter: (a, b) => (a.status || '').localeCompare(b.status || ''),
      width: '12%',
      render: (status, record) => (
        <StatusDropdown
          currentStatus={status}
          onStatusChange={(newStatus) => handleStatusChange(record.id, newStatus)}
          disabled={loading}
        />
      ),
    },
    {
      title: 'Folder',
      key: 'folder',
      width: '14%',
      render: (_, record) => {
        if (!record.folder_id) {
          return <span className="text-xs text-neutral-400 italic">No folder</span>;
        }
        const folder = folders.find(f => f.id === record.folder_id);
        return (
          <span className="flex items-center gap-1.5">
            <FolderOpen className="w-3 h-3" style={{ color: folder?.color || '#06b6d4' }} />
            <span className="text-xs truncate">{folder?.name || 'Unknown'}</span>
          </span>
        );
      },
    },
    {
      title: 'Deadline',
      dataIndex: 'end_date',
      key: 'end_date',
      sorter: (a, b) => new Date(a.end_date || 0) - new Date(b.end_date || 0),
      width: '14%',
      render: (endDate) => (
        <span className="flex items-center gap-1.5 text-xs text-neutral-500">
          <Calendar className="w-3 h-3" />
          <span className="truncate">{formatDeadline(endDate)}</span>
        </span>
      ),
    },
    {
      title: '',
      key: 'actions',
      width: '8%',
      align: 'right',
      render: (_, record) => (
        <Space size={4}>
          <Tooltip title="Edit">
            <Button
              type="text"
              size="small"
              icon={<Edit3 className="w-4 h-4" />}
              onClick={(e) => {
                e.stopPropagation();
                onAssessmentEdit(record);
              }}
            />
          </Tooltip>
          <Tooltip title="More actions">
            <Button
              type="text"
              size="small"
              icon={<MoreVertical className="w-4 h-4" />}
              onClick={(e) => {
                e.stopPropagation();
                const rect = e.currentTarget.getBoundingClientRect();
                setContextMenu({
                  open: true,
                  position: { x: rect.right - 200, y: rect.bottom + 5 },
                  assessment: record,
                });
              }}
            />
          </Tooltip>
        </Space>
      ),
    },
  ];

  return (
    <>
      <Table
        dataSource={assessments}
        columns={columns}
        rowKey="id"
        loading={loading}
        pagination={false}
        size="middle"
        locale={{
          emptyText: (
            <Empty
              image={Empty.PRESENTED_IMAGE_SIMPLE}
              description="No assessments found"
            >
              <span className="text-neutral-400">Create your first assessment to get started</span>
            </Empty>
          ),
        }}
        onRow={(record) => ({
          onContextMenu: (e) => {
            e.preventDefault();
            setContextMenu({
              open: true,
              position: { x: e.clientX, y: e.clientY },
              assessment: record,
            });
          },
        })}
      />

      <ContextMenu
        isOpen={contextMenu.open}
        onClose={() => setContextMenu({ open: false, position: { x: 0, y: 0 }, assessment: null })}
        position={contextMenu.position}
        onMoveToFolder={handleMoveToFolder}
        onDuplicate={handleDuplicate}
        onDelete={handleDelete}
        onExport={() => {}}
        onShare={() => {}}
        folders={folders}
        assessment={contextMenu.assessment}
      />
    </>
  );
};

export default AssessmentsTable;
