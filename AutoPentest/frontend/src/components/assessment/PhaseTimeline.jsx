/**
 * PhaseTimeline Component
 *
 * Displays assessment phase progress with visual timeline and progress bar.
 * Fetches data from the world model wm_plans table via backend API.
 */
import React from 'react';
import { Card, Progress, Steps, Tag, Typography, Empty } from 'antd';
import { CheckCircle, Loader2, Clock, AlertTriangle } from '../icons';

const { Text } = Typography;
const { Step } = Steps;

/**
 * Map phase status to Ant Design Steps status
 */
const getStepStatus = (status) => {
  switch (status) {
    case 'done':
      return 'finish';
    case 'in_progress':
      return 'process';
    case 'pending':
      return 'wait';
    default:
      return 'wait';
  }
};

/**
 * Map phase status to icon component
 */
const getStepIcon = (status) => {
  switch (status) {
    case 'done':
      return <CheckCircle className="w-4 h-4" />;
    case 'in_progress':
      return <Loader2 className="w-4 h-4 animate-spin" />;
    case 'pending':
      return <Clock className="w-4 h-4" />;
    default:
      return <Clock className="w-4 h-4" />;
  }
};

/**
 * Map phase status to Tag color
 */
const getStatusColor = (status) => {
  switch (status) {
    case 'done':
      return 'success';
    case 'in_progress':
      return 'processing';
    case 'pending':
      return 'default';
    default:
      return 'default';
  }
};

/**
 * PhaseTimeline Component
 *
 * @param {Object} props
 * @param {Array} props.phases - Array of phase objects with {phase, name, status, result}
 * @param {Number} props.currentPhase - Current phase number (1-5)
 * @param {Number} props.progress - Progress percentage (0-100)
 * @param {String} props.message - Optional status message
 */
export const PhaseTimeline = ({ phases, currentPhase, progress, message }) => {
  // Handle no data case
  if (!phases || phases.length === 0) {
    return (
      <Card size="small" className="mb-4">
        <Empty
          image={<AlertTriangle className="w-8 h-8 mx-auto text-neutral-300 dark:text-neutral-600" />}
          description={
            <Text type="secondary" className="text-sm">
              Phase orchestration not yet initialized
            </Text>
          }
        />
      </Card>
    );
  }

  // Calculate progress color based on percentage
  const getProgressStatus = () => {
    if (progress === 100) return 'success';
    if (progress >= 60) return 'active';
    return 'active';
  };

  return (
    <Card
      size="small"
      className="mb-4"
      title={
        <div className="flex items-center justify-between">
          <span className="text-sm font-semibold">
            Assessment Progress - Phase {currentPhase} of {phases.length}
          </span>
          {message && (
            <Tag color={getStatusColor(phases[currentPhase - 1]?.status)} className="ml-2">
              {message}
            </Tag>
          )}
        </div>
      }
    >
      {/* Progress Bar */}
      <Progress
        percent={progress}
        status={getProgressStatus()}
        className="mb-4"
        strokeColor={{
          '0%': '#1890ff',
          '100%': '#52c41a',
        }}
      />

      {/* Phase Steps Timeline */}
      <Steps current={currentPhase - 1} size="small">
        {phases.map((phase, index) => {
          const stepStatus = getStepStatus(phase.status);
          const icon = getStepIcon(phase.status);

          return (
            <Step
              key={index}
              title={
                <div className="flex items-center gap-2">
                  <Text strong className="text-xs">
                    Phase {phase.phase}
                  </Text>
                </div>
              }
              description={
                <div className="space-y-1">
                  <Text className="text-xs">{phase.name}</Text>
                  {phase.result && phase.result.trim() !== '' && (
                    <Text type="secondary" className="text-xs block truncate max-w-xs">
                      {phase.result.substring(0, 60)}
                      {phase.result.length > 60 ? '...' : ''}
                    </Text>
                  )}
                </div>
              }
              status={stepStatus}
              icon={icon}
            />
          );
        })}
      </Steps>

      {/* Phase Status Summary */}
      <div className="mt-4 pt-3 border-t border-neutral-200 dark:border-neutral-700">
        <div className="flex items-center justify-between text-xs">
          <div className="flex items-center gap-4">
            <div className="flex items-center gap-1">
              <CheckCircle className="w-3 h-3 text-green-500" />
              <Text type="secondary" className="text-xs">
                {phases.filter(p => p.status === 'done').length} Completed
              </Text>
            </div>
            <div className="flex items-center gap-1">
              <Loader2 className="w-3 h-3 text-blue-500" />
              <Text type="secondary" className="text-xs">
                {phases.filter(p => p.status === 'in_progress').length} In Progress
              </Text>
            </div>
            <div className="flex items-center gap-1">
              <Clock className="w-3 h-3 text-neutral-400" />
              <Text type="secondary" className="text-xs">
                {phases.filter(p => p.status === 'pending').length} Pending
              </Text>
            </div>
          </div>
          <Text type="secondary" className="text-xs">
            {Math.round(progress)}% Complete
          </Text>
        </div>
      </div>
    </Card>
  );
};

export default PhaseTimeline;
