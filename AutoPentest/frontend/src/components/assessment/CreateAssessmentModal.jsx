import { useState } from 'react';
import { Modal, Input, Form, Alert, Select, DatePicker } from 'antd';
import apiClient from '../../services/api';

const { TextArea } = Input;

const CreateAssessmentModal = ({ onClose, onSuccess }) => {
  const [form] = Form.useForm();
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState('');

  const handleSubmit = async (values) => {
    setError('');
    setLoading(true);

    try {
      const payload = {
        ...values,
        target_domains: values.target_domains
          ? values.target_domains.split(',').map(d => d.trim()).filter(Boolean)
          : [],
        ip_scopes: values.ip_scopes
          ? values.ip_scopes.split(',').map(ip => ip.trim()).filter(Boolean)
          : [],
        ports: values.ports
          ? values.ports.split(',').map(p => parseInt(p.trim())).filter(p => !isNaN(p))
          : [],
        start_date: values.start_date?.format('YYYY-MM-DD') || null,
        end_date: values.end_date?.format('YYYY-MM-DD') || null,
        category: values.category || null,
        environment: values.environment || 'non_specifie',
      };

      await apiClient.post('/assessments', payload);
      onSuccess();
    } catch (err) {
      setError(err.response?.data?.detail || 'Failed to create assessment');
    } finally {
      setLoading(false);
    }
  };

  return (
    <Modal
      title="Create New Assessment"
      open={true}
      onCancel={onClose}
      onOk={() => form.submit()}
      okText={loading ? 'Creating...' : 'Create Assessment'}
      okButtonProps={{ loading }}
      cancelButtonProps={{ disabled: loading }}
      width={640}
      destroyOnClose
      styles={{ body: { maxHeight: 'calc(100vh - 300px)', overflowY: 'auto' } }}
    >
      <Form
        form={form}
        layout="vertical"
        onFinish={handleSubmit}
        initialValues={{ environment: 'non_specifie' }}
        style={{ marginTop: 16 }}
      >
        {error && (
          <Alert message={error} type="error" showIcon style={{ marginBottom: 16 }} />
        )}

        <Form.Item
          label="Assessment Name"
          name="name"
          rules={[{ required: true, message: 'Please enter an assessment name' }]}
        >
          <Input placeholder="Q4 2025 Pentest" />
        </Form.Item>

        <Form.Item label="Client Name" name="client_name">
          <Input placeholder="Acme Corporation" />
        </Form.Item>

        <Form.Item label="Git Repository URL" name="git_repo_url">
          <Input placeholder="https://github.com/org/repo.git" />
        </Form.Item>

        <div className="grid grid-cols-2 gap-4">
          <Form.Item label="Category" name="category">
            <Select placeholder="Select category" allowClear>
              <Select.Option value="API">API</Select.Option>
              <Select.Option value="Website">Website</Select.Option>
              <Select.Option value="External Infra">External Infra</Select.Option>
              <Select.Option value="Mobile">Mobile</Select.Option>
              <Select.Option value="Cloud">Cloud</Select.Option>
              <Select.Option value="General">General</Select.Option>
            </Select>
          </Form.Item>

          <Form.Item label="Environment" name="environment">
            <Select>
              <Select.Option value="non_specifie">Non specified</Select.Option>
              <Select.Option value="production">Production</Select.Option>
              <Select.Option value="dev">Dev</Select.Option>
            </Select>
          </Form.Item>
        </div>

        <Form.Item label="Scope" name="scope">
          <TextArea
            placeholder="*.example.com, web applications, API endpoints..."
            rows={3}
          />
        </Form.Item>

        <Form.Item label="Limitations" name="limitations">
          <TextArea
            placeholder="No DoS attacks, no social engineering, testing only between 9am-5pm EST..."
            rows={2}
          />
        </Form.Item>

        <Form.Item label="Target Domains" name="target_domains" extra="Comma-separated list">
          <Input placeholder="example.com, app.example.com, api.example.com" />
        </Form.Item>

        <Form.Item label="IP Scopes" name="ip_scopes" extra="Comma-separated list">
          <Input placeholder="192.168.1.0/24, 10.0.0.0/16" />
        </Form.Item>

        <Form.Item label="Ports" name="ports" extra="Comma-separated list">
          <Input placeholder="80, 443, 8080, 5000" />
        </Form.Item>

        <div className="grid grid-cols-2 gap-4">
          <Form.Item label="Start Date" name="start_date">
            <DatePicker style={{ width: '100%' }} />
          </Form.Item>
          <Form.Item label="End Date" name="end_date">
            <DatePicker style={{ width: '100%' }} />
          </Form.Item>
        </div>
      </Form>
    </Modal>
  );
};

export default CreateAssessmentModal;
