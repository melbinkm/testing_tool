import { useState, useEffect } from 'react';
import { Modal, Input, Form, Alert, Select, DatePicker, Button } from 'antd';
import { Save } from 'lucide-react';
import apiClient from '../../services/api';
import dayjs from 'dayjs';

const { TextArea } = Input;

const EditAssessmentModal = ({ assessment, onClose, onSuccess }) => {
  const [form] = Form.useForm();
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState('');

  useEffect(() => {
    if (assessment) {
      form.setFieldsValue({
        name: assessment.name || '',
        client_name: assessment.client_name || '',
        category: assessment.category || undefined,
        environment: assessment.environment || 'non_specifie',
        start_date: assessment.start_date ? dayjs(assessment.start_date) : null,
        end_date: assessment.end_date ? dayjs(assessment.end_date) : null,
        scope: assessment.scope || '',
        limitations: assessment.limitations || '',
        objectives: assessment.objectives || '',
        target_domains: Array.isArray(assessment.target_domains)
          ? assessment.target_domains.join('\n')
          : assessment.target_domains || '',
        ip_scopes: Array.isArray(assessment.ip_scopes)
          ? assessment.ip_scopes.join('\n')
          : assessment.ip_scopes || '',
      });
    }
  }, [assessment, form]);

  const handleSubmit = async (values) => {
    setError('');
    setLoading(true);

    try {
      const submitData = {
        name: values.name,
        start_date: values.start_date?.format('YYYY-MM-DD') || null,
        end_date: values.end_date?.format('YYYY-MM-DD') || null,
        client_name: values.client_name?.trim() || null,
        category: values.category?.trim() || null,
        environment: values.environment || 'non_specifie',
        scope: values.scope?.trim() || null,
        limitations: values.limitations?.trim() || null,
        objectives: values.objectives?.trim() || null,
        target_domains: values.target_domains
          ? values.target_domains.split('\n').filter(d => d.trim())
          : [],
        ip_scopes: values.ip_scopes
          ? values.ip_scopes.split('\n').filter(s => s.trim())
          : [],
      };

      await apiClient.put(`/assessments/${assessment.id}`, submitData);
      onSuccess();
      onClose();
    } catch (err) {
      console.error('Update error:', err.response?.data);
      setError(
        Array.isArray(err.response?.data?.detail)
          ? err.response.data.detail.map(e => e.msg).join(', ')
          : err.response?.data?.detail || 'Failed to update assessment'
      );
    } finally {
      setLoading(false);
    }
  };

  if (!assessment) return null;

  return (
    <Modal
      title="Edit Assessment"
      open={true}
      onCancel={onClose}
      onOk={() => form.submit()}
      okText={loading ? 'Saving...' : 'Save Changes'}
      okButtonProps={{ loading, icon: <Save className="w-4 h-4" /> }}
      cancelButtonProps={{ disabled: loading }}
      width={720}
      destroyOnClose
      styles={{ body: { maxHeight: 'calc(100vh - 300px)', overflowY: 'auto' } }}
    >
      <p className="text-sm text-neutral-500 mb-4">Update assessment details and configuration</p>

      <Form
        form={form}
        layout="vertical"
        onFinish={handleSubmit}
      >
        {error && (
          <Alert message={error} type="error" showIcon style={{ marginBottom: 16 }} />
        )}

        {/* Basic Information */}
        <div className="mb-4">
          <h3 className="text-sm font-semibold text-neutral-700 dark:text-neutral-300 mb-3">Basic Information</h3>
          <Form.Item
            label="Assessment Name"
            name="name"
            rules={[{ required: true, message: 'Please enter an assessment name' }]}
          >
            <Input placeholder="My Security Assessment" />
          </Form.Item>

          <div className="grid grid-cols-2 gap-4">
            <Form.Item label="Client Name" name="client_name">
              <Input placeholder="Acme Corp" />
            </Form.Item>
            <Form.Item label="Category" name="category">
              <Select placeholder="Select category" allowClear>
                <Select.Option value="API">API</Select.Option>
                <Select.Option value="Website">Website</Select.Option>
                <Select.Option value="External Infra">External Infra</Select.Option>
                <Select.Option value="Mobile">Mobile</Select.Option>
                <Select.Option value="Cloud">Cloud</Select.Option>
                <Select.Option value="General">General</Select.Option>
              </Select>
            </Form.Item>
          </div>

          <div className="grid grid-cols-3 gap-4">
            <Form.Item label="Environment" name="environment">
              <Select>
                <Select.Option value="non_specifie">Non specified</Select.Option>
                <Select.Option value="production">Production</Select.Option>
                <Select.Option value="dev">Dev</Select.Option>
              </Select>
            </Form.Item>
            <Form.Item label="Start Date" name="start_date">
              <DatePicker style={{ width: '100%' }} />
            </Form.Item>
            <Form.Item label="End Date" name="end_date">
              <DatePicker style={{ width: '100%' }} />
            </Form.Item>
          </div>
        </div>

        {/* Target Information */}
        <div className="mb-4">
          <h3 className="text-sm font-semibold text-neutral-700 dark:text-neutral-300 mb-3">Target Information</h3>
          <div className="grid grid-cols-2 gap-4">
            <Form.Item label="Target Domains" name="target_domains" extra="One domain per line">
              <TextArea
                rows={4}
                className="font-mono text-xs"
                placeholder={"example.com\nsubdomain.example.com\n*.example.com"}
              />
            </Form.Item>
            <Form.Item label="IP Scopes" name="ip_scopes" extra="One range per line">
              <TextArea
                rows={4}
                className="font-mono text-xs"
                placeholder={"192.168.1.0/24\n10.0.0.1-10.0.0.255\n172.16.0.1"}
              />
            </Form.Item>
          </div>
        </div>

        {/* Scope & Objectives */}
        <div>
          <h3 className="text-sm font-semibold text-neutral-700 dark:text-neutral-300 mb-3">Scope & Objectives</h3>
          <Form.Item label="Scope" name="scope">
            <TextArea rows={3} placeholder="Describe what is in scope for this assessment..." />
          </Form.Item>
          <Form.Item label="Objectives" name="objectives">
            <TextArea rows={3} placeholder="What are the goals of this assessment..." />
          </Form.Item>
          <Form.Item label="Limitations" name="limitations">
            <TextArea rows={3} placeholder="Any restrictions or limitations..." />
          </Form.Item>
        </div>
      </Form>
    </Modal>
  );
};

export default EditAssessmentModal;
