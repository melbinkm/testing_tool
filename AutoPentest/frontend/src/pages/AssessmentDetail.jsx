import { useState, useEffect, useMemo } from 'react';
import { useParams, Link } from 'react-router-dom';
import { Spin, Card, Statistic, Tag, Button, Tabs, Empty, Segmented, Row, Col, Divider, Typography, message } from 'antd';
import { Clock, User, Target, Globe, Server, Shield, ArrowLeft, AlertTriangle, Info, Eye, TrendingUp, Filter, FolderOpen, RefreshCw, Upload } from '../components/icons';
import apiClient from '../services/api';
import workspaceService from '../services/workspaceService';
import EditableField from '../components/common/EditableField';
import ReconTable from '../components/assessment/ReconTable';
import PhaseSection from '../components/assessment/PhaseSection';
import PhaseContentViewSimple from '../components/assessment/PhaseContentViewSimple';
import CardsTable from '../components/assessment/CardsTable';
import CommandHistoryRefactored from '../components/assessment/CommandHistoryRefactored';
import ImportScanModal from '../components/assessment/ImportScanModal';
import CredentialsManager from '../components/assessment/CredentialsManager';
import ContextDocumentsPanel from '../components/assessment/ContextDocumentsPanel';
import ChangeContainerModal from '../components/workspace/ChangeContainerModal';
import PhaseTimeline from '../components/assessment/PhaseTimeline';
import ActivityFeed from '../components/assessment/ActivityFeed';
import { useWebSocket } from '../hooks/useWebSocket';

const { Title, Text } = Typography;

const PHASE_NAMES = {
  1: 'Reconnaissance',
  2: 'Mapping & Enumeration',
  3: 'SAST Code Review',
  4: 'Vulnerability Assessment',
  5: 'Exploitation',
  6: 'Post-Exploitation & Reporting',
};

const STATUS_TAG_MAP = {
  in_progress: { color: 'processing', text: 'In Progress' },
  active: { color: 'processing', text: 'Active' },
  completed: { color: 'success', text: 'Completed' },
  archived: { color: 'default', text: 'Archived' },
};

const AssessmentDetail = () => {
  const { id } = useParams();
  const [assessment, setAssessment] = useState(null);
  const [reconData, setReconData] = useState([]);
  const [reconCategories, setReconCategories] = useState(['endpoint', 'subdomain', 'service', 'technology']);
  const [cards, setCards] = useState([]);
  const [sections, setSections] = useState([]);
  const [commands, setCommands] = useState([]);
  const [loading, setLoading] = useState(true);
  const [activePhase, setActivePhase] = useState('1');
  const [cardFilter, setCardFilter] = useState('overview');
  const [showImportModal, setShowImportModal] = useState(false);
  const [openingWorkspace, setOpeningWorkspace] = useState(false);
  const [showChangeContainerModal, setShowChangeContainerModal] = useState(false);
  const [phaseProgress, setPhaseProgress] = useState(null);

  // WebSocket connection for real-time updates
  const { subscribe, isConnected } = useWebSocket(id);

  useEffect(() => {
    loadAssessment();
  }, [id]);

  // Subscribe to WebSocket events for real-time updates
  useEffect(() => {
    if (!id) return;

    const unsubscribeCardAdded = subscribe('card_added', (data) => {
      setCards(prev => [data.card, ...prev]);
    });

    const unsubscribeCardUpdated = subscribe('card_updated', (data) => {
      setCards(prev => prev.map(card =>
        card.id === data.card_id ? data.card : card
      ));
    });

    const unsubscribeCardDeleted = subscribe('card_deleted', (data) => {
      setCards(prev => prev.filter(card => card.id !== data.card_id));
    });

    const unsubscribeReconAdded = subscribe('recon_added', (data) => {
      setReconData(prev => [data.recon, ...prev]);
    });

    const unsubscribeReconUpdated = subscribe('recon_updated', (data) => {
      setReconData(prev => prev.map(recon =>
        recon.id === data.recon_id ? data.recon : recon
      ));
    });

    const unsubscribeReconDeleted = subscribe('recon_deleted', (data) => {
      setReconData(prev => prev.filter(recon => recon.id !== data.recon_id));
    });

    const unsubscribeSectionUpdated = subscribe('section_updated', (data) => {
      setSections(prev => {
        const index = prev.findIndex(s => s.id === data.section.id);
        if (index >= 0) {
          const newSections = [...prev];
          newSections[index] = data.section;
          return newSections;
        } else {
          return [...prev, data.section];
        }
      });
    });

    const unsubscribeCommandCompleted = subscribe('command_completed', (data) => {
      setCommands(prev => [data.command, ...prev]);
    });

    const unsubscribeCommandFailed = subscribe('command_failed', (data) => {
      setCommands(prev => [data.command, ...prev]);
    });

    const unsubscribeAssessmentUpdated = subscribe('assessment_updated', (data) => {
      setAssessment(prev => ({ ...prev, ...data.fields }));
    });

    const unsubscribePhaseChanged = subscribe('phase_changed', async (data) => {
      // Re-fetch assessment data to get updated phase info
      try {
        const response = await apiClient.get(`/assessments/${id}/sections/phases`);
        setPhaseProgress(response.data);
      } catch (error) {
        console.error('Failed to refresh phase progress:', error);
      }
    });

    return () => {
      unsubscribeCardAdded();
      unsubscribeCardUpdated();
      unsubscribeCardDeleted();
      unsubscribeReconAdded();
      unsubscribeReconUpdated();
      unsubscribeReconDeleted();
      unsubscribeSectionUpdated();
      unsubscribeCommandCompleted();
      unsubscribeCommandFailed();
      unsubscribeAssessmentUpdated();
      unsubscribePhaseChanged();
    };
  }, [id, subscribe]);

  // Round 11 Fix 3B: Polling fallback for phase progress (30-second interval)
  useEffect(() => {
    if (!id || !assessment || assessment.status !== 'in_progress') return;

    const pollInterval = setInterval(async () => {
      try {
        const response = await apiClient.get(`/assessments/${id}/sections/phases`);
        setPhaseProgress(response.data);
      } catch (error) {
        // Silently fail - not critical
      }
    }, 30000); // Poll every 30 seconds

    return () => clearInterval(pollInterval);
  }, [id, assessment?.status]);

  const loadAssessment = async () => {
    try {
      setLoading(true);

      const [assessmentRes, reconRes, reconTypesRes, cardsRes, sectionsRes, commandsRes, phasesRes] = await Promise.all([
        apiClient.get(`/assessments/${id}`),
        apiClient.get(`/assessments/${id}/recon`),
        apiClient.get(`/assessments/${id}/recon/types`),
        apiClient.get(`/assessments/${id}/cards`),
        apiClient.get(`/assessments/${id}/sections`),
        apiClient.get(`/assessments/${id}/commands?limit=100`),
        apiClient.get(`/assessments/${id}/sections/phases`).catch(() => null), // Graceful fallback
      ]);

      setAssessment(assessmentRes.data);
      setReconData(reconRes.data);
      setReconCategories(reconTypesRes.data.length > 0 ? reconTypesRes.data : reconCategories);
      setCards(cardsRes.data);
      setSections(sectionsRes.data);
      setCommands(commandsRes.data);
      setPhaseProgress(phasesRes?.data || null);
    } catch (error) {
      console.error('Failed to load assessment:', error);
    } finally {
      setLoading(false);
    }
  };

  const updateAssessment = async (field, value) => {
    try {
      // Handle array fields (target_domains, ip_scopes, ports)
      let processedValue = value;
      if (field === 'target_domains' || field === 'ip_scopes') {
        // Convert string to array (split by newlines)
        if (typeof value === 'string') {
          processedValue = value.split('\n').map(item => item.trim()).filter(Boolean);
        }
      } else if (field === 'ports') {
        // Convert string to integer array
        if (typeof value === 'string') {
          processedValue = value.split('\n').map(p => parseInt(p.trim())).filter(p => !isNaN(p));
        }
      }

      await apiClient.put(`/assessments/${id}`, { [field]: processedValue });
      setAssessment({ ...assessment, [field]: processedValue });
    } catch (error) {
      console.error('Failed to update assessment:', error);
      const detail = error.response?.data?.detail;
      message.error(detail || 'Failed to update assessment');
    }
  };

  const handleOpenWorkspace = async () => {
    if (!assessment.workspace_path) {
      alert('No workspace created for this assessment yet.');
      return;
    }

    setOpeningWorkspace(true);

    try {
      const result = await workspaceService.openAssessmentWorkspace(id);

      if (result.success && result.host_path) {
        try {
          const { openFolderOnHost } = await import('../services/folderOpenerService');
          const openResult = await openFolderOnHost(result.host_path);
          if (openResult.success) {
            return;
          }
        } catch (serviceError) {
          // Folder opener service not available, falling back to clipboard
        }

        if (navigator.clipboard) {
          await navigator.clipboard.writeText(result.host_path);
          alert(`Path copied to clipboard:\n\n${result.host_path}\n\nPaste in Finder (Cmd+Shift+G)`);
        } else {
          alert(`Workspace path:\n\n${result.host_path}`);
        }
      }
    } catch (error) {
      console.error('Failed to open workspace:', error);
      alert(error.response?.data?.detail || 'Failed to open workspace folder');
    } finally {
      setOpeningWorkspace(false);
    }
  };

  const handleContainerChange = async () => {
    setShowChangeContainerModal(false);
    await loadAssessment();
  };

  // Calculate statistics
  const stats = useMemo(() => {
    const findings = cards.filter(c => c.card_type === 'finding');
    const observations = cards.filter(c => c.card_type === 'observation');
    const infos = cards.filter(c => c.card_type === 'info');

    const sevenDaysAgo = new Date();
    sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);
    const recentCards = cards.filter(card => new Date(card.created_at) > sevenDaysAgo);

    const last24h = new Date();
    last24h.setDate(last24h.getDate() - 1);
    const last24hCards = cards.filter(card => new Date(card.created_at) > last24h);

    return {
      totalCards: cards.length,
      findings: findings.length,
      observations: observations.length,
      infos: infos.length,
      critical: findings.filter(f => f.severity === 'CRITICAL').length,
      high: findings.filter(f => f.severity === 'HIGH').length,
      medium: findings.filter(f => f.severity === 'MEDIUM').length,
      low: findings.filter(f => f.severity === 'LOW').length,
      commands: commands.length,
      recon: reconData.length,
      phases: sections.length,
      recentCards: recentCards.length,
      last24hCards: last24hCards.length
    };
  }, [cards, commands, reconData, sections]);

  // Filter cards based on selected filter
  const filteredCards = useMemo(() => {
    switch (cardFilter) {
      case 'findings':
        return cards.filter(c => c.card_type === 'finding');
      case 'observations':
        return cards.filter(c => c.card_type === 'observation');
      case 'info':
        return cards.filter(c => c.card_type === 'info');
      case 'critical':
        return cards.filter(c => c.severity === 'CRITICAL');
      case 'high':
        return cards.filter(c => c.severity === 'HIGH');
      case 'medium':
        return cards.filter(c => c.severity === 'MEDIUM');
      case 'low':
        return cards.filter(c => c.severity === 'LOW');
      case 'overview':
      default:
        return cards;
    }
  }, [cards, cardFilter]);

  // Calculate risk distribution percentages
  const getRiskDistribution = () => {
    const total = stats.critical + stats.high + stats.medium + stats.low;
    if (total === 0) return { critical: 0, high: 0, medium: 0, low: 0 };

    return {
      critical: Math.round((stats.critical / total) * 100),
      high: Math.round((stats.high / total) * 100),
      medium: Math.round((stats.medium / total) * 100),
      low: Math.round((stats.low / total) * 100)
    };
  };

  const riskDistribution = getRiskDistribution();

  const getSeverityBarColor = (severity) => {
    switch (severity) {
      case 'CRITICAL': return 'bg-red-500';
      case 'HIGH': return 'bg-orange-500';
      case 'MEDIUM': return 'bg-yellow-500';
      case 'LOW': return 'bg-blue-500';
      default: return 'bg-neutral-500';
    }
  };

  // Card filter options for Segmented
  const filterOptions = [
    { label: `All (${stats.totalCards})`, value: 'overview' },
    { label: `Findings (${stats.findings})`, value: 'findings' },
    { label: `Observations (${stats.observations})`, value: 'observations' },
    { label: `Info (${stats.infos})`, value: 'info' },
  ];

  const severityFilterOptions = [
    { label: <span className="flex items-center gap-1"><span className="w-1.5 h-1.5 rounded-full bg-red-500 inline-block" />Critical ({stats.critical})</span>, value: 'critical' },
    { label: <span className="flex items-center gap-1"><span className="w-1.5 h-1.5 rounded-full bg-orange-500 inline-block" />High ({stats.high})</span>, value: 'high' },
    { label: <span className="flex items-center gap-1"><span className="w-1.5 h-1.5 rounded-full bg-yellow-500 inline-block" />Medium ({stats.medium})</span>, value: 'medium' },
    { label: <span className="flex items-center gap-1"><span className="w-1.5 h-1.5 rounded-full bg-blue-500 inline-block" />Low ({stats.low})</span>, value: 'low' },
  ];

  // Phase tabs items
  const phaseTabItems = [1, 2, 3, 4, 5, 6].map((phaseNum) => {
    const section = sections.find(s => s.section_type === `phase_${phaseNum}`);
    const hasContent = section?.content;

    return {
      key: String(phaseNum),
      label: (
        <div className="flex items-center gap-2">
          <span>Phase {phaseNum}</span>
          {hasContent && (
            <div className="w-1.5 h-1.5 bg-green-500 rounded-full" />
          )}
          <Text type="secondary" className="text-xs">
            {PHASE_NAMES[phaseNum]}
          </Text>
        </div>
      ),
      children: (
        <PhaseContentViewSimple
          phaseNumber={phaseNum}
          assessmentId={id}
          section={sections.find(s => s.section_type === `phase_${phaseNum}`)}
          onUpdate={loadAssessment}
          cards={cards.filter(c => String(c.section_number) === String(phaseNum))}
          commands={commands.filter(c => c.phase?.includes(`Phase ${phaseNum}`))}
        />
      ),
    };
  });

  if (loading) {
    return (
      <div className="flex items-center justify-center min-h-screen">
        <Spin size="large" />
      </div>
    );
  }

  if (!assessment) {
    return (
      <div className="flex items-center justify-center min-h-screen">
        <Empty
          description={
            <div>
              <p className="text-lg font-semibold mb-2">Assessment not found</p>
              <Text type="secondary" className="mb-4 block">The assessment you're looking for doesn't exist.</Text>
            </div>
          }
        >
          <Link to="/assessments">
            <Button type="primary">Back to Assessments</Button>
          </Link>
        </Empty>
      </div>
    );
  }

  const statusInfo = STATUS_TAG_MAP[assessment.status] || { color: 'default', text: assessment.status };

  return (
    <div className="max-w-7xl mx-auto p-6 space-y-4">
      {/* Header compact */}
      <div className="flex items-center justify-between border-b pb-4">
        <div className="flex items-center gap-3">
          <Link
            to="/assessments"
            className="flex items-center gap-2 text-sm transition-colors"
          >
            <ArrowLeft className="w-4 h-4" />
            Back
          </Link>
          <Divider type="vertical" style={{ height: 20 }} />
          <div>
            <Title level={4} className="!mb-0">{assessment.name}</Title>
            <div className="flex items-center gap-2 text-sm">
              <span>{assessment.client_name || 'No client'}</span>
              {assessment.environment && assessment.environment !== 'non_specifie' && (
                <>
                  <span>·</span>
                  <Tag color={assessment.environment === 'production' ? 'orange' : 'green'} style={{ margin: 0 }}>
                    {assessment.environment === 'production' ? 'Production' : 'Dev'}
                  </Tag>
                </>
              )}
              <span>·</span>
              <Tag color={statusInfo.color} style={{ margin: 0 }}>{statusInfo.text}</Tag>
              {assessment.container_name && (
                <>
                  <span>·</span>
                  <Button
                    type="link"
                    size="small"
                    onClick={() => setShowChangeContainerModal(true)}
                    className="!p-0 !h-auto"
                  >
                    <Tag color="blue" icon={<Server className="w-3 h-3 inline mr-1" />} style={{ margin: 0, cursor: 'pointer' }}>
                      {assessment.container_name}
                    </Tag>
                  </Button>
                </>
              )}
            </div>
          </div>
        </div>
        <div className="flex items-center gap-2">
          <Button
            size="small"
            icon={<Upload className="w-3.5 h-3.5" />}
            onClick={() => setShowImportModal(true)}
          >
            Import
          </Button>
          <Button
            size="small"
            icon={openingWorkspace ? <RefreshCw className="w-3.5 h-3.5 animate-spin" /> : <FolderOpen className="w-3.5 h-3.5" />}
            onClick={handleOpenWorkspace}
            disabled={openingWorkspace}
            loading={openingWorkspace}
          >
            Workspace
          </Button>
        </div>
      </div>

      {/* Import Scan Modal */}
      {showImportModal && (
        <ImportScanModal
          assessmentId={id}
          onClose={() => setShowImportModal(false)}
          onSuccess={() => {
            loadAssessment();
          }}
        />
      )}

      {/* Change Container Modal */}
      {showChangeContainerModal && assessment && (
        <ChangeContainerModal
          assessment={assessment}
          onClose={() => setShowChangeContainerModal(false)}
          onSuccess={handleContainerChange}
        />
      )}

      {/* Stats Grid */}
      <Row gutter={[12, 12]}>
        <Col span={4}>
          <Card size="small" className="text-center">
            <Statistic title="Cards" value={stats.totalCards} valueStyle={{ fontSize: '1.125rem' }} />
          </Card>
        </Col>
        <Col span={4}>
          <Card size="small" className="text-center">
            <Statistic title="Commands" value={stats.commands} valueStyle={{ fontSize: '1.125rem' }} />
          </Card>
        </Col>
        <Col span={4}>
          <Card size="small" className="text-center">
            <Statistic title="Recon" value={stats.recon} valueStyle={{ fontSize: '1.125rem' }} />
          </Card>
        </Col>
        <Col span={4}>
          <Card size="small" className="text-center">
            <Statistic title="Critical" value={stats.critical} valueStyle={{ fontSize: '1.125rem', color: '#ef4444' }} />
          </Card>
        </Col>
        <Col span={4}>
          <Card size="small" className="text-center">
            <Statistic title="High" value={stats.high} valueStyle={{ fontSize: '1.125rem', color: '#f97316' }} />
          </Card>
        </Col>
        <Col span={4}>
          <Card size="small" className="text-center">
            <Statistic title="Medium" value={stats.medium} valueStyle={{ fontSize: '1.125rem', color: '#eab308' }} />
          </Card>
        </Col>
      </Row>

      {/* Assessment Settings */}
      <Card
        title={<span className="text-sm font-semibold">Assessment Settings</span>}
        size="small"
      >
        <div className="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
          <div>
            <Text strong>Client:</Text>
            <EditableField
              value={assessment.client_name || ''}
              onSave={(value) => updateAssessment('client_name', value)}
              placeholder="Client name"
              className="text-neutral-900 dark:text-neutral-100 ml-2"
            />
          </div>
          <div>
            <Text strong>Scope:</Text>
            <EditableField
              value={assessment.scope || ''}
              onSave={(value) => updateAssessment('scope', value)}
              placeholder="Assessment scope"
              className="text-neutral-900 dark:text-neutral-100 ml-2"
            />
          </div>
          <div>
            <Text strong>Domains:</Text>
            <EditableField
              value={Array.isArray(assessment.target_domains) ? assessment.target_domains.join('\n') : (assessment.target_domains || '')}
              onSave={(value) => updateAssessment('target_domains', value)}
              placeholder="Target domains"
              multiline
              className="text-neutral-900 dark:text-neutral-100 ml-2"
            />
          </div>
          <div>
            <Text strong>IP Scopes:</Text>
            <EditableField
              value={Array.isArray(assessment.ip_scopes) ? assessment.ip_scopes.join('\n') : (assessment.ip_scopes || '')}
              onSave={(value) => updateAssessment('ip_scopes', value)}
              placeholder="IP scopes"
              multiline
              className="text-neutral-900 dark:text-neutral-100 ml-2"
            />
          </div>
          <div>
            <Text strong>Ports:</Text>
            <EditableField
              value={Array.isArray(assessment.ports) ? assessment.ports.join('\n') : (assessment.ports || '')}
              onSave={(value) => updateAssessment('ports', value)}
              placeholder="Ports"
              multiline
              className="text-neutral-900 dark:text-neutral-100 ml-2"
            />
          </div>
          <div>
            <Text strong>Limitations:</Text>
            <EditableField
              value={assessment.limitations || ''}
              onSave={(value) => updateAssessment('limitations', value)}
              placeholder="Assessment limitations"
              multiline
              className="text-neutral-900 dark:text-neutral-100 ml-2"
            />
          </div>
          <div>
            <Text strong>Objectives:</Text>
            <EditableField
              value={assessment.objectives || ''}
              onSave={(value) => updateAssessment('objectives', value)}
              placeholder="Assessment objectives"
              multiline
              className="text-neutral-900 dark:text-neutral-100 ml-2"
            />
          </div>
          <div>
            <Text strong>Git Repository:</Text>
            {assessment.git_repo_url ? (
              <a
                href={assessment.git_repo_url}
                target="_blank"
                rel="noopener noreferrer"
                className="text-blue-500 hover:text-blue-400 ml-2"
              >
                {assessment.git_repo_url}
              </a>
            ) : (
              <Text className="text-neutral-500 ml-2">Not configured</Text>
            )}
          </div>
        </div>
      </Card>

      {/* Credentials & Tokens Section */}
      <CredentialsManager assessmentId={id} onUpdate={loadAssessment} />

      {/* Context Documents Section */}
      <ContextDocumentsPanel assessmentId={parseInt(id)} />

      {/* Reconnaissance Data - Dynamic Categories */}
      <div className="space-y-3">
        <Title level={5} className="!mb-0">Reconnaissance Data</Title>
        <div className="space-y-3">
          {reconCategories.reduce((pairs, category, index) => {
            if (index % 2 === 0) {
              pairs.push(reconCategories.slice(index, index + 2));
            }
            return pairs;
          }, []).map((pair, pairIndex) => (
            <div key={pairIndex} className="grid grid-cols-1 lg:grid-cols-2 gap-3">
              {pair.map(category => {
                // Proper pluralization
                const pluralize = (word) => {
                  if (word === 'technology') return 'Technologies';
                  return word.charAt(0).toUpperCase() + word.slice(1) + 's';
                };

                return (
                  <ReconTable
                    key={category}
                    title={pluralize(category)}
                    data={reconData.filter(item => item.data_type === category)}
                    assessmentId={id}
                    onUpdate={loadAssessment}
                  />
                );
              })}
            </div>
          ))}
        </div>
      </div>

      {/* Cards & Findings */}
      <div>
        <div className="flex items-center justify-between mb-3">
          <Title level={4} className="!mb-0">Cards & Findings</Title>
          <Text type="secondary" className="text-sm">{filteredCards.length} cards</Text>
        </div>

        {/* Filter bar */}
        <Card size="small" className="mb-6">
          <div className="flex flex-wrap items-center gap-2">
            {/* Type filters */}
            <Segmented
              value={['overview', 'findings', 'observations', 'info'].includes(cardFilter) ? cardFilter : 'overview'}
              onChange={(val) => setCardFilter(val)}
              options={filterOptions}
              size="small"
            />

            <Divider type="vertical" style={{ height: 24 }} />

            {/* Severity filters */}
            {severityFilterOptions.map(opt => (
              <Button
                key={opt.value}
                type={cardFilter === opt.value ? 'primary' : 'default'}
                size="small"
                onClick={() => setCardFilter(cardFilter === opt.value ? 'overview' : opt.value)}
                danger={opt.value === 'critical'}
              >
                {opt.label}
              </Button>
            ))}
          </div>
        </Card>

        {/* Content area */}
        <div className="w-full">
          {cardFilter === 'overview' ? (
            <div className="space-y-6">
              {/* Risk Distribution */}
              <div>
                <Title level={4} className="flex items-center gap-2">
                  <Target className="w-5 h-5 text-primary-500" />
                  Risk Distribution
                </Title>

                {stats.findings > 0 ? (
                  <div className="space-y-4">
                    {/* Visual Bar Chart */}
                    <div className="flex h-8 bg-neutral-100 dark:bg-neutral-700 rounded-lg overflow-hidden">
                      {riskDistribution.critical > 0 && (
                        <div
                          className={`${getSeverityBarColor('CRITICAL')} flex items-center justify-center text-white text-xs font-medium`}
                          style={{ width: `${riskDistribution.critical}%` }}
                        >
                          {riskDistribution.critical}%
                        </div>
                      )}
                      {riskDistribution.high > 0 && (
                        <div
                          className={`${getSeverityBarColor('HIGH')} flex items-center justify-center text-white text-xs font-medium`}
                          style={{ width: `${riskDistribution.high}%` }}
                        >
                          {riskDistribution.high}%
                        </div>
                      )}
                      {riskDistribution.medium > 0 && (
                        <div
                          className={`${getSeverityBarColor('MEDIUM')} flex items-center justify-center text-white text-xs font-medium`}
                          style={{ width: `${riskDistribution.medium}%` }}
                        >
                          {riskDistribution.medium}%
                        </div>
                      )}
                      {riskDistribution.low > 0 && (
                        <div
                          className={`${getSeverityBarColor('LOW')} flex items-center justify-center text-white text-xs font-medium`}
                          style={{ width: `${riskDistribution.low}%` }}
                        >
                          {riskDistribution.low}%
                        </div>
                      )}
                    </div>

                    {/* Legend */}
                    <div className="grid grid-cols-2 md:grid-cols-4 gap-3">
                      {stats.critical > 0 && (
                        <div className="flex items-center gap-2">
                          <div className="w-3 h-3 bg-red-500 rounded" />
                          <Text type="secondary" className="text-sm">
                            Critical: {stats.critical} ({riskDistribution.critical}%)
                          </Text>
                        </div>
                      )}
                      {stats.high > 0 && (
                        <div className="flex items-center gap-2">
                          <div className="w-3 h-3 bg-orange-500 rounded" />
                          <Text type="secondary" className="text-sm">
                            High: {stats.high} ({riskDistribution.high}%)
                          </Text>
                        </div>
                      )}
                      {stats.medium > 0 && (
                        <div className="flex items-center gap-2">
                          <div className="w-3 h-3 bg-yellow-500 rounded" />
                          <Text type="secondary" className="text-sm">
                            Medium: {stats.medium} ({riskDistribution.medium}%)
                          </Text>
                        </div>
                      )}
                      {stats.low > 0 && (
                        <div className="flex items-center gap-2">
                          <div className="w-3 h-3 bg-blue-500 rounded" />
                          <Text type="secondary" className="text-sm">
                            Low: {stats.low} ({riskDistribution.low}%)
                          </Text>
                        </div>
                      )}
                    </div>
                  </div>
                ) : (
                  <Empty
                    image={<Shield className="w-12 h-12 mx-auto text-neutral-300 dark:text-neutral-600" />}
                    description={<Text type="secondary" className="text-sm">No findings yet</Text>}
                  />
                )}
              </div>

              {/* Findings List */}
              <div>
                <Title level={4} className="flex items-center gap-2">
                  <AlertTriangle className="w-5 h-5 text-primary-500" />
                  Findings ({stats.findings})
                </Title>

                {stats.findings > 0 ? (
                  <CardsTable
                    cards={cards
                      .filter(c => c.card_type === 'finding')
                      .sort((a, b) => {
                        const severityOrder = { 'CRITICAL': 4, 'HIGH': 3, 'MEDIUM': 2, 'LOW': 1 };
                        const aOrder = severityOrder[a.severity] || 0;
                        const bOrder = severityOrder[b.severity] || 0;
                        if (aOrder !== bOrder) return bOrder - aOrder;
                        return new Date(b.created_at) - new Date(a.created_at);
                      })
                    }
                    assessmentId={id}
                    onUpdate={loadAssessment}
                  />
                ) : (
                  <Empty
                    image={<Shield className="w-12 h-12 mx-auto text-neutral-300 dark:text-neutral-600" />}
                    description={<Text type="secondary" className="text-sm">No findings yet</Text>}
                  />
                )}
              </div>
            </div>
          ) : (
            /* Filtered view */
            <div>
              {filteredCards.length === 0 ? (
                <Empty
                  image={<Shield className="w-12 h-12 mx-auto text-neutral-300 dark:text-neutral-600" />}
                  description={<Text type="secondary" className="text-sm">No cards found for this filter</Text>}
                />
              ) : (
                <CardsTable
                  cards={filteredCards}
                  assessmentId={id}
                  onUpdate={loadAssessment}
                />
              )}
            </div>
          )}
        </div>
      </div>

      {/* Phase Progress Timeline */}
      {phaseProgress && (
        <PhaseTimeline
          phases={phaseProgress.phases}
          currentPhase={phaseProgress.current_phase}
          progress={phaseProgress.progress_pct}
          message={phaseProgress.message}
          isComplete={phaseProgress.is_complete}
        />
      )}

      {/* Real-Time Activity Feed */}
      <ActivityFeed
        assessmentId={id}
        subscribe={subscribe}
        isConnected={isConnected}
      />

      {/* Assessment Phases */}
      <div>
        <Title level={4}>Assessment Phases</Title>
        <Tabs
          activeKey={activePhase}
          onChange={setActivePhase}
          items={phaseTabItems}
          type="card"
        />
      </div>

      {/* Command History */}
      <Card
        title={
          <div className="flex items-center justify-between">
            <span className="text-sm font-semibold">Command History</span>
            <Text type="secondary" className="text-xs font-normal">{commands.length} commands</Text>
          </div>
        }
        size="small"
      >
        <CommandHistoryRefactored commands={commands} />
      </Card>
    </div>
  );
};

export default AssessmentDetail;
