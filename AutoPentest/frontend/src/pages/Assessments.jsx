import { useState, useEffect, useRef, useCallback } from 'react';
import { Typography, Button, Input, Select, Spin, Card } from 'antd';
import { Plus, Search, Filter, X } from '../components/icons';
import apiClient from '../services/api';
import folderService from '../services/folderService';
import CreateAssessmentModal from '../components/assessment/CreateAssessmentModal';
import EditAssessmentModal from '../components/assessment/EditAssessmentModal';
import CreateFolderModal from '../components/common/CreateFolderModal';
import EditFolderModal from '../components/common/EditFolderModal';
import AssessmentsTable from '../components/common/AssessmentsTable';
import SidebarLayout from '../components/common/SidebarLayout';
import { useWebSocketContext } from '../contexts/WebSocketContext';

const { Title, Text } = Typography;

const Assessments = () => {
  const [assessments, setAssessments] = useState([]);
  const [allAssessments, setAllAssessments] = useState([]); // For accurate counting
  const [folders, setFolders] = useState([]);
  const [loading, setLoading] = useState(true);
  const [isCreateModalOpen, setIsCreateModalOpen] = useState(false);
  const [isEditAssessmentModalOpen, setIsEditAssessmentModalOpen] = useState(false);
  const [editingAssessment, setEditingAssessment] = useState(null);
  const [isCreateFolderModalOpen, setIsCreateFolderModalOpen] = useState(false);
  const [isEditFolderModalOpen, setIsEditFolderModalOpen] = useState(false);
  const [editingFolder, setEditingFolder] = useState(null);
  const [searchQuery, setSearchQuery] = useState('');
  const [filterStatus, setFilterStatus] = useState('all');
  const [activeView, setActiveView] = useState('active'); // 'active', 'completed', 'archived', or folder ID
  const [actionLoading, setActionLoading] = useState(false);
  const searchInputRef = useRef(null);
  const searchContainerRef = useRef(null);

  // WebSocket for real-time updates
  const { subscribe } = useWebSocketContext();

  useEffect(() => {
    loadData();
  }, []);

  // Subscribe to WebSocket events for real-time updates
  useEffect(() => {
    // Assessment created
    const unsubscribeCreated = subscribe('assessment_created', (data) => {
      setAssessments(prev => [data.assessment, ...prev]);
      setAllAssessments(prev => [data.assessment, ...prev]);
    });

    // Assessment updated
    const unsubscribeUpdated = subscribe('assessment_updated', (data) => {
      setAssessments(prev => prev.map(a =>
        a.id === data.assessment_id ? { ...a, ...data.fields } : a
      ));
      setAllAssessments(prev => prev.map(a =>
        a.id === data.assessment_id ? { ...a, ...data.fields } : a
      ));
    });

    // Assessment deleted
    const unsubscribeDeleted = subscribe('assessment_deleted', (data) => {
      setAssessments(prev => prev.filter(a => a.id !== data.assessment_id));
      setAllAssessments(prev => prev.filter(a => a.id !== data.assessment_id));
    });

    return () => {
      unsubscribeCreated();
      unsubscribeUpdated();
      unsubscribeDeleted();
    };
  }, [subscribe]);

  // Handle Escape key to clear search
  useEffect(() => {
    const handleEscape = (e) => {
      if (e.key === 'Escape' && searchQuery) {
        setSearchQuery('');
        searchInputRef.current?.blur();
      }
    };

    window.addEventListener('keydown', handleEscape);
    return () => window.removeEventListener('keydown', handleEscape);
  }, [searchQuery]);

  // Handle click outside search to clear
  useEffect(() => {
    const handleClickOutside = (e) => {
      if (searchContainerRef.current && !searchContainerRef.current.contains(e.target)) {
        if (document.activeElement === searchInputRef.current) {
          setSearchQuery('');
          searchInputRef.current?.blur();
        }
      }
    };

    if (searchQuery || document.activeElement === searchInputRef.current) {
      document.addEventListener('mousedown', handleClickOutside);
    }

    return () => document.removeEventListener('mousedown', handleClickOutside);
  }, [searchQuery]);

  const loadData = async () => {
    try {
      setLoading(true);
      const [foldersData, allAssessmentsData] = await Promise.all([
        folderService.getFolders(),
        apiClient.get('/assessments')
      ]);
      setFolders(foldersData);
      setAllAssessments(allAssessmentsData.data);

      // Load assessments for the default view (active)
      const activeData = await apiClient.get('/assessments?status=active');
      setAssessments(activeData.data);
    } catch (error) {
      console.error('Failed to load data:', error);
    } finally {
      setLoading(false);
    }
  };

  const loadAssessmentsForView = useCallback(async () => {
    try {
      let assessmentsData;

      if (activeView === 'active') {
        assessmentsData = await apiClient.get('/assessments?status=active');
      } else if (activeView === 'completed') {
        assessmentsData = await apiClient.get('/assessments?status=completed');
      } else if (activeView === 'archived') {
        assessmentsData = await apiClient.get('/assessments?status=archived');
      } else {
        // Custom folder - activeView is the folder ID as string
        const folder = folders.find(f => f.id.toString() === activeView);
        if (folder) {
          assessmentsData = await folderService.getAssessmentsByFolder(folder.id);
        } else {
          assessmentsData = { data: [] };
        }
      }

      setAssessments(assessmentsData.data || assessmentsData);
    } catch (error) {
      console.error('Failed to load assessments for view:', error);
    }
  }, [activeView, folders]);

  // Trigger reload when view changes
  useEffect(() => {
    loadAssessmentsForView();
  }, [loadAssessmentsForView]);

  const handleAssessmentUpdate = async () => {
    try {
      setActionLoading(true);
      const allAssessmentsData = await apiClient.get('/assessments');
      setAllAssessments(allAssessmentsData.data);
      await loadAssessmentsForView();
      setEditingAssessment(null);
    } catch (error) {
      console.error('Failed to update assessments:', error);
    } finally {
      setActionLoading(false);
    }
  };

  const handleAssessmentDelete = async (assessmentId) => {
    try {
      await apiClient.delete(`/assessments/${assessmentId}`);
      await handleAssessmentUpdate();
    } catch (error) {
      console.error('Failed to delete assessment:', error);
    }
  };

  const handleEditAssessment = (assessment) => {
    const freshAssessment = assessments.find(a => a.id === assessment.id) || assessment;
    setEditingAssessment(freshAssessment);
    setIsEditAssessmentModalOpen(true);
  };

  const handleEditFolder = (folder) => {
    setEditingFolder(folder);
    setIsEditFolderModalOpen(true);
  };

  const handleFolderUpdate = async () => {
    const foldersData = await folderService.getFolders();
    setFolders(foldersData);
    const allAssessmentsData = await apiClient.get('/assessments');
    setAllAssessments(allAssessmentsData.data);
    await loadAssessmentsForView();
  };

  const filteredAssessments = assessments.filter((assessment) => {
    const matchesSearch = assessment.name.toLowerCase().includes(searchQuery.toLowerCase()) ||
      assessment.client_name?.toLowerCase().includes(searchQuery.toLowerCase());
    const matchesStatus = filterStatus === 'all' || assessment.status === filterStatus;
    return matchesSearch && matchesStatus;
  });

  // Get current view name
  const getCurrentViewName = () => {
    if (activeView === 'active') return 'Active';
    if (activeView === 'completed') return 'Completed';
    if (activeView === 'archived') return 'Archived';

    const folder = folders.find(f => f.id.toString() === activeView);
    return folder ? folder.name : 'Unknown Folder';
  };

  if (loading) {
    return (
      <div className="flex items-center justify-center h-96">
        <Spin size="large" tip="Loading assessments..." />
      </div>
    );
  }

  return (
    <div className="-m-6 h-[calc(100vh-56px)]">
      <SidebarLayout
        folders={folders}
        allAssessments={allAssessments}
        activeView={activeView}
        onViewChange={setActiveView}
        onCreateFolder={() => setIsCreateFolderModalOpen(true)}
        onEditFolder={handleEditFolder}
        className="h-full"
      >
        <div className="space-y-6 animate-in">
          {/* Header */}
          <div className="flex items-center justify-between">
            <div>
              <Title level={2} className="!mb-0">Assessments</Title>
              <Text type="secondary" className="mt-2 block">
                Manage your security assessments and penetration tests
              </Text>
            </div>
            <Button
              type="primary"
              icon={<Plus className="w-4 h-4" />}
              onClick={() => setIsCreateModalOpen(true)}
            >
              New Assessment
            </Button>
          </div>

          {/* Current View Info */}
          <Card size="small">
            <div className="flex items-center justify-between">
              <div>
                <Title level={4} className="!mb-0">
                  {getCurrentViewName()}
                </Title>
                <Text type="secondary" className="block">
                  {filteredAssessments.length} assessment{filteredAssessments.length !== 1 ? 's' : ''}
                </Text>
              </div>
            </div>
          </Card>

          {/* Search Bar - Optional for filtering within view */}
          {assessments.length > 10 && (
            <Card size="small">
              <div className="flex items-center gap-4">
                <div ref={searchContainerRef} className="flex-1 max-w-md">
                  <Input
                    ref={searchInputRef}
                    value={searchQuery}
                    onChange={(e) => setSearchQuery(e.target.value)}
                    placeholder="Search assessments..."
                    prefix={<Search className="w-4 h-4 text-neutral-400" />}
                    suffix={searchQuery ? (
                      <X
                        className="w-4 h-4 text-neutral-400 cursor-pointer hover:text-neutral-600"
                        onClick={() => setSearchQuery('')}
                      />
                    ) : null}
                    allowClear={false}
                  />
                </div>

                <div className="flex items-center gap-2">
                  <Filter className="w-4 h-4 text-neutral-400" />
                  <Select
                    value={filterStatus}
                    onChange={(value) => setFilterStatus(value)}
                    style={{ width: 160 }}
                    options={[
                      { value: 'all', label: 'All Status' },
                      { value: 'active', label: 'Active' },
                      { value: 'completed', label: 'Completed' },
                      { value: 'archived', label: 'Archived' },
                    ]}
                  />
                </div>
              </div>
            </Card>
          )}

          {/* Assessments Table */}
          <AssessmentsTable
            assessments={filteredAssessments}
            folders={folders}
            onAssessmentUpdate={handleAssessmentUpdate}
            onAssessmentDelete={handleAssessmentDelete}
            onAssessmentEdit={handleEditAssessment}
            loading={actionLoading}
          />
        </div>

        {/* Create Assessment Modal */}
        {isCreateModalOpen && (
          <CreateAssessmentModal
            onClose={() => setIsCreateModalOpen(false)}
            onSuccess={async () => {
              setIsCreateModalOpen(false);
              const allAssessmentsData = await apiClient.get('/assessments');
              setAllAssessments(allAssessmentsData.data);
              await loadAssessmentsForView();
            }}
          />
        )}

        {/* Create Folder Modal */}
        {isCreateFolderModalOpen && (
          <CreateFolderModal
            onClose={() => setIsCreateFolderModalOpen(false)}
            onSuccess={handleFolderUpdate}
          />
        )}

        {/* Edit Assessment Modal */}
        {isEditAssessmentModalOpen && editingAssessment && (
          <EditAssessmentModal
            assessment={editingAssessment}
            onClose={() => {
              setIsEditAssessmentModalOpen(false);
              setEditingAssessment(null);
            }}
            onSuccess={handleAssessmentUpdate}
          />
        )}

        {/* Edit Folder Modal */}
        {isEditFolderModalOpen && editingFolder && (
          <EditFolderModal
            folder={editingFolder}
            onClose={() => {
              setIsEditFolderModalOpen(false);
              setEditingFolder(null);
            }}
            onSuccess={handleFolderUpdate}
          />
        )}
      </SidebarLayout>
    </div>
  );
};

export default Assessments;
