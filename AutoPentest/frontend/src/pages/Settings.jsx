import { useState, useEffect } from 'react';
import {
  Settings as SettingsIcon,
  Server,
  Database,
  Terminal,
  Info,
  CheckCircle,
  AlertCircle,
  RefreshCw,
  ExternalLink,
  Globe,
  Mail,
  Clock,
  Save,
  Moon,
  Sun,
  FolderOpen
} from '../components/icons';
import apiClient from '../services/api';
import workspaceService from '../services/workspaceService';
import { useTheme } from '../contexts/ThemeContext';
import {
  Tabs,
  Switch,
  InputNumber,
  Button,
  Card,
  Descriptions,
  Radio,
  Alert,
  Typography,
  List,
  Spin,
  Badge
} from 'antd';

const { Title, Text } = Typography;

const Settings = () => {
  const { theme, toggleTheme, isDark, primaryColor, setPrimaryColor, colorThemes } = useTheme();
  const [activeTab, setActiveTab] = useState('general');
  const [systemStatus, setSystemStatus] = useState({
    backend: { status: 'checking', latency: 0, version: '' },
    database: { status: 'checking', connected: false, version: '' },
    exegol: { status: 'checking', running: false, container: '' }
  });
  const [systemInfo, setSystemInfo] = useState(null);
  const [loading, setLoading] = useState(false);
  const [commandTimeout, setCommandTimeout] = useState(300);
  const [originalTimeout, setOriginalTimeout] = useState(300);
  const [savingTimeout, setSavingTimeout] = useState(false);
  const [timeoutMessage, setTimeoutMessage] = useState(null);
  const [approvalTimeout, setApprovalTimeout] = useState(30);
  const [originalApprovalTimeout, setOriginalApprovalTimeout] = useState(30);
  const [savingApprovalTimeout, setSavingApprovalTimeout] = useState(false);
  const [approvalTimeoutMessage, setApprovalTimeoutMessage] = useState(null);
  const [containerName, setContainerName] = useState('');
  const [originalContainerName, setOriginalContainerName] = useState('');
  const [savingContainer, setSavingContainer] = useState(false);
  const [containerMessage, setContainerMessage] = useState(null);
  const [availableContainers, setAvailableContainers] = useState([]);
  const [loadingContainers, setLoadingContainers] = useState(false);
  const [outputMaxLength, setOutputMaxLength] = useState(5000);
  const [originalOutputMaxLength, setOriginalOutputMaxLength] = useState(5000);
  const [savingOutputMaxLength, setSavingOutputMaxLength] = useState(false);
  const [outputMaxLengthMessage, setOutputMaxLengthMessage] = useState(null);
  const [commandHistoryLimit, setCommandHistoryLimit] = useState(10);
  const [originalHistoryLimit, setOriginalHistoryLimit] = useState(10);
  const [savingHistoryLimit, setSavingHistoryLimit] = useState(false);
  const [historyLimitMessage, setHistoryLimitMessage] = useState(null);
  const [openingWorkspace, setOpeningWorkspace] = useState(false);
  const [workspaceMessage, setWorkspaceMessage] = useState(null);

  useEffect(() => {
    loadSystemStatus();
    loadSystemInfo();
    loadCommandTimeout();
    loadApprovalTimeout();
    loadOutputMaxLength();
    loadCommandHistoryLimit();
    loadExegolContainers();
  }, []);

  const loadSystemStatus = async () => {
    setLoading(true);
    try {
      const { data } = await apiClient.get('/system/status');
      setSystemStatus(data);
    } catch (error) {
      // console.error('Failed to load system status:', error);
      setSystemStatus({
        backend: { status: 'error', latency: 0, version: '' },
        database: { status: 'error', connected: false, version: '' },
        exegol: { status: 'error', running: false, container: '' }
      });
    } finally {
      setLoading(false);
    }
  };

  const loadSystemInfo = async () => {
    try {
      const { data } = await apiClient.get('/system/info');
      setSystemInfo(data);
      if (data.container_name) {
        setContainerName(data.container_name);
        setOriginalContainerName(data.container_name);
      }
    } catch (error) {
      // console.error('Failed to load system info:', error);
    }
  };

  const loadCommandTimeout = async () => {
    try {
      const { data } = await apiClient.get('/system/settings/command_timeout');
      const timeoutValue = parseInt(data.value);
      setCommandTimeout(timeoutValue);
      setOriginalTimeout(timeoutValue);
    } catch (error) {
      // console.error('Failed to load command timeout:', error);
      // Use default value if loading fails
      setCommandTimeout(300);
      setOriginalTimeout(300);
    }
  };

  const loadOutputMaxLength = async () => {
    try {
      const { data } = await apiClient.get('/system/settings/output_max_length');
      const maxLengthValue = parseInt(data.value);
      setOutputMaxLength(maxLengthValue);
      setOriginalOutputMaxLength(maxLengthValue);
    } catch (error) {
      // console.error('Failed to load output max length:', error);
      // Use default value if loading fails
      setOutputMaxLength(5000);
      setOriginalOutputMaxLength(5000);
    }
  };

  const loadExegolContainers = async () => {
    setLoadingContainers(true);
    try {
      const { data } = await apiClient.get('/system/exegol/containers');
      setAvailableContainers(data.containers || []);
    } catch (error) {
      // console.error('Failed to load Exegol containers:', error);
      setAvailableContainers([]);
    } finally {
      setLoadingContainers(false);
    }
  };

  const handleSaveTimeout = async () => {
    // Validate timeout value
    if (commandTimeout < 30 || commandTimeout > 1800) {
      setTimeoutMessage({ type: 'error', text: 'Timeout must be between 30 and 1800 seconds (30s to 30min)' });
      setTimeout(() => setTimeoutMessage(null), 5000);
      return;
    }

    setSavingTimeout(true);
    setTimeoutMessage(null);

    try {
      await apiClient.put('/system/settings/command_timeout', {
        value: commandTimeout.toString()
      });

      setOriginalTimeout(commandTimeout);
      setTimeoutMessage({ type: 'success', text: 'Command timeout updated successfully' });
      setTimeout(() => setTimeoutMessage(null), 3000);
    } catch (error) {
      console.error('Failed to save command timeout:', error);
      setTimeoutMessage({ type: 'error', text: error.response?.data?.detail || 'Failed to save timeout setting' });
      setTimeout(() => setTimeoutMessage(null), 5000);
    } finally {
      setSavingTimeout(false);
    }
  };

  const handleTimeoutPreset = (seconds) => {
    setCommandTimeout(seconds);
  };

  const loadApprovalTimeout = async () => {
    try {
      const { data } = await apiClient.get('/command-settings');
      const timeoutValue = data.timeout_seconds || 30;
      setApprovalTimeout(timeoutValue);
      setOriginalApprovalTimeout(timeoutValue);
    } catch (error) {
      // console.error('Failed to load approval timeout:', error);
      setApprovalTimeout(30);
      setOriginalApprovalTimeout(30);
    }
  };

  const handleSaveApprovalTimeout = async () => {
    if (approvalTimeout < 10 || approvalTimeout > 600) {
      setApprovalTimeoutMessage({ type: 'error', text: 'Timeout must be between 10 and 600 seconds (10s to 10min)' });
      setTimeout(() => setApprovalTimeoutMessage(null), 5000);
      return;
    }

    setSavingApprovalTimeout(true);
    setApprovalTimeoutMessage(null);

    try {
      await apiClient.put('/command-settings', { timeout_seconds: approvalTimeout });

      setOriginalApprovalTimeout(approvalTimeout);
      setApprovalTimeoutMessage({ type: 'success', text: 'Approval timeout updated successfully' });
      setTimeout(() => setApprovalTimeoutMessage(null), 3000);
    } catch (error) {
      console.error('Failed to save approval timeout:', error);
      setApprovalTimeoutMessage({ type: 'error', text: error.response?.data?.detail || 'Failed to save approval timeout' });
      setTimeout(() => setApprovalTimeoutMessage(null), 5000);
    } finally {
      setSavingApprovalTimeout(false);
    }
  };

  const handleApprovalTimeoutPreset = (seconds) => {
    setApprovalTimeout(seconds);
  };

  const handleSaveOutputMaxLength = async () => {
    // Validate output max length value
    if (outputMaxLength !== -1 && (outputMaxLength < 500 || outputMaxLength > 100000)) {
      setOutputMaxLengthMessage({ type: 'error', text: 'Output max length must be between 500 and 100000 characters, or -1 for unlimited' });
      setTimeout(() => setOutputMaxLengthMessage(null), 5000);
      return;
    }

    setSavingOutputMaxLength(true);
    setOutputMaxLengthMessage(null);

    try {
      await apiClient.put('/system/settings/output_max_length', {
        value: outputMaxLength.toString()
      });

      setOriginalOutputMaxLength(outputMaxLength);
      setOutputMaxLengthMessage({ type: 'success', text: 'Output max length updated successfully' });
      setTimeout(() => setOutputMaxLengthMessage(null), 3000);
    } catch (error) {
      console.error('Failed to save output max length:', error);
      setOutputMaxLengthMessage({ type: 'error', text: error.response?.data?.detail || 'Failed to save output max length setting' });
      setTimeout(() => setOutputMaxLengthMessage(null), 5000);
    } finally {
      setSavingOutputMaxLength(false);
    }
  };

  const handleOutputMaxLengthPreset = (value) => {
    setOutputMaxLength(value);
  };

  const loadCommandHistoryLimit = async () => {
    try {
      const { data } = await apiClient.get('/system/settings/command_history_limit');
      const limitValue = parseInt(data.value);
      setCommandHistoryLimit(limitValue);
      setOriginalHistoryLimit(limitValue);
    } catch (error) {
      console.error('Failed to load command history limit:', error);
      // Use default value if loading fails
      setCommandHistoryLimit(10);
      setOriginalHistoryLimit(10);
    }
  };

  const handleSaveCommandHistoryLimit = async () => {
    // Validate history limit value
    if (commandHistoryLimit < 5 || commandHistoryLimit > 100) {
      setHistoryLimitMessage({ type: 'error', text: 'Command history limit must be between 5 and 100' });
      setTimeout(() => setHistoryLimitMessage(null), 5000);
      return;
    }

    setSavingHistoryLimit(true);
    setHistoryLimitMessage(null);

    try {
      await apiClient.put('/system/settings/command_history_limit', {
        value: commandHistoryLimit.toString()
      });

      setOriginalHistoryLimit(commandHistoryLimit);
      setHistoryLimitMessage({ type: 'success', text: 'Command history limit updated successfully' });
      setTimeout(() => setHistoryLimitMessage(null), 3000);
    } catch (error) {
      console.error('Failed to save command history limit:', error);
      setHistoryLimitMessage({ type: 'error', text: error.response?.data?.detail || 'Failed to save command history limit setting' });
      setTimeout(() => setHistoryLimitMessage(null), 5000);
    } finally {
      setSavingHistoryLimit(false);
    }
  };

  const handleHistoryLimitPreset = (value) => {
    setCommandHistoryLimit(value);
  };

  const handleOpenWorkspace = async () => {
    setOpeningWorkspace(true);
    setWorkspaceMessage(null);

    try {
      const result = await workspaceService.openRootWorkspace();

      if (result.success && result.host_path) {
        // Try to open via local folder opener service (runs on host)
        try {
          const { openFolderOnHost } = await import('../services/folderOpenerService');
          const openResult = await openFolderOnHost(result.host_path);
          if (openResult.success) {
            setWorkspaceMessage({
              type: 'success',
              text: `Opened in ${openResult.os} file explorer`
            });
            setTimeout(() => setWorkspaceMessage(null), 3000);
            return;
          }
        } catch (serviceError) {
          console.log('Folder opener service not available:', serviceError.message);
        }

        // Fallback: Copy path to clipboard
        if (navigator.clipboard) {
          await navigator.clipboard.writeText(result.host_path);
          setWorkspaceMessage({
            type: 'success',
            text: `Path copied: ${result.host_path}`
          });
        } else {
          setWorkspaceMessage({
            type: 'success',
            text: result.host_path
          });
        }
        setTimeout(() => setWorkspaceMessage(null), 5000);
      }
    } catch (error) {
      console.error('Failed to open workspace:', error);
      setWorkspaceMessage({
        type: 'error',
        text: error.response?.data?.detail || 'Failed to get workspace path'
      });
      setTimeout(() => setWorkspaceMessage(null), 5000);
    } finally {
      setOpeningWorkspace(false);
    }
  };

  const formatOutputLength = (length) => {
    if (length === -1) return 'Unlimited';
    if (length < 1000) return `${length} chars`;
    return `${(length / 1000).toFixed(1)}K chars`;
  };

  const handleSaveContainer = async () => {
    if (!containerName || containerName.trim() === '') {
      setContainerMessage({ type: 'error', text: 'Container name cannot be empty' });
      setTimeout(() => setContainerMessage(null), 5000);
      return;
    }

    setSavingContainer(true);
    setContainerMessage(null);

    try {
      await apiClient.put('/system/settings/container_name', {
        value: containerName.trim()
      });

      setOriginalContainerName(containerName.trim());
      setContainerMessage({ type: 'success', text: 'Container name updated successfully' });
      setTimeout(() => setContainerMessage(null), 3000);

      // Reload system info and status
      await loadSystemInfo();
      await loadSystemStatus();
    } catch (error) {
      console.error('Failed to save container name:', error);
      setContainerMessage({ type: 'error', text: error.response?.data?.detail || 'Failed to save container name' });
      setTimeout(() => setContainerMessage(null), 5000);
    } finally {
      setSavingContainer(false);
    }
  };

  const formatTime = (seconds) => {
    if (seconds < 60) {
      return `${seconds}s`;
    }
    const minutes = Math.floor(seconds / 60);
    const remainingSeconds = seconds % 60;
    return remainingSeconds > 0 ? `${minutes}m ${remainingSeconds}s` : `${minutes}m`;
  };

  // Helper to render preset buttons for command settings
  const renderPresetButtons = (presets, currentValue, onSelect) => (
    <div className="flex flex-wrap gap-2 mb-3">
      {presets.map((preset) => (
        <Button
          key={preset.value}
          size="small"
          type={currentValue === preset.value ? 'primary' : 'default'}
          onClick={() => onSelect(preset.value)}
        >
          {preset.label}
        </Button>
      ))}
    </div>
  );

  // Helper to render a status dot with label
  const renderStatusDot = (isHealthy, healthyLabel, unhealthyLabel, warnColor = false) => (
    <div className="flex items-center gap-1.5">
      <Badge
        status={isHealthy ? 'success' : (warnColor ? 'warning' : 'error')}
      />
      <span className={`text-xs font-medium ${
        isHealthy
          ? 'text-green-700 dark:text-green-400'
          : warnColor
            ? 'text-amber-700 dark:text-amber-400'
            : 'text-red-700 dark:text-red-400'
      }`}>
        {isHealthy ? healthyLabel : unhealthyLabel}
      </span>
    </div>
  );

  // --- TAB: GENERAL ---
  const renderGeneralTab = () => (
    <div className="space-y-6">
      {/* Appearance Settings */}
      <div>
        <Text strong className="text-sm mb-3 block">Appearance</Text>

        <Card size="small" className="!mb-0" styles={{ body: { padding: 0 } }}>
          {/* Theme Toggle */}
          <div className="p-4 flex items-center justify-between border-b">
            <div className="flex items-center gap-3">
              {isDark ? (
                <Moon className="w-4 h-4 text-neutral-500 dark:text-neutral-400" />
              ) : (
                <Sun className="w-4 h-4 text-neutral-500" />
              )}
              <Text className="text-sm font-medium">Theme</Text>
              <Text type="secondary" className="text-xs">{isDark ? 'Dark' : 'Light'}</Text>
            </div>
            <Switch
              checked={isDark}
              onChange={toggleTheme}
              checkedChildren={<Moon className="w-3 h-3" />}
              unCheckedChildren={<Sun className="w-3 h-3" />}
            />
          </div>

          {/* Primary Color */}
          <div className="p-4">
            <Text className="text-sm font-medium mb-3 block">Primary Color</Text>
            <div className="grid grid-cols-4 gap-2">
              {Object.entries(colorThemes).map(([key, colorTheme]) => {
                const isActive = primaryColor === key;
                return (
                  <button
                    key={key}
                    onClick={() => setPrimaryColor(key)}
                    className={`flex items-center gap-2 p-2 rounded border transition-colors ${
                      isActive
                        ? 'border-primary-500 bg-primary-100/50 dark:bg-primary-900/20'
                        : 'border-neutral-200 dark:border-neutral-700 hover:border-neutral-300 dark:hover:border-neutral-600 bg-white dark:bg-neutral-800'
                    }`}
                    title={colorTheme.name}
                  >
                    <div
                      className="w-5 h-5 rounded-full flex-shrink-0"
                      style={{ backgroundColor: colorTheme.colors[500] }}
                    />
                    <span className="text-xs font-medium text-neutral-900 dark:text-neutral-100 truncate">{colorTheme.name}</span>
                    {isActive && <CheckCircle className="w-3 h-3 text-primary-600 dark:text-primary-400 ml-auto flex-shrink-0" />}
                  </button>
                );
              })}
            </div>
          </div>
        </Card>
      </div>

      {/* Command Settings */}
      <div>
        <Text strong className="text-sm mb-3 block">Command Settings</Text>

        {/* Command Timeout */}
        <Card size="small" className="!mb-4">
          <div className="flex items-center gap-2 mb-3">
            <Clock className="w-4 h-4 text-neutral-500 dark:text-neutral-400" />
            <Text className="text-sm font-medium">Command Timeout</Text>
          </div>

          {renderPresetButtons(
            [
              { label: '3m', value: 180 },
              { label: '5m', value: 300 },
              { label: '10m', value: 600 },
              { label: '15m', value: 900 },
              { label: '30m', value: 1800 }
            ],
            commandTimeout,
            handleTimeoutPreset
          )}

          <div className="flex items-center gap-2">
            <InputNumber
              min={30}
              max={1800}
              value={commandTimeout}
              onChange={(val) => setCommandTimeout(val || 30)}
              size="small"
              className="!w-24"
            />
            <Text type="secondary" className="text-xs">seconds ({formatTime(commandTimeout)})</Text>
            <Button
              type="primary"
              size="small"
              onClick={handleSaveTimeout}
              loading={savingTimeout}
              disabled={commandTimeout === originalTimeout}
              icon={!savingTimeout && <Save className="w-3 h-3" />}
              className="ml-auto"
            >
              Save
            </Button>
          </div>

          {timeoutMessage && (
            <Alert
              message={timeoutMessage.text}
              type={timeoutMessage.type}
              showIcon
              className="mt-2"
              banner
            />
          )}
        </Card>

        {/* Approval Timeout */}
        <Card size="small" className="!mb-4">
          <div className="flex items-center gap-2 mb-3">
            <Clock className="w-4 h-4 text-neutral-500 dark:text-neutral-400" />
            <Text className="text-sm font-medium">Approval Timeout</Text>
            <Text type="secondary" className="text-xs">(Command Approval)</Text>
          </div>

          {renderPresetButtons(
            [
              { label: '15s', value: 15 },
              { label: '30s', value: 30 },
              { label: '1m', value: 60 },
              { label: '2m', value: 120 },
              { label: '5m', value: 300 }
            ],
            approvalTimeout,
            handleApprovalTimeoutPreset
          )}

          <div className="flex items-center gap-2">
            <InputNumber
              min={10}
              max={600}
              value={approvalTimeout}
              onChange={(val) => setApprovalTimeout(val || 30)}
              size="small"
              className="!w-24"
            />
            <Text type="secondary" className="text-xs">seconds ({formatTime(approvalTimeout)})</Text>
            <Button
              type="primary"
              size="small"
              onClick={handleSaveApprovalTimeout}
              loading={savingApprovalTimeout}
              disabled={approvalTimeout === originalApprovalTimeout}
              icon={!savingApprovalTimeout && <Save className="w-3 h-3" />}
              className="ml-auto"
            >
              Save
            </Button>
          </div>

          <Text type="secondary" className="text-xs mt-2 block">
            Time to wait for user approval before rejecting a blocked command.
          </Text>

          {approvalTimeoutMessage && (
            <Alert
              message={approvalTimeoutMessage.text}
              type={approvalTimeoutMessage.type}
              showIcon
              className="mt-2"
              banner
            />
          )}
        </Card>

        {/* Output Max Length */}
        <Card size="small" className="!mb-4">
          <div className="flex items-center gap-2 mb-3">
            <Terminal className="w-4 h-4 text-neutral-500 dark:text-neutral-400" />
            <Text className="text-sm font-medium">Output Max Length</Text>
          </div>

          {renderPresetButtons(
            [
              { label: '1K', value: 1000 },
              { label: '2.5K', value: 2500 },
              { label: '5K', value: 5000 },
              { label: '10K', value: 10000 },
              { label: '50K', value: 50000 },
              { label: 'Unlimited', value: -1 }
            ],
            outputMaxLength,
            handleOutputMaxLengthPreset
          )}

          <div className="flex items-center gap-2">
            <InputNumber
              min={-1}
              max={100000}
              value={outputMaxLength}
              onChange={(val) => setOutputMaxLength(val || 500)}
              size="small"
              className="!w-28"
            />
            <Text type="secondary" className="text-xs">
              characters ({formatOutputLength(outputMaxLength)})
            </Text>
            <Button
              type="primary"
              size="small"
              onClick={handleSaveOutputMaxLength}
              loading={savingOutputMaxLength}
              disabled={outputMaxLength === originalOutputMaxLength}
              icon={!savingOutputMaxLength && <Save className="w-3 h-3" />}
              className="ml-auto"
            >
              Save
            </Button>
          </div>

          <Text type="secondary" className="text-xs mt-2 block">
            Controls how much command output is shown before truncation. Use -1 for unlimited output.
          </Text>

          {outputMaxLengthMessage && (
            <Alert
              message={outputMaxLengthMessage.text}
              type={outputMaxLengthMessage.type}
              showIcon
              className="mt-2"
              banner
            />
          )}
        </Card>

        {/* Command History Limit */}
        <Card size="small">
          <div className="flex items-center gap-2 mb-3">
            <Clock className="w-4 h-4 text-neutral-500 dark:text-neutral-400" />
            <Text className="text-sm font-medium">Command History Limit</Text>
          </div>

          {renderPresetButtons(
            [5, 10, 20, 50, 100].map((v) => ({ label: `${v}`, value: v })),
            commandHistoryLimit,
            handleHistoryLimitPreset
          )}

          <div className="flex items-center gap-2">
            <InputNumber
              min={5}
              max={100}
              value={commandHistoryLimit}
              onChange={(val) => setCommandHistoryLimit(Math.min(100, Math.max(5, val || 5)))}
              size="small"
              className="!w-24"
            />
            <Text type="secondary" className="text-xs">commands</Text>
            <Button
              type="primary"
              size="small"
              onClick={handleSaveCommandHistoryLimit}
              loading={savingHistoryLimit}
              disabled={commandHistoryLimit === originalHistoryLimit}
              icon={!savingHistoryLimit && <Save className="w-3 h-3" />}
              className="ml-auto"
            >
              Save
            </Button>
          </div>

          <Text type="secondary" className="text-xs mt-2 block">
            Number of recent commands to include when loading an assessment via MCP.
          </Text>

          {historyLimitMessage && (
            <Alert
              message={historyLimitMessage.text}
              type={historyLimitMessage.type}
              showIcon
              className="mt-2"
              banner
            />
          )}
        </Card>
      </div>

      {/* System Info Footer */}
      {systemInfo && (
        <Card size="small">
          <div className="flex items-center gap-2 text-xs">
            <Info className="w-3 h-3" />
            <Text type="secondary" className="text-xs">{systemInfo.platform_name} v{systemInfo.version}</Text>
            <span>•</span>
            <Text type="secondary" className="text-xs">FastAPI {systemInfo.fastapi_version}</Text>
          </div>
        </Card>
      )}
    </div>
  );

  // --- TAB: TOOLS ---
  const renderToolsTab = () => (
    <div className="space-y-6">
      {/* Workspace Access */}
      <div>
        <Text strong className="text-sm mb-3 block">Workspace Access</Text>

        <Card size="small">
          <div className="flex items-start justify-between">
            <div className="flex items-center gap-2">
              <FolderOpen className="w-4 h-4 text-neutral-500 dark:text-neutral-400" />
              <div>
                <Text className="text-sm font-medium block">Open Workspace Folder</Text>
                <Text type="secondary" className="text-xs">
                  Opens /workspace directory in file explorer
                </Text>
              </div>
            </div>
            <Button
              type="primary"
              size="small"
              onClick={handleOpenWorkspace}
              loading={openingWorkspace}
              icon={!openingWorkspace && <FolderOpen className="w-3 h-3" />}
            >
              {openingWorkspace ? 'Opening' : 'Open Folder'}
            </Button>
          </div>

          {workspaceMessage && (
            <Alert
              message={workspaceMessage.text}
              type={workspaceMessage.type}
              showIcon
              className="mt-3"
              banner
            />
          )}
        </Card>
      </div>

      {/* Exegol Configuration */}
      {systemInfo && (
        <div>
          <Text strong className="text-sm mb-3 block">Exegol Configuration</Text>

          <Card size="small">
            <div className="mb-3">
              <div className="flex items-center justify-between mb-3">
                <div className="flex items-center gap-2">
                  <Terminal className="w-4 h-4 text-neutral-500 dark:text-neutral-400" />
                  <Text className="text-sm font-medium">Container Selection</Text>
                </div>
                <Button
                  type="link"
                  size="small"
                  onClick={loadExegolContainers}
                  loading={loadingContainers}
                  icon={<RefreshCw className={`w-3 h-3 ${loadingContainers ? 'animate-spin' : ''}`} />}
                >
                  Detect
                </Button>
              </div>

              {loadingContainers ? (
                <div className="flex items-center justify-center p-4">
                  <Spin size="small" />
                  <Text type="secondary" className="text-xs ml-2">Detecting containers...</Text>
                </div>
              ) : availableContainers.length === 0 ? (
                <Alert
                  type="warning"
                  showIcon
                  icon={<AlertCircle className="w-4 h-4" />}
                  message="No Exegol containers detected. Make sure Docker is running and you have Exegol containers."
                  className="!text-xs"
                />
              ) : (
                <Radio.Group
                  value={containerName}
                  onChange={(e) => setContainerName(e.target.value)}
                  className="w-full"
                >
                  <div className="space-y-2">
                    {availableContainers.map((container) => (
                      <label
                        key={container.id}
                        className={`flex items-center justify-between p-3 border-2 rounded-lg cursor-pointer transition-colors ${
                          containerName === container.name
                            ? 'border-primary-500 bg-primary-100/50 dark:bg-primary-900/20'
                            : 'border-neutral-200 dark:border-neutral-700 hover:border-neutral-300 dark:hover:border-neutral-600'
                        }`}
                      >
                        <div className="flex items-center gap-3">
                          <Radio value={container.name} />
                          <div>
                            <Text className="text-sm font-mono font-medium block">
                              {container.name}
                            </Text>
                            <Text type="secondary" className="text-xs">
                              {container.image} · {container.id}
                            </Text>
                          </div>
                        </div>
                        {renderStatusDot(
                          container.status === 'running',
                          'Running',
                          container.status,
                          container.status !== 'running'
                        )}
                      </label>
                    ))}
                  </div>
                </Radio.Group>
              )}

              <div className="mt-3 flex items-center justify-end">
                <Button
                  type="primary"
                  size="small"
                  onClick={handleSaveContainer}
                  loading={savingContainer}
                  disabled={containerName.trim() === originalContainerName || availableContainers.length === 0}
                  icon={!savingContainer && <Save className="w-3 h-3" />}
                >
                  {savingContainer ? 'Saving' : 'Save Selection'}
                </Button>
              </div>

              <Text type="secondary" className="text-xs mt-2 block">
                Default container for new assessments. Change per-assessment using the container badge.
              </Text>

              {containerMessage && (
                <Alert
                  message={containerMessage.text}
                  type={containerMessage.type}
                  showIcon
                  className="mt-2"
                  banner
                />
              )}
            </div>

            <div className="pt-3 border-t">
              <Text type="secondary" className="text-xs mb-1 block">Workspace Path</Text>
              <code className="text-xs font-mono bg-neutral-100 dark:bg-neutral-700 text-neutral-900 dark:text-neutral-100 px-2 py-1 rounded">
                {systemInfo.workspace_base}
              </code>
            </div>
          </Card>
        </div>
      )}
    </div>
  );

  // --- TAB: ABOUT ---
  const renderAboutTab = () => (
    <div className="space-y-6">
      {/* Platform Information */}
      <div>
        <Text strong className="text-sm mb-3 block">Platform Information</Text>

        {systemInfo ? (
          <Descriptions
            bordered
            size="small"
            column={1}
            className="settings-descriptions"
            items={[
              {
                key: 'platform',
                label: 'Platform',
                children: (
                  <Text className="text-xs font-medium">
                    {systemInfo.platform_name} v{systemInfo.version}
                  </Text>
                ),
              },
              {
                key: 'backend',
                label: 'Backend API',
                children: (
                  <div className="flex items-center gap-2">
                    <Text type="secondary" className="text-xs">FastAPI {systemInfo.fastapi_version}</Text>
                    {renderStatusDot(
                      systemStatus.backend.status === 'connected',
                      `${systemStatus.backend.latency}ms`,
                      'Error'
                    )}
                  </div>
                ),
              },
              {
                key: 'frontend',
                label: 'Frontend',
                children: (
                  <div className="flex items-center gap-2">
                    <Text type="secondary" className="text-xs">React + Vite</Text>
                    {renderStatusDot(true, 'Active', 'Inactive')}
                  </div>
                ),
              },
              {
                key: 'database',
                label: 'Database',
                children: (
                  <div className="flex items-center gap-2">
                    <Text type="secondary" className="text-xs">PostgreSQL {systemStatus.database.version}</Text>
                    {renderStatusDot(
                      systemStatus.database.connected,
                      'Connected',
                      'Disconnected'
                    )}
                  </div>
                ),
              },
              {
                key: 'exegol',
                label: 'Exegol Container',
                children: (
                  <div className="flex items-center gap-2">
                    <Text type="secondary" className="text-xs max-w-[120px] truncate">
                      {systemStatus.exegol.container || systemInfo.container_name}
                    </Text>
                    {renderStatusDot(
                      systemStatus.exegol.running,
                      'Running',
                      'Stopped',
                      true
                    )}
                  </div>
                ),
              },
              {
                key: 'python',
                label: 'Python Version',
                children: (
                  <Text className="text-xs font-medium">{systemInfo.python_version}</Text>
                ),
              },
              {
                key: 'environment',
                label: 'Environment',
                children: (
                  <Text className="text-xs font-medium capitalize">{systemInfo.environment}</Text>
                ),
              },
            ]}
          />
        ) : (
          <Card className="text-center">
            <AlertCircle className="w-8 h-8 mx-auto mb-2 text-neutral-300 dark:text-neutral-600" />
            <Text type="secondary" className="text-xs">Unable to load system information</Text>
          </Card>
        )}
      </div>

      {/* Links & Resources */}
      <div>
        <Text strong className="text-sm mb-3 block">Links & Resources</Text>

        <List
          size="small"
          bordered
          dataSource={[
            {
              key: 'github',
              icon: (
                <svg className="w-4 h-4 text-neutral-500 dark:text-neutral-400" fill="currentColor" viewBox="0 0 24 24">
                  <path fillRule="evenodd" d="M12 2C6.477 2 2 6.484 2 12.017c0 4.425 2.865 8.18 6.839 9.504.5.092.682-.217.682-.483 0-.237-.008-.868-.013-1.703-2.782.605-3.369-1.343-3.369-1.343-.454-1.158-1.11-1.466-1.11-1.466-.908-.62.069-.608.069-.608 1.003.07 1.531 1.032 1.531 1.032.892 1.53 2.341 1.088 2.91.832.092-.647.35-1.088.636-1.338-2.22-.253-4.555-1.113-4.555-4.951 0-1.093.39-1.988 1.029-2.688-.103-.253-.446-1.272.098-2.65 0 0 .84-.27 2.75 1.026A9.564 9.564 0 0112 6.844c.85.004 1.705.115 2.504.337 1.909-1.296 2.747-1.027 2.747-1.027.546 1.379.202 2.398.1 2.651.64.7 1.028 1.595 1.028 2.688 0 3.848-2.339 4.695-4.566 4.943.359.309.678.92.678 1.855 0 1.338-.012 2.419-.012 2.747 0 .268.18.58.688.482A10.019 10.019 0 0022 12.017C22 6.484 17.522 2 12 2z" clipRule="evenodd" />
                </svg>
              ),
              title: 'GitHub Repository',
              href: 'https://github.com/Vasco0x4/AutoPentest',
              external: true,
            },
            {
              key: 'website',
              icon: <Globe className="w-4 h-4 text-neutral-500 dark:text-neutral-400" />,
              title: 'Author Website',
              href: 'https://www.vasco0x4.me/',
              external: true,
            },
            {
              key: 'email',
              icon: <Mail className="w-4 h-4 text-neutral-500 dark:text-neutral-400" />,
              title: 'Contact Email',
              href: 'mailto:Vasco0x4@proton.me',
              external: false,
            },
            {
              key: 'swagger',
              icon: <Server className="w-4 h-4 text-neutral-500 dark:text-neutral-400" />,
              title: 'API Documentation (Swagger)',
              href: 'http://localhost:8000/docs',
              external: true,
            },
            {
              key: 'redoc',
              icon: <Database className="w-4 h-4 text-neutral-500 dark:text-neutral-400" />,
              title: 'API Documentation (ReDoc)',
              href: 'http://localhost:8000/redoc',
              external: true,
            },
            {
              key: 'exegol',
              icon: <Terminal className="w-4 h-4 text-neutral-500 dark:text-neutral-400" />,
              title: 'Exegol Project',
              href: 'https://github.com/ThePorgs/Exegol',
              external: true,
            },
            {
              key: 'mcp',
              icon: <Info className="w-4 h-4 text-neutral-500 dark:text-neutral-400" />,
              title: 'MCP Protocol',
              href: 'https://modelcontextprotocol.io/',
              external: true,
            },
          ]}
          renderItem={(item) => (
            <List.Item className="!px-3 !py-2.5 cursor-pointer hover:bg-neutral-50 dark:hover:bg-neutral-700/50 transition-colors">
              <a
                href={item.href}
                target={item.external ? '_blank' : undefined}
                rel={item.external ? 'noopener noreferrer' : undefined}
                className="flex items-center justify-between w-full no-underline"
              >
                <div className="flex items-center gap-2">
                  {item.icon}
                  <Text className="text-sm">{item.title}</Text>
                </div>
                <ExternalLink className="w-3 h-3 text-neutral-400" />
              </a>
            </List.Item>
          )}
        />
      </div>
    </div>
  );

  // Tab items for antd Tabs
  const tabItems = [
    {
      key: 'general',
      label: (
        <span className="flex items-center gap-2">
          <SettingsIcon className="w-4 h-4" />
          General
        </span>
      ),
      children: renderGeneralTab(),
    },
    {
      key: 'tools',
      label: (
        <span className="flex items-center gap-2">
          <Terminal className="w-4 h-4" />
          Tools
        </span>
      ),
      children: renderToolsTab(),
    },
    {
      key: 'about',
      label: (
        <span className="flex items-center gap-2">
          <Info className="w-4 h-4" />
          About
        </span>
      ),
      children: renderAboutTab(),
    },
  ];

  return (
    <div className="space-y-6 animate-in">
      {/* Header */}
      <div>
        <Title level={3} className="!mb-0">Settings</Title>
        <Text type="secondary">
          System status and configuration
        </Text>
      </div>

      {/* Tabs */}
      <Tabs
        activeKey={activeTab}
        onChange={setActiveTab}
        items={tabItems}
        className="settings-tabs"
      />
    </div>
  );
};

export default Settings;
