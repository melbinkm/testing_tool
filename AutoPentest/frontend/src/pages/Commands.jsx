import { useState, useEffect, useCallback, Fragment } from 'react';
import { useSearchParams } from 'react-router-dom';
import { Typography, Card, Statistic, Tabs, Input, Segmented, Table, Tag, Button, Empty, Spin, Select, Switch, Badge, Progress, Row, Col } from 'antd';
import { Terminal, Clock, Search, ChevronDown, ChevronRight, Check, X, Plus, Activity, TrendingUp, AlertCircle, BarChart3 } from '../components/icons';
import commandService from '../services/commandService';
import commandSettingsService from '../services/commandSettingsService';
import toolStatsService from '../services/toolStatsService';
import useInfiniteScroll from '../hooks/useInfiniteScroll';
import { useWebSocketContext } from '../contexts/WebSocketContext';

const { Title, Text } = Typography;

const Commands = () => {
  const [searchParams, setSearchParams] = useSearchParams();

  // Stats state
  const [stats, setStats] = useState({ total: 0, passed: 0, failed: 0, avg_execution_time: 0 });

  // Command list state
  const [commands, setCommands] = useState([]);
  const [loading, setLoading] = useState(false);
  const [initialLoading, setInitialLoading] = useState(true);
  const [hasMore, setHasMore] = useState(true);
  const [total, setTotal] = useState(0);
  const [searchQuery, setSearchQuery] = useState('');
  const [statusFilter, setStatusFilter] = useState('all');
  const [expandedCommand, setExpandedCommand] = useState(null);
  const [searchDebounceTimer, setSearchDebounceTimer] = useState(null);

  // Main tab state - initialize from URL param
  const [mainTab, setMainTab] = useState(searchParams.get('tab') || 'all');

  // Analytics states
  const [toolStats, setToolStats] = useState(null);
  const [analyticsLoading, setAnalyticsLoading] = useState(false);
  const [analyticsPeriod, setAnalyticsPeriod] = useState('30');
  const [includeFailedCommands, setIncludeFailedCommands] = useState(true);

  // Approval sub-tab state
  const [approvalTab, setApprovalTab] = useState('pending');
  const [historyFilter, setHistoryFilter] = useState('all');

  // Pending commands state
  const [pendingCommands, setPendingCommands] = useState([]);
  const [historyCommands, setHistoryCommands] = useState([]);
  const [pendingCount, setPendingCount] = useState(0);

  // Command settings state
  const [executionMode, setExecutionMode] = useState('open');
  const [filterKeywords, setFilterKeywords] = useState([]);
  const [newKeyword, setNewKeyword] = useState('');
  const [savingMode, setSavingMode] = useState(false);

  // Approval state
  const [processingId, setProcessingId] = useState(null);

  // WebSocket for real-time updates
  const { subscribe } = useWebSocketContext();

  // Load initial data
  useEffect(() => {
    loadStats();
    loadSettings();
    loadInitialCommands();
    loadPendingCommands();

    if (mainTab === 'analytics') {
      loadAnalytics();
    }
  }, []);

  // Load analytics when tab changes or filters update
  useEffect(() => {
    if (mainTab === 'analytics') {
      loadAnalytics();
    }
  }, [mainTab, analyticsPeriod, includeFailedCommands]);

  // Subscribe to WebSocket events for real-time updates
  useEffect(() => {
    const unsubscribes = [
      subscribe('command_pending_approval', () => loadPendingCommands()),
      subscribe('command_approved', () => {
        loadPendingCommands();
        loadInitialCommands();
        loadStats();
      }),
      subscribe('command_rejected', () => loadPendingCommands()),
      subscribe('command_timeout', () => loadPendingCommands()),
    ];
    return () => unsubscribes.forEach(unsub => unsub && unsub());
  }, [subscribe]);

  const loadStats = async () => {
    try {
      const data = await commandService.getStats();
      setStats(data);
    } catch (error) {
      // silent
    }
  };

  const loadSettings = async () => {
    try {
      const settings = await commandSettingsService.getCommandSettings();
      setExecutionMode(settings.execution_mode || 'open');
      setFilterKeywords(settings.filter_keywords || []);
    } catch (error) {
      // silent
    }
  };

  const loadPendingCommands = async () => {
    try {
      const data = await commandSettingsService.listPendingCommands();
      const allCmds = data.commands || [];
      setPendingCommands(allCmds.filter(c => c.status === 'pending'));
      setHistoryCommands(allCmds.filter(c => c.status !== 'pending'));
      setPendingCount(data.pending_count || 0);
    } catch (error) {
      // silent
    }
  };

  const loadAnalytics = async () => {
    try {
      setAnalyticsLoading(true);
      const params = {
        top_n: 20,
        include_failed: includeFailedCommands
      };

      if (analyticsPeriod !== 'all') {
        params.since_days = parseInt(analyticsPeriod);
      }

      const data = await toolStatsService.getToolStats(params);
      setToolStats(data);
    } catch (error) {
      console.error('Failed to load analytics:', error);
      setToolStats(null);
    } finally {
      setAnalyticsLoading(false);
    }
  };

  const loadMore = useCallback(async () => {
    if (loading || !hasMore) return;
    try {
      setLoading(true);
      const skip = commands.length;
      const status = statusFilter === 'passed' ? 'success' : statusFilter === 'failed' ? 'failed' : null;
      const data = await commandService.getAllCommands({ skip, limit: 50, status, search: searchQuery.trim() || null });
      setCommands((prev) => [...prev, ...data.commands]);
      setTotal(data.total);
      setHasMore(data.has_more);
    } catch (error) {
      // silent
    } finally {
      setLoading(false);
    }
  }, [commands.length, statusFilter, searchQuery, hasMore, loading]);

  const loadInitialCommands = async () => {
    try {
      setInitialLoading(true);
      const data = await commandService.getAllCommands({ skip: 0, limit: 50, status: null, search: null });
      setCommands(data.commands);
      setTotal(data.total);
      setHasMore(data.has_more);
    } catch (error) {
      // silent
    } finally {
      setInitialLoading(false);
    }
  };

  const reloadWithFilters = useCallback(async () => {
    try {
      setLoading(true);
      const status = statusFilter === 'passed' ? 'success' : statusFilter === 'failed' ? 'failed' : null;
      const data = await commandService.getAllCommands({ skip: 0, limit: 50, status, search: searchQuery.trim() || null });
      setCommands(data.commands);
      setTotal(data.total);
      setHasMore(data.has_more);
      setExpandedCommand(null);
    } catch (error) {
      // silent
    } finally {
      setLoading(false);
    }
  }, [statusFilter, searchQuery]);

  useEffect(() => {
    if (!initialLoading && mainTab === 'all') {
      reloadWithFilters();
    }
  }, [statusFilter]);

  const handleSearchChange = (value) => {
    setSearchQuery(value);
    if (searchDebounceTimer) clearTimeout(searchDebounceTimer);
    const timer = setTimeout(() => { if (!initialLoading) reloadWithFilters(); }, 500);
    setSearchDebounceTimer(timer);
  };

  useEffect(() => { return () => { if (searchDebounceTimer) clearTimeout(searchDebounceTimer); }; }, [searchDebounceTimer]);

  const sentryRef = useInfiniteScroll({ onLoadMore: loadMore, hasMore, loading, threshold: 300 });

  // Mode and keyword handlers
  const handleModeChange = async (newMode) => {
    setSavingMode(true);
    try {
      await commandSettingsService.updateCommandSettings({ execution_mode: newMode });
      setExecutionMode(newMode);
    } catch (error) {
      console.error('Failed to update mode:', error);
    } finally {
      setSavingMode(false);
    }
  };

  const handleAddKeyword = async () => {
    if (!newKeyword.trim()) return;
    try {
      const result = await commandSettingsService.addKeyword(newKeyword.trim());
      setFilterKeywords(result.filter_keywords);
      setNewKeyword('');
    } catch (error) {
      console.error('Failed to add keyword:', error);
    }
  };

  const handleRemoveKeyword = async (keyword) => {
    try {
      const result = await commandSettingsService.removeKeyword(keyword);
      setFilterKeywords(result.filter_keywords);
    } catch (error) {
      console.error('Failed to remove keyword:', error);
    }
  };

  // Approval handlers
  const handleApprove = async (commandId) => {
    setProcessingId(commandId);
    try {
      await commandSettingsService.approveCommand(commandId);
      await loadPendingCommands();
      await loadInitialCommands();
      await loadStats();
    } catch (error) {
      console.error('Failed to approve command:', error);
    } finally {
      setProcessingId(null);
    }
  };

  const handleReject = async (commandId) => {
    setProcessingId(commandId);
    try {
      await commandSettingsService.rejectCommand(commandId);
      await loadPendingCommands();
    } catch (error) {
      console.error('Failed to reject command:', error);
    } finally {
      setProcessingId(null);
    }
  };

  // Helpers
  const getStatusTag = (status, success) => {
    if (status === 'pending') return <Tag color="warning">Pending</Tag>;
    if (status === 'executed' || status === 'approved') return <Tag color="success">Approved</Tag>;
    if (status === 'rejected') return <Tag color="error">Rejected</Tag>;
    if (status === 'timeout') return <Tag color="orange">Timeout</Tag>;
    if (success === true) return <Tag color="success">Success</Tag>;
    if (success === false) return <Tag color="error">Failed</Tag>;
    return <Tag>Unknown</Tag>;
  };

  const getStatusDot = (status, success) => {
    if (status === 'pending') return 'bg-amber-400';
    if (status === 'executed' || status === 'approved') return 'bg-green-500';
    if (status === 'rejected') return 'bg-red-500';
    if (status === 'timeout') return 'bg-orange-500';
    if (success === true) return 'bg-green-500';
    if (success === false) return 'bg-red-500';
    return 'bg-neutral-400';
  };

  const formatTime = (dateStr) => {
    if (!dateStr) return '—';
    const date = new Date(dateStr);
    const now = new Date();
    const diff = Math.floor((now - date) / 1000);
    if (diff < 60) return `${diff}s ago`;
    if (diff < 3600) return `${Math.floor(diff / 60)}m ago`;
    if (diff < 86400) return `${Math.floor(diff / 3600)}h ago`;
    return date.toLocaleDateString();
  };

  const filteredHistory = historyCommands.filter(cmd => {
    if (historyFilter === 'all') return true;
    if (historyFilter === 'approved') return cmd.status === 'executed';
    if (historyFilter === 'rejected') return cmd.status === 'rejected';
    if (historyFilter === 'timeout') return cmd.status === 'timeout';
    return true;
  });

  // Command columns for antd Table
  const commandColumns = [
    {
      title: '',
      key: 'status',
      width: 32,
      render: (_, cmd) => <div className={`w-2 h-2 rounded-full ${getStatusDot(null, cmd.success)}`} />,
    },
    {
      title: 'Command',
      key: 'command',
      render: (_, cmd) => (
        <code className="text-xs font-mono">
          {cmd.command.length > 60 ? cmd.command.substring(0, 60) + '...' : cmd.command}
        </code>
      ),
    },
    {
      title: 'Assessment',
      dataIndex: 'assessment_name',
      key: 'assessment',
      width: 160,
      render: (text) => <Text type="secondary" className="text-sm">{text}</Text>,
    },
    {
      title: 'Duration',
      key: 'duration',
      width: 80,
      render: (_, cmd) => <Text type="secondary" className="text-xs">{cmd.execution_time?.toFixed(2)}s</Text>,
    },
    {
      title: 'Executed',
      key: 'time',
      width: 96,
      render: (_, cmd) => <Text type="secondary" className="text-xs">{formatTime(cmd.created_at)}</Text>,
    },
    {
      title: '',
      key: 'expand',
      width: 32,
      render: (_, cmd) => expandedCommand === cmd.id
        ? <ChevronDown className="w-4 h-4 text-neutral-400" />
        : <ChevronRight className="w-4 h-4 text-neutral-400" />,
    },
  ];

  // Pending command columns
  const pendingColumns = [
    {
      title: '',
      key: 'status',
      width: 32,
      render: (_, cmd) => <div className={`w-2 h-2 rounded-full ${getStatusDot(cmd.status)}`} />,
    },
    {
      title: 'Command',
      key: 'command',
      render: (_, cmd) => (
        <code className="text-xs font-mono">
          {cmd.command.length > 50 ? cmd.command.substring(0, 50) + '...' : cmd.command}
        </code>
      ),
    },
    {
      title: 'Assessment',
      dataIndex: 'assessment_name',
      key: 'assessment',
      width: 140,
    },
    {
      title: 'Keywords',
      key: 'keywords',
      width: 140,
      render: (_, cmd) => (
        <div className="flex flex-wrap gap-1">
          {cmd.matched_keywords?.map((kw) => (
            <Tag key={kw} color="warning" style={{ margin: 0 }}>{kw}</Tag>
          ))}
        </div>
      ),
    },
    {
      title: 'Time',
      key: 'time',
      width: 80,
      render: (_, cmd) => <Text type="secondary" className="text-xs">{formatTime(cmd.created_at)}</Text>,
    },
    {
      title: '',
      key: 'actions',
      width: 80,
      render: (_, cmd) => (
        <div className="flex items-center gap-1">
          <Button
            type="text"
            size="small"
            icon={<Check className="w-4 h-4" />}
            onClick={() => handleApprove(cmd.id)}
            loading={processingId === cmd.id}
            className="!text-green-600 hover:!bg-green-50"
          />
          <Button
            type="text"
            size="small"
            danger
            icon={<X className="w-4 h-4" />}
            onClick={() => handleReject(cmd.id)}
            loading={processingId === cmd.id}
          />
        </div>
      ),
    },
  ];

  // History columns
  const historyColumns = [
    {
      title: '',
      key: 'status_dot',
      width: 32,
      render: (_, cmd) => <div className={`w-2 h-2 rounded-full ${getStatusDot(cmd.status)}`} />,
    },
    {
      title: 'Command',
      key: 'command',
      render: (_, cmd) => (
        <code className="text-xs font-mono">
          {cmd.command.length > 50 ? cmd.command.substring(0, 50) + '...' : cmd.command}
        </code>
      ),
    },
    {
      title: 'Assessment',
      dataIndex: 'assessment_name',
      key: 'assessment',
      width: 140,
    },
    {
      title: 'Status',
      key: 'status',
      width: 100,
      render: (_, cmd) => getStatusTag(cmd.status),
    },
    {
      title: 'Resolved',
      key: 'resolved',
      width: 96,
      render: (_, cmd) => <Text type="secondary" className="text-xs">{formatTime(cmd.resolved_at)}</Text>,
    },
  ];

  // Analytics tool columns
  const toolColumns = [
    {
      title: '#',
      key: 'rank',
      width: 40,
      render: (_, __, idx) => <Text type="secondary">{idx + 1}</Text>,
    },
    {
      title: 'Tool',
      key: 'tool',
      render: (_, tool) => <code className="font-mono">{tool.tool}</code>,
    },
    {
      title: 'Count',
      dataIndex: 'count',
      key: 'count',
      width: 64,
      align: 'right',
      render: (count) => <Text type="secondary" className="font-mono">{count}</Text>,
    },
    {
      title: 'Share',
      dataIndex: 'percentage',
      key: 'share',
      width: 64,
      align: 'right',
      render: (pct) => <Text strong>{pct}%</Text>,
    },
    {
      title: 'Success',
      key: 'success',
      width: 80,
      align: 'center',
      render: (_, tool) => (
        <div className="inline-flex items-center gap-1">
          <div className={`w-1 h-4 rounded-full ${
            tool.success_rate >= 95 ? 'bg-green-500' :
            tool.success_rate >= 85 ? 'bg-green-400' :
            tool.success_rate >= 70 ? 'bg-yellow-500' :
            tool.success_rate >= 50 ? 'bg-orange-500' :
            'bg-red-500'
          }`} />
          <span className={`font-mono ${
            tool.success_rate >= 85 ? 'text-green-600 dark:text-green-400' :
            tool.success_rate >= 70 ? 'text-yellow-600 dark:text-yellow-400' :
            'text-red-600 dark:text-red-400'
          }`}>
            {tool.success_rate.toFixed(0)}%
          </span>
        </div>
      ),
    },
  ];

  // Tab items
  const tabItems = [
    {
      key: 'all',
      label: 'All Commands',
      children: (
        <div className="space-y-4">
          {/* Search & Filter */}
          <div className="flex items-center gap-4">
            <Input
              value={searchQuery}
              onChange={(e) => handleSearchChange(e.target.value)}
              placeholder="Search commands..."
              prefix={<Search className="w-4 h-4 text-neutral-400" />}
              style={{ maxWidth: 320 }}
              allowClear
            />
            <Segmented
              value={statusFilter}
              onChange={setStatusFilter}
              options={[
                { label: 'All', value: 'all' },
                { label: 'Passed', value: 'passed' },
                { label: 'Failed', value: 'failed' },
              ]}
              size="small"
            />
          </div>

          {/* Commands Table */}
          {commands.length === 0 ? (
            <Card>
              <Empty
                image={<Terminal className="w-8 h-8 mx-auto text-neutral-300" />}
                description={searchQuery ? 'No matching commands' : 'No commands executed yet'}
              />
            </Card>
          ) : (
            <Table
              columns={commandColumns}
              dataSource={commands}
              rowKey="id"
              pagination={false}
              size="small"
              onRow={(cmd) => ({
                onClick: () => setExpandedCommand(expandedCommand === cmd.id ? null : cmd.id),
                style: { cursor: 'pointer' },
              })}
              expandable={{
                expandedRowKeys: expandedCommand ? [expandedCommand] : [],
                expandedRowRender: (cmd) => (
                  <div className="space-y-3 p-2">
                    <div>
                      <Text type="secondary" className="text-xs font-medium uppercase">Command</Text>
                      <code className="block mt-1 p-2 border rounded text-xs font-mono">{cmd.command}</code>
                    </div>
                    {cmd.stdout && (
                      <div>
                        <Text type="secondary" className="text-xs font-medium uppercase">Output</Text>
                        <pre className="mt-1 p-3 bg-neutral-900 text-neutral-100 rounded text-xs font-mono max-h-48 overflow-auto">{cmd.stdout}</pre>
                      </div>
                    )}
                    {cmd.stderr && (
                      <div>
                        <span className="text-xs font-medium text-red-500 uppercase">Error</span>
                        <pre className="mt-1 p-3 bg-red-950 text-red-100 rounded text-xs font-mono max-h-48 overflow-auto">{cmd.stderr}</pre>
                      </div>
                    )}
                  </div>
                ),
                showExpandColumn: false,
              }}
            />
          )}
          {hasMore && (
            <div ref={sentryRef} className="py-4 text-center">
              {loading && <Spin size="small" />}
            </div>
          )}
        </div>
      ),
    },
    {
      key: 'approval',
      label: (
        <span className="flex items-center gap-2">
          Command Approval
          {pendingCount > 0 && <Badge count={pendingCount} size="small" />}
        </span>
      ),
      children: (
        <div className="space-y-4">
          {/* Mode Selector */}
          <div className="flex items-center gap-3">
            <Text type="secondary" className="text-sm">Execution Mode:</Text>
            <Segmented
              value={executionMode}
              onChange={handleModeChange}
              disabled={savingMode}
              options={[
                { label: 'Open', value: 'open' },
                { label: 'Filter', value: 'filter' },
                { label: 'Closed', value: 'closed' },
              ]}
              size="small"
            />
          </div>

          {/* Keywords (only show in filter mode) */}
          {executionMode === 'filter' && (
            <div className="flex items-center gap-2 flex-wrap">
              <Text type="secondary" className="text-xs">Blocked keywords:</Text>
              {filterKeywords.map((kw) => (
                <Tag
                  key={kw}
                  closable
                  onClose={() => handleRemoveKeyword(kw)}
                >
                  {kw}
                </Tag>
              ))}
              <Input
                size="small"
                value={newKeyword}
                onChange={(e) => setNewKeyword(e.target.value)}
                onPressEnter={handleAddKeyword}
                placeholder="+ add"
                style={{ width: 80 }}
              />
            </div>
          )}

          {/* Approval Sub-tabs */}
          <Tabs
            activeKey={approvalTab}
            onChange={setApprovalTab}
            size="small"
            items={[
              {
                key: 'pending',
                label: `Pending ${pendingCount > 0 ? `(${pendingCount})` : ''}`,
                children: pendingCommands.length === 0 ? (
                  <Card>
                    <Empty
                      image={<Terminal className="w-8 h-8 mx-auto text-neutral-300" />}
                      description="No commands pending approval"
                    />
                  </Card>
                ) : (
                  <Table
                    columns={pendingColumns}
                    dataSource={pendingCommands}
                    rowKey="id"
                    pagination={false}
                    size="small"
                  />
                ),
              },
              {
                key: 'history',
                label: 'Approval History',
                children: (
                  <div className="space-y-4">
                    <Segmented
                      value={historyFilter}
                      onChange={setHistoryFilter}
                      options={[
                        { label: 'All', value: 'all' },
                        { label: 'Approved', value: 'approved' },
                        { label: 'Rejected', value: 'rejected' },
                        { label: 'Timeout', value: 'timeout' },
                      ]}
                      size="small"
                    />

                    {filteredHistory.length === 0 ? (
                      <Card>
                        <Empty
                          image={<Clock className="w-8 h-8 mx-auto text-neutral-300" />}
                          description="No approval history"
                        />
                      </Card>
                    ) : (
                      <Table
                        columns={historyColumns}
                        dataSource={filteredHistory}
                        rowKey="id"
                        pagination={false}
                        size="small"
                      />
                    )}
                  </div>
                ),
              },
            ]}
          />
        </div>
      ),
    },
    {
      key: 'analytics',
      label: (
        <span className="flex items-center gap-2">
          <BarChart3 className="w-4 h-4" />
          Tool Analytics
        </span>
      ),
      children: (
        <div className="space-y-4">
          {/* Filters Bar */}
          <div className="flex items-center justify-between">
            <div className="flex items-center gap-3">
              <Select
                value={analyticsPeriod}
                onChange={setAnalyticsPeriod}
                style={{ width: 100 }}
                size="small"
                options={[
                  { value: '30', label: '30d' },
                  { value: '90', label: '90d' },
                  { value: '180', label: '180d' },
                  { value: 'all', label: 'All' },
                ]}
              />

              <label className="flex items-center gap-1.5 text-xs cursor-pointer">
                <Switch
                  size="small"
                  checked={includeFailedCommands}
                  onChange={setIncludeFailedCommands}
                />
                <span>Include Failed</span>
              </label>
            </div>

            {toolStats && (
              <Text type="secondary" className="text-xs">
                {toolStats.total_commands.toLocaleString()} commands · {toolStats.total_assessments} assessments
              </Text>
            )}
          </div>

          {analyticsLoading ? (
            <div className="flex items-center justify-center py-16">
              <Spin />
            </div>
          ) : toolStats ? (
            <Row gutter={[16, 16]}>
              {/* Left: Tools Table */}
              <Col span={16}>
                <Table
                  columns={toolColumns}
                  dataSource={toolStats.most_used_tools}
                  rowKey="tool"
                  pagination={false}
                  size="small"
                />
              </Col>

              {/* Right: Categories */}
              <Col span={8}>
                <Card size="small" title={<span className="text-xs font-semibold">Categories</span>}>
                  <div className="space-y-3">
                    {Object.entries(toolStats.tool_categories)
                      .sort(([, a], [, b]) => b.count - a.count)
                      .map(([category, data]) => (
                        <div key={category} className="space-y-1">
                          <div className="flex items-center justify-between text-xs">
                            <Text className="capitalize font-medium text-xs">
                              {category}
                            </Text>
                            <div className="flex items-center gap-2">
                              <Text type="secondary" className="font-mono text-xs">
                                {data.count}
                              </Text>
                              <Text strong className="w-10 text-right text-xs">
                                {data.percentage}%
                              </Text>
                            </div>
                          </div>
                          <Progress
                            percent={data.percentage}
                            showInfo={false}
                            size="small"
                          />
                          <div className="flex flex-wrap gap-1 mt-1">
                            {data.tools.slice(0, 3).map(t => (
                              <code key={t} className="text-[10px] px-1 py-0.5 bg-neutral-100 dark:bg-neutral-800 rounded">
                                {t}
                              </code>
                            ))}
                            {data.tools.length > 3 && (
                              <Text type="secondary" className="text-[10px]">
                                +{data.tools.length - 3}
                              </Text>
                            )}
                          </div>
                        </div>
                      ))}
                  </div>
                </Card>
              </Col>
            </Row>
          ) : (
            <Card>
              <Empty
                image={<BarChart3 className="w-10 h-10 mx-auto text-neutral-300" />}
                description="No analytics data"
              />
            </Card>
          )}
        </div>
      ),
    },
  ];

  if (initialLoading) {
    return (
      <div className="flex items-center justify-center h-96">
        <Spin size="large" tip="Loading commands..." />
      </div>
    );
  }

  return (
    <div className="space-y-6 animate-in">
      {/* Header */}
      <div>
        <Title level={2} className="!mb-0">Commands</Title>
        <Text type="secondary">Execution history and approval queue</Text>
      </div>

      {/* Stats Header */}
      <Row gutter={[16, 16]}>
        <Col span={6}>
          <Card size="small">
            <Statistic
              title="Total Commands"
              value={stats.total}
              prefix={<Terminal className="w-4 h-4" />}
            />
          </Card>
        </Col>
        <Col span={6}>
          <Card size="small">
            <Statistic
              title="Avg Time"
              value={stats.avg_execution_time}
              suffix="s"
              prefix={<Clock className="w-4 h-4" />}
            />
          </Card>
        </Col>
        <Col span={6}>
          <Card size="small">
            <Statistic
              title="Passed"
              value={stats.passed}
              valueStyle={{ color: '#16a34a' }}
              prefix={<TrendingUp className="w-4 h-4 text-green-500" />}
            />
          </Card>
        </Col>
        <Col span={6}>
          <Card size="small">
            <Statistic
              title="Failed"
              value={stats.failed}
              valueStyle={{ color: '#dc2626' }}
              prefix={<AlertCircle className="w-4 h-4 text-red-500" />}
            />
          </Card>
        </Col>
      </Row>

      {/* Main Tabs */}
      <Tabs
        activeKey={mainTab}
        onChange={setMainTab}
        items={tabItems}
      />
    </div>
  );
};

export default Commands;
