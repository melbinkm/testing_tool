# AutoPentest Setup Guide

## Prerequisites

- **Python 3.10+** (required by the `mcp` SDK)
- **Docker Engine + Docker Compose** (for the full stack)
- **An MCP-compatible AI client** (Claude Code, Claude Desktop, Gemini CLI, etc.)

---

## Option 1: MCP Server Only (Standalone)

Use this when you just want to connect the MCP server to your AI client without the web dashboard or database.

```bash
cd AutoPentest

# Make the launcher executable
chmod +x start_mcp.sh

# Run it (creates venv, installs deps, starts the MCP server)
./start_mcp.sh
```

The script will:
1. Create a Python venv at `backend/venv/` if missing
2. Install all dependencies from `backend/requirements.txt`
3. Test the MCP import
4. Launch the server on stdio (logs to `/tmp/autopentest_mcp.log`)

### Connect Your AI Client

Add to your MCP client configuration (e.g. `~/.claude/claude_desktop_config.json`):

```json
{
  "mcpServers": {
    "autopentest": {
      "command": "/bin/bash",
      "args": ["/absolute/path/to/AutoPentest/start_mcp.sh"]
    }
  }
}
```

---

## Option 2: Full Stack (Docker Compose)

Use this for the complete platform with PostgreSQL, REST API, Kali container, and web dashboard.

### 1. Configure Environment

```bash
cp backend/.env.example backend/.env
```

Edit `backend/.env` and change at minimum:
- `POSTGRES_PASSWORD` - set a secure password
- `DEFAULT_CONTAINER_NAME` - defaults to `kali-autopentest`

### 2. Start Services

```bash
docker-compose up -d
```

This starts 4 containers:

| Service | Container | Port | Purpose |
|---------|-----------|------|---------|
| postgres | `autopentest_postgres` | 5432 | PostgreSQL 16 database |
| backend | `autopentest_backend` | 8000 | FastAPI REST API |
| kali | `kali-autopentest` | -- | Kali Linux with security tools |
| frontend | `autopentest_frontend` | 5173 | React web dashboard |

### 3. Verify

```bash
# Check all containers are running
docker-compose ps

# Test backend health
curl http://localhost:8000/health

# Test Kali container has tools
docker exec kali-autopentest which nmap ffuf nuclei sqlmap

# Open the web dashboard
# http://localhost:5173
```

---

## Python Dependencies

All dependencies are in `backend/requirements.txt`:

### Core
| Package | Purpose |
|---------|---------|
| `fastapi` | REST API framework |
| `uvicorn` | ASGI server |
| `sqlalchemy` + `asyncpg` | PostgreSQL ORM |
| `pydantic` + `pydantic-settings` | Data validation and settings |
| `httpx` | Async HTTP client |
| `mcp>=1.0.0` | Model Context Protocol SDK |
| `structlog` | Structured logging |

### AutoPentest MCP Tools
| Package | Purpose |
|---------|---------|
| `pyyaml` | Scope YAML file parsing |
| `jsonschema` | Scope schema validation |
| `playwright` | Browser automation (15 browser tools) |
| `jinja2` | Evidence report templates |
| `aiosqlite` | World model SQLite database |

### Install Playwright Browsers (if using browser tools)

```bash
source backend/venv/bin/activate
playwright install chromium
```

---

## Zen Features (v2)

The following features were adapted from [Zen-Ai-Pentest](https://github.com/SHAdd0WTAka/Zen-Ai-Pentest):

### Risk Engine (`risk_score`, `risk_assess`)
CVSS v3.1 base score calculation, EPSS estimation, business impact scoring, and unified risk prioritization. Use `risk_score` for individual findings and `risk_assess` for batch assessment.

### PoC Generation (`poc_generate`)
Generates proof-of-concept scripts (curl + Python) for confirmed findings. Supports SQLi, XSS, IDOR, SSRF, LFI, and command injection. PoC-level only — demonstrates the vulnerability exists without deep exploitation.

### Exploit Safety Levels
4-tier safety classification (SAFE → CAUTION → DANGEROUS → BLOCKED) applied automatically to commands executed via `execute_command`. Blocked commands are refused; dangerous commands show warnings.

### SARIF Output
Export findings as SARIF 2.1.0 JSON via `evidence_export(format="sarif")` for CI/CD integration (GitHub Code Scanning, Azure DevOps, etc.).

### Plan-and-Execute with Reflection
Plan persistence in the world model via `wm_add_plan` and `wm_update_plan`. Create multi-step testing plans, track step completion, and add reflections on findings.

### DB-Aware SQL Injection Payloads
DB-specific SQLi payloads for MySQL, PostgreSQL, MSSQL, Oracle, SQLite with WAF bypass variants. Use `fuzz_parameter(..., payload_types=["sqli_db"], db_type="mysql")`.

---

## Optional Configuration

### Scope File

Create a YAML scope file to define authorized testing boundaries:

```bash
mkdir -p scope
```

Create `scope/engagement.yaml`:

```yaml
targets:
  domains:
    - "*.example.com"
  ips:
    - "10.0.0.0/24"
  urls:
    - "https://api.example.com/*"
exclusions:
  domains:
    - "prod.example.com"
constraints:
  max_requests_per_minute: 100
  max_total_requests: 10000
```

Set in `.env`:
```
SCOPE_FILE=./scope/engagement.yaml
```

### Identity File (for Auth Testing)

Create a YAML file with test identities for BOLA/IDOR testing:

```yaml
identities:
  - id: admin
    type: admin
    scope: all
    should_have_access: true
    auth:
      header: "Authorization"
      value: "Bearer admin-token-here"
  - id: user1
    type: regular
    scope: own-data
    should_have_access: false
    auth:
      header: "Authorization"
      value: "Bearer user1-token-here"
```

Set in environment:
```
IDENTITY_FILE=./scope/identities.yaml
```

---

## Project Structure

```
AutoPentest/
├── backend/
│   ├── mcp/
│   │   ├── autopentest_server.py          # MCP entry point (79 tools)
│   │   └── modules/
│   │       ├── service.py                 # Container management
│   │       ├── resources.py               # MCP resources
│   │       ├── tools_assessment.py        # 2 tools
│   │       ├── tools_cards.py             # 4 tools
│   │       ├── tools_recon.py             # 2 tools
│   │       ├── tools_execution.py         # 1 tool (+ safety classification)
│   │       ├── tools_scanning.py          # 5 tools
│   │       ├── tools_credentials.py       # 2 tools
│   │       ├── tools_scope.py             # 6 tools
│   │       ├── tools_http.py              # 3 tools
│   │       ├── tools_fuzzer.py            # 3 tools (+ DB-aware SQLi payloads)
│   │       ├── tools_nuclei.py            # 3 tools
│   │       ├── tools_openapi.py           # 6 tools
│   │       ├── tools_validator.py         # 4 tools
│   │       ├── tools_evidence.py          # 4 tools (+ SARIF export)
│   │       ├── tools_auth_tester.py       # 3 tools
│   │       ├── tools_world_model.py       # 13 tools (+ plan persistence)
│   │       ├── tools_risk.py              # 3 tools (risk scoring, PoC gen)
│   │       ├── tools_browser.py           # 15 tools
│   │       └── lib/                       # 33 supporting libraries
│   ├── api/                               # REST API endpoints
│   ├── models/                            # Database models
│   ├── services/                          # Business logic
│   ├── config.py                          # Pydantic settings
│   └── requirements.txt                   # Python dependencies
├── frontend/                              # React dashboard (Ant Design 5.x)
├── docker-compose.yml                     # 4-service orchestration
├── Dockerfile.kali                        # Kali Linux container
└── start_mcp.sh                           # MCP server launcher
```

---

## Frontend Dependencies

The web dashboard is built with React 19 and Ant Design 5.x:

| Package | Purpose |
|---------|---------|
| `react` + `react-dom` | UI framework |
| `react-router-dom` | Client-side routing |
| `antd` | Ant Design component library (buttons, tables, modals, forms, etc.) |
| `@ant-design/icons` | Ant Design icon set |
| `axios` | HTTP client |
| `lucide-react` | Supplementary icon library |
| `dayjs` | Date handling (required by antd DatePicker) |
| `tailwindcss` | Utility CSS (layout, spacing, custom styles) |

### Install & Run Frontend

```bash
cd frontend
npm install
npm run dev   # Starts Vite dev server on http://localhost:5173
```

---

## Troubleshooting

### MCP server fails to start
- Check logs: `cat /tmp/autopentest_mcp.log`
- Verify Python 3.10+: `python3 --version`
- Reinstall deps: `rm -rf backend/venv && ./start_mcp.sh`

### Docker containers won't start
- Check Docker is running: `docker info`
- Check logs: `docker-compose logs -f backend`
- Rebuild: `docker-compose build --no-cache`

### Kali container missing tools
- Rebuild: `docker-compose build kali`
- Check manually: `docker exec kali-autopentest apt list --installed`

### Browser tools not working
- Install Playwright browsers: `playwright install chromium`

### Scope validation errors
- Verify `SCOPE_FILE` path in `.env`
- Check YAML syntax: `python3 -c "import yaml; yaml.safe_load(open('scope/engagement.yaml'))"`
